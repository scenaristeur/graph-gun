(self["webpackChunkgraph_gun"]=self["webpackChunkgraph_gun"]||[]).push([[583],{583:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return u}});var r=function(){var e=this,t=e._self._c;return t("div",[e._v(" ------------------------ "),t("br"),t("h2",[e._v(" Matrix Client")]),e._v(" provider : "),t("input",{directives:[{name:"model",rawName:"v-model",value:e.provider,expression:"provider"}],attrs:{placeholder:"provider, ex: https://matrix.org"},domProps:{value:e.provider},on:{input:function(t){t.target.composing||(e.provider=t.target.value)}}}),t("br"),e._v(" Login with token : "),t("input",{directives:[{name:"model",rawName:"v-model",value:e.token,expression:"token"}],attrs:{placeholder:"token",type:"password"},domProps:{value:e.token},on:{input:function(t){t.target.composing||(e.token=t.target.value)}}}),t("br"),e._v(" Or Login with userId / password : "),t("input",{directives:[{name:"model",rawName:"v-model",value:e.userId,expression:"userId"}],attrs:{placeholder:"userId"},domProps:{value:e.userId},on:{input:function(t){t.target.composing||(e.userId=t.target.value)}}}),t("input",{directives:[{name:"model",rawName:"v-model",value:e.password,expression:"password"}],attrs:{placeholder:"password",type:"password"},domProps:{value:e.password},on:{input:function(t){t.target.composing||(e.password=t.target.value)}}}),t("br"),t("button",{on:{click:e.login}},[e._v("Login")]),t("br"),t("br"),e._v(" "+e._s(e.log)+" "),t("br"),"PREPARED"==e.state?t("div",[t("input",{directives:[{name:"model",rawName:"v-model",value:e.message2send,expression:"message2send"}],attrs:{placeholder:"message to Send"},domProps:{value:e.message2send},on:{input:function(t){t.target.composing||(e.message2send=t.target.value)}}}),t("button",{on:{click:e.sendMessage}},[e._v("Send to #test:matrix.org room ")]),e._v(" roomList : "+e._s(e.roomList)+" ")]):e._e(),t("br"),t("br")])},i=[],o=n(1364),s=n.n(o),a={name:"MatrixLogin",data(){return{provider:"https://matrix.org",token:"",userId:"@spoggy:matrix.org",password:"",client:null,state:null,log:null,message2send:"",roomList:{}}},methods:{async login(){if(this.token.length>0){this.log="login with token";try{this.client=s().createClient({baseUrl:this.provider,accessToken:this.token,userId:this.userId}),this.log="starting client",this.startClient()}catch(e){alert(e)}}else this.log="login with userId/password",this.client=s().createClient(this.provider),this.client.login("m.login.password",{user:this.userId,password:this.password}).then((e=>{this.log="getAccessToken",this.token=e.access_token,this.login()}))},startClient(){this.client.startClient();let e=this;e.log="first sync, waiting for client to be ready",this.client.once("sync",(function(t,n,r){console.log(t,n,r),e.state=t,e.log="client ready","PREPARED"==t&&(e.onClientReady(),e.$store.commit("setUsername",e.userId))}))},onClientReady(){let e=this;this.log="client listening on events & room.timeline",this.client.on("event",(function(e){console.log(e.getType()),console.log(e)})),this.client.on("Room.timeline",(function(e,t,n){console.log(e.event,t,n)}));var t=this.client.getRooms();console.log(t.length,t),t.forEach((t=>{console.log(t.roomId,t),e.roomList[t.roomId]={id:t.roomId,name:t.name};var n=t.getJoinedMembers();n.forEach((e=>{console.log(e.name)})),t.timeline.forEach((e=>{console.log(JSON.stringify(e.event.content,e))}))}))},initialRoomSync(){var e="!hCZXcwEEfmJWNeIGbo:matrix.org";this.client.initialRoomSync(e).then((e=>{console.log("initialRoomSync",e)})).catch((e=>{console.log(e)}))},sendMessage(){var e="!hCZXcwEEfmJWNeIGbo:matrix.org";let t={id:1234,label:this.message2send};var n={body:JSON.stringify(t),msgtype:"m.text"};console.log(n),this.client.sendEvent(e,"m.room.message",n,"").then((e=>{console.log("message send sucessfully",e),this.message2send=""})).catch((e=>{console.log(e)}))}}},c=a,l=n(1001),d=(0,l.Z)(c,r,i,!1,null,null,null),u=d.exports},4019:function(e){e.exports="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView},260:function(e,t,n){"use strict";var r,i,o,s=n(4019),a=n(9781),c=n(7854),l=n(614),d=n(111),u=n(2597),h=n(648),g=n(6330),p=n(8880),f=n(8052),y=n(3070).f,m=n(7976),v=n(9518),E=n(7674),S=n(5112),b=n(9711),w=n(9909),_=w.enforce,T=w.get,I=c.Int8Array,R=I&&I.prototype,k=c.Uint8ClampedArray,O=k&&k.prototype,C=I&&v(I),P=R&&v(R),M=Object.prototype,D=c.TypeError,A=S("toStringTag"),U=b("TYPED_ARRAY_TAG"),L="TypedArrayConstructor",N=s&&!!E&&"Opera"!==h(c.opera),B=!1,j={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},x={BigInt64Array:8,BigUint64Array:8},K=function(e){if(!d(e))return!1;var t=h(e);return"DataView"===t||u(j,t)||u(x,t)},F=function(e){var t=v(e);if(d(t)){var n=T(t);return n&&u(n,L)?n[L]:F(t)}},q=function(e){if(!d(e))return!1;var t=h(e);return u(j,t)||u(x,t)},$=function(e){if(q(e))return e;throw D("Target is not a typed array")},V=function(e){if(l(e)&&(!E||m(C,e)))return e;throw D(g(e)+" is not a typed array constructor")},G=function(e,t,n,r){if(a){if(n)for(var i in j){var o=c[i];if(o&&u(o.prototype,e))try{delete o.prototype[e]}catch(s){try{o.prototype[e]=t}catch(l){}}}P[e]&&!n||f(P,e,n?t:N&&R[e]||t,r)}},W=function(e,t,n){var r,i;if(a){if(E){if(n)for(r in j)if(i=c[r],i&&u(i,e))try{delete i[e]}catch(o){}if(C[e]&&!n)return;try{return f(C,e,n?t:N&&C[e]||t)}catch(o){}}for(r in j)i=c[r],!i||i[e]&&!n||f(i,e,t)}};for(r in j)i=c[r],o=i&&i.prototype,o?_(o)[L]=i:N=!1;for(r in x)i=c[r],o=i&&i.prototype,o&&(_(o)[L]=i);if((!N||!l(C)||C===Function.prototype)&&(C=function(){throw D("Incorrect invocation")},N))for(r in j)c[r]&&E(c[r],C);if((!N||!P||P===M)&&(P=C.prototype,N))for(r in j)c[r]&&E(c[r].prototype,P);if(N&&v(O)!==P&&E(O,P),a&&!u(P,A))for(r in B=!0,y(P,A,{get:function(){return d(this)?this[U]:void 0}}),j)c[r]&&p(c[r],U,r);e.exports={NATIVE_ARRAY_BUFFER_VIEWS:N,TYPED_ARRAY_TAG:B&&U,aTypedArray:$,aTypedArrayConstructor:V,exportTypedArrayMethod:G,exportTypedArrayStaticMethod:W,getTypedArrayConstructor:F,isView:K,isTypedArray:q,TypedArray:C,TypedArrayPrototype:P}},9671:function(e,t,n){var r=n(9974),i=n(8361),o=n(7908),s=n(6244),a=function(e){var t=1==e;return function(n,a,c){var l,d,u=o(n),h=i(u),g=r(a,c),p=s(h);while(p-- >0)if(l=h[p],d=g(l,p,u),d)switch(e){case 0:return l;case 1:return p}return t?-1:void 0}};e.exports={findLast:a(0),findLastIndex:a(1)}},8544:function(e,t,n){var r=n(7293);e.exports=!r((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype}))},9518:function(e,t,n){var r=n(2597),i=n(614),o=n(7908),s=n(6200),a=n(8544),c=s("IE_PROTO"),l=Object,d=l.prototype;e.exports=a?l.getPrototypeOf:function(e){var t=o(e);if(r(t,c))return t[c];var n=t.constructor;return i(n)&&t instanceof n?n.prototype:t instanceof l?d:null}},4590:function(e,t,n){var r=n(3002),i=RangeError;e.exports=function(e,t){var n=r(e);if(n%t)throw i("Wrong offset");return n}},3002:function(e,t,n){var r=n(9303),i=RangeError;e.exports=function(e){var t=r(e);if(t<0)throw i("The argument can't be less than 0");return t}},2120:function(e,t,n){var r=n(2109),i=n(5005),o=n(2104),s=n(7293),a=n(9191),c="AggregateError",l=i(c),d=!s((function(){return 1!==l([1]).errors[0]}))&&s((function(){return 7!==l([1],c,{cause:7}).cause}));r({global:!0,constructor:!0,arity:2,forced:d},{AggregateError:a(c,(function(e){return function(t,n){return o(e,this,arguments)}}),d,!0)})},8675:function(e,t,n){"use strict";var r=n(260),i=n(6244),o=n(9303),s=r.aTypedArray,a=r.exportTypedArrayMethod;a("at",(function(e){var t=s(this),n=i(t),r=o(e),a=r>=0?r:n+r;return a<0||a>=n?void 0:t[a]}))},2958:function(e,t,n){"use strict";var r=n(260),i=n(9671).findLastIndex,o=r.aTypedArray,s=r.exportTypedArrayMethod;s("findLastIndex",(function(e){return i(o(this),e,arguments.length>1?arguments[1]:void 0)}))},3408:function(e,t,n){"use strict";var r=n(260),i=n(9671).findLast,o=r.aTypedArray,s=r.exportTypedArrayMethod;s("findLast",(function(e){return i(o(this),e,arguments.length>1?arguments[1]:void 0)}))},3462:function(e,t,n){"use strict";var r=n(7854),i=n(6916),o=n(260),s=n(6244),a=n(4590),c=n(7908),l=n(7293),d=r.RangeError,u=r.Int8Array,h=u&&u.prototype,g=h&&h.set,p=o.aTypedArray,f=o.exportTypedArrayMethod,y=!l((function(){var e=new Uint8ClampedArray(2);return i(g,e,{length:1,0:3},1),3!==e[1]})),m=y&&o.NATIVE_ARRAY_BUFFER_VIEWS&&l((function(){var e=new u(2);return e.set(1),e.set("2",1),0!==e[0]||2!==e[1]}));f("set",(function(e){p(this);var t=a(arguments.length>1?arguments[1]:void 0,1),n=c(e);if(y)return i(g,this,n,t);var r=this.length,o=s(n),l=0;if(o+t>r)throw d("Wrong length");while(l<o)this[t+l]=n[l++]}),!y||m)},1118:function(e,t,n){n(2958)},7380:function(e,t,n){n(3408)},7577:function(e,t,n){"use strict";n(1703);for(var r=/[\\\"\x00-\x1F]/g,i={},o=0;o<32;++o)i[String.fromCharCode(o)]="\\U"+("0000"+o.toString(16)).slice(-4).toUpperCase();function s(e){return r.lastIndex=0,e.replace(r,(function(e){return i[e]}))}function a(e){switch(typeof e){case"string":return'"'+s(e)+'"';case"number":return isFinite(e)?e:"null";case"boolean":return e;case"object":return null===e?"null":Array.isArray(e)?c(e):l(e);default:throw new Error("Cannot stringify: "+typeof e)}}function c(e){for(var t="[",n="",r=0;r<e.length;++r)n+=t,t=",",n+=a(e[r]);return","!=t?"[]":n+"]"}function l(e){var t="{",n="",r=Object.keys(e);r.sort();for(var i=0;i<r.length;++i){var o=r[i];n+=t+'"'+s(o)+'":',t=",",n+=a(e[o])}return","!=t?"{}":n+"}"}i["\b"]="\\b",i["\t"]="\\t",i["\n"]="\\n",i["\f"]="\\f",i["\r"]="\\r",i['"']='\\"',i["\\"]="\\\\",e.exports={stringify:a}},2516:function(e,t,n){"use strict";n(1703),n(8675),n(3462),n(7380),n(1118);var r=n(6779).Buffer;function i(e){if(e.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==t[s])throw new TypeError(o+" is ambiguous");t[s]=i}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function u(t){if((Array.isArray(t)||t instanceof Uint8Array)&&(t=r.from(t)),!r.isBuffer(t))throw new TypeError("Expected Buffer");if(0===t.length)return"";var n=0,i=0,o=0,s=t.length;while(o!==s&&0===t[o])o++,n++;var l=(s-o)*d+1>>>0,u=new Uint8Array(l);while(o!==s){for(var h=t[o],g=0,p=l-1;(0!==h||g<i)&&-1!==p;p--,g++)h+=256*u[p]>>>0,u[p]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");i=g,o++}var f=l-i;while(f!==l&&0===u[f])f++;for(var y=c.repeat(n);f<l;++f)y+=e.charAt(u[f]);return y}function h(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return r.alloc(0);var n=0,i=0,o=0;while(e[n]===c)i++,n++;var s=(e.length-n)*l+1>>>0,d=new Uint8Array(s);while(e[n]){var u=t[e.charCodeAt(n)];if(255===u)return;for(var h=0,g=s-1;(0!==u||h<o)&&-1!==g;g--,h++)u+=a*d[g]>>>0,d[g]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");o=h,n++}var p=s-o;while(p!==s&&0===d[p])p++;var f=r.allocUnsafe(i+(s-p));f.fill(0,0,i);var y=i;while(p!==s)f[y++]=d[p++];return f}function g(e){var t=h(e);if(t)return t;throw new Error("Non-base"+a+" character")}return{encode:u,decodeUnsafe:h,decode:g}}e.exports=i},1271:function(e,t,n){"use strict";n(8675),n(3462),n(7380),n(1118),n(1703),t.byteLength=d,t.toByteArray=h,t.fromByteArray=f;for(var r=[],i=[],o="undefined"!==typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,c=s.length;a<c;++a)r[a]=s[a],i[s.charCodeAt(a)]=a;function l(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");-1===n&&(n=t);var r=n===t?0:4-n%4;return[n,r]}function d(e){var t=l(e),n=t[0],r=t[1];return 3*(n+r)/4-r}function u(e,t,n){return 3*(t+n)/4-n}function h(e){var t,n,r=l(e),s=r[0],a=r[1],c=new o(u(e,s,a)),d=0,h=a>0?s-4:s;for(n=0;n<h;n+=4)t=i[e.charCodeAt(n)]<<18|i[e.charCodeAt(n+1)]<<12|i[e.charCodeAt(n+2)]<<6|i[e.charCodeAt(n+3)],c[d++]=t>>16&255,c[d++]=t>>8&255,c[d++]=255&t;return 2===a&&(t=i[e.charCodeAt(n)]<<2|i[e.charCodeAt(n+1)]>>4,c[d++]=255&t),1===a&&(t=i[e.charCodeAt(n)]<<10|i[e.charCodeAt(n+1)]<<4|i[e.charCodeAt(n+2)]>>2,c[d++]=t>>8&255,c[d++]=255&t),c}function g(e){return r[e>>18&63]+r[e>>12&63]+r[e>>6&63]+r[63&e]}function p(e,t,n){for(var r,i=[],o=t;o<n;o+=3)r=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),i.push(g(r));return i.join("")}function f(e){for(var t,n=e.length,i=n%3,o=[],s=16383,a=0,c=n-i;a<c;a+=s)o.push(p(e,a,a+s>c?c:a+s));return 1===i?(t=e[n-1],o.push(r[t>>2]+r[t<<4&63]+"==")):2===i&&(t=(e[n-2]<<8)+e[n-1],o.push(r[t>>10]+r[t>>4&63]+r[t<<2&63]+"=")),o.join("")}i["-".charCodeAt(0)]=62,i["_".charCodeAt(0)]=63},9751:function(e,t,n){var r,i,o;n(1703),function(n,s){i=[],r=s,o="function"===typeof r?r.apply(t,i):r,void 0===o||(e.exports=o)}(0,(function(){var e=XMLHttpRequest;if(!e)throw new Error("missing XMLHttpRequest");n.log={trace:s,debug:s,info:s,warn:s,error:s};var t=18e4;function n(e,t){if("function"!==typeof t)throw new Error("Bad callback given: "+t);if(!e)throw new Error("No options given");var r=e.onResponse;if(e="string"===typeof e?{uri:e}:JSON.parse(JSON.stringify(e)),e.onResponse=r,e.verbose&&(n.log=a()),e.url&&(e.uri=e.url,delete e.url),!e.uri&&""!==e.uri)throw new Error("options.uri is a required argument");if("string"!=typeof e.uri)throw new Error("options.uri must be a string");for(var o=["proxy","_redirectsFollowed","maxRedirects","followRedirect"],c=0;c<o.length;c++)if(e[o[c]])throw new Error("options."+o[c]+" is not supported");if(e.callback=t,e.method=e.method||"GET",e.headers=e.headers||{},e.body=e.body||null,e.timeout=e.timeout||n.DEFAULT_TIMEOUT,e.headers.host)throw new Error("Options.headers.host is not supported");e.json&&(e.headers.accept=e.headers.accept||"application/json","GET"!==e.method&&(e.headers["content-type"]="application/json"),"boolean"!==typeof e.json?e.body=JSON.stringify(e.json):"string"!==typeof e.body&&(e.body=JSON.stringify(e.body)));var l=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")};if(e.qs){var u="string"==typeof e.qs?e.qs:l(e.qs);-1!==e.uri.indexOf("?")?e.uri=e.uri+"&"+u:e.uri=e.uri+"?"+u}var h=function(e){var t={};t.boundry="-------------------------------"+Math.floor(1e9*Math.random());var n=[];for(var r in e)e.hasOwnProperty(r)&&n.push("--"+t.boundry+'\nContent-Disposition: form-data; name="'+r+'"\n\n'+e[r]+"\n");return n.push("--"+t.boundry+"--"),t.body=n.join(""),t.length=t.body.length,t.type="multipart/form-data; boundary="+t.boundry,t};if(e.form){if("string"==typeof e.form)throw"form name unsupported";if("POST"===e.method){var g=(e.encoding||"application/x-www-form-urlencoded").toLowerCase();switch(e.headers["content-type"]=g,g){case"application/x-www-form-urlencoded":e.body=l(e.form).replace(/%20/g,"+");break;case"multipart/form-data":var p=h(e.form);e.body=p.body,e.headers["content-type"]=p.type;break;default:throw new Error("unsupported encoding:"+g)}}}return e.onResponse=e.onResponse||s,!0===e.onResponse&&(e.onResponse=t,e.callback=s),!e.headers.authorization&&e.auth&&(e.headers.authorization="Basic "+d(e.auth.username+":"+e.auth.password)),i(e)}var r=0;function i(t){var i=new e,o=!1,s=l(t.uri),a="withCredentials"in i;if(r+=1,i.seq_id=r,i.id=r+": "+t.method+" "+t.uri,i._id=i.id,s&&!a){var c=new Error("Browser does not support cross-origin request: "+t.uri);return c.cors="unsupported",t.callback(c,i)}function d(){o=!0;var e=new Error("ETIMEDOUT");return e.code="ETIMEDOUT",e.duration=t.timeout,n.log.error("Timeout",{id:i._id,milliseconds:t.timeout}),t.callback(e,i)}i.timeoutTimer=setTimeout(d,t.timeout);var u={response:!1,loading:!1,end:!1};return i.onreadystatechange=h,i.open(t.method,t.uri,!0),s&&(i.withCredentials=!!t.withCredentials),i.send(t.body),i;function h(r){if(o)return n.log.debug("Ignoring timed out state change",{state:i.readyState,id:i.id});if(n.log.debug("State change",{state:i.readyState,id:i.id,timed_out:o}),i.readyState===e.OPENED)for(var s in n.log.debug("Request started",{id:i.id}),t.headers)i.setRequestHeader(s,t.headers[s]);else i.readyState===e.HEADERS_RECEIVED?g():i.readyState===e.LOADING?(g(),p()):i.readyState===e.DONE&&(g(),p(),f())}function g(){if(!u.response){if(u.response=!0,n.log.debug("Got response",{id:i.id,status:i.status}),clearTimeout(i.timeoutTimer),i.statusCode=i.status,s&&0==i.statusCode){var e=new Error("CORS request rejected: "+t.uri);return e.cors="rejected",u.loading=!0,u.end=!0,t.callback(e,i)}t.onResponse(null,i)}}function p(){u.loading||(u.loading=!0,n.log.debug("Response body loading",{id:i.id}))}function f(){if(!u.end){if(u.end=!0,n.log.debug("Request done",{id:i.id}),i.body=i.responseText,t.json)try{i.body=JSON.parse(i.responseText)}catch(e){return t.callback(e,i)}t.callback(null,i,i.body)}}}n.withCredentials=!1,n.DEFAULT_TIMEOUT=t,n.defaults=function(e,t){var r=function(t){var n=function(n,r){for(var i in n="string"===typeof n?{uri:n}:JSON.parse(JSON.stringify(n)),e)void 0===n[i]&&(n[i]=e[i]);return t(n,r)};return n},i=r(n);return i.get=r(n.get),i.post=r(n.post),i.put=r(n.put),i.head=r(n.head),i};var o=["get","put","post","head"];function s(){}function a(){var e,t,n={},r=["trace","debug","info","warn","error"];for(t=0;t<r.length;t++)e=r[t],n[e]=s,"undefined"!==typeof console&&console&&console[e]&&(n[e]=c(console,e));return n}function c(e,t){return n;function n(n,r){return"object"===typeof r&&(n+=" "+JSON.stringify(r)),e[t].call(e,n)}}function l(e){var t,n=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/;try{t=location.href}catch(s){t=document.createElement("a"),t.href="",t=t.href}var r=n.exec(t.toLowerCase())||[],i=n.exec(e.toLowerCase()),o=!(!i||i[1]==r[1]&&i[2]==r[2]&&(i[3]||("http:"===i[1]?80:443))==(r[3]||("http:"===r[1]?80:443)));return o}function d(e){var t,n,r,i,o,s,a,c,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d=0,u=0,h="",g=[];if(!e)return e;do{t=e.charCodeAt(d++),n=e.charCodeAt(d++),r=e.charCodeAt(d++),c=t<<16|n<<8|r,i=c>>18&63,o=c>>12&63,s=c>>6&63,a=63&c,g[u++]=l.charAt(i)+l.charAt(o)+l.charAt(s)+l.charAt(a)}while(d<e.length);switch(h=g.join(""),e.length%3){case 1:h=h.slice(0,-2)+"==";break;case 2:h=h.slice(0,-1)+"=";break}return h}return o.forEach((function(e){var t=e.toUpperCase(),r=e.toLowerCase();n[r]=function(e){"string"===typeof e?e={method:t,uri:e}:(e=JSON.parse(JSON.stringify(e)),e.method=t);var r=[e].concat(Array.prototype.slice.apply(arguments,[1]));return n.apply(this,r)}})),n.couch=function(e,t){"string"===typeof e&&(e={uri:e}),e.json=!0,e.body&&(e.json=e.body),delete e.body,t=t||s;var r=n(e,i);return r;function i(e,n,r){if(e)return t(e,n,r);if((n.statusCode<200||n.statusCode>299)&&r.error){for(var i in e=new Error("CouchDB error: "+(r.error.reason||r.error.error)),r)e[i]=r[i];return t(e,n,r)}return t(e,n,r)}},n}))},7575:function(e,t,n){var r=n(2516),i="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";e.exports=r(i)},5361:function(e,t,n){"use strict";
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */n(8675),n(3462),n(7380),n(1118),n(1703),n(6699);var r=n(1271),i=n(7055),o="function"===typeof Symbol&&"function"===typeof Symbol["for"]?Symbol["for"]("nodejs.util.inspect.custom"):null;t.Buffer=l,t.SlowBuffer=S,t.INSPECT_MAX_BYTES=50;var s=2147483647;function a(){try{var e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(n){return!1}}function c(e){if(e>s)throw new RangeError('The value "'+e+'" is invalid for option "size"');var t=new Uint8Array(e);return Object.setPrototypeOf(t,l.prototype),t}function l(e,t,n){if("number"===typeof e){if("string"===typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return g(e)}return d(e,t,n)}function d(e,t,n){if("string"===typeof e)return p(e,t);if(ArrayBuffer.isView(e))return y(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(Q(e,ArrayBuffer)||e&&Q(e.buffer,ArrayBuffer))return m(e,t,n);if("undefined"!==typeof SharedArrayBuffer&&(Q(e,SharedArrayBuffer)||e&&Q(e.buffer,SharedArrayBuffer)))return m(e,t,n);if("number"===typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');var r=e.valueOf&&e.valueOf();if(null!=r&&r!==e)return l.from(r,t,n);var i=v(e);if(i)return i;if("undefined"!==typeof Symbol&&null!=Symbol.toPrimitive&&"function"===typeof e[Symbol.toPrimitive])return l.from(e[Symbol.toPrimitive]("string"),t,n);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function u(e){if("number"!==typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function h(e,t,n){return u(e),e<=0?c(e):void 0!==t?"string"===typeof n?c(e).fill(t,n):c(e).fill(t):c(e)}function g(e){return u(e),c(e<0?0:0|E(e))}function p(e,t){if("string"===typeof t&&""!==t||(t="utf8"),!l.isEncoding(t))throw new TypeError("Unknown encoding: "+t);var n=0|b(e,t),r=c(n),i=r.write(e,t);return i!==n&&(r=r.slice(0,i)),r}function f(e){for(var t=e.length<0?0:0|E(e.length),n=c(t),r=0;r<t;r+=1)n[r]=255&e[r];return n}function y(e){if(Q(e,Uint8Array)){var t=new Uint8Array(e);return m(t.buffer,t.byteOffset,t.byteLength)}return f(e)}function m(e,t,n){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(n||0))throw new RangeError('"length" is outside of buffer bounds');var r;return r=void 0===t&&void 0===n?new Uint8Array(e):void 0===n?new Uint8Array(e,t):new Uint8Array(e,t,n),Object.setPrototypeOf(r,l.prototype),r}function v(e){if(l.isBuffer(e)){var t=0|E(e.length),n=c(t);return 0===n.length||e.copy(n,0,0,t),n}return void 0!==e.length?"number"!==typeof e.length||X(e.length)?c(0):f(e):"Buffer"===e.type&&Array.isArray(e.data)?f(e.data):void 0}function E(e){if(e>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return 0|e}function S(e){return+e!=e&&(e=0),l.alloc(+e)}function b(e,t){if(l.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||Q(e,ArrayBuffer))return e.byteLength;if("string"!==typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);var n=e.length,r=arguments.length>2&&!0===arguments[2];if(!r&&0===n)return 0;for(var i=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":return W(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return J(e).length;default:if(i)return r?-1:W(e).length;t=(""+t).toLowerCase(),i=!0}}function w(e,t,n){var r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if(n>>>=0,t>>>=0,n<=t)return"";e||(e="utf8");while(1)switch(e){case"hex":return B(this,t,n);case"utf8":case"utf-8":return D(this,t,n);case"ascii":return L(this,t,n);case"latin1":case"binary":return N(this,t,n);case"base64":return M(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return j(this,t,n);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function _(e,t,n){var r=e[t];e[t]=e[n],e[n]=r}function T(e,t,n,r,i){if(0===e.length)return-1;if("string"===typeof n?(r=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,X(n)&&(n=i?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(i)return-1;n=e.length-1}else if(n<0){if(!i)return-1;n=0}if("string"===typeof t&&(t=l.from(t,r)),l.isBuffer(t))return 0===t.length?-1:I(e,t,n,r,i);if("number"===typeof t)return t&=255,"function"===typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):I(e,[t],n,r,i);throw new TypeError("val must be string, number or Buffer")}function I(e,t,n,r,i){var o,s=1,a=e.length,c=t.length;if(void 0!==r&&(r=String(r).toLowerCase(),"ucs2"===r||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;s=2,a/=2,c/=2,n/=2}function l(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){var d=-1;for(o=n;o<a;o++)if(l(e,o)===l(t,-1===d?0:o-d)){if(-1===d&&(d=o),o-d+1===c)return d*s}else-1!==d&&(o-=o-d),d=-1}else for(n+c>a&&(n=a-c),o=n;o>=0;o--){for(var u=!0,h=0;h<c;h++)if(l(e,o+h)!==l(t,h)){u=!1;break}if(u)return o}return-1}function R(e,t,n,r){n=Number(n)||0;var i=e.length-n;r?(r=Number(r),r>i&&(r=i)):r=i;var o=t.length;r>o/2&&(r=o/2);for(var s=0;s<r;++s){var a=parseInt(t.substr(2*s,2),16);if(X(a))return s;e[n+s]=a}return s}function k(e,t,n,r){return z(W(t,e.length-n),e,n,r)}function O(e,t,n,r){return z(H(t),e,n,r)}function C(e,t,n,r){return z(J(t),e,n,r)}function P(e,t,n,r){return z(Y(t,e.length-n),e,n,r)}function M(e,t,n){return 0===t&&n===e.length?r.fromByteArray(e):r.fromByteArray(e.slice(t,n))}function D(e,t,n){n=Math.min(e.length,n);var r=[],i=t;while(i<n){var o,s,a,c,l=e[i],d=null,u=l>239?4:l>223?3:l>191?2:1;if(i+u<=n)switch(u){case 1:l<128&&(d=l);break;case 2:o=e[i+1],128===(192&o)&&(c=(31&l)<<6|63&o,c>127&&(d=c));break;case 3:o=e[i+1],s=e[i+2],128===(192&o)&&128===(192&s)&&(c=(15&l)<<12|(63&o)<<6|63&s,c>2047&&(c<55296||c>57343)&&(d=c));break;case 4:o=e[i+1],s=e[i+2],a=e[i+3],128===(192&o)&&128===(192&s)&&128===(192&a)&&(c=(15&l)<<18|(63&o)<<12|(63&s)<<6|63&a,c>65535&&c<1114112&&(d=c))}null===d?(d=65533,u=1):d>65535&&(d-=65536,r.push(d>>>10&1023|55296),d=56320|1023&d),r.push(d),i+=u}return U(r)}t.kMaxLength=s,l.TYPED_ARRAY_SUPPORT=a(),l.TYPED_ARRAY_SUPPORT||"undefined"===typeof console||"function"!==typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(l.prototype,"parent",{enumerable:!0,get:function(){if(l.isBuffer(this))return this.buffer}}),Object.defineProperty(l.prototype,"offset",{enumerable:!0,get:function(){if(l.isBuffer(this))return this.byteOffset}}),l.poolSize=8192,l.from=function(e,t,n){return d(e,t,n)},Object.setPrototypeOf(l.prototype,Uint8Array.prototype),Object.setPrototypeOf(l,Uint8Array),l.alloc=function(e,t,n){return h(e,t,n)},l.allocUnsafe=function(e){return g(e)},l.allocUnsafeSlow=function(e){return g(e)},l.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==l.prototype},l.compare=function(e,t){if(Q(e,Uint8Array)&&(e=l.from(e,e.offset,e.byteLength)),Q(t,Uint8Array)&&(t=l.from(t,t.offset,t.byteLength)),!l.isBuffer(e)||!l.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;for(var n=e.length,r=t.length,i=0,o=Math.min(n,r);i<o;++i)if(e[i]!==t[i]){n=e[i],r=t[i];break}return n<r?-1:r<n?1:0},l.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},l.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return l.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var r=l.allocUnsafe(t),i=0;for(n=0;n<e.length;++n){var o=e[n];if(Q(o,Uint8Array))i+o.length>r.length?l.from(o).copy(r,i):Uint8Array.prototype.set.call(r,o,i);else{if(!l.isBuffer(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(r,i)}i+=o.length}return r},l.byteLength=b,l.prototype._isBuffer=!0,l.prototype.swap16=function(){var e=this.length;if(e%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)_(this,t,t+1);return this},l.prototype.swap32=function(){var e=this.length;if(e%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)_(this,t,t+3),_(this,t+1,t+2);return this},l.prototype.swap64=function(){var e=this.length;if(e%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)_(this,t,t+7),_(this,t+1,t+6),_(this,t+2,t+5),_(this,t+3,t+4);return this},l.prototype.toString=function(){var e=this.length;return 0===e?"":0===arguments.length?D(this,0,e):w.apply(this,arguments)},l.prototype.toLocaleString=l.prototype.toString,l.prototype.equals=function(e){if(!l.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===l.compare(this,e)},l.prototype.inspect=function(){var e="",n=t.INSPECT_MAX_BYTES;return e=this.toString("hex",0,n).replace(/(.{2})/g,"$1 ").trim(),this.length>n&&(e+=" ... "),"<Buffer "+e+">"},o&&(l.prototype[o]=l.prototype.inspect),l.prototype.compare=function(e,t,n,r,i){if(Q(e,Uint8Array)&&(e=l.from(e,e.offset,e.byteLength)),!l.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===r&&(r=0),void 0===i&&(i=this.length),t<0||n>e.length||r<0||i>this.length)throw new RangeError("out of range index");if(r>=i&&t>=n)return 0;if(r>=i)return-1;if(t>=n)return 1;if(t>>>=0,n>>>=0,r>>>=0,i>>>=0,this===e)return 0;for(var o=i-r,s=n-t,a=Math.min(o,s),c=this.slice(r,i),d=e.slice(t,n),u=0;u<a;++u)if(c[u]!==d[u]){o=c[u],s=d[u];break}return o<s?-1:s<o?1:0},l.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},l.prototype.indexOf=function(e,t,n){return T(this,e,t,n,!0)},l.prototype.lastIndexOf=function(e,t,n){return T(this,e,t,n,!1)},l.prototype.write=function(e,t,n,r){if(void 0===t)r="utf8",n=this.length,t=0;else if(void 0===n&&"string"===typeof t)r=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(n)?(n>>>=0,void 0===r&&(r="utf8")):(r=n,n=void 0)}var i=this.length-t;if((void 0===n||n>i)&&(n=i),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var o=!1;;)switch(r){case"hex":return R(this,e,t,n);case"utf8":case"utf-8":return k(this,e,t,n);case"ascii":case"latin1":case"binary":return O(this,e,t,n);case"base64":return C(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return P(this,e,t,n);default:if(o)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),o=!0}},l.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var A=4096;function U(e){var t=e.length;if(t<=A)return String.fromCharCode.apply(String,e);var n="",r=0;while(r<t)n+=String.fromCharCode.apply(String,e.slice(r,r+=A));return n}function L(e,t,n){var r="";n=Math.min(e.length,n);for(var i=t;i<n;++i)r+=String.fromCharCode(127&e[i]);return r}function N(e,t,n){var r="";n=Math.min(e.length,n);for(var i=t;i<n;++i)r+=String.fromCharCode(e[i]);return r}function B(e,t,n){var r=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>r)&&(n=r);for(var i="",o=t;o<n;++o)i+=Z[e[o]];return i}function j(e,t,n){for(var r=e.slice(t,n),i="",o=0;o<r.length-1;o+=2)i+=String.fromCharCode(r[o]+256*r[o+1]);return i}function x(e,t,n){if(e%1!==0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function K(e,t,n,r,i,o){if(!l.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<o)throw new RangeError('"value" argument is out of bounds');if(n+r>e.length)throw new RangeError("Index out of range")}function F(e,t,n,r,i,o){if(n+r>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function q(e,t,n,r,o){return t=+t,n>>>=0,o||F(e,t,n,4,34028234663852886e22,-34028234663852886e22),i.write(e,t,n,r,23,4),n+4}function $(e,t,n,r,o){return t=+t,n>>>=0,o||F(e,t,n,8,17976931348623157e292,-17976931348623157e292),i.write(e,t,n,r,52,8),n+8}l.prototype.slice=function(e,t){var n=this.length;e=~~e,t=void 0===t?n:~~t,e<0?(e+=n,e<0&&(e=0)):e>n&&(e=n),t<0?(t+=n,t<0&&(t=0)):t>n&&(t=n),t<e&&(t=e);var r=this.subarray(e,t);return Object.setPrototypeOf(r,l.prototype),r},l.prototype.readUintLE=l.prototype.readUIntLE=function(e,t,n){e>>>=0,t>>>=0,n||x(e,t,this.length);var r=this[e],i=1,o=0;while(++o<t&&(i*=256))r+=this[e+o]*i;return r},l.prototype.readUintBE=l.prototype.readUIntBE=function(e,t,n){e>>>=0,t>>>=0,n||x(e,t,this.length);var r=this[e+--t],i=1;while(t>0&&(i*=256))r+=this[e+--t]*i;return r},l.prototype.readUint8=l.prototype.readUInt8=function(e,t){return e>>>=0,t||x(e,1,this.length),this[e]},l.prototype.readUint16LE=l.prototype.readUInt16LE=function(e,t){return e>>>=0,t||x(e,2,this.length),this[e]|this[e+1]<<8},l.prototype.readUint16BE=l.prototype.readUInt16BE=function(e,t){return e>>>=0,t||x(e,2,this.length),this[e]<<8|this[e+1]},l.prototype.readUint32LE=l.prototype.readUInt32LE=function(e,t){return e>>>=0,t||x(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},l.prototype.readUint32BE=l.prototype.readUInt32BE=function(e,t){return e>>>=0,t||x(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},l.prototype.readIntLE=function(e,t,n){e>>>=0,t>>>=0,n||x(e,t,this.length);var r=this[e],i=1,o=0;while(++o<t&&(i*=256))r+=this[e+o]*i;return i*=128,r>=i&&(r-=Math.pow(2,8*t)),r},l.prototype.readIntBE=function(e,t,n){e>>>=0,t>>>=0,n||x(e,t,this.length);var r=t,i=1,o=this[e+--r];while(r>0&&(i*=256))o+=this[e+--r]*i;return i*=128,o>=i&&(o-=Math.pow(2,8*t)),o},l.prototype.readInt8=function(e,t){return e>>>=0,t||x(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},l.prototype.readInt16LE=function(e,t){e>>>=0,t||x(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},l.prototype.readInt16BE=function(e,t){e>>>=0,t||x(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},l.prototype.readInt32LE=function(e,t){return e>>>=0,t||x(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},l.prototype.readInt32BE=function(e,t){return e>>>=0,t||x(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},l.prototype.readFloatLE=function(e,t){return e>>>=0,t||x(e,4,this.length),i.read(this,e,!0,23,4)},l.prototype.readFloatBE=function(e,t){return e>>>=0,t||x(e,4,this.length),i.read(this,e,!1,23,4)},l.prototype.readDoubleLE=function(e,t){return e>>>=0,t||x(e,8,this.length),i.read(this,e,!0,52,8)},l.prototype.readDoubleBE=function(e,t){return e>>>=0,t||x(e,8,this.length),i.read(this,e,!1,52,8)},l.prototype.writeUintLE=l.prototype.writeUIntLE=function(e,t,n,r){if(e=+e,t>>>=0,n>>>=0,!r){var i=Math.pow(2,8*n)-1;K(this,e,t,n,i,0)}var o=1,s=0;this[t]=255&e;while(++s<n&&(o*=256))this[t+s]=e/o&255;return t+n},l.prototype.writeUintBE=l.prototype.writeUIntBE=function(e,t,n,r){if(e=+e,t>>>=0,n>>>=0,!r){var i=Math.pow(2,8*n)-1;K(this,e,t,n,i,0)}var o=n-1,s=1;this[t+o]=255&e;while(--o>=0&&(s*=256))this[t+o]=e/s&255;return t+n},l.prototype.writeUint8=l.prototype.writeUInt8=function(e,t,n){return e=+e,t>>>=0,n||K(this,e,t,1,255,0),this[t]=255&e,t+1},l.prototype.writeUint16LE=l.prototype.writeUInt16LE=function(e,t,n){return e=+e,t>>>=0,n||K(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},l.prototype.writeUint16BE=l.prototype.writeUInt16BE=function(e,t,n){return e=+e,t>>>=0,n||K(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},l.prototype.writeUint32LE=l.prototype.writeUInt32LE=function(e,t,n){return e=+e,t>>>=0,n||K(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},l.prototype.writeUint32BE=l.prototype.writeUInt32BE=function(e,t,n){return e=+e,t>>>=0,n||K(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},l.prototype.writeIntLE=function(e,t,n,r){if(e=+e,t>>>=0,!r){var i=Math.pow(2,8*n-1);K(this,e,t,n,i-1,-i)}var o=0,s=1,a=0;this[t]=255&e;while(++o<n&&(s*=256))e<0&&0===a&&0!==this[t+o-1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+n},l.prototype.writeIntBE=function(e,t,n,r){if(e=+e,t>>>=0,!r){var i=Math.pow(2,8*n-1);K(this,e,t,n,i-1,-i)}var o=n-1,s=1,a=0;this[t+o]=255&e;while(--o>=0&&(s*=256))e<0&&0===a&&0!==this[t+o+1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+n},l.prototype.writeInt8=function(e,t,n){return e=+e,t>>>=0,n||K(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},l.prototype.writeInt16LE=function(e,t,n){return e=+e,t>>>=0,n||K(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},l.prototype.writeInt16BE=function(e,t,n){return e=+e,t>>>=0,n||K(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},l.prototype.writeInt32LE=function(e,t,n){return e=+e,t>>>=0,n||K(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},l.prototype.writeInt32BE=function(e,t,n){return e=+e,t>>>=0,n||K(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},l.prototype.writeFloatLE=function(e,t,n){return q(this,e,t,!0,n)},l.prototype.writeFloatBE=function(e,t,n){return q(this,e,t,!1,n)},l.prototype.writeDoubleLE=function(e,t,n){return $(this,e,t,!0,n)},l.prototype.writeDoubleBE=function(e,t,n){return $(this,e,t,!1,n)},l.prototype.copy=function(e,t,n,r){if(!l.isBuffer(e))throw new TypeError("argument should be a Buffer");if(n||(n=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-n&&(r=e.length-t+n);var i=r-n;return this===e&&"function"===typeof Uint8Array.prototype.copyWithin?this.copyWithin(t,n,r):Uint8Array.prototype.set.call(e,this.subarray(n,r),t),i},l.prototype.fill=function(e,t,n,r){if("string"===typeof e){if("string"===typeof t?(r=t,t=0,n=this.length):"string"===typeof n&&(r=n,n=this.length),void 0!==r&&"string"!==typeof r)throw new TypeError("encoding must be a string");if("string"===typeof r&&!l.isEncoding(r))throw new TypeError("Unknown encoding: "+r);if(1===e.length){var i=e.charCodeAt(0);("utf8"===r&&i<128||"latin1"===r)&&(e=i)}}else"number"===typeof e?e&=255:"boolean"===typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var o;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"===typeof e)for(o=t;o<n;++o)this[o]=e;else{var s=l.isBuffer(e)?e:l.from(e,r),a=s.length;if(0===a)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(o=0;o<n-t;++o)this[o+t]=s[o%a]}return this};var V=/[^+/0-9A-Za-z-_]/g;function G(e){if(e=e.split("=")[0],e=e.trim().replace(V,""),e.length<2)return"";while(e.length%4!==0)e+="=";return e}function W(e,t){var n;t=t||1/0;for(var r=e.length,i=null,o=[],s=0;s<r;++s){if(n=e.charCodeAt(s),n>55295&&n<57344){if(!i){if(n>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(s+1===r){(t-=3)>-1&&o.push(239,191,189);continue}i=n;continue}if(n<56320){(t-=3)>-1&&o.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(t-=3)>-1&&o.push(239,191,189);if(i=null,n<128){if((t-=1)<0)break;o.push(n)}else if(n<2048){if((t-=2)<0)break;o.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;o.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return o}function H(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}function Y(e,t){for(var n,r,i,o=[],s=0;s<e.length;++s){if((t-=2)<0)break;n=e.charCodeAt(s),r=n>>8,i=n%256,o.push(i),o.push(r)}return o}function J(e){return r.toByteArray(G(e))}function z(e,t,n,r){for(var i=0;i<r;++i){if(i+n>=t.length||i>=e.length)break;t[i+n]=e[i]}return i}function Q(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function X(e){return e!==e}var Z=function(){for(var e="0123456789abcdef",t=new Array(256),n=0;n<16;++n)for(var r=16*n,i=0;i<16;++i)t[r+i]=e[n]+e[i];return t}()},5477:function(e,t,n){"use strict";var r=n(8692),i=n(1542),o=i(r("String.prototype.indexOf"));e.exports=function(e,t){var n=r(e,!!t);return"function"===typeof n&&o(e,".prototype.")>-1?i(n):n}},1542:function(e,t,n){"use strict";var r=n(9148),i=n(8692),o=i("%Function.prototype.apply%"),s=i("%Function.prototype.call%"),a=i("%Reflect.apply%",!0)||r.call(s,o),c=i("%Object.getOwnPropertyDescriptor%",!0),l=i("%Object.defineProperty%",!0),d=i("%Math.max%");if(l)try{l({},"a",{value:1})}catch(h){l=null}e.exports=function(e){var t=a(r,s,arguments);if(c&&l){var n=c(t,"length");n.configurable&&l(t,"length",{value:1+d(0,e.length-(arguments.length-1))})}return t};var u=function(){return a(r,o,arguments)};l?l(e.exports,"apply",{value:u}):e.exports.apply=u},192:function(e,t,n){"use strict";
/*!
 * content-type
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */n(1703);var r=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,i=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,o=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,s=/\\([\u000b\u0020-\u00ff])/g,a=/([\\"])/g,c=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;function l(e){if(!e||"object"!==typeof e)throw new TypeError("argument obj is required");var t=e.parameters,n=e.type;if(!n||!c.test(n))throw new TypeError("invalid type");var r=n;if(t&&"object"===typeof t)for(var i,s=Object.keys(t).sort(),a=0;a<s.length;a++){if(i=s[a],!o.test(i))throw new TypeError("invalid parameter name");r+="; "+i+"="+h(t[i])}return r}function d(e){if(!e)throw new TypeError("argument string is required");var t="object"===typeof e?u(e):e;if("string"!==typeof t)throw new TypeError("argument string is required to be a string");var n=t.indexOf(";"),i=-1!==n?t.substr(0,n).trim():t.trim();if(!c.test(i))throw new TypeError("invalid media type");var o=new g(i.toLowerCase());if(-1!==n){var a,l,d;r.lastIndex=n;while(l=r.exec(t)){if(l.index!==n)throw new TypeError("invalid parameter format");n+=l[0].length,a=l[1].toLowerCase(),d=l[2],'"'===d[0]&&(d=d.substr(1,d.length-2).replace(s,"$1")),o.parameters[a]=d}if(n!==t.length)throw new TypeError("invalid parameter format")}return o}function u(e){var t;if("function"===typeof e.getHeader?t=e.getHeader("content-type"):"object"===typeof e.headers&&(t=e.headers&&e.headers["content-type"]),"string"!==typeof t)throw new TypeError("content-type header is missing from object");return t}function h(e){var t=String(e);if(o.test(t))return t;if(t.length>0&&!i.test(t))throw new TypeError("invalid parameter value");return'"'+t.replace(a,"\\$1")+'"'}function g(e){this.parameters=Object.create(null),this.type=e}t.format=l,t.parse=d},3793:function(e,t,n){"use strict";n(1703);var r,i="object"===typeof Reflect?Reflect:null,o=i&&"function"===typeof i.apply?i.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};function s(e){console&&console.warn&&console.warn(e)}r=i&&"function"===typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var a=Number.isNaN||function(e){return e!==e};function c(){c.init.call(this)}e.exports=c,e.exports.once=S,c.EventEmitter=c,c.prototype._events=void 0,c.prototype._eventsCount=0,c.prototype._maxListeners=void 0;var l=10;function d(e){if("function"!==typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function u(e){return void 0===e._maxListeners?c.defaultMaxListeners:e._maxListeners}function h(e,t,n,r){var i,o,a;if(d(n),o=e._events,void 0===o?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),a=o[t]),void 0===a)a=o[t]=n,++e._eventsCount;else if("function"===typeof a?a=o[t]=r?[n,a]:[a,n]:r?a.unshift(n):a.push(n),i=u(e),i>0&&a.length>i&&!a.warned){a.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=a.length,s(c)}return e}function g(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=g.bind(r);return i.listener=n,r.wrapFn=i,i}function f(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"===typeof i?n?[i.listener||i]:[i]:n?E(i):m(i,i.length)}function y(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"===typeof n)return 1;if(void 0!==n)return n.length}return 0}function m(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function v(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function E(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}function S(e,t){return new Promise((function(n,r){function i(n){e.removeListener(t,o),r(n)}function o(){"function"===typeof e.removeListener&&e.removeListener("error",i),n([].slice.call(arguments))}w(e,t,o,{once:!0}),"error"!==t&&b(e,i,{once:!0})}))}function b(e,t,n){"function"===typeof e.on&&w(e,"error",t,n)}function w(e,t,n,r){if("function"===typeof e.on)r.once?e.once(t,n):e.on(t,n);else{if("function"!==typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function i(o){r.once&&e.removeEventListener(t,i),n(o)}))}}Object.defineProperty(c,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(e){if("number"!==typeof e||e<0||a(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");l=e}}),c.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},c.prototype.setMaxListeners=function(e){if("number"!==typeof e||e<0||a(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},c.prototype.getMaxListeners=function(){return u(this)},c.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,i=this._events;if(void 0!==i)r=r&&void 0===i.error;else if(!r)return!1;if(r){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var c=i[e];if(void 0===c)return!1;if("function"===typeof c)o(c,this,t);else{var l=c.length,d=m(c,l);for(n=0;n<l;++n)o(d[n],this,t)}return!0},c.prototype.addListener=function(e,t){return h(this,e,t,!1)},c.prototype.on=c.prototype.addListener,c.prototype.prependListener=function(e,t){return h(this,e,t,!0)},c.prototype.once=function(e,t){return d(t),this.on(e,p(this,e,t)),this},c.prototype.prependOnceListener=function(e,t){return d(t),this.prependListener(e,p(this,e,t)),this},c.prototype.removeListener=function(e,t){var n,r,i,o,s;if(d(t),r=this._events,void 0===r)return this;if(n=r[e],void 0===n)return this;if(n===t||n.listener===t)0===--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!==typeof n){for(i=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){s=n[o].listener,i=o;break}if(i<0)return this;0===i?n.shift():v(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,s||t)}return this},c.prototype.off=c.prototype.removeListener,c.prototype.removeAllListeners=function(e){var t,n,r;if(n=this._events,void 0===n)return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0===--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,o=Object.keys(n);for(r=0;r<o.length;++r)i=o[r],"removeListener"!==i&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],"function"===typeof t)this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},c.prototype.listeners=function(e){return f(this,e,!0)},c.prototype.rawListeners=function(e){return f(this,e,!1)},c.listenerCount=function(e,t){return"function"===typeof e.listenerCount?e.listenerCount(t):y.call(e,t)},c.prototype.listenerCount=y,c.prototype.eventNames=function(){return this._eventsCount>0?r(this._events):[]}},5847:function(e,t,n){"use strict";n(1703);var r="Function.prototype.bind called on incompatible ",i=Array.prototype.slice,o=Object.prototype.toString,s="[object Function]";e.exports=function(e){var t=this;if("function"!==typeof t||o.call(t)!==s)throw new TypeError(r+t);for(var n,a=i.call(arguments,1),c=function(){if(this instanceof n){var r=t.apply(this,a.concat(i.call(arguments)));return Object(r)===r?r:this}return t.apply(e,a.concat(i.call(arguments)))},l=Math.max(0,t.length-a.length),d=[],u=0;u<l;u++)d.push("$"+u);if(n=Function("binder","return function ("+d.join(",")+"){ return binder.apply(this,arguments); }")(c),t.prototype){var h=function(){};h.prototype=t.prototype,n.prototype=new h,h.prototype=null}return n}},9148:function(e,t,n){"use strict";var r=n(5847);e.exports=Function.prototype.bind||r},8692:function(e,t,n){"use strict";var r;n(1703),n(8675),n(3462),n(7380),n(1118),n(2120);var i=SyntaxError,o=Function,s=TypeError,a=function(e){try{return o('"use strict"; return ('+e+").constructor;")()}catch(t){}},c=Object.getOwnPropertyDescriptor;if(c)try{c({},"")}catch(C){c=null}var l=function(){throw new s},d=c?function(){try{return l}catch(e){try{return c(arguments,"callee").get}catch(t){return l}}}():l,u=n(2763)(),h=Object.getPrototypeOf||function(e){return e.__proto__},g={},p="undefined"===typeof Uint8Array?r:h(Uint8Array),f={"%AggregateError%":"undefined"===typeof AggregateError?r:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"===typeof ArrayBuffer?r:ArrayBuffer,"%ArrayIteratorPrototype%":u?h([][Symbol.iterator]()):r,"%AsyncFromSyncIteratorPrototype%":r,"%AsyncFunction%":g,"%AsyncGenerator%":g,"%AsyncGeneratorFunction%":g,"%AsyncIteratorPrototype%":g,"%Atomics%":"undefined"===typeof Atomics?r:Atomics,"%BigInt%":"undefined"===typeof BigInt?r:BigInt,"%Boolean%":Boolean,"%DataView%":"undefined"===typeof DataView?r:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":Error,"%eval%":eval,"%EvalError%":EvalError,"%Float32Array%":"undefined"===typeof Float32Array?r:Float32Array,"%Float64Array%":"undefined"===typeof Float64Array?r:Float64Array,"%FinalizationRegistry%":"undefined"===typeof FinalizationRegistry?r:FinalizationRegistry,"%Function%":o,"%GeneratorFunction%":g,"%Int8Array%":"undefined"===typeof Int8Array?r:Int8Array,"%Int16Array%":"undefined"===typeof Int16Array?r:Int16Array,"%Int32Array%":"undefined"===typeof Int32Array?r:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":u?h(h([][Symbol.iterator]())):r,"%JSON%":"object"===typeof JSON?JSON:r,"%Map%":"undefined"===typeof Map?r:Map,"%MapIteratorPrototype%":"undefined"!==typeof Map&&u?h((new Map)[Symbol.iterator]()):r,"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"===typeof Promise?r:Promise,"%Proxy%":"undefined"===typeof Proxy?r:Proxy,"%RangeError%":RangeError,"%ReferenceError%":ReferenceError,"%Reflect%":"undefined"===typeof Reflect?r:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"===typeof Set?r:Set,"%SetIteratorPrototype%":"undefined"!==typeof Set&&u?h((new Set)[Symbol.iterator]()):r,"%SharedArrayBuffer%":"undefined"===typeof SharedArrayBuffer?r:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":u?h(""[Symbol.iterator]()):r,"%Symbol%":u?Symbol:r,"%SyntaxError%":i,"%ThrowTypeError%":d,"%TypedArray%":p,"%TypeError%":s,"%Uint8Array%":"undefined"===typeof Uint8Array?r:Uint8Array,"%Uint8ClampedArray%":"undefined"===typeof Uint8ClampedArray?r:Uint8ClampedArray,"%Uint16Array%":"undefined"===typeof Uint16Array?r:Uint16Array,"%Uint32Array%":"undefined"===typeof Uint32Array?r:Uint32Array,"%URIError%":URIError,"%WeakMap%":"undefined"===typeof WeakMap?r:WeakMap,"%WeakRef%":"undefined"===typeof WeakRef?r:WeakRef,"%WeakSet%":"undefined"===typeof WeakSet?r:WeakSet},y=function e(t){var n;if("%AsyncFunction%"===t)n=a("async function () {}");else if("%GeneratorFunction%"===t)n=a("function* () {}");else if("%AsyncGeneratorFunction%"===t)n=a("async function* () {}");else if("%AsyncGenerator%"===t){var r=e("%AsyncGeneratorFunction%");r&&(n=r.prototype)}else if("%AsyncIteratorPrototype%"===t){var i=e("%AsyncGenerator%");i&&(n=h(i.prototype))}return f[t]=n,n},m={"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},v=n(9148),E=n(5769),S=v.call(Function.call,Array.prototype.concat),b=v.call(Function.apply,Array.prototype.splice),w=v.call(Function.call,String.prototype.replace),_=v.call(Function.call,String.prototype.slice),T=v.call(Function.call,RegExp.prototype.exec),I=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,R=/\\(\\)?/g,k=function(e){var t=_(e,0,1),n=_(e,-1);if("%"===t&&"%"!==n)throw new i("invalid intrinsic syntax, expected closing `%`");if("%"===n&&"%"!==t)throw new i("invalid intrinsic syntax, expected opening `%`");var r=[];return w(e,I,(function(e,t,n,i){r[r.length]=n?w(i,R,"$1"):t||e})),r},O=function(e,t){var n,r=e;if(E(m,r)&&(n=m[r],r="%"+n[0]+"%"),E(f,r)){var o=f[r];if(o===g&&(o=y(r)),"undefined"===typeof o&&!t)throw new s("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:n,name:r,value:o}}throw new i("intrinsic "+e+" does not exist!")};e.exports=function(e,t){if("string"!==typeof e||0===e.length)throw new s("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!==typeof t)throw new s('"allowMissing" argument must be a boolean');if(null===T(/^%?[^%]*%?$/g,e))throw new i("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var n=k(e),r=n.length>0?n[0]:"",o=O("%"+r+"%",t),a=o.name,l=o.value,d=!1,u=o.alias;u&&(r=u[0],b(n,S([0,1],u)));for(var h=1,g=!0;h<n.length;h+=1){var p=n[h],y=_(p,0,1),m=_(p,-1);if(('"'===y||"'"===y||"`"===y||'"'===m||"'"===m||"`"===m)&&y!==m)throw new i("property names with quotes must have matching quotes");if("constructor"!==p&&g||(d=!0),r+="."+p,a="%"+r+"%",E(f,a))l=f[a];else if(null!=l){if(!(p in l)){if(!t)throw new s("base intrinsic for "+e+" exists, but the property is not available.");return}if(c&&h+1>=n.length){var v=c(l,p);g=!!v,l=g&&"get"in v&&!("originalValue"in v.get)?v.get:l[p]}else g=E(l,p),l=l[p];g&&!d&&(f[a]=l)}}return l}},2763:function(e,t,n){"use strict";var r="undefined"!==typeof Symbol&&Symbol,i=n(3994);e.exports=function(){return"function"===typeof r&&("function"===typeof Symbol&&("symbol"===typeof r("foo")&&("symbol"===typeof Symbol("bar")&&i())))}},3994:function(e){"use strict";e.exports=function(){if("function"!==typeof Symbol||"function"!==typeof Object.getOwnPropertySymbols)return!1;if("symbol"===typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),n=Object(t);if("string"===typeof t)return!1;if("[object Symbol]"!==Object.prototype.toString.call(t))return!1;if("[object Symbol]"!==Object.prototype.toString.call(n))return!1;var r=42;for(t in e[t]=r,e)return!1;if("function"===typeof Object.keys&&0!==Object.keys(e).length)return!1;if("function"===typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var i=Object.getOwnPropertySymbols(e);if(1!==i.length||i[0]!==t)return!1;if(!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"===typeof Object.getOwnPropertyDescriptor){var o=Object.getOwnPropertyDescriptor(e,t);if(o.value!==r||!0!==o.enumerable)return!1}return!0}},5769:function(e,t,n){"use strict";var r=n(9148);e.exports=r.call(Function.call,Object.prototype.hasOwnProperty)},7055:function(e,t){
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
t.read=function(e,t,n,r,i){var o,s,a=8*i-r-1,c=(1<<a)-1,l=c>>1,d=-7,u=n?i-1:0,h=n?-1:1,g=e[t+u];for(u+=h,o=g&(1<<-d)-1,g>>=-d,d+=a;d>0;o=256*o+e[t+u],u+=h,d-=8);for(s=o&(1<<-d)-1,o>>=-d,d+=r;d>0;s=256*s+e[t+u],u+=h,d-=8);if(0===o)o=1-l;else{if(o===c)return s?NaN:1/0*(g?-1:1);s+=Math.pow(2,r),o-=l}return(g?-1:1)*s*Math.pow(2,o-r)},t.write=function(e,t,n,r,i,o){var s,a,c,l=8*o-i-1,d=(1<<l)-1,u=d>>1,h=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,g=r?0:o-1,p=r?1:-1,f=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=d):(s=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-s))<1&&(s--,c*=2),t+=s+u>=1?h/c:h*Math.pow(2,1-u),t*c>=2&&(s++,c/=2),s+u>=d?(a=0,s=d):s+u>=1?(a=(t*c-1)*Math.pow(2,i),s+=u):(a=t*Math.pow(2,u-1)*Math.pow(2,i),s=0));i>=8;e[n+g]=255&a,g+=p,a/=256,i-=8);for(s=s<<i|a,l+=i;l>0;e[n+g]=255&s,g+=p,s/=256,l-=8);e[n+g-p]|=128*f}},9245:function(e,t,n){var r,i;n(1703),function(o,s){"use strict";r=s,i="function"===typeof r?r.call(t,n,t,e):r,void 0===i||(e.exports=i)}(0,(function(){"use strict";var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"];function i(e,t){var n=e[t];if("function"===typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(r){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function o(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function s(r){return"debug"===r&&(r="log"),typeof console!==t&&("trace"===r&&n?o:void 0!==console[r]?i(console,r):void 0!==console.log?i(console,"log"):e)}function a(t,n){for(var i=0;i<r.length;i++){var o=r[i];this[o]=i<t?e:this.methodFactory(o,t,n)}this.log=this.debug}function c(e,n,r){return function(){typeof console!==t&&(a.call(this,n,r),this[e].apply(this,arguments))}}function l(e,t,n){return s(e)||c.apply(this,arguments)}function d(e,n,i){var o,s=this;n=null==n?"WARN":n;var c="loglevel";function d(e){var n=(r[e]||"silent").toUpperCase();if(typeof window!==t&&c){try{return void(window.localStorage[c]=n)}catch(i){}try{window.document.cookie=encodeURIComponent(c)+"="+n+";"}catch(i){}}}function u(){var e;if(typeof window!==t&&c){try{e=window.localStorage[c]}catch(i){}if(typeof e===t)try{var n=window.document.cookie,r=n.indexOf(encodeURIComponent(c)+"=");-1!==r&&(e=/^([^;]+)/.exec(n.slice(r))[1])}catch(i){}return void 0===s.levels[e]&&(e=void 0),e}}function h(){if(typeof window!==t&&c){try{return void window.localStorage.removeItem(c)}catch(e){}try{window.document.cookie=encodeURIComponent(c)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}"string"===typeof e?c+=":"+e:"symbol"===typeof e&&(c=void 0),s.name=e,s.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},s.methodFactory=i||l,s.getLevel=function(){return o},s.setLevel=function(n,r){if("string"===typeof n&&void 0!==s.levels[n.toUpperCase()]&&(n=s.levels[n.toUpperCase()]),!("number"===typeof n&&n>=0&&n<=s.levels.SILENT))throw"log.setLevel() called with invalid level: "+n;if(o=n,!1!==r&&d(n),a.call(s,n,e),typeof console===t&&n<s.levels.SILENT)return"No console available for logging"},s.setDefaultLevel=function(e){n=e,u()||s.setLevel(e,!1)},s.resetLevel=function(){s.setLevel(n,!1),h()},s.enableAll=function(e){s.setLevel(s.levels.TRACE,e)},s.disableAll=function(e){s.setLevel(s.levels.SILENT,e)};var g=u();null==g&&(g=n),s.setLevel(g,!1)}var u=new d,h={};u.getLogger=function(e){if("symbol"!==typeof e&&"string"!==typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=h[e];return t||(t=h[e]=new d(e,u.getLevel(),u.methodFactory)),t};var g=typeof window!==t?window.log:void 0;return u.noConflict=function(){return typeof window!==t&&window.log===u&&(window.log=g),u},u.getLoggers=function(){return h},u["default"]=u,u}))},5221:function(e,t,n){"use strict";n(1703),Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensibleEvents=void 0;var r=n(7793),i=n(5700),o=n(4564),s=n(7692),a=n(4142),c=n(6588),l=n(3249);function d(e,t){var n="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=u(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==n["return"]||n["return"]()}finally{if(a)throw o}}}}function u(e,t){if(e){if("string"===typeof e)return h(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?h(e,t):void 0}}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function g(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function p(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e,t,n){return t&&p(e.prototype,t),n&&p(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var m=function(){function e(){g(this,e),y(this,"interpreters",new r.NamespacedMap([[o.LEGACY_M_ROOM_MESSAGE,o.parseMRoomMessage],[a.M_MESSAGE,s.parseMMessage],[a.M_EMOTE,s.parseMMessage],[a.M_NOTICE,s.parseMMessage],[c.M_POLL_START,l.parseMPoll],[c.M_POLL_RESPONSE,l.parseMPoll],[c.M_POLL_END,l.parseMPoll]])),y(this,"_unknownInterpretOrder",[a.M_MESSAGE])}return f(e,[{key:"unknownInterpretOrder",get:function(){var e;return null!==(e=this._unknownInterpretOrder)&&void 0!==e?e:[]},set:function(e){this._unknownInterpretOrder=e}},{key:"registerInterpreter",value:function(e,t){this.interpreters.set(e,t)}},{key:"parse",value:function(e){try{if(this.interpreters.hasNamespaced(e.type))return this.interpreters.getNamespaced(e.type)(e);var t,n=d(this.unknownInterpretOrder);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(this.interpreters.has(r)){var o=this.interpreters.get(r)(e);if(o)return o}}}catch(s){n.e(s)}finally{n.f()}return null}catch(a){if(a instanceof i.InvalidEventError)return null;throw a}}}],[{key:"defaultInstance",get:function(){return e._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return e.defaultInstance.unknownInterpretOrder},set:function(t){e.defaultInstance.unknownInterpretOrder=t}},{key:"registerInterpreter",value:function(t,n){e.defaultInstance.registerInterpreter(t,n)}},{key:"parse",value:function(t){return e.defaultInstance.parse(t)}}]),e}();t.ExtensibleEvents=m,y(m,"_defaultInstance",new m)},3034:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},5700:function(e,t,n){"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&f(e,t)}function c(e){var t=g();return function(){var n,r=y(e);if(t){var i=y(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return l(this,n)}}function l(e,t){if(t&&("object"===r(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return d(e)}function d(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function u(e){var t="function"===typeof Map?new Map:void 0;return u=function(e){if(null===e||!p(e))return e;if("function"!==typeof e)throw new TypeError("Super expression must either be null or a function");if("undefined"!==typeof t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return h(e,arguments,y(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),f(n,e)},u(e)}function h(e,t,n){return h=g()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=Function.bind.apply(e,r),o=new i;return n&&f(o,n.prototype),o},h.apply(null,arguments)}function g(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function p(e){return-1!==Function.toString.call(e).indexOf("[native code]")}function f(e,t){return f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},f(e,t)}function y(e){return y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},y(e)}n(1703),Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidEventError=void 0;var m=function(e){a(n,e);var t=c(n);function n(e){return s(this,n),t.call(this,e)}return o(n)}(u(Error));t.InvalidEventError=m},7793:function(e,t,n){"use strict";function r(e,t){var n="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=i(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){c=!0,s=e},f:function(){try{a||null==n["return"]||n["return"]()}finally{if(c)throw s}}}}function i(e,t){if(e){if("string"===typeof e)return o(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?o(e,t):void 0}}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n(1703),Object.defineProperty(t,"__esModule",{value:!0}),t.NamespacedMap=void 0;var d=function(){function e(t){if(s(this,e),l(this,"internalMap",new Map),t){var n,i=r(t);try{for(i.s();!(n=i.n()).done;){var o=n.value;this.set(o[0],o[1])}}catch(a){i.e(a)}finally{i.f()}}}return c(e,[{key:"get",value:function(e){return e.name&&this.internalMap.has(e.name)?this.internalMap.get(e.name):e.altName&&this.internalMap.has(e.altName)?this.internalMap.get(e.altName):null}},{key:"set",value:function(e,t){e.name&&this.internalMap.set(e.name,t),e.altName&&this.internalMap.set(e.altName,t)}},{key:"has",value:function(e){return!!this.get(e)}},{key:"delete",value:function(e){e.name&&this.internalMap["delete"](e.name),e.altName&&this.internalMap["delete"](e.altName)}},{key:"hasNamespaced",value:function(e){return this.internalMap.has(e)}},{key:"getNamespaced",value:function(e){return this.internalMap.get(e)}}]),e}();t.NamespacedMap=d},9686:function(e,t,n){"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function i(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&o(e,t)}function o(e,t){return o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},o(e,t)}function s(e){var t=l();return function(){var n,r=d(e);if(t){var i=d(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return a(this,n)}}function a(e,t){if(t&&("object"===r(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return c(e)}function c(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function l(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function d(e){return d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},d(e)}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function g(e,t,n){return t&&h(e.prototype,t),n&&h(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}n(1703),n(6699),Object.defineProperty(t,"__esModule",{value:!0}),t.UnstableValue=t.NamespacedValue=void 0;var p=function(){function e(t,n){if(u(this,e),this.stable=t,this.unstable=n,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return g(e,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(e){return!!this.name&&this.name===e||!!this.altName&&this.altName===e}},{key:"findIn",value:function(e){var t;return this.name&&(t=null===e||void 0===e?void 0:e[this.name]),!t&&this.altName&&(t=null===e||void 0===e?void 0:e[this.altName]),t}},{key:"includedIn",value:function(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}]),e}();t.NamespacedValue=p;var f=function(e){i(n,e);var t=s(n);function n(e,r){var i;if(u(this,n),i=t.call(this,e,r),!i.unstable)throw new Error("Unstable value must be supplied");return i}return g(n,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),n}(p);t.UnstableValue=f},2982:function(e,t,n){"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}n(1703),Object.defineProperty(t,"__esModule",{value:!0}),t.EmoteEvent=void 0;var i=n(7801),o=n(4142),s=n(278);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function d(e,t,n){return t&&l(e.prototype,t),n&&l(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function u(){return u="undefined"!==typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=h(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}},u.apply(this,arguments)}function h(e,t){while(!Object.prototype.hasOwnProperty.call(e,t))if(e=E(e),null===e)break;return e}function g(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&p(e,t)}function p(e,t){return p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},p(e,t)}function f(e){var t=v();return function(){var n,r=E(e);if(t){var i=E(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return y(this,n)}}function y(e,t){if(t&&("object"===r(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return m(e)}function m(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function v(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function E(e){return E=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},E(e)}var S=function(e){g(n,e);var t=f(n);function n(e){return c(this,n),t.call(this,e)}return d(n,[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,s.isEventTypeSame)(e,o.M_EMOTE)||u(E(n.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=u(E(n.prototype),"serialize",this).call(this);return e.content["msgtype"]="m.emote",e}}],[{key:"from",value:function(e,t){var r;return new n({type:o.M_EMOTE.name,content:(r={},a(r,o.M_TEXT.name,e),a(r,o.M_HTML.name,t),r)})}}]),n}(i.MessageEvent);t.EmoteEvent=S},6473:function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}n(1703),Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensibleEvent=void 0;var s=function(){function e(t){r(this,e),this.wireFormat=t}return o(e,[{key:"wireContent",get:function(){return this.wireFormat.content}}]),e}();t.ExtensibleEvent=s},7801:function(e,t,n){"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}n(1703),Object.defineProperty(t,"__esModule",{value:!0}),t.MessageEvent=void 0;var i=n(6473),o=n(7167),s=n(5700),a=n(4142),c=n(278);function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){b(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function g(e,t,n){return t&&h(e.prototype,t),n&&h(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function p(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&f(e,t)}function f(e,t){return f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},f(e,t)}function y(e){var t=E();return function(){var n,r=S(e);if(t){var i=S(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return m(this,n)}}function m(e,t){if(t&&("object"===r(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return v(e)}function v(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function E(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function S(e){return S=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},S(e)}function b(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var w=function(e){p(n,e);var t=y(n);function n(e){var r;u(this,n),r=t.call(this,e),b(v(r),"text",void 0),b(v(r),"html",void 0),b(v(r),"renderings",void 0);var i=a.M_MESSAGE.findIn(r.wireContent),c=a.M_TEXT.findIn(r.wireContent),l=a.M_HTML.findIn(r.wireContent);if((0,o.isProvided)(i)){if(!Array.isArray(i))throw new s.InvalidEventError("m.message contents must be an array");var d=i.find((function(e){return!(0,o.isProvided)(e.mimetype)||"text/plain"===e.mimetype})),h=i.find((function(e){return"text/html"===e.mimetype}));if(!d)throw new s.InvalidEventError("m.message is missing a plain text representation");r.text=d.body,r.html=null===h||void 0===h?void 0:h.body,r.renderings=i}else{if(!(0,o.isOptionalAString)(c))throw new s.InvalidEventError("Missing textual representation for event");r.text=c,r.html=l,r.renderings=[{body:c,mimetype:"text/plain"}],r.html&&r.renderings.push({body:r.html,mimetype:"text/html"})}return r}return g(n,[{key:"isEmote",get:function(){return a.M_EMOTE.matches(this.wireFormat.type)||(0,o.isProvided)(a.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return a.M_NOTICE.matches(this.wireFormat.type)||(0,o.isProvided)(a.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(e){return(0,c.isEventTypeSame)(e,a.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var e=b({},a.M_MESSAGE.name,this.renderings);if(1===this.renderings.length){var t=this.renderings[0].mimetype;void 0!==t&&"text/plain"!==t||(e=b({},a.M_TEXT.name,this.renderings[0].body))}return e}},{key:"serialize",value:function(){var e;return{type:"m.room.message",content:d(d({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:null!==(e=this.html)&&void 0!==e?e:void 0})}}}],[{key:"from",value:function(e,t){var r;return new n({type:a.M_MESSAGE.name,content:(r={},b(r,a.M_TEXT.name,e),b(r,a.M_HTML.name,t),r)})}}]),n}(i.ExtensibleEvent);t.MessageEvent=w},2828:function(e,t,n){"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}n(1703),Object.defineProperty(t,"__esModule",{value:!0}),t.NoticeEvent=void 0;var i=n(7801),o=n(4142),s=n(278);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function d(e,t,n){return t&&l(e.prototype,t),n&&l(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function u(){return u="undefined"!==typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=h(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}},u.apply(this,arguments)}function h(e,t){while(!Object.prototype.hasOwnProperty.call(e,t))if(e=E(e),null===e)break;return e}function g(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&p(e,t)}function p(e,t){return p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},p(e,t)}function f(e){var t=v();return function(){var n,r=E(e);if(t){var i=E(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return y(this,n)}}function y(e,t){if(t&&("object"===r(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return m(e)}function m(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function v(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function E(e){return E=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},E(e)}var S=function(e){g(n,e);var t=f(n);function n(e){return c(this,n),t.call(this,e)}return d(n,[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,s.isEventTypeSame)(e,o.M_NOTICE)||u(E(n.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=u(E(n.prototype),"serialize",this).call(this);return e.content["msgtype"]="m.notice",e}}],[{key:"from",value:function(e,t){var r;return new n({type:o.M_NOTICE.name,content:(r={},a(r,o.M_TEXT.name,e),a(r,o.M_HTML.name,t),r)})}}]),n}(i.MessageEvent);t.NoticeEvent=S},2467:function(e,t,n){"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}n(1703),Object.defineProperty(t,"__esModule",{value:!0}),t.PollEndEvent=void 0;var i=n(6588),o=n(5700),s=n(4780),a=n(7801),c=n(4142),l=n(278),d=n(6473);function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach((function(t){_(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function g(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function p(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e,t,n){return t&&p(e.prototype,t),n&&p(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function y(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&m(e,t)}function m(e,t){return m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},m(e,t)}function v(e){var t=b();return function(){var n,r=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return E(this,n)}}function E(e,t){if(t&&("object"===r(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return S(e)}function S(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function b(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function w(e){return w=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},w(e)}function _(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var T=function(e){y(n,e);var t=v(n);function n(e){var r;g(this,n),r=t.call(this,e),_(S(r),"pollEventId",void 0),_(S(r),"closingMessage",void 0);var i=r.wireContent["m.relates_to"];if(!s.REFERENCE_RELATION.matches(null===i||void 0===i?void 0:i.rel_type)||"string"!==typeof(null===i||void 0===i?void 0:i.event_id))throw new o.InvalidEventError("Relationship must be a reference to an event");return r.pollEventId=i.event_id,r.closingMessage=new a.MessageEvent(r.wireFormat),r}return f(n,[{key:"isEquivalentTo",value:function(e){return(0,l.isEventTypeSame)(e,i.M_POLL_END)}},{key:"serialize",value:function(){return{type:i.M_POLL_END.name,content:h(_({"m.relates_to":{rel_type:s.REFERENCE_RELATION.name,event_id:this.pollEventId}},i.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}],[{key:"from",value:function(e,t){var r;return new n({type:i.M_POLL_END.name,content:(r={"m.relates_to":{rel_type:s.REFERENCE_RELATION.name,event_id:e}},_(r,i.M_POLL_END.name,{}),_(r,c.M_TEXT.name,t),r)})}}]),n}(d.ExtensibleEvent);t.PollEndEvent=T},6093:function(e,t,n){"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}n(1703),Object.defineProperty(t,"__esModule",{value:!0}),t.PollResponseEvent=void 0;var i=n(6473),o=n(6588),s=n(5700),a=n(4780),c=n(278);function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t,n){return t&&d(e.prototype,t),n&&d(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function h(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&g(e,t)}function g(e,t){return g=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},g(e,t)}function p(e){var t=m();return function(){var n,r=v(e);if(t){var i=v(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return f(this,n)}}function f(e,t){if(t&&("object"===r(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return y(e)}function y(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function m(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function v(e){return v=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},v(e)}function E(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var S=function(e){h(n,e);var t=p(n);function n(e){var r;l(this,n),r=t.call(this,e),E(y(r),"internalAnswerIds",void 0),E(y(r),"internalSpoiled",void 0),E(y(r),"pollEventId",void 0);var i=r.wireContent["m.relates_to"];if(!a.REFERENCE_RELATION.matches(null===i||void 0===i?void 0:i.rel_type)||"string"!==typeof(null===i||void 0===i?void 0:i.event_id))throw new s.InvalidEventError("Relationship must be a reference to an event");return r.pollEventId=i.event_id,r.validateAgainst(null),r}return u(n,[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(e){var t=o.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(null===t||void 0===t?void 0:t.answers))return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);var n=t.answers;if(n.some((function(e){return"string"!==typeof e}))||0===n.length)return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);if(e){if(n.some((function(t){return!e.answers.some((function(e){return e.id===t}))})))return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);n=n.slice(0,e.maxSelections)}this.internalAnswerIds=n,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(e){return(0,c.isEventTypeSame)(e,o.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:o.M_POLL_RESPONSE.name,content:E({"m.relates_to":{rel_type:a.REFERENCE_RELATION.name,event_id:this.pollEventId}},o.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}],[{key:"from",value:function(e,t){return new n({type:o.M_POLL_RESPONSE.name,content:E({"m.relates_to":{rel_type:a.REFERENCE_RELATION.name,event_id:t}},o.M_POLL_RESPONSE.name,{answers:e})})}}]),n}(i.ExtensibleEvent);t.PollResponseEvent=S},9696:function(e,t,n){"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}n(1703),Object.defineProperty(t,"__esModule",{value:!0}),t.PollStartEvent=t.PollAnswerSubevent=void 0;var i=n(6588),o=n(7801),s=n(4142),a=n(5700),c=n(9686),l=n(278),d=n(6473);function u(e){return f(e)||p(e)||g(e)||h()}function h(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function g(e,t){if(e){if("string"===typeof e)return y(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?y(e,t):void 0}}function p(e){if("undefined"!==typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function f(e){if(Array.isArray(e))return y(e)}function y(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function m(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function v(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?m(Object(n),!0).forEach((function(t){C(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):m(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function E(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function S(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function b(e,t,n){return t&&S(e.prototype,t),n&&S(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function w(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_(e,t)}function _(e,t){return _=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},_(e,t)}function T(e){var t=k();return function(){var n,r=O(e);if(t){var i=O(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return I(this,n)}}function I(e,t){if(t&&("object"===r(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return R(e)}function R(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function k(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function O(e){return O=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},O(e)}function C(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var P=function(e){w(n,e);var t=T(n);function n(e){var r;E(this,n),r=t.call(this,e),C(R(r),"id",void 0);var i=e.content.id;if(!i||"string"!==typeof i)throw new a.InvalidEventError("Answer ID must be a non-empty string");return r.id=i,r}return b(n,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:v({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(e,t){return new n({type:"org.matrix.sdk.poll.answer",content:C({id:e},s.M_TEXT.name,t)})}}]),n}(o.MessageEvent);t.PollAnswerSubevent=P;var M=function(e){w(n,e);var t=T(n);function n(e){var r;E(this,n),r=t.call(this,e),C(R(r),"question",void 0),C(R(r),"kind",void 0),C(R(r),"rawKind",void 0),C(R(r),"maxSelections",void 0),C(R(r),"answers",void 0);var s=i.M_POLL_START.findIn(r.wireContent);if(!s.question)throw new a.InvalidEventError("A question is required");if(r.question=new o.MessageEvent({type:"org.matrix.sdk.poll.question",content:s.question}),r.rawKind=s.kind,i.M_POLL_KIND_DISCLOSED.matches(r.rawKind)?r.kind=i.M_POLL_KIND_DISCLOSED:r.kind=i.M_POLL_KIND_UNDISCLOSED,r.maxSelections=Number.isFinite(s.max_selections)&&s.max_selections>0?s.max_selections:1,!Array.isArray(s.answers))throw new a.InvalidEventError("Poll answers must be an array");var c=s.answers.slice(0,20).map((function(e){return new P({type:"org.matrix.sdk.poll.answer",content:e})}));if(c.length<=0)throw new a.InvalidEventError("No answers available");return r.answers=c,r}return b(n,[{key:"isEquivalentTo",value:function(e){return(0,l.isEventTypeSame)(e,i.M_POLL_START)}},{key:"serialize",value:function(){var e;return{type:i.M_POLL_START.name,content:(e={},C(e,i.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map((function(e){return e.serialize().content}))}),C(e,s.M_TEXT.name,"".concat(this.question.text,"\n").concat(this.answers.map((function(e,t){return"".concat(t+1,". ").concat(e.text)})).join("\n"))),e)}}}],[{key:"from",value:function(e,t,r){var o,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return new n({type:i.M_POLL_START.name,content:(o={},C(o,s.M_TEXT.name,e),C(o,i.M_POLL_START.name,{question:C({},s.M_TEXT.name,e),kind:r instanceof c.NamespacedValue?r.name:r,max_selections:a,answers:t.map((function(e){return C({id:A()},s.M_TEXT.name,e)}))}),o)})}}]),n}(d.ExtensibleEvent);t.PollStartEvent=M;var D="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function A(){return u(Array(16)).map((function(){return D.charAt(Math.floor(Math.random()*D.length))})).join("")}},4142:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_TEXT=t.M_NOTICE=t.M_MESSAGE=t.M_HTML=t.M_EMOTE=void 0;var r=n(9686),i=new r.UnstableValue("m.message","org.matrix.msc1767.message");t.M_MESSAGE=i;var o=new r.UnstableValue("m.text","org.matrix.msc1767.text");t.M_TEXT=o;var s=new r.UnstableValue("m.html","org.matrix.msc1767.html");t.M_HTML=s;var a=new r.UnstableValue("m.emote","org.matrix.msc1767.emote");t.M_EMOTE=a;var c=new r.UnstableValue("m.notice","org.matrix.msc1767.notice");t.M_NOTICE=c},6588:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_POLL_START=t.M_POLL_RESPONSE=t.M_POLL_KIND_UNDISCLOSED=t.M_POLL_KIND_DISCLOSED=t.M_POLL_END=void 0;var r=n(9686),i=new r.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");t.M_POLL_KIND_DISCLOSED=i;var o=new r.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");t.M_POLL_KIND_UNDISCLOSED=o;var s=new r.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");t.M_POLL_START=s;var a=new r.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");t.M_POLL_RESPONSE=a;var c=new r.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");t.M_POLL_END=c},4780:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.REFERENCE_RELATION=void 0;var r=n(9686),i=new r.NamespacedValue("m.reference");t.REFERENCE_RELATION=i},3255:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(5221);Object.keys(r).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===r[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}}))}));var i=n(3034);Object.keys(i).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))}));var o=n(5700);Object.keys(o).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))}));var s=n(9686);Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))}));var a=n(7793);Object.keys(a).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))}));var c=n(7167);Object.keys(c).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===c[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))}));var l=n(3413);Object.keys(l).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))}));var d=n(278);Object.keys(d).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))}));var u=n(4564);Object.keys(u).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))}));var h=n(7692);Object.keys(h).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===h[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))}));var g=n(3249);Object.keys(g).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===g[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))}));var p=n(4780);Object.keys(p).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))}));var f=n(6473);Object.keys(f).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===f[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))}));var y=n(4142);Object.keys(y).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))}));var m=n(7801);Object.keys(m).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===m[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))}));var v=n(2982);Object.keys(v).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===v[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))}));var E=n(2828);Object.keys(E).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===E[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))}));var S=n(6588);Object.keys(S).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===S[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))}));var b=n(9696);Object.keys(b).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===b[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))}));var w=n(6093);Object.keys(w).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===w[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return w[e]}}))}));var _=n(2467);Object.keys(_).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===_[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return _[e]}}))}))},4564:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LEGACY_M_ROOM_MESSAGE=void 0,t.parseMRoomMessage=h;var r=n(7801),i=n(2828),o=n(2982),s=n(9686),a=n(4142);function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){d(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=new s.NamespacedValue("m.room.message");function h(e){var t,n,s;if(a.M_MESSAGE.findIn(e.content)||a.M_TEXT.findIn(e.content))return new r.MessageEvent(e);var c,u,h,g=null===(t=e.content)||void 0===t?void 0:t.msgtype,p=null===(n=e.content)||void 0===n?void 0:n.body,f="org.matrix.custom.html"===(null===(s=e.content)||void 0===s?void 0:s.format)?e.content.formatted_body:null;return"m.text"===g?new r.MessageEvent(l(l({},e),{},{content:l(l({},e.content),{},(c={},d(c,a.M_TEXT.name,p),d(c,a.M_HTML.name,f),c))})):"m.notice"===g?new i.NoticeEvent(l(l({},e),{},{content:l(l({},e.content),{},(u={},d(u,a.M_TEXT.name,p),d(u,a.M_HTML.name,f),u))})):"m.emote"===g?new o.EmoteEvent(l(l({},e),{},{content:l(l({},e.content),{},(h={},d(h,a.M_TEXT.name,p),d(h,a.M_HTML.name,f),h))})):null}t.LEGACY_M_ROOM_MESSAGE=u},7692:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseMMessage=a;var r=n(7801),i=n(4142),o=n(2982),s=n(2828);function a(e){return i.M_EMOTE.matches(e.type)?new o.EmoteEvent(e):i.M_NOTICE.matches(e.type)?new s.NoticeEvent(e):new r.MessageEvent(e)}},3249:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseMPoll=a;var r=n(6588),i=n(9696),o=n(6093),s=n(2467);function a(e){return r.M_POLL_START.matches(e.type)?new i.PollStartEvent(e):r.M_POLL_RESPONSE.matches(e.type)?new o.PollResponseEvent(e):r.M_POLL_END.matches(e.type)?new s.PollEndEvent(e):null}},7167:function(e,t){"use strict";function n(e){return r(e)&&"string"===typeof e}function r(e){return null!==e&&void 0!==e}Object.defineProperty(t,"__esModule",{value:!0}),t.isOptionalAString=n,t.isProvided=r},3413:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LegacyMsgType=void 0,t.isEventLike=o;var r,i=n(4142);function o(e,t){var n=e.content;return t===r.Text?i.M_MESSAGE.matches(e.type)||"m.room.message"===e.type&&"m.text"===(null===n||void 0===n?void 0:n["msgtype"]):t===r.Emote?i.M_EMOTE.matches(e.type)||"m.room.message"===e.type&&"m.emote"===(null===n||void 0===n?void 0:n["msgtype"]):t===r.Notice&&(i.M_NOTICE.matches(e.type)||"m.room.message"===e.type&&"m.notice"===(null===n||void 0===n?void 0:n["msgtype"]))}t.LegacyMsgType=r,function(e){e["Text"]="m.text",e["Notice"]="m.notice",e["Emote"]="m.emote"}(r||(t.LegacyMsgType=r={}))},278:function(e,t){"use strict";function n(e,t){if("string"===typeof e)return"string"===typeof t?t===e:t.matches(e);if("string"===typeof t)return e.matches(t);var n=t,r=e;return n.matches(r.name)||n.matches(r.altName)}Object.defineProperty(t,"__esModule",{value:!0}),t.isEventTypeSame=n},9666:function(e,t){"use strict";let n,r,i;Object.defineProperty(t,"__esModule",{value:!0}),t.TweakName=t.RuleId=t.PushRuleKind=t.PushRuleActionName=t.DMMemberCountCondition=t.ConditionOperator=t.ConditionKind=void 0,t.isDmMemberCountCondition=s,t.PushRuleActionName=n,function(e){e["DontNotify"]="dont_notify",e["Notify"]="notify",e["Coalesce"]="coalesce"}(n||(t.PushRuleActionName=n={})),t.TweakName=r,function(e){e["Highlight"]="highlight",e["Sound"]="sound"}(r||(t.TweakName=r={})),t.ConditionOperator=i,function(e){e["ExactEquals"]="==",e["LessThan"]="<",e["GreaterThan"]=">",e["GreaterThanOrEqual"]=">=",e["LessThanOrEqual"]="<="}(i||(t.ConditionOperator=i={}));const o="2";function s(e){return"==2"===e||"2"===e}let a,c,l;t.DMMemberCountCondition=o,t.ConditionKind=a,function(e){e["EventMatch"]="event_match",e["ContainsDisplayName"]="contains_display_name",e["RoomMemberCount"]="room_member_count",e["SenderNotificationPermission"]="sender_notification_permission"}(a||(t.ConditionKind=a={})),t.PushRuleKind=c,function(e){e["Override"]="override",e["ContentSpecific"]="content",e["RoomSpecific"]="room",e["SenderSpecific"]="sender",e["Underride"]="underride"}(c||(t.PushRuleKind=c={})),t.RuleId=l,function(e){e["Master"]=".m.rule.master",e["ContainsDisplayName"]=".m.rule.contains_display_name",e["ContainsUserName"]=".m.rule.contains_user_name",e["AtRoomNotification"]=".m.rule.roomnotif",e["DM"]=".m.rule.room_one_to_one",e["EncryptedDM"]=".m.rule.encrypted_room_one_to_one",e["Message"]=".m.rule.message",e["EncryptedMessage"]=".m.rule.encrypted",e["InviteToSelf"]=".m.rule.invite_for_me",e["MemberEvent"]=".m.rule.member_event",e["IncomingCall"]=".m.rule.call",e["SuppressNotices"]=".m.rule.suppress_notices",e["Tombstone"]=".m.rule.tombstone"}(l||(t.RuleId=l={}))},7946:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_BEACON_INFO=t.M_BEACON=void 0;var r=n(3698);const i=new r.UnstableValue("m.beacon_info","org.matrix.msc3672.beacon_info");t.M_BEACON_INFO=i;const o=new r.UnstableValue("m.beacon","org.matrix.msc3672.beacon");t.M_BEACON=o},7778:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UNSTABLE_MSC3089_TREE_SUBTYPE=t.UNSTABLE_MSC3089_LEAF=t.UNSTABLE_MSC3089_BRANCH=t.UNSTABLE_MSC3088_PURPOSE=t.UNSTABLE_MSC3088_ENABLED=t.UNSTABLE_MSC2716_MARKER=t.UNSTABLE_ELEMENT_FUNCTIONAL_USERS=t.RoomType=t.RoomCreateTypeField=t.RelationType=t.MsgType=t.EventType=t.EVENT_VISIBILITY_CHANGE_TYPE=void 0;var r=n(3698);let i,o,s;t.EventType=i,function(e){e["RoomCanonicalAlias"]="m.room.canonical_alias",e["RoomCreate"]="m.room.create",e["RoomJoinRules"]="m.room.join_rules",e["RoomMember"]="m.room.member",e["RoomThirdPartyInvite"]="m.room.third_party_invite",e["RoomPowerLevels"]="m.room.power_levels",e["RoomName"]="m.room.name",e["RoomTopic"]="m.room.topic",e["RoomAvatar"]="m.room.avatar",e["RoomPinnedEvents"]="m.room.pinned_events",e["RoomEncryption"]="m.room.encryption",e["RoomHistoryVisibility"]="m.room.history_visibility",e["RoomGuestAccess"]="m.room.guest_access",e["RoomServerAcl"]="m.room.server_acl",e["RoomTombstone"]="m.room.tombstone",e["RoomAliases"]="m.room.aliases",e["SpaceChild"]="m.space.child",e["SpaceParent"]="m.space.parent",e["RoomRedaction"]="m.room.redaction",e["RoomMessage"]="m.room.message",e["RoomMessageEncrypted"]="m.room.encrypted",e["Sticker"]="m.sticker",e["CallInvite"]="m.call.invite",e["CallCandidates"]="m.call.candidates",e["CallAnswer"]="m.call.answer",e["CallHangup"]="m.call.hangup",e["CallReject"]="m.call.reject",e["CallSelectAnswer"]="m.call.select_answer",e["CallNegotiate"]="m.call.negotiate",e["CallSDPStreamMetadataChanged"]="m.call.sdp_stream_metadata_changed",e["CallSDPStreamMetadataChangedPrefix"]="org.matrix.call.sdp_stream_metadata_changed",e["CallReplaces"]="m.call.replaces",e["CallAssertedIdentity"]="m.call.asserted_identity",e["CallAssertedIdentityPrefix"]="org.matrix.call.asserted_identity",e["KeyVerificationRequest"]="m.key.verification.request",e["KeyVerificationStart"]="m.key.verification.start",e["KeyVerificationCancel"]="m.key.verification.cancel",e["KeyVerificationMac"]="m.key.verification.mac",e["KeyVerificationDone"]="m.key.verification.done",e["RoomMessageFeedback"]="m.room.message.feedback",e["Reaction"]="m.reaction",e["Typing"]="m.typing",e["Receipt"]="m.receipt",e["Presence"]="m.presence",e["FullyRead"]="m.fully_read",e["Tag"]="m.tag",e["SpaceOrder"]="org.matrix.msc3230.space_order",e["PushRules"]="m.push_rules",e["Direct"]="m.direct",e["IgnoredUserList"]="m.ignored_user_list",e["RoomKey"]="m.room_key",e["RoomKeyRequest"]="m.room_key_request",e["ForwardedRoomKey"]="m.forwarded_room_key",e["Dummy"]="m.dummy"}(i||(t.EventType=i={})),t.RelationType=o,function(e){e["Annotation"]="m.annotation",e["Replace"]="m.replace",e["Reference"]="m.reference",e["Thread"]="m.thread"}(o||(t.RelationType=o={})),t.MsgType=s,function(e){e["Text"]="m.text",e["Emote"]="m.emote",e["Notice"]="m.notice",e["Image"]="m.image",e["File"]="m.file",e["Audio"]="m.audio",e["Location"]="m.location",e["Video"]="m.video",e["KeyVerificationRequest"]="m.key.verification.request"}(s||(t.MsgType=s={}));const a="type";let c;t.RoomCreateTypeField=a,t.RoomType=c,function(e){e["Space"]="m.space",e["UnstableCall"]="org.matrix.msc3417.call",e["ElementVideo"]="io.element.video"}(c||(t.RoomType=c={}));const l=new r.UnstableValue("m.room.purpose","org.matrix.msc3088.purpose");t.UNSTABLE_MSC3088_PURPOSE=l;const d=new r.UnstableValue("m.enabled","org.matrix.msc3088.enabled");t.UNSTABLE_MSC3088_ENABLED=d;const u=new r.UnstableValue("m.data_tree","org.matrix.msc3089.data_tree");t.UNSTABLE_MSC3089_TREE_SUBTYPE=u;const h=new r.UnstableValue("m.leaf","org.matrix.msc3089.leaf");t.UNSTABLE_MSC3089_LEAF=h;const g=new r.UnstableValue("m.branch","org.matrix.msc3089.branch");t.UNSTABLE_MSC3089_BRANCH=g;const p=new r.UnstableValue("m.room.marker","org.matrix.msc2716.marker");t.UNSTABLE_MSC2716_MARKER=p;const f=new r.UnstableValue("io.element.functional_members","io.element.functional_members");t.UNSTABLE_ELEMENT_FUNCTIONAL_USERS=f;const y=new r.UnstableValue("m.visibility","org.matrix.msc3531.visibility");t.EVENT_VISIBILITY_CHANGE_TYPE=y},6570:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TEXT_NODE_TYPE=void 0;var r=n(3698);const i=new r.UnstableValue("m.text","org.matrix.msc1767.text");t.TEXT_NODE_TYPE=i},3786:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_TIMESTAMP=t.M_LOCATION=t.M_ASSET=t.LocationAssetType=void 0;var r=n(3698);n(6570);let i;t.LocationAssetType=i,function(e){e["Self"]="m.self",e["Pin"]="m.pin"}(i||(t.LocationAssetType=i={}));const o=new r.UnstableValue("m.asset","org.matrix.msc3488.asset");t.M_ASSET=o;const s=new r.UnstableValue("m.ts","org.matrix.msc3488.ts");t.M_TIMESTAMP=s;const a=new r.UnstableValue("m.location","org.matrix.msc3488.location");t.M_LOCATION=a},5718:function(e,t){"use strict";let n,r,i,o,s,a;Object.defineProperty(t,"__esModule",{value:!0}),t.Visibility=t.RestrictedAllowType=t.Preset=t.JoinRule=t.HistoryVisibility=t.GuestAccess=void 0,t.Visibility=n,function(e){e["Public"]="public",e["Private"]="private"}(n||(t.Visibility=n={})),t.Preset=r,function(e){e["PrivateChat"]="private_chat",e["TrustedPrivateChat"]="trusted_private_chat",e["PublicChat"]="public_chat"}(r||(t.Preset=r={})),t.JoinRule=i,function(e){e["Public"]="public",e["Invite"]="invite",e["Private"]="private",e["Knock"]="knock",e["Restricted"]="restricted"}(i||(t.JoinRule=i={})),t.RestrictedAllowType=o,function(e){e["RoomMembership"]="m.room_membership"}(o||(t.RestrictedAllowType=o={})),t.GuestAccess=s,function(e){e["CanJoin"]="can_join",e["Forbidden"]="forbidden"}(s||(t.GuestAccess=s={})),t.HistoryVisibility=a,function(e){e["Invited"]="invited",e["Joined"]="joined",e["Shared"]="shared",e["WorldReadable"]="world_readable"}(a||(t.HistoryVisibility=a={}))},6445:function(e,t){"use strict";let n;Object.defineProperty(t,"__esModule",{value:!0}),t.ReceiptType=void 0,t.ReceiptType=n,function(e){e["Read"]="m.read",e["FullyRead"]="m.fully_read",e["ReadPrivate"]="org.matrix.msc2285.read.private"}(n||(t.ReceiptType=n={}))},1626:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},3250:function(e,t){"use strict";var n;let r;Object.defineProperty(t,"__esModule",{value:!0}),t.SearchOrderBy=void 0,function(e){e["RoomId"]="room_id",e["Sender"]="sender"}(n||(n={})),t.SearchOrderBy=r,function(e){e["Recent"]="recent",e["Rank"]="rank"}(r||(t.SearchOrderBy=r={}))},1375:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_TOPIC=void 0;var r=n(3698);const i=new r.UnstableValue("m.topic","org.matrix.msc3765.topic");t.M_TOPIC=i},3698:function(e,t,n){"use strict";n(1703),n(6699);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.UnstableValue=t.ServerControlledNamespacedValue=t.NamespacedValue=void 0;var i=r(n(4344));class o{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}matches(e){return this.name===e||this.altName===e}findIn(e){let t;return this.name&&(t=null===e||void 0===e?void 0:e[this.name]),!t&&this.altName&&(t=null===e||void 0===e?void 0:e[this.altName]),t}includedIn(e){let t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}t.NamespacedValue=o;class s extends o{constructor(...e){super(...e),(0,i.default)(this,"preferUnstable",!1)}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}t.ServerControlledNamespacedValue=s;class a extends o{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}t.UnstableValue=a},4111:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TypedReEmitter=t.ReEmitter=void 0;class n{constructor(e){this.target=e}reEmit(e,t){for(const n of t){const t=(...t)=>{"error"===n&&0===this.target.listenerCount("error")||this.target.emit(n,...t,e)};e.on(n,t)}}}t.ReEmitter=n;class r extends n{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}}t.TypedReEmitter=r},7911:function(e,t,n){"use strict";n(6699),n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.AutoDiscoveryAction=t.AutoDiscovery=void 0;var i=r(n(4344)),o=n(6471);let s;t.AutoDiscoveryAction=s,function(e){e["SUCCESS"]="SUCCESS",e["IGNORE"]="IGNORE",e["PROMPT"]="PROMPT",e["FAIL_PROMPT"]="FAIL_PROMPT",e["FAIL_ERROR"]="FAIL_ERROR"}(s||(t.AutoDiscoveryAction=s={}));class a{static async fromDiscoveryConfig(e){const t={"m.homeserver":{state:a.FAIL_ERROR,error:a.ERROR_INVALID,base_url:null},"m.identity_server":{state:a.PROMPT,error:null,base_url:null}};if(!e||!e["m.homeserver"])return o.logger.error("No m.homeserver key in config"),t["m.homeserver"].state=a.FAIL_PROMPT,t["m.homeserver"].error=a.ERROR_INVALID,Promise.resolve(t);if(!e["m.homeserver"]["base_url"])return o.logger.error("No m.homeserver base_url in config"),t["m.homeserver"].state=a.FAIL_PROMPT,t["m.homeserver"].error=a.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const n=this.sanitizeWellKnownUrl(e["m.homeserver"]["base_url"]);if(!n)return o.logger.error("Invalid base_url for m.homeserver"),t["m.homeserver"].error=a.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const r=await this.fetchWellKnownObject(`${n}/_matrix/client/versions`);if(!r||!r.raw["versions"])return o.logger.error("Invalid /versions response"),t["m.homeserver"].error=a.ERROR_INVALID_HOMESERVER,t["m.homeserver"].base_url=n,Promise.resolve(t);t["m.homeserver"]={state:a.SUCCESS,error:null,base_url:n};let i="";if(e["m.identity_server"]){const n={"m.homeserver":t["m.homeserver"],"m.identity_server":{state:a.FAIL_PROMPT,error:a.ERROR_INVALID_IS,base_url:null}};if(i=this.sanitizeWellKnownUrl(e["m.identity_server"]["base_url"]),!i)return o.logger.error("Invalid base_url for m.identity_server"),n["m.identity_server"].error=a.ERROR_INVALID_IS_BASE_URL,Promise.resolve(n);const r=await this.fetchWellKnownObject(`${i}/_matrix/identity/api/v1`);if(!r||!r.raw||r.action!==s.SUCCESS)return o.logger.error("Invalid /api/v1 response"),n["m.identity_server"].error=a.ERROR_INVALID_IDENTITY_SERVER,n["m.identity_server"].base_url=i,Promise.resolve(n)}return i&&i.toString().length>0&&(t["m.identity_server"]={state:a.SUCCESS,error:null,base_url:i}),Object.keys(e).forEach((n=>{if("m.homeserver"===n||"m.identity_server"===n){const r=["error","state","base_url"];for(const i of Object.keys(e[n]))r.includes(i)||(t[n][i]=e[n][i])}else t[n]=e[n]})),Promise.resolve(t)}static async findClientConfig(e){if(!e||"string"!==typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t={"m.homeserver":{state:a.FAIL_ERROR,error:a.ERROR_INVALID,base_url:null},"m.identity_server":{state:a.PROMPT,error:null,base_url:null}},n=await this.fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return n&&n.action===s.SUCCESS?a.fromDiscoveryConfig(n.raw):(o.logger.error("No response or error when parsing .well-known"),n.reason&&o.logger.error(n.reason),n.action===s.IGNORE?t["m.homeserver"]={state:a.PROMPT,error:null,base_url:null}:(t["m.homeserver"].state=a.FAIL_PROMPT,t["m.homeserver"].error=a.ERROR_INVALID),Promise.resolve(t))}static async getRawClientConfig(e){if(!e||"string"!==typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t=await this.fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return t&&t.raw||{}}static sanitizeWellKnownUrl(e){if(!e)return!1;try{let n=null;try{n=new URL(e)}catch(t){o.logger.error("Could not parse url",t)}if(!n||!n.hostname)return!1;if("http:"!==n.protocol&&"https:"!==n.protocol)return!1;const r=n.port?`:${n.port}`:"",i=n.pathname?n.pathname:"";let s=`${n.protocol}//${n.hostname}${r}${i}`;return s.endsWith("/")&&(s=s.substring(0,s.length-1)),s}catch(t){return o.logger.error(t),!1}}static fetchWellKnownObject(e){return new Promise((function(t){const r=n(5346).getRequest();if(!r)throw new Error("No request library available");r({method:"GET",uri:e,timeout:5e3},((e,n,r)=>{if(e||n&&(n.statusCode<200||n.statusCode>=300)){let r=s.FAIL_PROMPT,i=(e?e.message:null)||"General failure";return n&&404===n.statusCode&&(r=s.IGNORE,i=a.ERROR_MISSING_WELLKNOWN),void t({raw:{},action:r,reason:i,error:e})}try{t({raw:JSON.parse(r),action:s.SUCCESS})}catch(i){let e=a.ERROR_INVALID;"SyntaxError"===i.name&&(e=a.ERROR_INVALID_JSON),t({raw:{},action:s.FAIL_PROMPT,reason:e,error:i})}}))}))}}t.AutoDiscovery=a,(0,i.default)(a,"ERROR_INVALID","Invalid homeserver discovery response"),(0,i.default)(a,"ERROR_GENERIC_FAILURE","Failed to get autodiscovery configuration from server"),(0,i.default)(a,"ERROR_INVALID_HS_BASE_URL","Invalid base_url for m.homeserver"),(0,i.default)(a,"ERROR_INVALID_HOMESERVER","Homeserver URL does not appear to be a valid Matrix homeserver"),(0,i.default)(a,"ERROR_INVALID_IS_BASE_URL","Invalid base_url for m.identity_server"),(0,i.default)(a,"ERROR_INVALID_IDENTITY_SERVER","Identity server URL does not appear to be a valid identity server"),(0,i.default)(a,"ERROR_INVALID_IS","Invalid identity server discovery response"),(0,i.default)(a,"ERROR_MISSING_WELLKNOWN","No .well-known JSON file found"),(0,i.default)(a,"ERROR_INVALID_JSON","Invalid JSON"),(0,i.default)(a,"ALL_ERRORS",[a.ERROR_INVALID,a.ERROR_GENERIC_FAILURE,a.ERROR_INVALID_HS_BASE_URL,a.ERROR_INVALID_HOMESERVER,a.ERROR_INVALID_IS_BASE_URL,a.ERROR_INVALID_IDENTITY_SERVER,a.ERROR_INVALID_IS,a.ERROR_MISSING_WELLKNOWN,a.ERROR_INVALID_JSON]),(0,i.default)(a,"FAIL_ERROR",s.FAIL_ERROR),(0,i.default)(a,"FAIL_PROMPT",s.FAIL_PROMPT),(0,i.default)(a,"PROMPT",s.PROMPT),(0,i.default)(a,"SUCCESS",s.SUCCESS)},1364:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0});var i={};t["default"]=void 0;var o=r(n(9751)),s=r(n(5410)),a=l(n(5346));function c(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(c=function(e){return e?n:t})(e)}function l(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=c(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}if(Object.keys(a).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))})),a.getRequest())throw new Error("Multiple matrix-js-sdk entrypoints detected!");let d;a.request((function(e,t){return e.qs=s.default.stringify(e.qs||{},e.qsStringifyOptions),(0,o.default)(e,t)}));try{d=n.g.indexedDB}catch(h){}d&&a.setCryptoStoreFactory((function(){return new a.IndexedDBCryptoStore(d,"matrix-js-sdk:crypto")}));var u=a;t["default"]=u,n.g.matrixcs=a},9528:function(e,t,n){"use strict";n(6699),n(1703),n(8675),n(3462),n(7380),n(1118);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomVersionStability=t.PendingEventOrdering=t.MatrixClient=t.ClientEvent=t.CRYPTO_ENABLED=void 0;var i=r(n(4344)),o=n(3255),s=n(2438),a=n(2842),c=n(3484),l=n(9393),d=n(9097),u=n(9028),h=W(n(3926)),g=n(8919),p=n(541),f=n(7911),y=W(n(9485)),m=n(4111),v=n(3616),E=n(6471),S=n(5045),b=n(5354),w=n(529),_=n(4897),T=n(4791),I=n(6876),R=n(2697),k=n(895),O=n(7205),C=n(5346),P=n(9168),M=W(n(8652)),D=n(7778),A=n(5718),U=n(3071),L=n(5789),N=n(8862),B=n(6783),j=n(3250),x=n(9666),K=n(241),F=n(9392),q=n(6445),$=n(1356),V=n(7946);function G(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(G=function(e){return e?n:t})(e)}function W(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=G(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}function H(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Y(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?H(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):H(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const J=3e3,z=(0,w.isCryptoAvailable)();t.CRYPTO_ENABLED=z;const Q=216e5,X=6e5;let Z,ee;var te;t.PendingEventOrdering=Z,function(e){e["Chronological"]="chronological",e["Detached"]="detached"}(Z||(t.PendingEventOrdering=Z={})),t.RoomVersionStability=ee,function(e){e["Stable"]="stable",e["Unstable"]="unstable"}(ee||(t.RoomVersionStability=ee={})),function(e){e["MasterKey"]="master_key",e["SelfSigningKey"]="self_signing_key",e["UserSigningKey"]="user_signing_key"}(te||(te={}));const ne="$";let re;t.ClientEvent=re,function(e){e["Sync"]="sync",e["Event"]="event",e["ToDeviceEvent"]="toDeviceEvent",e["AccountData"]="accountData",e["Room"]="Room",e["DeleteRoom"]="deleteRoom",e["SyncUnexpectedError"]="sync.unexpectedError",e["ClientWellKnown"]="WellKnown.client"}(re||(t.ClientEvent=re={}));class ie extends F.TypedEventEmitter{constructor(e){super(),(0,i.default)(this,"reEmitter",new m.TypedReEmitter(this)),(0,i.default)(this,"olmVersion",null),(0,i.default)(this,"usingExternalCrypto",!1),(0,i.default)(this,"store",void 0),(0,i.default)(this,"deviceId",void 0),(0,i.default)(this,"credentials",void 0),(0,i.default)(this,"pickleKey",void 0),(0,i.default)(this,"scheduler",void 0),(0,i.default)(this,"clientRunning",!1),(0,i.default)(this,"timelineSupport",!1),(0,i.default)(this,"urlPreviewCache",{}),(0,i.default)(this,"identityServer",void 0),(0,i.default)(this,"http",void 0),(0,i.default)(this,"crypto",void 0),(0,i.default)(this,"cryptoCallbacks",void 0),(0,i.default)(this,"callEventHandler",void 0),(0,i.default)(this,"supportsCallTransfer",!1),(0,i.default)(this,"forceTURN",!1),(0,i.default)(this,"iceCandidatePoolSize",0),(0,i.default)(this,"idBaseUrl",void 0),(0,i.default)(this,"baseUrl",void 0),(0,i.default)(this,"canSupportVoip",!1),(0,i.default)(this,"peekSync",null),(0,i.default)(this,"isGuestAccount",!1),(0,i.default)(this,"ongoingScrollbacks",{}),(0,i.default)(this,"notifTimelineSet",null),(0,i.default)(this,"cryptoStore",void 0),(0,i.default)(this,"verificationMethods",void 0),(0,i.default)(this,"fallbackICEServerAllowed",!1),(0,i.default)(this,"roomList",void 0),(0,i.default)(this,"syncApi",void 0),(0,i.default)(this,"pushRules",void 0),(0,i.default)(this,"syncLeftRoomsPromise",void 0),(0,i.default)(this,"syncedLeftRooms",!1),(0,i.default)(this,"clientOpts",void 0),(0,i.default)(this,"clientWellKnownIntervalID",void 0),(0,i.default)(this,"canResetTimelineCallback",void 0),(0,i.default)(this,"pushProcessor",new p.PushProcessor(this)),(0,i.default)(this,"serverVersionsPromise",void 0),(0,i.default)(this,"cachedCapabilities",void 0),(0,i.default)(this,"clientWellKnown",void 0),(0,i.default)(this,"clientWellKnownPromise",void 0),(0,i.default)(this,"turnServers",[]),(0,i.default)(this,"turnServersExpiry",0),(0,i.default)(this,"checkTurnServersIntervalID",void 0),(0,i.default)(this,"exportedOlmDeviceToImport",void 0),(0,i.default)(this,"txnCtr",0),(0,i.default)(this,"mediaHandler",new K.MediaHandler(this)),(0,i.default)(this,"pendingEventEncryption",new Map),(0,i.default)(this,"startCallEventHandler",(()=>{this.isInitialSyncComplete()&&(this.callEventHandler.start(),this.off(re.Sync,this.startCallEventHandler))})),e.baseUrl=h.ensureNoTrailingSlash(e.baseUrl),e.idBaseUrl=h.ensureNoTrailingSlash(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=e.usingExternalCrypto,this.store=e.store||new c.StubStore,this.deviceId=e.deviceId||null;const t=e.userId||null;this.credentials={userId:t},this.http=new b.MatrixHttpApi(this,{baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,request:e.request,prefix:b.PREFIX_R0,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader}),e.deviceToImport?this.deviceId?E.logger.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?E.logger.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this.exportedOlmDeviceToImport=e.deviceToImport.olmDevice):E.logger.warn("not importing device because no device ID in exported data"):e.pickleKey&&(this.pickleKey=e.pickleKey),this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction((async e=>{const t=this.getRoom(e.getRoomId());e.status!==a.EventStatus.SENDING&&this.updatePendingEventStatus(t,e,a.EventStatus.SENDING);const n=await this.sendEventHttpRequest(e);return t&&t.updatePendingEvent(e,a.EventStatus.SENT,n.event_id),n})),(0,l.supportsMatrixCall)()&&(this.callEventHandler=new u.CallEventHandler(this),this.canSupportVoip=!0,this.on(re.Sync,this.startCallEventHandler)),this.timelineSupport=Boolean(e.timelineSupport),this.cryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=void 0===e.iceCandidatePoolSize?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.roomList=new v.RoomList(this.cryptoStore),this.on(a.MatrixEventEvent.Decrypted,(e=>{var t,n;const r=e.getPushActions(),i=this.getPushActionsForEvent(e,!0),o=this.getRoom(e.getRoomId());if(!o)return;const s=o.getUnreadNotificationCount(C.NotificationCountType.Highlight),a=!(null===r||void 0===r||null===(t=r.tweaks)||void 0===t||!t.highlight),c=!(null===i||void 0===i||null===(n=i.tweaks)||void 0===n||!n.highlight);if((a!==c||s>0)&&!o.hasUserReadEvent(this.getUserId(),e.getId())){let e=s;c&&!a&&e++,!c&&a&&e--,o.setUnreadNotificationCount(C.NotificationCountType.Highlight,e);const t=o.getUnreadNotificationCount(C.NotificationCountType.Total);t<e&&o.setUnreadNotificationCount(C.NotificationCountType.Total,e)}})),this.on(C.RoomEvent.Receipt,((e,t)=>{if(t&&this.isRoomEncrypted(t.roomId)){const n=e.getContent(),r=Object.keys(n).filter((e=>{const t=n[e][q.ReceiptType.Read];if(t&&Object.keys(t).includes(this.getUserId()))return!0;const r=n[e][q.ReceiptType.ReadPrivate];return!(!r||!Object.keys(r).includes(this.getUserId()))})).length>0;if(!r)return;const i=20,o=t.getLiveTimeline().getEvents();let s=0;for(let e=o.length-1;e>=0;e--){if(e===o.length-i)return;const n=o[e];if(t.hasUserReadEvent(this.getUserId(),n.getId()))break;const r=this.getPushActionsForEvent(n);s+=r.tweaks&&r.tweaks.highlight?1:0}t.setUnreadNotificationCount(C.NotificationCountType.Highlight,s)}}))}async startClient(e){if(this.clientRunning)return;this.clientRunning=!0,"number"===typeof e&&(e={initialSyncLimit:e});const t=this.getUserId();t&&this.store.storeUser(new I.User(t)),this.crypto&&(this.crypto.uploadDeviceKeys(),this.crypto.start()),this.canSupportVoip&&(this.checkTurnServersIntervalID=setInterval((()=>{this.checkTurnServers()}),X),this.checkTurnServers()),this.syncApi&&(E.logger.error("Still have sync object whilst not running: stopping old one"),this.syncApi.stop());try{const{serverSupport:e,stable:t}=await this.doesServerSupportThread();$.Thread.setServerSideSupport(e,t)}catch(n){$.Thread.setServerSideSupport(!1,!0)}this.clientOpts=Object.assign({},e),this.clientOpts.crypto=this.crypto,this.clientOpts.canResetEntireTimeline=e=>!!this.canResetTimelineCallback&&this.canResetTimelineCallback(e),this.syncApi=new s.SyncApi(this,this.clientOpts),this.syncApi.sync(),void 0!==this.clientOpts.clientWellKnownPollPeriod&&(this.clientWellKnownIntervalID=setInterval((()=>{this.fetchClientWellKnown()}),1e3*this.clientOpts.clientWellKnownPollPeriod),this.fetchClientWellKnown())}stopClient(){var e,t,r,i;null===(e=this.crypto)||void 0===e||e.stop(),this.clientRunning&&(E.logger.log("stopping MatrixClient"),this.clientRunning=!1,null===(t=this.syncApi)||void 0===t||t.stop(),this.syncApi=null,null===(r=this.peekSync)||void 0===r||r.stopPeeking(),null===(i=this.callEventHandler)||void 0===i||i.stop(),this.callEventHandler=null,n.g.clearInterval(this.checkTurnServersIntervalID),void 0!==this.clientWellKnownIntervalID&&n.g.clearInterval(this.clientWellKnownIntervalID))}async rehydrateDevice(){if(this.crypto)throw new Error("Cannot rehydrate device after crypto is initialized");if(!this.cryptoCallbacks.getDehydrationKey)return;const e=await this.getDehydratedDevice();if(!e)return;if(!e.device_data||!e.device_id)return void E.logger.info("no dehydrated device found");const t=new n.g.Olm.Account;try{const n=e.device_data;if(n.algorithm!==O.DEHYDRATION_ALGORITHM)return void E.logger.warn("Wrong algorithm for dehydrated device");E.logger.log("unpickling dehydrated device");const r=await this.cryptoCallbacks.getDehydrationKey(n,(e=>{t.unpickle(new Uint8Array(e),n.account)}));t.unpickle(r,n.account),E.logger.log("unpickled device");const i=await this.http.authedRequest(void 0,b.Method.Post,"/dehydrated_device/claim",void 0,{device_id:e.device_id},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"});if(!0===i.success){this.deviceId=e.device_id,E.logger.info("using dehydrated device");const n=this.pickleKey||"DEFAULT_KEY";return this.exportedOlmDeviceToImport={pickledAccount:t.pickle(n),sessions:[],pickleKey:n},t.free(),this.deviceId}return t.free(),void E.logger.info("not using dehydrated device")}catch(r){t.free(),E.logger.warn("could not unpickle",r)}}async getDehydratedDevice(){try{return await this.http.authedRequest(void 0,b.Method.Get,"/dehydrated_device",void 0,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})}catch(e){return void E.logger.info("could not get dehydrated device",e.toString())}}setDehydrationKey(e,t,n){if(this.crypto)return this.crypto.dehydrationManager.setKeyAndQueueDehydration(e,t,n);E.logger.warn("not dehydrating device if crypto is not enabled")}async createDehydratedDevice(e,t,n){if(this.crypto)return await this.crypto.dehydrationManager.setKey(e,t,n),this.crypto.dehydrationManager.dehydrateDevice();E.logger.warn("not dehydrating device if crypto is not enabled")}async exportDevice(){if(this.crypto)return{userId:this.credentials.userId,deviceId:this.deviceId,olmDevice:await this.crypto.olmDevice.export()};E.logger.warn("not exporting device if crypto is not enabled")}clearStores(){if(this.clientRunning)throw new Error("Cannot clear stores while client is running");const e=[];return e.push(this.store.deleteAllData()),this.cryptoStore&&e.push(this.cryptoStore.deleteAllData()),Promise.all(e).then()}getUserId(){return this.credentials&&this.credentials.userId?this.credentials.userId:null}getDomain(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null}getDeviceId(){return this.deviceId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}createCall(e){return(0,l.createNewMatrixCall)(this,e)}getSyncState(){return this.syncApi?this.syncApi.getSyncState():null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){const e=this.getSyncState();return!!e&&(e===s.SyncState.Prepared||e===s.SyncState.Syncing)}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){return this.syncApi.retryImmediately()}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(e=!1){const t=(new Date).getTime();return this.cachedCapabilities&&!e&&t<this.cachedCapabilities.expiration?(E.logger.log("Returning cached capabilities"),Promise.resolve(this.cachedCapabilities.capabilities)):this.http.authedRequest(void 0,b.Method.Get,"/capabilities").catch((e=>{E.logger.error(e)})).then(((e={})=>{const n=e["capabilities"]||{},r=Object.keys(n).length?Q:6e4+5e3*Math.random();return this.cachedCapabilities={capabilities:n,expiration:t+r},E.logger.log("Caching capabilities: ",n),n}))}async initCrypto(){if(!(0,w.isCryptoAvailable)())throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(this.crypto)return void E.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");if(!this.cryptoStore)throw new Error("Cannot enable encryption: no cryptoStore provided");E.logger.log("Crypto: Starting up crypto store..."),await this.cryptoStore.startup(),E.logger.log("Crypto: initialising roomlist..."),await this.roomList.init();const e=this.getUserId();if(null===e)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(null===this.deviceId)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");const t=new w.Crypto(this,e,this.deviceId,this.store,this.cryptoStore,this.roomList,this.verificationMethods);this.reEmitter.reEmit(t,[w.CryptoEvent.KeyBackupFailed,w.CryptoEvent.KeyBackupSessionsRemaining,w.CryptoEvent.RoomKeyRequest,w.CryptoEvent.RoomKeyRequestCancellation,w.CryptoEvent.Warning,w.CryptoEvent.DevicesUpdated,w.CryptoEvent.WillUpdateDevices,w.CryptoEvent.DeviceVerificationChanged,w.CryptoEvent.UserTrustStatusChanged,w.CryptoEvent.KeysChanged]),E.logger.log("Crypto: initialising crypto object..."),await t.init({exportedOlmDevice:this.exportedOlmDeviceToImport,pickleKey:this.pickleKey}),delete this.exportedOlmDeviceToImport,this.olmVersion=w.Crypto.getOlmVersion(),t.registerEventHandlers(this),this.crypto=t}isCryptoEnabled(){return!!this.crypto}getDeviceEd25519Key(){return this.crypto?this.crypto.getDeviceEd25519Key():null}getDeviceCurve25519Key(){return this.crypto?this.crypto.getDeviceCurve25519Key():null}async uploadKeys(){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.uploadDeviceKeys()}downloadKeys(e,t){return this.crypto?this.crypto.downloadKeys(e,t):Promise.reject(new Error("End-to-end encryption disabled"))}getStoredDevicesForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevicesForUser(e)||[]}getStoredDevice(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevice(e,t)||null}setDeviceVerified(e,t,n=!0){const r=this.setDeviceVerification(e,t,n,null,null);return e==this.credentials.userId&&this.checkKeyBackup(),r}setDeviceBlocked(e,t,n=!0){return this.setDeviceVerification(e,t,null,n,null)}setDeviceKnown(e,t,n=!0){return this.setDeviceVerification(e,t,null,null,n)}async setDeviceVerification(e,t,n,r,i){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.setDeviceVerification(e,t,n,r,i)}requestVerificationDM(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerificationDM(e,t)}findVerificationRequestDMInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.findVerificationRequestDMInProgress(e)}getVerificationRequestsToDeviceInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getVerificationRequestsToDeviceInProgress(e)}requestVerification(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerification(e,t)}beginKeyVerification(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.beginKeyVerification(e,t,n)}checkSecretStorageKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStorageKey(e,t)}setGlobalBlacklistUnverifiedDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setGlobalBlacklistUnverifiedDevices(e)}getGlobalBlacklistUnverifiedDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getGlobalBlacklistUnverifiedDevices()}setGlobalErrorOnUnknownDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setGlobalErrorOnUnknownDevices(e)}getGlobalErrorOnUnknownDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getGlobalErrorOnUnknownDevices()}getCrossSigningId(e=P.CrossSigningKey.Master){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCrossSigningId(e)}getStoredCrossSigningForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredCrossSigningForUser(e)}checkUserTrust(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkUserTrust(e)}checkDeviceTrust(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkDeviceTrust(e,t)}checkIfOwnDeviceCrossSigned(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkIfOwnDeviceCrossSigned(e)}checkOwnCrossSigningTrust(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkOwnCrossSigningTrust(e)}checkCrossSigningPrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkCrossSigningPrivateKey(e,t)}legacyDeviceVerification(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.legacyDeviceVerification(e,t,n)}prepareToEncrypt(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.prepareToEncrypt(e)}isCrossSigningReady(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isCrossSigningReady()}bootstrapCrossSigning(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.bootstrapCrossSigning(e)}getCryptoTrustCrossSignedDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCryptoTrustCrossSignedDevices()}setCryptoTrustCrossSignedDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setCryptoTrustCrossSignedDevices(e)}countSessionsNeedingBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.countSessionsNeedingBackup()}getEventEncryptionInfo(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getEventEncryptionInfo(e)}createRecoveryKeyFromPassphrase(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.createRecoveryKeyFromPassphrase(e)}isSecretStorageReady(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isSecretStorageReady()}bootstrapSecretStorage(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.bootstrapSecretStorage(e)}addSecretStorageKey(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.addSecretStorageKey(e,t,n)}hasSecretStorageKey(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.hasSecretStorageKey(e)}storeSecret(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.storeSecret(e,t,n)}getSecret(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getSecret(e)}isSecretStored(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isSecretStored(e)}requestSecret(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestSecret(e,t)}getDefaultSecretStorageKeyId(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getDefaultSecretStorageKeyId()}setDefaultSecretStorageKeyId(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setDefaultSecretStorageKeyId(e)}checkSecretStoragePrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStoragePrivateKey(e,t)}async getEventSenderDeviceInfo(e){return this.crypto?this.crypto.getEventSenderDeviceInfo(e):null}async isEventSenderVerified(e){const t=await this.getEventSenderDeviceInfo(e);return!!t&&t.isVerified()}cancelAndResendEventRoomKeyRequest(e){return e.cancelAndResendKeyRequest(this.crypto,this.getUserId())}setRoomEncryption(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.setRoomEncryption(e,t)}isRoomEncrypted(e){const t=this.getRoom(e);if(!t)return!1;const n=t.currentState.getStateEvents(D.EventType.RoomEncryption,"");return!!n||this.roomList.isRoomEncrypted(e)}forceDiscardSession(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");this.crypto.forceDiscardSession(e)}exportRoomKeys(){return this.crypto?this.crypto.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))}importRoomKeys(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.importRoomKeys(e,t)}checkKeyBackup(){return this.crypto.backupManager.checkKeyBackup()}async getKeyBackupVersion(){let e;try{e=await this.http.authedRequest(void 0,b.Method.Get,"/room_keys/version",void 0,void 0,{prefix:b.PREFIX_UNSTABLE})}catch(t){if("M_NOT_FOUND"===t.errcode)return null;throw t}return N.BackupManager.checkBackupVersion(e),e}isKeyBackupTrusted(e){return this.crypto.backupManager.isKeyBackupTrusted(e)}getKeyBackupEnabled(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.getKeyBackupEnabled()}enableKeyBackup(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.enableKeyBackup(e)}disableKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.disableKeyBackup()}async prepareKeyBackupVersion(e,t={secureSecretStorage:!1}){if(!this.crypto)throw new Error("End-to-end encryption disabled");const{algorithm:n,auth_data:r,recovery_key:i,privateKey:o}=await this.crypto.backupManager.prepareKeyBackupVersion(e);return t.secureSecretStorage&&(await this.storeSecret("m.megolm_backup.v1",(0,y.encodeBase64)(o)),E.logger.info("Key backup private key stored in secret storage")),{algorithm:n,auth_data:r,recovery_key:i}}isKeyBackupKeyStored(){return Promise.resolve(this.isSecretStored("m.megolm_backup.v1"))}async createKeyBackupVersion(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.createKeyBackupVersion(e);const t={algorithm:e.algorithm,auth_data:e.auth_data};await this.crypto.signObject(t.auth_data),this.cryptoCallbacks.getCrossSigningKey&&this.crypto.crossSigningInfo.getId()&&await this.crypto.crossSigningInfo.signObject(t.auth_data,"master");const n=await this.http.authedRequest(void 0,b.Method.Post,"/room_keys/version",void 0,t,{prefix:b.PREFIX_UNSTABLE});return await this.checkKeyBackup(),this.getKeyBackupEnabled()||E.logger.error("Key backup not usable even though we just created it"),n}deleteKeyBackupVersion(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.version&&this.crypto.backupManager.disableKeyBackup();const t=h.encodeUri("/room_keys/version/$version",{$version:e});return this.http.authedRequest(void 0,b.Method.Delete,t,void 0,void 0,{prefix:b.PREFIX_UNSTABLE})}makeKeyBackupPath(e,t,n){let r;r=void 0!==t?h.encodeUri("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?h.encodeUri("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys";const i=void 0===n?void 0:{version:n};return{path:r,queryData:i}}sendKeyBackup(e,t,n,r){if(!this.crypto)throw new Error("End-to-end encryption disabled");const i=this.makeKeyBackupPath(e,t,n);return this.http.authedRequest(void 0,b.Method.Put,i.path,i.queryData,r,{prefix:b.PREFIX_UNSTABLE})}async scheduleAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.scheduleAllGroupSessionsForBackup()}flagAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.flagAllGroupSessionsForBackup()}isValidRecoveryKey(e){try{return(0,_.decodeRecoveryKey)(e),!0}catch(t){return!1}}keyBackupKeyFromPassword(e,t){return(0,T.keyFromAuthData)(t.auth_data,e)}keyBackupKeyFromRecoveryKey(e){return(0,_.decodeRecoveryKey)(e)}async restoreKeyBackupWithPassword(e,t,n,r,i){const o=await(0,T.keyFromAuthData)(r.auth_data,e);return this.restoreKeyBackup(o,t,n,r,i)}async restoreKeyBackupWithSecretStorage(e,t,n,r){const i=await this.getSecret("m.megolm_backup.v1"),o=(0,w.fixBackupKey)(i);if(o){const[e]=await this.crypto.getSecretStorageKey();await this.storeSecret("m.megolm_backup.v1",o,[e])}const s=(0,y.decodeBase64)(o||i);return this.restoreKeyBackup(s,t,n,e,r)}restoreKeyBackupWithRecoveryKey(e,t,n,r,i){const o=(0,_.decodeRecoveryKey)(e);return this.restoreKeyBackup(o,t,n,r,i)}async restoreKeyBackupWithCache(e,t,n,r){const i=await this.crypto.getSessionBackupPrivateKey();if(!i)throw new Error("Couldn't get key");return this.restoreKeyBackup(i,e,t,n,r)}async restoreKeyBackup(e,t,n,r,i){const o=null===i||void 0===i?void 0:i.cacheCompleteCallback,s=null===i||void 0===i?void 0:i.progressCallback;if(!this.crypto)throw new Error("End-to-end encryption disabled");let a=0,c=[];const l=this.makeKeyBackupPath(t,n,r.version),d=await N.BackupManager.makeAlgorithm(r,(async()=>e)),u=d.untrusted;try{if(!await d.keyMatches(e))return Promise.reject(new b.MatrixError({errcode:ie.RESTORE_BACKUP_ERROR_BAD_KEY}));this.crypto.storeSessionBackupPrivateKey(e).catch((e=>{E.logger.warn("Error caching session backup key:",e)})).then(o),s&&s({stage:"fetch"});const r=await this.http.authedRequest(void 0,b.Method.Get,l.path,l.queryData,void 0,{prefix:b.PREFIX_UNSTABLE});if(r.rooms){const e=r.rooms;for(const[t,n]of Object.entries(e)){if(!n.sessions)continue;a+=Object.keys(n.sessions).length;const e=await d.decryptSessions(n.sessions);for(const n of e)n.room_id=t,c.push(n)}}else if(r.sessions){const e=r.sessions;a=Object.keys(e).length,c=await d.decryptSessions(e);for(const n of c)n.room_id=t}else{a=1;try{const[e]=await d.decryptSessions({[n]:r});e.room_id=t,e.session_id=n,c.push(e)}catch(h){E.logger.log("Failed to decrypt megolm session from backup",h)}}}finally{d.free()}return await this.importRoomKeys(c,{progressCallback:s,untrusted:u,source:"backup"}),await this.checkKeyBackup(),{total:a,imported:c.length}}deleteKeysFromBackup(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");const r=this.makeKeyBackupPath(e,t,n);return this.http.authedRequest(void 0,b.Method.Delete,r.path,r.queryData,void 0,{prefix:b.PREFIX_UNSTABLE})}async sendSharedHistoryKeys(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");const n=this.roomList.getRoomEncryption(e);if(!n)return void E.logger.error("Unknown room.  Not sharing decryption keys");const r=await this.crypto.downloadKeys(t),i={};for(const[s,a]of Object.entries(r))i[s]=Object.values(a);const o=this.crypto.getRoomDecryptor(e,n.algorithm);o.sendSharedHistoryInboundSessions?await o.sendSharedHistoryInboundSessions(i):E.logger.warn("Algorithm does not support sharing previous keys",n.algorithm)}getMediaConfig(e){return this.http.authedRequest(e,b.Method.Get,"/config",void 0,void 0,{prefix:b.PREFIX_MEDIA_R0})}getRoom(e){return this.store.getRoom(e)}getRooms(){return this.store.getRooms()}getVisibleRooms(){const e=this.store.getRooms(),t=new Set;for(const n of e){const e=n.currentState.getStateEvents(D.EventType.RoomCreate,"");if(e){const n=e.getContent()["predecessor"];n&&n["room_id"]&&t.add(n["room_id"])}}return e.filter((e=>{const n=e.currentState.getStateEvents(D.EventType.RoomTombstone,"");return!n||!t.has(e.roomId)}))}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t,n){const r=h.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e}),i=(0,b.retryNetworkOperation)(5,(()=>this.http.authedRequest(void 0,b.Method.Put,r,void 0,t)));return n&&i.then((e=>n(null,e)),n),i}getAccountData(e){return this.store.getAccountData(e)}async getAccountDataFromServer(e){if(this.isInitialSyncComplete()){const t=this.store.getAccountData(e);return t?t.getContent():null}const t=h.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});try{return await this.http.authedRequest(void 0,b.Method.Get,t)}catch(r){var n;if("M_NOT_FOUND"===(null===(n=r.data)||void 0===n?void 0:n.errcode))return null;throw r}}getIgnoredUsers(){const e=this.getAccountData("m.ignored_user_list");return e&&e.getContent()&&e.getContent()["ignored_users"]?Object.keys(e.getContent()["ignored_users"]):[]}setIgnoredUsers(e,t){const n={ignored_users:{}};return e.forEach((e=>{n.ignored_users[e]={}})),this.setAccountData("m.ignored_user_list",n,t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}async joinRoom(e,t,n){if(h.isFunction(t))throw new Error("Expected 'opts' object, got function.");t=t||{},void 0===t.syncRoom&&(t.syncRoom=!0);const r=this.getRoom(e);if(r&&r.hasMembershipState(this.credentials.userId,"join"))return Promise.resolve(r);let i=Promise.resolve();t.inviteSignUrl&&(i=this.http.requestOtherUrl(void 0,b.Method.Post,t.inviteSignUrl,{mxid:this.credentials.userId}));const o={};t.viaServers&&(o["server_name"]=t.viaServers);const a={qsStringifyOptions:{arrayFormat:"repeat"}};try{const r={},c=await i;c&&(r.third_party_signed=c);const l=h.encodeUri("/join/$roomid",{$roomid:e}),d=await this.http.authedRequest(void 0,b.Method.Post,l,o,r,a),u=d["room_id"],g=new s.SyncApi(this,this.clientOpts),p=g.createRoom(u);return t.syncRoom,null===n||void 0===n||n(null,p),p}catch(c){throw null===n||void 0===n||n(c),c}}resendEvent(e,t){return this.updatePendingEventStatus(t,e,a.EventStatus.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![a.EventStatus.QUEUED,a.EventStatus.NOT_SENT,a.EventStatus.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===a.EventStatus.ENCRYPTING?this.pendingEventEncryption.delete(e.getId()):this.scheduler&&e.status===a.EventStatus.QUEUED&&this.scheduler.removeEventFromQueue(e);const t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,a.EventStatus.CANCELLED)}setRoomName(e,t,n){return this.sendStateEvent(e,D.EventType.RoomName,{name:t},void 0,n)}setRoomTopic(e,t,n){const r="function"===typeof n,i=r?void 0:n,o=r?n:void 0,s=M.makeTopicContent(t,i);return this.sendStateEvent(e,D.EventType.RoomTopic,s,void 0,o)}getRoomTags(e,t){const n=h.encodeUri("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(t,b.Method.Get,n)}setRoomTag(e,t,n,r){const i=h.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(r,b.Method.Put,i,void 0,n)}deleteRoomTag(e,t,n){const r=h.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(n,b.Method.Delete,r)}setRoomAccountData(e,t,n,r){const i=h.encodeUri("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(r,b.Method.Put,i,void 0,n)}setPowerLevel(e,t,n,r,i){let o={users:{}};(null===r||void 0===r?void 0:r.getType())===D.EventType.RoomPowerLevels&&(o=h.deepCopy(r.getContent())),o.users[t]=n;const s=h.encodeUri("/rooms/$roomId/state/m.room.power_levels",{$roomId:e});return this.http.authedRequest(i,b.Method.Put,s,void 0,o)}async unstable_createLiveBeacon(e,t){return this.unstable_setLiveBeacon(e,t)}async unstable_setLiveBeacon(e,t){const n=this.getUserId();return this.sendStateEvent(e,V.M_BEACON_INFO.name,t,n)}sendEvent(e,t,n,r,i,o){var s,a;if(null!==(s=t)&&void 0!==s&&s.startsWith(ne)||null===t||(o=i,i=r,r=n,n=t,t=null),t&&(null===(a=r["m.relates_to"])||void 0===a||!a.rel_type)){var c,l;const n=!(null===(c=r["m.relates_to"])||void 0===c||!c["m.in_reply_to"]);r["m.relates_to"]=Y(Y({},r["m.relates_to"]),{},{rel_type:$.THREAD_RELATION_TYPE.name,event_id:t,is_falling_back:!n});const i=null===(l=this.getRoom(e))||void 0===l?void 0:l.getThread(t);var d,u;if(i&&!n)r["m.relates_to"]["m.in_reply_to"]={event_id:null!==(d=null===(u=i.lastReply((e=>e.isRelation($.THREAD_RELATION_TYPE.name)&&!e.status)))||void 0===u?void 0:u.getId())&&void 0!==d?d:t}}return this.sendCompleteEvent(e,t,{type:n,content:r},i,o)}sendCompleteEvent(e,t,n,r,i){h.isFunction(r)&&(i=r,r=void 0),r||(r=this.makeTxnId());const o=new a.MatrixEvent(Object.assign(n,{event_id:"~"+e+":"+r,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:(new Date).getTime()})),s=this.getRoom(e),c=null===s||void 0===s?void 0:s.getThread(t);c&&o.setThread(c),this.reEmitter.reEmit(o,[a.MatrixEventEvent.Replaced,a.MatrixEventEvent.VisibilityChange]),null===s||void 0===s||s.reEmitter.reEmit(o,[a.MatrixEventEvent.BeforeRedaction]);const l=o.getAssociatedId();if(null!==l&&void 0!==l&&l.startsWith("~")){const e=s.getPendingEvents().find((e=>e.getId()===l));e.once(a.MatrixEventEvent.LocalEventIdReplaced,(()=>{o.updateAssociatedId(e.getId())}))}const d=o.getType();return E.logger.log(`sendEvent of type ${d} in ${e} with txnId ${r}`),o.setTxnId(r),o.setStatus(a.EventStatus.SENDING),null===s||void 0===s||s.addPendingEvent(o,r),o.status===a.EventStatus.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(s,o,i)}encryptAndSendEvent(e,t,n){let r=!1;return Promise.resolve().then((()=>{const n=this.encryptEventIfNeeded(t,e);return n?(this.pendingEventEncryption.set(t.getId(),n),this.updatePendingEventStatus(e,t,a.EventStatus.ENCRYPTING),n.then((()=>{this.pendingEventEncryption.has(t.getId())?this.updatePendingEventStatus(e,t,a.EventStatus.SENDING):r=!0}))):null})).then((()=>{if(r)return{};let n;return this.scheduler&&(n=this.scheduler.queueEvent(t),n&&this.scheduler.getQueueForEvent(t).length>1&&this.updatePendingEventStatus(e,t,a.EventStatus.QUEUED)),n||(n=this.sendEventHttpRequest(t),e&&(n=n.then((n=>(e.updatePendingEvent(t,a.EventStatus.SENT,n["event_id"]),n))))),n})).then((e=>(null===n||void 0===n||n(null,e),e))).catch((r=>{E.logger.error("Error sending event",r.stack||r);try{t.error=r,this.updatePendingEventStatus(e,t,a.EventStatus.NOT_SENT),r.event=t,null===n||void 0===n||n(r)}catch(i){E.logger.error("Exception in error handler!",i.stack||r)}throw r}))}encryptEventIfNeeded(e,t){if(e.isEncrypted())return null;if(e.isRedaction())return null;if(!this.isRoomEncrypted(e.getRoomId()))return null;if(!this.crypto&&this.usingExternalCrypto)return null;if(e.getType()===D.EventType.Reaction)return null;if(!this.crypto)throw new Error("This room is configured to use encryption, but your client does not support encryption.");return this.crypto.encryptEvent(e,t)}getEncryptedIfNeededEventType(e,t){return t===D.EventType.Reaction?t:this.isRoomEncrypted(e)?D.EventType.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,n){e?e.updatePendingEvent(t,n):t.setStatus(n)}sendEventHttpRequest(e){let t=e.getTxnId();t||(t=this.makeTxnId(),e.setTxnId(t));const n={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:t};let r;if(e.isState()){let t="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(t="/rooms/$roomId/state/$eventType/$stateKey"),r=h.encodeUri(t,n)}else if(e.isRedaction()){const t="/rooms/$roomId/redact/$redactsEventId/$txnId";r=h.encodeUri(t,Object.assign({$redactsEventId:e.event.redacts},n))}else r=h.encodeUri("/rooms/$roomId/send/$eventType/$txnId",n);return this.http.authedRequest(void 0,b.Method.Put,r,void 0,e.getWireContent()).then((t=>(E.logger.log(`Event sent to ${e.getRoomId()} with event id ${t.event_id}`),t)))}redactEvent(e,t,n,r,i){var o;null!==(o=n)&&void 0!==o&&o.startsWith(ne)||(i=r,r=n,n=t,t=null);const s="object"===typeof i?i:{},a=s.reason,c="function"===typeof i?i:void 0;return this.sendCompleteEvent(e,t,{type:D.EventType.RoomRedaction,content:{reason:a},redacts:n},r,c)}sendMessage(e,t,n,r,i){"string"!==typeof t&&null!==t&&(i=r,r=n,n=t,t=null),h.isFunction(r)&&(i=r,r=void 0);let s=D.EventType.RoomMessage,a=n;const c=(e={},t=!0)=>{let n=null;if(e["msgtype"]===D.MsgType.Text?n=o.MessageEvent.from(e["body"],e["formatted_body"]).serialize():e["msgtype"]===D.MsgType.Emote?n=o.EmoteEvent.from(e["body"],e["formatted_body"]).serialize():e["msgtype"]===D.MsgType.Notice&&(n=o.NoticeEvent.from(e["body"],e["formatted_body"]).serialize()),n&&e["m.new_content"]&&t){const t=c(e["m.new_content"],!1);t&&(n.content["m.new_content"]=t.content)}if(n)for(const[r,i]of Object.entries(e))n.content.hasOwnProperty(r)||(n.content[r]=i);return n},l=c(a);return l&&(s=l.type,a=l.content),this.sendEvent(e,t,s,a,r,i)}sendTextMessage(e,t,n,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith(ne)||null===t||(i=r,r=n,n=t,t=null);const s=M.makeTextMessage(n);return this.sendMessage(e,t,s,r,i)}sendNotice(e,t,n,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith(ne)||null===t||(i=r,r=n,n=t,t=null);const s=M.makeNotice(n);return this.sendMessage(e,t,s,r,i)}sendEmoteMessage(e,t,n,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith(ne)||null===t||(i=r,r=n,n=t,t=null);const s=M.makeEmoteMessage(n);return this.sendMessage(e,t,s,r,i)}sendImageMessage(e,t,n,r,i="Image",o){var s;null!==(s=t)&&void 0!==s&&s.startsWith(ne)||null===t||(o=i,i=r||"Image",r=n,n=t,t=null),h.isFunction(i)&&(o=i,i=void 0);const a={msgtype:D.MsgType.Image,url:n,info:r,body:i};return this.sendMessage(e,t,a,void 0,o)}sendStickerMessage(e,t,n,r,i="Sticker",o){var s;null!==(s=t)&&void 0!==s&&s.startsWith(ne)||null===t||(o=i,i=r||"Sticker",r=n,n=t,t=null),h.isFunction(i)&&(o=i,i=void 0);const a={url:n,info:r,body:i};return this.sendEvent(e,t,D.EventType.Sticker,a,void 0,o)}sendHtmlMessage(e,t,n,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith(ne)||null===t||(i=r,r=n,n=t,t=null);const s=M.makeHtmlMessage(n,r);return this.sendMessage(e,t,s,void 0,i)}sendHtmlNotice(e,t,n,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith(ne)||null===t||(i=r,r=n,n=t,t=null);const s=M.makeHtmlNotice(n,r);return this.sendMessage(e,t,s,void 0,i)}sendHtmlEmote(e,t,n,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith(ne)||null===t||(i=r,r=n,n=t,t=null);const s=M.makeHtmlEmote(n,r);return this.sendMessage(e,t,s,void 0,i)}sendReceipt(e,t,n,r){if("function"===typeof n&&(r=n,n={}),this.isGuest())return Promise.resolve({});const i=h.encodeUri("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),o=this.http.authedRequest(r,b.Method.Post,i,void 0,n||{}),s=this.getRoom(e.getRoomId());return s&&s.addLocalEchoReceipt(this.credentials.userId,e,t),o}async sendReadReceipt(e,t=q.ReceiptType.Read,n){const r=e.getId(),i=this.getRoom(e.getRoomId());if(i&&i.hasPendingEvent(r))throw new Error(`Cannot set read receipt to a pending event (${r})`);return this.sendReceipt(e,t,{},n)}async setRoomReadMarkers(e,t,n,r){const i=this.getRoom(e);if(i&&i.hasPendingEvent(t))throw new Error(`Cannot set read marker to a pending event (${t})`);let o,s;if(n){if(o=n.getId(),null!==i&&void 0!==i&&i.hasPendingEvent(o))throw new Error(`Cannot set read receipt to a pending event (${o})`);null===i||void 0===i||i.addLocalEchoReceipt(this.credentials.userId,n,q.ReceiptType.Read)}if(r){if(s=r.getId(),null!==i&&void 0!==i&&i.hasPendingEvent(s))throw new Error(`Cannot set read receipt to a pending event (${s})`);null===i||void 0===i||i.addLocalEchoReceipt(this.credentials.userId,r,q.ReceiptType.ReadPrivate)}return this.setRoomReadMarkersHttpRequest(e,t,o,s)}getUrlPreview(e,t,n){t=6e4*Math.floor(t/6e4);const r=new URL(e);r.hash="",e=r.toString();const i=t+"_"+e,o=this.urlPreviewCache[i];if(o)return n&&o.then(n).catch(n),o;const s=this.http.authedRequest(n,b.Method.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:b.PREFIX_MEDIA_R0});return this.urlPreviewCache[i]=s,s}sendTyping(e,t,n,r){if(this.isGuest())return Promise.resolve({});const i=h.encodeUri("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.credentials.userId}),o={typing:t};return t&&(o.timeout=n||2e4),this.http.authedRequest(r,b.Method.Put,i,void 0,o)}getRoomUpgradeHistory(e,t=!1){let n=this.getRoom(e);if(!n)return[];const r=[n];let i=n.currentState.getStateEvents(D.EventType.RoomCreate,"");while(i){const e=i.getContent()["predecessor"];if(!e||!e["room_id"])break;{const n=this.getRoom(e["room_id"]);if(!n)break;if(t){const e=n.currentState.getStateEvents(D.EventType.RoomTombstone,"");if(!e||e.getContent()["replacement_room"]!==n.roomId)break}r.splice(0,0,n),i=n.currentState.getStateEvents(D.EventType.RoomCreate,"")}}let o=n.currentState.getStateEvents(D.EventType.RoomTombstone,"");while(o){const e=this.getRoom(o.getContent()["replacement_room"]);if(!e)break;if(e.roomId===n.roomId)break;if(t){if(i=e.currentState.getStateEvents(D.EventType.RoomCreate,""),!i||!i.getContent()["predecessor"])break;const t=i.getContent()["predecessor"];if(t["room_id"]!==n.roomId)break}r.push(e);const s=new Set(r.map((e=>e.roomId)));if(s.size<r.length)return r.slice(0,r.length-1);n=e,o=n.currentState.getStateEvents(D.EventType.RoomTombstone,"")}return r}invite(e,t,n,r){return this.membershipChange(e,t,"invite",r,n)}inviteByEmail(e,t,n){return this.inviteByThreePid(e,"email",t,n)}async inviteByThreePid(e,t,n,r){var i;const o=h.encodeUri("/rooms/$roomId/invite",{$roomId:e}),s=this.getIdentityServerUrl(!0);if(!s)return Promise.reject(new b.MatrixError({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));const a={id_server:s,medium:t,address:n};if(null!==(i=this.identityServer)&&void 0!==i&&i.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(a["id_access_token"]=e)}return this.http.authedRequest(r,b.Method.Post,o,void 0,a)}leave(e,t){return this.membershipChange(e,void 0,"leave",void 0,t)}leaveRoomChain(e,t=!0){const n=this.getRoomUpgradeHistory(e);let r=n;if(!t){r=[];for(const t of n)if(r.push(t),t.roomId===e)break}const i={},o=[],s=e=>this.leave(e).then((()=>{i[e]=null})).catch((t=>(i[e]=t,null)));for(const a of r)o.push(s(a.roomId));return Promise.all(o).then((()=>i))}ban(e,t,n,r){return this.membershipChange(e,t,"ban",n,r)}forget(e,t,n){void 0===t&&(t=!0);const r=this.membershipChange(e,void 0,"forget",void 0,n);return t?r.then((t=>(this.store.removeRoom(e),this.emit(re.DeleteRoom,e),t))):r}unban(e,t,n){const r=h.encodeUri("/rooms/$roomId/unban",{$roomId:e}),i={user_id:t};return this.http.authedRequest(n,b.Method.Post,r,void 0,i)}kick(e,t,n,r){const i=h.encodeUri("/rooms/$roomId/kick",{$roomId:e}),o={user_id:t,reason:n};return this.http.authedRequest(r,b.Method.Post,i,void 0,o)}membershipChange(e,t,n,r,i){h.isFunction(r)&&(i=r,r=void 0);const o=h.encodeUri("/rooms/$room_id/$membership",{$room_id:e,$membership:n});return this.http.authedRequest(i,b.Method.Post,o,void 0,{user_id:t,reason:r})}getPushActionsForEvent(e,t=!1){return e.getPushActions()&&!t||e.setPushActions(this.pushProcessor.actionsForEvent(e)),e.getPushActions()}setProfileInfo(e,t,n){const r=h.encodeUri("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(n,b.Method.Put,r,void 0,t)}async setDisplayName(e,t){const n=await this.setProfileInfo("displayname",{displayname:e},t),r=this.getUser(this.getUserId());return r&&(r.displayName=e,r.emit(I.UserEvent.DisplayName,r.events.presence,r)),n}async setAvatarUrl(e,t){const n=await this.setProfileInfo("avatar_url",{avatar_url:e},t),r=this.getUser(this.getUserId());return r&&(r.avatarUrl=e,r.emit(I.UserEvent.AvatarUrl,r.events.presence,r)),n}mxcUrlToHttp(e,t,n,r,i){return(0,R.getHttpUriForMxc)(this.baseUrl,e,t,n,r,i)}setPresence(e,t){const n=h.encodeUri("/presence/$userId/status",{$userId:this.credentials.userId});"string"===typeof e&&(e={presence:e});const r=["offline","online","unavailable"];if(-1===r.indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);return this.http.authedRequest(t,b.Method.Put,n,void 0,e)}getPresence(e,t){const n=h.encodeUri("/presence/$userId/status",{$userId:e});return this.http.authedRequest(t,b.Method.Get,n)}scrollback(e,t=30,n){h.isFunction(t)&&(n=t,t=void 0);let r=0,i=this.ongoingScrollbacks[e.roomId]||{};if(i.promise)return i.promise;if(i.errorTs){const e=Date.now()-i.errorTs;r=Math.max(J-e,0)}if(null===e.oldState.paginationToken)return Promise.resolve(e);const o=this.store.scrollback(e,t).length;if(o===t)return Promise.resolve(e);t-=o;const s=new Promise(((i,o)=>{(0,h.sleep)(r).then((()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,g.Direction.Backward))).then((t=>{var r;const o=t.chunk.map(this.getEventMapper());if(t.state){const n=t.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(n)}const[s,a]=e.partitionThreadedEvents(o);this.processBeaconEvents(e,s),e.addEventsToTimeline(s,!0,e.getLiveTimeline()),this.processThreadEvents(e,a,!0),e.oldState.paginationToken=t.end,0===t.chunk.length&&(e.oldState.paginationToken=null),this.store.storeEvents(e,o,t.end,!0),this.ongoingScrollbacks[e.roomId]=null,null===(r=n)||void 0===r||r(null,e),i(e)})).catch((t=>{var r;this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},null===(r=n)||void 0===r||r(t),o(t)}))}));return i={promise:s,errorTs:null},this.ongoingScrollbacks[e.roomId]=i,s}getEventMapper(e){return(0,U.eventMapperFor)(this,e||{})}async getEventTimeline(e,t){var n,r,i;if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);const o=h.encodeUri("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t});let s;this.clientOpts.lazyLoadMembers&&(s={filter:JSON.stringify(d.Filter.LAZY_LOADING_MESSAGES_FILTER)});const a=await this.http.authedRequest(void 0,b.Method.Get,o,s);if(!a.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);const c=this.getEventMapper(),l=c(a.event),u=[...a.events_after.reverse().map(c),l,...a.events_before.map(c)];if(this.supportsExperimentalThreads()){if(!e.canContain(l))return;if($.Thread.hasServerSideSupport&&e.thread){const n=e.thread,r={direction:g.Direction.Backward,limit:50};await n.fetchInitialEvents();let i=n.liveTimeline.getPaginationToken(g.Direction.Backward);while(!n.findEventById(t))if(i&&(r.from=i),({nextBatch:i}=await n.fetchEvents(r)),!i)break;return n.liveTimeline}}let p=e.getTimelineForEvent(u[0].getId());p?p.getState(g.EventTimeline.BACKWARDS).setUnknownStateEvents(a.state.map(c)):(p=e.addTimeline(),p.initialiseState(a.state.map(c)),p.getState(g.EventTimeline.FORWARDS).paginationToken=a.end);const[f,y]=e.room.partitionThreadedEvents(u);return e.addEventsToTimeline(f,!0,p,a.start),this.processThreadEvents(e.room,y,!0),this.processBeaconEvents(e.room,f),null!==(n=null!==(r=e.getTimelineForEvent(t))&&void 0!==r?r:null===(i=e.room.findThreadForEvent(l))||void 0===i?void 0:i.liveTimeline)&&void 0!==n?n:p}async getLatestTimeline(e){var t;if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");const n=h.encodeUri("/rooms/$roomId/messages",{$roomId:e.room.roomId}),r={dir:"b"};this.clientOpts.lazyLoadMembers&&(r.filter=JSON.stringify(d.Filter.LAZY_LOADING_MESSAGES_FILTER));const i=await this.http.authedRequest(void 0,b.Method.Get,n,r),o=null===(t=i.chunk)||void 0===t?void 0:t[0];if(!o)throw new Error("No message returned from /messages when trying to construct getLatestTimeline");return this.getEventTimeline(e,o.event_id)}createMessagesRequest(e,t,n=30,r,i){const o=h.encodeUri("/rooms/$roomId/messages",{$roomId:e}),s={limit:n.toString(),dir:r};t&&(s.from=t);let a=null;var c;(this.clientOpts.lazyLoadMembers&&(a=Object.assign({},d.Filter.LAZY_LOADING_MESSAGES_FILTER)),i)&&(a=a||{},Object.assign(a,null===(c=i.getRoomTimelineFilterComponent())||void 0===c?void 0:c.toJSON()));return a&&(s.filter=JSON.stringify(a)),this.http.authedRequest(void 0,b.Method.Get,o,s)}paginateEventTimeline(e,t){const n=e.getTimelineSet()===this.notifTimelineSet;t=t||{};const r=t.backwards||!1;if(n&&!r)throw new Error("paginateNotifTimeline can only paginate backwards");const i=r?g.EventTimeline.BACKWARDS:g.EventTimeline.FORWARDS,o=e.getPaginationToken(i),s=e.paginationRequests[i];if(s)return s;let a,c,l;if(n){var d;a="/notifications",c={limit:(null!==(d=t.limit)&&void 0!==d?d:30).toString(),only:"highlight"},"end"!==o&&(c.from=o),l=this.http.authedRequest(void 0,b.Method.Get,a,c).then((async t=>{const n=t.next_token,o=[];for(let e=0;e<t.notifications.length;e++){const n=t.notifications[e],r=this.getEventMapper()(n.event);r.setPushActions(p.PushProcessor.actionListToActionsObject(n.actions)),r.event.room_id=n.room_id,o[e]=r}const s=e.getTimelineSet();return s.addEventsToTimeline(o,r,e,n),this.processBeaconEvents(s.room,o),r&&!t.next_token&&e.setPaginationToken(null,i),!!t.next_token})).finally((()=>{e.paginationRequests[i]=null})),e.paginationRequests[i]=l}else{const n=this.getRoom(e.getRoomId());if(!n)throw new Error("Unknown room "+e.getRoomId());l=this.createMessagesRequest(e.getRoomId(),o,t.limit,i,e.getFilter()).then((t=>{if(t.state){const n=e.getState(i),r=t.state.map(this.getEventMapper());n.setUnknownStateEvents(r)}const o=t.end,s=t.chunk.map(this.getEventMapper()),a=e.getTimelineSet(),[c,l]=a.room.partitionThreadedEvents(s);return a.addEventsToTimeline(c,r,e,o),this.processBeaconEvents(a.room,c),this.processThreadEvents(n,l,r),r&&t.end==t.start&&e.setPaginationToken(null,i),t.end!=t.start})).finally((()=>{e.paginationRequests[i]=null})),e.paginationRequests[i]=l}return l}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end",null)}peekInRoom(e){return this.peekSync&&this.peekSync.stopPeeking(),this.peekSync=new s.SyncApi(this,this.clientOpts),this.peekSync.peek(e)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){const n=this.sendStateEvent(e,D.EventType.RoomGuestAccess,{guest_access:t.allowJoin?"can_join":"forbidden"},"");let r=Promise.resolve(void 0);return t.allowRead&&(r=this.sendStateEvent(e,D.EventType.RoomHistoryVisibility,{history_visibility:"world_readable"},"")),Promise.all([r,n]).then()}requestRegisterEmailToken(e,t,n,r){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:r})}requestRegisterMsisdnToken(e,t,n,r,i){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:r,next_link:i})}requestAdd3pidEmailToken(e,t,n,r){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:r})}requestAdd3pidMsisdnToken(e,t,n,r,i){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:r,next_link:i})}requestPasswordEmailToken(e,t,n,r){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:r})}requestPasswordMsisdnToken(e,t,n,r,i){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:r,next_link:i})}async requestTokenFromEndpoint(e,t){const n=Object.assign({},t);if(!await this.doesServerSupportSeparateAddAndBind()&&this.idBaseUrl){var r;const e=new URL(this.idBaseUrl);if(n.id_server=e.host,null!==(r=this.identityServer)&&void 0!==r&&r.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(n.id_access_token=e)}}return this.http.request(void 0,b.Method.Post,e,void 0,n)}getRoomPushRule(e,t){if(!this.pushRules)throw new Error("SyncApi.sync() must be done before accessing to push rules.");for(let n=0;n<this.pushRules[e].room.length;n++){const r=this.pushRules[e].room[n];if(r.rule_id===t)return r}}setRoomMutePushRule(e,t,n){let r,i=!1;const o=this.getRoomPushRule(e,t);if(null!==o&&void 0!==o&&o.actions.includes(C.PushRuleActionName.DontNotify)&&(i=!0),n)if(o){if(!i){const n=h.defer();this.deletePushRule(e,x.PushRuleKind.RoomSpecific,o.rule_id).then((()=>{this.addPushRule(e,x.PushRuleKind.RoomSpecific,t,{actions:[C.PushRuleActionName.DontNotify]}).then((()=>{n.resolve()})).catch((e=>{n.reject(e)}))})).catch((e=>{n.reject(e)})),r=n.promise}}else r=this.addPushRule(e,x.PushRuleKind.RoomSpecific,t,{actions:[C.PushRuleActionName.DontNotify]});else i&&(r=this.deletePushRule(e,x.PushRuleKind.RoomSpecific,o.rule_id));if(r)return new Promise(((e,t)=>{r.then((()=>{this.getPushRules().then((t=>{this.pushRules=t,e()})).catch((e=>{t(e)}))})).catch((e=>{this.getPushRules().then((n=>{this.pushRules=n,t(e)})).catch((n=>{t(e)}))}))}))}searchMessageText(e,t){const n={search_term:e.query};return"keys"in e&&(n.keys=e.keys),this.search({body:{search_categories:{room_events:n}}},t)}searchRoomEvents(e){const t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:j.SearchOrderBy.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},n={_query:t,results:[],highlights:[]};return this.search({body:t}).then((e=>this.processRoomEventsSearch(n,e)))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;const t={body:e._query,next_batch:e.next_batch},n=this.search(t).then((t=>this.processRoomEventsSearch(e,t))).finally((()=>{e.pendingRequest=null}));return e.pendingRequest=n,n}processRoomEventsSearch(e,t){var n,r;const i=t.search_categories.room_events;e.count=i.count,e.next_batch=i.next_batch;const o=new Set(i.highlights);e.highlights.forEach((e=>{o.add(e)})),e.highlights=Array.from(o);const s=this.getEventMapper(),a=null!==(n=null===(r=i.results)||void 0===r?void 0:r.length)&&void 0!==n?n:0;for(let c=0;c<a;c++){const t=k.SearchResult.fromJson(i.results[c],s),n=this.getRoom(t.context.getEvent().getRoomId());if(n)for(const e of t.context.getTimeline()){const t=n.getMember(e.getSender());!e.sender&&t&&(e.sender=t)}e.results.push(t)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;const e=new s.SyncApi(this,this.clientOpts);return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then((()=>{E.logger.log("Marking success of sync left room request"),this.syncedLeftRooms=!0})).finally((()=>{this.syncLeftRoomsPromise=null})),this.syncLeftRoomsPromise}createFilter(e){const t=h.encodeUri("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(void 0,b.Method.Post,t,void 0,e).then((t=>{const n=d.Filter.fromJson(this.credentials.userId,t.filter_id,e);return this.store.storeFilter(n),n}))}getFilter(e,t,n){if(n){const n=this.store.getFilter(e,t);if(n)return Promise.resolve(n)}const r=h.encodeUri("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(void 0,b.Method.Get,r).then((n=>{const r=d.Filter.fromJson(e,t,n);return this.store.storeFilter(r),r}))}async getOrCreateFilter(e,t){const n=this.store.getFilterIdByName(e);let r;if(n){try{const e=await this.getFilter(this.credentials.userId,n,!0);if(e){const i=e.getDefinition(),o=t.getDefinition();h.deepCompare(i,o)&&(r=n)}}catch(o){if("M_UNKNOWN"!==o.errcode&&"M_NOT_FOUND"!==o.errcode)throw o}r||this.store.setFilterIdByName(e,void 0)}if(r)return r;const i=await this.createFilter(t.getDefinition());return this.store.setFilterIdByName(e,i.filterId),i.filterId}getOpenIdToken(){const e=h.encodeUri("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(void 0,b.Method.Post,e,void 0,{})}turnServer(e){return this.http.authedRequest(e,b.Method.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}async checkTurnServers(){if(!this.canSupportVoip)return;let e=!1;const t=this.turnServersExpiry-Date.now();if(t>X)E.logger.debug("TURN creds are valid for another "+t+" ms: not fetching new ones."),e=!0;else{E.logger.debug("Fetching new TURN credentials");try{const t=await this.turnServer();if(t.uris){E.logger.log("Got TURN URIs: "+t.uris+" refresh in "+t.ttl+" secs");const n={urls:t.uris,username:t.username,credential:t.password};this.turnServers=[n],this.turnServersExpiry=Date.now()+1e3*t.ttl,e=!0}}catch(r){E.logger.error("Failed to get TURN URIs",r),403===r.httpStatus&&(E.logger.info("TURN access unavailable for this account: stopping credentials checks"),null!==this.checkTurnServersIntervalID&&n.g.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=null)}}return e}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){const e=h.encodeUri("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(void 0,b.Method.Get,e,void 0,void 0,{prefix:""}).then((e=>e["admin"]))}whoisSynapseUser(e){const t=h.encodeUri("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(void 0,b.Method.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){const t=h.encodeUri("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(void 0,b.Method.Post,t,void 0,void 0,{prefix:""})}async fetchClientWellKnown(){this.clientWellKnownPromise=f.AutoDiscovery.getRawClientConfig(this.getDomain()),this.clientWellKnown=await this.clientWellKnownPromise,this.emit(re.ClientWellKnown,this.clientWellKnown)}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){return this.clientWellKnownPromise}storeClientOptions(){const e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter((([t,n])=>e.includes(typeof n))).reduce(((e,[t,n])=>(e[t]=n,e)),{});return this.store.storeClientOptions(t)}async _unstable_getSharedRooms(e){const t=await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666"),n=await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666.mutual_rooms");if(!t&&!n)throw Error("Server does not support mutual_rooms API");const r=h.encodeUri(`/uk.half-shot.msc2666/user/${n?"mutual_rooms":"shared_rooms"}/$userId`,{$userId:e}),i=await this.http.authedRequest(void 0,b.Method.Get,r,void 0,void 0,{prefix:b.PREFIX_UNSTABLE});return i.joined}getVersions(){return this.serverVersionsPromise||(this.serverVersionsPromise=this.http.request(void 0,b.Method.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch((e=>{throw this.serverVersionsPromise=null,e}))),this.serverVersionsPromise}async isVersionSupported(e){const{versions:t}=await this.getVersions();return t&&t.includes(e)}async doesServerSupportLazyLoading(){const e=await this.getVersions();if(!e)return!1;const t=e["versions"],n=e["unstable_features"];return t&&t.includes("r0.5.0")||n&&n["m.lazy_load_members"]}async doesServerRequireIdServerParam(){const e=await this.getVersions();if(!e)return!0;const t=e["versions"];if(t&&t.includes("r0.6.0"))return!1;const n=e["unstable_features"];return!n||(void 0===n["m.require_identity_server"]||n["m.require_identity_server"])}async doesServerAcceptIdentityAccessToken(){const e=await this.getVersions();if(!e)return!1;const t=e["versions"],n=e["unstable_features"];return t&&t.includes("r0.6.0")||n&&n["m.id_access_token"]}async doesServerSupportSeparateAddAndBind(){const e=await this.getVersions();if(!e)return!1;const t=e["versions"],n=e["unstable_features"];return(null===t||void 0===t?void 0:t.includes("r0.6.0"))||(null===n||void 0===n?void 0:n["m.separate_add_and_bind"])}async doesServerSupportUnstableFeature(e){const t=await this.getVersions();if(!t)return!1;const n=t["unstable_features"];return n&&!!n[e]}async doesServerForceEncryptionForPreset(e){const t=await this.getVersions();if(!t)return!1;const n=t["unstable_features"],r=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return n&&!!n[`io.element.e2ee_forced.${r}`]}async doesServerSupportThread(){try{const e=await this.doesServerSupportUnstableFeature("org.matrix.msc3440"),t=await this.doesServerSupportUnstableFeature("org.matrix.msc3440.stable");return{serverSupport:e||t,stable:t}}catch(e){return null}}doesServerSupportLogoutDevices(){return this.isVersionSupported("r0.6.1")}hasLazyLoadMembersEnabled(){return!!this.clientOpts.lazyLoadMembers}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}async relations(e,t,n,r,i={direction:g.Direction.Backward}){const o=this.getEncryptedIfNeededEventType(e,r),s=await this.fetchRelations(e,t,n,o,i),a=this.getEventMapper(),c=s.original_event?a(s.original_event):void 0;let l=s.chunk.map(a);if(o===D.EventType.RoomMessageEncrypted){const e=c?l.concat(c):l;await Promise.all(e.map((e=>this.decryptEventIfNeeded(e)))),null!==r&&(l=l.filter((e=>e.getType()===r)))}return c&&n===D.RelationType.Replace&&(l=l.filter((e=>e.getSender()===c.getSender()))),{originalEvent:c,events:l,nextBatch:s.next_batch,prevBatch:s.prev_batch}}getCrossSigningCacheCallbacks(){var e;return null===(e=this.crypto)||void 0===e?void 0:e.crossSigningInfo.getCacheCallbacks()}generateClientSecret(){return(0,L.randomString)(32)}decryptEventIfNeeded(e,t){return e.shouldAttemptDecryption()&&e.attemptDecryption(this.crypto,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case S.SERVICE_TYPES.IS:return t+b.PREFIX_IDENTITY_V2+"/terms";case S.SERVICE_TYPES.IM:return t+"/_matrix/integrations/v1/terms";default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(e=!1){return e&&(this.idBaseUrl.startsWith("http://")||this.idBaseUrl.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=h.ensureNoTrailingSlash(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}setAccessToken(e){this.http.opts.accessToken=e}isLoggedIn(){return void 0!==this.http.opts.accessToken}makeTxnId(){return"m"+(new Date).getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(void 0,b.Method.Get,"/register/available",{username:e}).then((e=>e.available)).catch((e=>"M_USER_IN_USE"!==e.errcode&&Promise.reject(e)))}register(e,t,n,r,i,o,s,a){!0===i?i={email:!0}:null!==i&&void 0!==i&&!1!==i||(i={}),"function"===typeof s&&(a=s,s=void 0),n&&(r.session=n);const c={auth:r,refresh_token:!0};return void 0!==e&&null!==e&&(c.username=e),void 0!==t&&null!==t&&(c.password=t),i.email&&(c.bind_email=!0),i.msisdn&&(c.bind_msisdn=!0),void 0!==o&&null!==o&&(c.guest_access_token=o),void 0!==s&&null!==s&&(c.inhibit_login=s),void 0!==t&&null!==t&&(c.x_show_msisdn=!0),this.registerRequest(c,void 0,a)}registerGuest(e,t){return e=e||{},e.body=e.body||{},this.registerRequest(e.body,"guest",t)}registerRequest(e,t,n){const r={};return t&&(r.kind=t),this.http.request(n,b.Method.Post,"/register",r,e)}refreshToken(e){return this.http.authedRequest(void 0,b.Method.Post,"/refresh",void 0,{refresh_token:e},{prefix:b.PREFIX_V1,inhibitLogoutEmit:!0})}loginFlows(e){return this.http.request(e,b.Method.Get,"/login")}login(e,t,n){const r={type:e};return Object.assign(r,t),this.http.authedRequest(((e,t)=>{t&&t.access_token&&t.user_id&&(this.http.opts.accessToken=t.access_token,this.credentials={userId:t.user_id}),n&&n(e,t)}),b.Method.Post,"/login",void 0,r)}loginWithPassword(e,t,n){return this.login("m.login.password",{user:e,password:t},n)}loginWithSAML2(e,t){return this.login("m.login.saml2",{relay_state:e},t)}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e,t="sso",n){let r="/login/"+t+"/redirect";return n&&(r+="/"+n),this.http.getUrl(r,{redirectUrl:e},b.PREFIX_R0)}loginWithToken(e,t){return this.login("m.login.token",{token:e},t)}async logout(e,t=!1){var n,r;if(null!==(n=this.crypto)&&void 0!==n&&null!==(r=n.backupManager)&&void 0!==r&&r.getKeyBackupEnabled())try{while(await this.crypto.backupManager.backupPendingKeys(200)>0);}catch(i){E.logger.error("Key backup request failed when logging out. Some keys may be missing from backup",i)}return t&&this.stopClient(),this.http.authedRequest(e,b.Method.Post,"/logout")}deactivateAccount(e,t){if("function"===typeof t)throw new Error("deactivateAccount no longer accepts a callback parameter");const n={};return e&&(n.auth=e),void 0!==t&&(n.erase=t),this.http.authedRequest(void 0,b.Method.Post,"/account/deactivate",void 0,n)}getFallbackAuthUrl(e,t){const n=h.encodeUri("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(n,{session:t},b.PREFIX_R0)}async createRoom(e,t){var n;const r=(e.invite_3pid||[]).filter((e=>!e.id_access_token));if(r.length>0&&null!==(n=this.identityServer)&&void 0!==n&&n.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();if(e)for(const t of r)t.id_access_token=e}return this.http.authedRequest(t,b.Method.Post,"/createRoom",void 0,e)}fetchRelations(e,t,n,r,i={direction:g.Direction.Backward}){const o=h.encodeParams(i);let s="/rooms/$roomId/relations/$eventId";null!==n?(s+="/$relationType",null!==r&&(s+="/$eventType")):null!==r&&(E.logger.warn(`eventType: ${r} ignored when fetching\n            relations as relationType is null`),r=null);const a=h.encodeUri(s+"?"+o,{$roomId:e,$eventId:t,$relationType:n,$eventType:r});return this.http.authedRequest(void 0,b.Method.Get,a,null,null,{prefix:b.PREFIX_UNSTABLE})}roomState(e,t){const n=h.encodeUri("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(t,b.Method.Get,n)}fetchRoomEvent(e,t,n){const r=h.encodeUri("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(n,b.Method.Get,r)}members(e,t,n,r,i){const o={};t&&(o.membership=t),n&&(o.not_membership=n),r&&(o.at=r);const s=h.encodeParams(o),a=h.encodeUri("/rooms/$roomId/members?"+s,{$roomId:e});return this.http.authedRequest(i,b.Method.Get,a)}upgradeRoom(e,t){const n=h.encodeUri("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(void 0,b.Method.Post,n,void 0,{new_version:t})}getStateEvent(e,t,n,r){const i={$roomId:e,$eventType:t,$stateKey:n};let o=h.encodeUri("/rooms/$roomId/state/$eventType",i);return void 0!==n&&(o=h.encodeUri(o+"/$stateKey",i)),this.http.authedRequest(r,b.Method.Get,o)}sendStateEvent(e,t,n,r="",i){const o={$roomId:e,$eventType:t,$stateKey:r};let s=h.encodeUri("/rooms/$roomId/state/$eventType",o);return void 0!==r&&(s=h.encodeUri(s+"/$stateKey",o)),this.http.authedRequest(i,b.Method.Put,s,void 0,n)}roomInitialSync(e,t,n){var r,i;h.isFunction(t)&&(n=t,t=void 0);const o=h.encodeUri("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(n,b.Method.Get,o,{limit:null!==(r=null===(i=t)||void 0===i?void 0:i.toString())&&void 0!==r?r:"30"})}setRoomReadMarkersHttpRequest(e,t,n,r){const i=h.encodeUri("/rooms/$roomId/read_markers",{$roomId:e}),o={[q.ReceiptType.FullyRead]:t,[q.ReceiptType.Read]:n,[q.ReceiptType.ReadPrivate]:r};return this.http.authedRequest(void 0,b.Method.Post,i,void 0,o)}getJoinedRooms(){const e=h.encodeUri("/joined_rooms",{});return this.http.authedRequest(void 0,b.Method.Get,e)}getJoinedRoomMembers(e){const t=h.encodeUri("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(void 0,b.Method.Get,t)}publicRooms(e,t){"function"==typeof e&&(t=e,e={}),void 0===e&&(e={});const n={};return e.server&&(n.server=e.server,delete e.server),0===Object.keys(e).length&&0===Object.keys(n).length?this.http.authedRequest(t,b.Method.Get,"/publicRooms"):this.http.authedRequest(t,b.Method.Post,"/publicRooms",n,e)}createAlias(e,t,n){const r=h.encodeUri("/directory/room/$alias",{$alias:e}),i={room_id:t};return this.http.authedRequest(n,b.Method.Put,r,void 0,i)}deleteAlias(e,t){const n=h.encodeUri("/directory/room/$alias",{$alias:e});return this.http.authedRequest(t,b.Method.Delete,n)}getLocalAliases(e){const t=h.encodeUri("/rooms/$roomId/aliases",{$roomId:e}),n=b.PREFIX_V3;return this.http.authedRequest(void 0,b.Method.Get,t,null,null,{prefix:n})}getRoomIdForAlias(e,t){const n=h.encodeUri("/directory/room/$alias",{$alias:e});return this.http.authedRequest(t,b.Method.Get,n)}resolveRoomAlias(e,t){const n=h.encodeUri("/directory/room/$alias",{$alias:e});return this.http.request(t,b.Method.Get,n)}getRoomDirectoryVisibility(e,t){const n=h.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(t,b.Method.Get,n)}setRoomDirectoryVisibility(e,t,n){const r=h.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(n,b.Method.Put,r,void 0,{visibility:t})}setRoomDirectoryVisibilityAppService(e,t,n,r){const i=h.encodeUri("/directory/list/appservice/$networkId/$roomId",{$networkId:e,$roomId:t});return this.http.authedRequest(r,b.Method.Put,i,void 0,{visibility:n})}searchUserDirectory(e){const t={search_term:e.term};return void 0!==e.limit&&(t.limit=e.limit),this.http.authedRequest(void 0,b.Method.Post,"/user_directory/search",void 0,t)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t,n){h.isFunction(t)&&(n=t,t=void 0);const r=t?h.encodeUri("/profile/$userId/$info",{$userId:e,$info:t}):h.encodeUri("/profile/$userId",{$userId:e});return this.http.authedRequest(n,b.Method.Get,r)}getThreePids(e){return this.http.authedRequest(e,b.Method.Get,"/account/3pid")}addThreePid(e,t,n){const r="/account/3pid",i={threePidCreds:e,bind:t};return this.http.authedRequest(n,b.Method.Post,r,null,i)}async addThreePidOnly(e){const t="/account/3pid/add",n=await this.isVersionSupported("r0.6.0")?b.PREFIX_R0:b.PREFIX_UNSTABLE;return this.http.authedRequest(void 0,b.Method.Post,t,null,e,{prefix:n})}async bindThreePid(e){const t="/account/3pid/bind",n=await this.isVersionSupported("r0.6.0")?b.PREFIX_R0:b.PREFIX_UNSTABLE;return this.http.authedRequest(void 0,b.Method.Post,t,null,e,{prefix:n})}async unbindThreePid(e,t){const n="/account/3pid/unbind",r={medium:e,address:t,id_server:this.getIdentityServerUrl(!0)},i=await this.isVersionSupported("r0.6.0")?b.PREFIX_R0:b.PREFIX_UNSTABLE;return this.http.authedRequest(void 0,b.Method.Post,n,null,r,{prefix:i})}deleteThreePid(e,t){const n="/account/3pid/delete";return this.http.authedRequest(void 0,b.Method.Post,n,null,{medium:e,address:t})}setPassword(e,t,n,r){"function"===typeof n&&(r=n),"boolean"!==typeof n&&(n=void 0);const i="/account/password",o={auth:e,new_password:t,logout_devices:n};return this.http.authedRequest(r,b.Method.Post,i,null,o)}getDevices(){return this.http.authedRequest(void 0,b.Method.Get,"/devices")}getDevice(e){const t=h.encodeUri("/devices/$device_id",{$device_id:e});return this.http.authedRequest(void 0,b.Method.Get,t)}setDeviceDetails(e,t){const n=h.encodeUri("/devices/$device_id",{$device_id:e});return this.http.authedRequest(void 0,b.Method.Put,n,void 0,t)}deleteDevice(e,t){const n=h.encodeUri("/devices/$device_id",{$device_id:e}),r={};return t&&(r.auth=t),this.http.authedRequest(void 0,b.Method.Delete,n,void 0,r)}deleteMultipleDevices(e,t){const n={devices:e};t&&(n.auth=t);const r="/delete_devices";return this.http.authedRequest(void 0,b.Method.Post,r,void 0,n)}getPushers(e){return this.http.authedRequest(e,b.Method.Get,"/pushers")}setPusher(e,t){const n="/pushers/set";return this.http.authedRequest(t,b.Method.Post,n,null,e)}getPushRules(e){return this.http.authedRequest(e,b.Method.Get,"/pushrules/").then((e=>p.PushProcessor.rewriteDefaultRules(e)))}addPushRule(e,t,n,r,i){const o=h.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest(i,b.Method.Put,o,void 0,r)}deletePushRule(e,t,n,r){const i=h.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest(r,b.Method.Delete,i)}setPushRuleEnabled(e,t,n,r,i){const o=h.encodeUri("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:n});return this.http.authedRequest(i,b.Method.Put,o,void 0,{enabled:r})}setPushRuleActions(e,t,n,r,i){const o=h.encodeUri("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:n});return this.http.authedRequest(i,b.Method.Put,o,void 0,{actions:r})}search(e,t){const n={};return e.next_batch&&(n.next_batch=e.next_batch),this.http.authedRequest(t,b.Method.Post,"/search",n,e.body)}uploadKeysRequest(e,t,n){return this.http.authedRequest(n,b.Method.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(void 0,b.Method.Post,"/keys/signatures/upload",void 0,e,{prefix:b.PREFIX_UNSTABLE})}downloadKeysForUsers(e,t){if(h.isFunction(t))throw new Error("downloadKeysForUsers no longer accepts a callback parameter");t=t||{};const n={device_keys:{}};return"token"in t&&(n.token=t.token),e.forEach((e=>{n.device_keys[e]=[]})),this.http.authedRequest(void 0,b.Method.Post,"/keys/query",void 0,n)}claimOneTimeKeys(e,t="signed_curve25519",n){const r={};void 0===t&&(t="signed_curve25519");for(let s=0;s<e.length;++s){const n=e[s][0],i=e[s][1],o=r[n]||{};r[n]=o,o[i]=t}const i={one_time_keys:r};n&&(i.timeout=n);const o="/keys/claim";return this.http.authedRequest(void 0,b.Method.Post,o,void 0,i)}getKeyChanges(e,t){const n={from:e,to:t};return this.http.authedRequest(void 0,b.Method.Get,"/keys/changes",n)}uploadDeviceSigningKeys(e,t){const n=Object.assign({},t);return e&&Object.assign(n,{auth:e}),this.http.authedRequest(void 0,b.Method.Post,"/keys/device_signing/upload",void 0,n,{prefix:b.PREFIX_UNSTABLE})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");const t=this.idBaseUrl+b.PREFIX_IDENTITY_V2+"/account/register";return this.http.requestOtherUrl(void 0,b.Method.Post,t,null,e)}requestEmailToken(e,t,n,r,i,o){const s={client_secret:t,email:e,send_attempt:null===n||void 0===n?void 0:n.toString(),next_link:r};return this.http.idServerRequest(i,b.Method.Post,"/validate/email/requestToken",s,b.PREFIX_IDENTITY_V2,o)}requestMsisdnToken(e,t,n,r,i,o,s){const a={client_secret:n,country:e,phone_number:t,send_attempt:null===r||void 0===r?void 0:r.toString(),next_link:i};return this.http.idServerRequest(o,b.Method.Post,"/validate/msisdn/requestToken",a,b.PREFIX_IDENTITY_V2,s)}submitMsisdnToken(e,t,n,r){const i={sid:e,client_secret:t,token:n};return this.http.idServerRequest(void 0,b.Method.Post,"/validate/msisdn/submitToken",i,b.PREFIX_IDENTITY_V2,r)}submitMsisdnTokenOtherUrl(e,t,n,r){const i={sid:t,client_secret:n,token:r};return this.http.requestOtherUrl(void 0,b.Method.Post,e,void 0,i)}getIdentityHashDetails(e){return this.http.idServerRequest(void 0,b.Method.Get,"/hash_details",null,b.PREFIX_IDENTITY_V2,e)}async identityHashedLookup(e,t){const r={},i=await this.getIdentityHashDetails(t);if(!i||!i["lookup_pepper"]||!i["algorithms"])throw new Error("Unsupported identity server: bad response");r["pepper"]=i["lookup_pepper"];const o={};if(i["algorithms"].includes("sha256")){const t=new n.g.Olm.Utility;r["addresses"]=e.map((e=>{const n=e[0].toLowerCase(),i=e[1].toLowerCase(),s=t.sha256(`${n} ${i} ${r["pepper"]}`).replace(/\+/g,"-").replace(/\//g,"_");return o[s]=e[0],s})),r["algorithm"]="sha256"}else{if(!i["algorithms"].includes("none"))throw new Error("Unsupported identity server: unknown hash algorithm");r["addresses"]=e.map((e=>{const t=e[0].toLowerCase(),n=e[1].toLowerCase(),r=`${t} ${n}`;return o[r]=e[0],r})),r["algorithm"]="none"}const s=await this.http.idServerRequest(void 0,b.Method.Post,"/lookup",r,b.PREFIX_IDENTITY_V2,t);if(!s||!s["mappings"])return[];const a=[];for(const n of Object.keys(s["mappings"])){const e=s["mappings"][n],t=o[n];if(!t)throw new Error("Identity server returned more results than expected");a.push({address:t,mxid:e})}return a}async lookupThreePid(e,t,n,r){const i=await this.identityHashedLookup([[t,e]],r),o=i.find((e=>e.address===t));if(!o)return n&&n(null,{}),{};const s={address:t,medium:e,mxid:o.mxid};return n&&n(null,s),s}async bulkLookupThreePids(e,t){const n=await this.identityHashedLookup(e.map((e=>[e[1],e[0]])),t),r=[];for(const i of n){const t=e.find((e=>e[1]===i.address));if(!t)throw new Error("Identity sever returned unexpected results");r.push([t[0],i.address,i.mxid])}return{threepids:r}}getIdentityAccount(e){return this.http.idServerRequest(void 0,b.Method.Get,"/account",void 0,b.PREFIX_IDENTITY_V2,e)}sendToDevice(e,t,n){const r=h.encodeUri("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:n||this.makeTxnId()}),i={messages:t},o=Object.keys(t).reduce(((e,n)=>(e[n]=Object.keys(t[n]),e)),{});return E.logger.log(`PUT ${r}`,o),this.http.authedRequest(void 0,b.Method.Put,r,void 0,i)}getThirdpartyProtocols(){return this.http.authedRequest(void 0,b.Method.Get,"/thirdparty/protocols").then((e=>{if(!e||"object"!==typeof e)throw new Error(`/thirdparty/protocols did not return an object: ${e}`);return e}))}getThirdpartyLocation(e,t){const n=h.encodeUri("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(void 0,b.Method.Get,n,t)}getThirdpartyUser(e,t){const n=h.encodeUri("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(void 0,b.Method.Get,n,t)}getTerms(e,t){const n=this.termsUrlForService(e,t);return this.http.requestOtherUrl(void 0,b.Method.Get,n)}agreeToTerms(e,t,n,r){const i=this.termsUrlForService(e,t),o={Authorization:"Bearer "+n};return this.http.requestOtherUrl(void 0,b.Method.Post,i,null,{user_accepts:r},{headers:o})}reportEvent(e,t,n,r){const i=h.encodeUri("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(void 0,b.Method.Post,i,null,{score:n,reason:r})}getRoomHierarchy(e,t,n,r=!1,i){const o=h.encodeUri("/rooms/$roomId/hierarchy",{$roomId:e}),s={suggested_only:String(r),max_depth:null===n||void 0===n?void 0:n.toString(),from:i,limit:null===t||void 0===t?void 0:t.toString()};return this.http.authedRequest(void 0,b.Method.Get,o,s,void 0,{prefix:b.PREFIX_V1}).catch((e=>{if("M_UNRECOGNIZED"===e.errcode)return this.http.authedRequest(void 0,b.Method.Get,o,s,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw e}))}async unstableCreateFileTree(e){const{room_id:t}=await this.createRoom({name:e,preset:A.Preset.PrivateChat,power_level_content_override:Y(Y({},B.DEFAULT_TREE_POWER_LEVELS_TEMPLATE),{},{users:{[this.getUserId()]:100}}),creation_content:{[D.RoomCreateTypeField]:D.RoomType.Space},initial_state:[{type:D.UNSTABLE_MSC3088_PURPOSE.name,state_key:D.UNSTABLE_MSC3089_TREE_SUBTYPE.name,content:{[D.UNSTABLE_MSC3088_ENABLED.name]:!0}},{type:D.EventType.RoomEncryption,state_key:"",content:{algorithm:y.MEGOLM_ALGORITHM}}]});return new B.MSC3089TreeSpace(this,t)}unstableGetFileTreeSpace(e){var t,n;const r=this.getRoom(e);if("join"!==(null===r||void 0===r?void 0:r.getMyMembership()))return null;const i=r.currentState.getStateEvents(D.EventType.RoomCreate,""),o=r.currentState.getStateEvents(D.UNSTABLE_MSC3088_PURPOSE.name,D.UNSTABLE_MSC3089_TREE_SUBTYPE.name);if(!i)throw new Error("Expected single room create event");return null!==o&&void 0!==o&&null!==(t=o.getContent())&&void 0!==t&&t[D.UNSTABLE_MSC3088_ENABLED.name]?(null===(n=i.getContent())||void 0===n?void 0:n[D.RoomCreateTypeField])!==D.RoomType.Space?null:new B.MSC3089TreeSpace(this,e):null}supportsExperimentalThreads(){var e;return(null===(e=this.clientOpts)||void 0===e?void 0:e.experimentalThreadSupport)||!1}async getRoomSummary(e,t){const n=h.encodeUri("/rooms/$roomid/summary",{$roomid:e});return this.http.authedRequest(void 0,b.Method.Get,n,{via:t},null,{qsStringifyOptions:{arrayFormat:"repeat"},prefix:"/_matrix/client/unstable/im.nheko.summary"})}processThreadEvents(e,t,n){e.processThreadedEvents(t,n)}processBeaconEvents(e,t){null!==t&&void 0!==t&&t.length&&e&&e.currentState.processBeaconEvents(t,this)}async whoami(){return this.http.authedRequest(void 0,b.Method.Get,"/account/whoami")}timestampToEvent(e,t,n){const r=h.encodeUri("/rooms/$roomId/timestamp_to_event",{$roomId:e});return this.http.authedRequest(void 0,b.Method.Get,r,{ts:t.toString(),dir:n},void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"})}}t.MatrixClient=ie,(0,i.default)(ie,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY")},8652:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.makeBeaconInfoContent=t.makeBeaconContent=t.getTextForLocationEvent=void 0,t.makeEmoteMessage=m,t.makeHtmlEmote=p,t.makeHtmlMessage=h,t.makeHtmlNotice=g,t.makeLocationContent=void 0,t.makeNotice=y,t.makeTextMessage=f,t.parseTopicContent=t.parseLocationEvent=t.parseBeaconInfoContent=t.parseBeaconContent=t.makeTopicContent=void 0;var i=r(n(4344)),o=n(3255),s=n(7778),a=n(6570),c=n(3786),l=n(1375);function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function h(e,t){return{msgtype:s.MsgType.Text,format:"org.matrix.custom.html",body:e,formatted_body:t}}function g(e,t){return{msgtype:s.MsgType.Notice,format:"org.matrix.custom.html",body:e,formatted_body:t}}function p(e,t){return{msgtype:s.MsgType.Emote,format:"org.matrix.custom.html",body:e,formatted_body:t}}function f(e){return{msgtype:s.MsgType.Text,body:e}}function y(e){return{msgtype:s.MsgType.Notice,body:e}}function m(e){return{msgtype:s.MsgType.Emote,body:e}}const v=(e,t,n,r)=>{const i=`at ${new Date(n).toISOString()}`,o=t===c.LocationAssetType.Self?"User":void 0,s=r?`"${r}"`:void 0;return[o,"Location",s,e,i].filter(Boolean).join(" ")};t.getTextForLocationEvent=v;const E=(e,t,n,r,i)=>{const o=null!==e&&void 0!==e?e:v(t,i||c.LocationAssetType.Self,n,r),l=n?{[c.M_TIMESTAMP.name]:n}:{};return u({msgtype:s.MsgType.Location,body:o,geo_uri:t,[c.M_LOCATION.name]:{description:r,uri:t},[c.M_ASSET.name]:{type:i||c.LocationAssetType.Self},[a.TEXT_NODE_TYPE.name]:o},l)};t.makeLocationContent=E;const S=e=>{var t,n;const r=c.M_LOCATION.findIn(e),i=c.M_ASSET.findIn(e),o=c.M_TIMESTAMP.findIn(e),s=a.TEXT_NODE_TYPE.findIn(e),l=null!==(t=null===r||void 0===r?void 0:r.uri)&&void 0!==t?t:null===e||void 0===e?void 0:e.geo_uri,d=null===r||void 0===r?void 0:r.description,u=null!==(n=null===i||void 0===i?void 0:i.type)&&void 0!==n?n:c.LocationAssetType.Self,h=null!==s&&void 0!==s?s:e.body;return E(h,l,o,d,u)};t.parseLocationEvent=S;const b=(e,t)=>{const n=[{body:e,mimetype:"text/plain"}];return(0,o.isProvided)(t)&&n.push({body:t,mimetype:"text/html"}),{topic:e,[l.M_TOPIC.name]:n}};t.makeTopicContent=b;const w=e=>{var t,n,r;const i=l.M_TOPIC.findIn(e),s=null!==(t=null===i||void 0===i||null===(n=i.find((e=>!(0,o.isProvided)(e.mimetype)||"text/plain"===e.mimetype)))||void 0===n?void 0:n.body)&&void 0!==t?t:e.topic,a=null===i||void 0===i||null===(r=i.find((e=>"text/html"===e.mimetype)))||void 0===r?void 0:r.body;return{text:s,html:a}};t.parseTopicContent=w;const _=(e,t,n,r,i)=>({description:n,timeout:e,live:t,[c.M_TIMESTAMP.name]:i||Date.now(),[c.M_ASSET.name]:{type:null!==r&&void 0!==r?r:c.LocationAssetType.Self}});t.makeBeaconInfoContent=_;const T=e=>{const{description:t,timeout:n,live:r}=e,{type:i}=c.M_ASSET.findIn(e),o=c.M_TIMESTAMP.findIn(e);return{description:t,timeout:n,live:r,assetType:i,timestamp:o}};t.parseBeaconInfoContent=T;const I=(e,t,n,r)=>({[c.M_LOCATION.name]:{description:r,uri:e},[c.M_TIMESTAMP.name]:t,"m.relates_to":{rel_type:o.REFERENCE_RELATION.name,event_id:n}});t.makeBeaconContent=I;const R=e=>{const{description:t,uri:n}=c.M_LOCATION.findIn(e),r=c.M_TIMESTAMP.findIn(e);return{description:t,uri:n,timestamp:r}};t.parseBeaconContent=R},2697:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getHttpUriForMxc=s;var r=o(n(3926));function i(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(i=function(e){return e?n:t})(e)}function o(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=i(t);if(n&&n.has(e))return n.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var a=o?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(r,s,a):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}function s(e,t,n,i,o,s=!1){if("string"!==typeof t||!t)return"";if(0!==t.indexOf("mxc://"))return s?t:"";let a=t.slice(6),c="/_matrix/media/r0/download/";const l={};n&&(l["width"]=Math.round(n).toString()),i&&(l["height"]=Math.round(i).toString()),o&&(l["method"]=o),Object.keys(l).length>0&&(c="/_matrix/media/r0/thumbnail/");const d=a.indexOf("#");let u="";d>=0&&(u=a.slice(d),a=a.slice(0,d));const h=0===Object.keys(l).length?"":"?"+r.encodeParams(l);return e+c+a+h+u}},4984:function(e,t,n){"use strict";n(1703),n(8675),n(3462),n(7380),n(1118);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.UserTrustLevel=t.DeviceTrustLevel=t.CrossSigningLevel=t.CrossSigningInfo=void 0,t.createCryptoStoreCacheCallbacks=y,t.requestKeysDuringVerification=m;var i=r(n(4344)),o=n(9485),s=n(6471),a=n(7896),c=n(5470);const l=6e4;function d(e){return Object.values(e.keys)[0]}class u{constructor(e,t={},n={}){this.userId=e,this.callbacks=t,this.cacheCallbacks=n,(0,i.default)(this,"keys",{}),(0,i.default)(this,"firstUse",!0),(0,i.default)(this,"crossSigningVerifiedBefore",!1)}static fromStorage(e,t){const n=new u(t);for(const r in e)e.hasOwnProperty(r)&&(n[r]=e[r]);return n}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}async getCrossSigningKey(e,t){const r=["master","self_signing","user_signing"].indexOf(e)>=0;if(!this.callbacks.getCrossSigningKey)throw new Error("No getCrossSigningKey callback supplied");function i(e){if(!e)return;const r=new n.g.Olm.PkSigning,i=r.init_with_seed(e);if(i===t)return[i,r];r.free()}let o;void 0===t&&(t=this.getId(e)),this.cacheCallbacks.getCrossSigningKeyCache&&r&&(o=await this.cacheCallbacks.getCrossSigningKeyCache(e,t));const s=i(o);if(s)return s;o=await this.callbacks.getCrossSigningKey(e,t);const a=i(o);if(a)return this.cacheCallbacks.storeCrossSigningKeyCache&&r&&await this.cacheCallbacks.storeCrossSigningKeyCache(e,o),a;if(!o)throw new Error("getCrossSigningKey callback for "+e+" returned falsey");throw new Error("Key type "+e+" from getCrossSigningKey callback did not match")}async isStoredInSecretStorage(e){const t=await e.isStored("m.cross_signing.master")||{};function n(e){for(const n of Object.keys(t))e[n]||delete t[n]}for(const r of["self_signing","user_signing"])n(await e.isStored(`m.cross_signing.${r}`)||{});return Object.keys(t).length?t:null}static async storeInSecretStorage(e,t){for(const[n,r]of e){const e=(0,o.encodeBase64)(r);await t.store(`m.cross_signing.${n}`,e)}}static async getFromSecretStorage(e,t){const n=await t.get(`m.cross_signing.${e}`);return n?(0,o.decodeBase64)(n):null}async isStoredInKeyCache(e){const t=this.cacheCallbacks;if(!t)return!1;const n=e?[e]:["master","self_signing","user_signing"];for(const r of n)if(!await t.getCrossSigningKeyCache(r))return!1;return!0}async getCrossSigningKeysFromCache(){const e=new Map,t=this.cacheCallbacks;if(!t)return e;for(const n of["master","self_signing","user_signing"]){const r=await t.getCrossSigningKeyCache(n);r&&e.set(n,r)}return e}getId(e="master"){if(!this.keys[e])return null;const t=this.keys[e];return d(t)}async resetKeys(e){if(!this.callbacks.saveCrossSigningKeys)throw new Error("No saveCrossSigningKeys callback supplied");if(void 0===e||e&g.MASTER||!this.keys.master)e=g.MASTER|g.USER_SIGNING|g.SELF_SIGNING;else if(0===e)return;const t={},r={};let i,s;try{if(e&g.MASTER?(i=new n.g.Olm.PkSigning,t.master=i.generate_seed(),s=i.init_with_seed(t.master),r.master={user_id:this.userId,usage:["master"],keys:{["ed25519:"+s]:s}}):[s,i]=await this.getCrossSigningKey("master"),e&g.SELF_SIGNING){const e=new n.g.Olm.PkSigning;try{t.self_signing=e.generate_seed();const n=e.init_with_seed(t.self_signing);r.self_signing={user_id:this.userId,usage:["self_signing"],keys:{["ed25519:"+n]:n}},(0,o.pkSign)(r.self_signing,i,this.userId,s)}finally{e.free()}}if(e&g.USER_SIGNING){const e=new n.g.Olm.PkSigning;try{t.user_signing=e.generate_seed();const n=e.init_with_seed(t.user_signing);r.user_signing={user_id:this.userId,usage:["user_signing"],keys:{["ed25519:"+n]:n}},(0,o.pkSign)(r.user_signing,i,this.userId,s)}finally{e.free()}}Object.assign(this.keys,r),this.callbacks.saveCrossSigningKeys(t)}finally{i&&i.free()}}clearKeys(){this.keys={}}setKeys(e){const t={};if(e.master){if(e.master.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw s.logger.error(t),new Error(t)}this.keys.master?d(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else{if(!this.keys.master)throw new Error("Tried to set cross-signing keys without a master key");t.master=this.keys.master}const n=d(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw s.logger.error(t),new Error(t)}try{(0,o.pkVerify)(e.user_signing,n,this.userId)}catch(r){throw s.logger.error("invalid signature on user-signing key"),r}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw s.logger.error(t),new Error(t)}try{(0,o.pkVerify)(e.self_signing,n,this.userId)}catch(r){throw s.logger.error("invalid signature on self-signing key"),r}}e.master&&(this.keys.master=e.master,this.keys.self_signing=null,this.keys.user_signing=null),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}updateCrossSigningVerifiedBefore(e){!this.crossSigningVerifiedBefore&&e&&(this.crossSigningVerifiedBefore=!0)}async signObject(e,t){if(!this.keys[t])throw new Error("Attempted to sign with "+t+" key but no such key present");const[n,r]=await this.getCrossSigningKey(t);try{return(0,o.pkSign)(e,r,this.userId,n),e}finally{r.free()}}async signUser(e){if(this.keys.user_signing)return this.signObject(e.keys.master,"user_signing");s.logger.info("No user signing key: not signing user")}async signDevice(e,t){if(e!==this.userId)throw new Error(`Trying to sign ${e}'s device; can only sign our own device`);if(this.keys.self_signing)return this.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing");s.logger.info("No self signing key: not signing device")}checkUserTrust(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new p(!0,!0,this.firstUse);if(!this.keys.user_signing)return new p(!1,!1,e.firstUse);let t;const n=e.keys.master,r=this.getId("user_signing");try{(0,o.pkVerify)(n,r,this.userId),t=!0}catch(i){t=!1}return new p(t,e.crossSigningVerifiedBefore,e.firstUse)}checkDeviceTrust(e,t,n,r){const i=this.checkUserTrust(e),s=e.keys.self_signing;if(!s)return new f(!1,!1,n,r);const a=h(t,e.userId);try{return(0,o.pkVerify)(s,e.getId(),e.userId),(0,o.pkVerify)(a,d(s),e.userId),f.fromUserTrustLevel(i,n,r)}catch(c){return new f(!1,!1,n,r)}}getCacheCallbacks(){return this.cacheCallbacks}}function h(e,t){return{algorithms:e.algorithms,keys:e.keys,device_id:e.deviceId,user_id:t,signatures:e.signatures}}let g;t.CrossSigningInfo=u,t.CrossSigningLevel=g,function(e){e[e["MASTER"]=4]="MASTER",e[e["USER_SIGNING"]=2]="USER_SIGNING",e[e["SELF_SIGNING"]=1]="SELF_SIGNING"}(g||(t.CrossSigningLevel=g={}));class p{constructor(e,t,n){this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=n}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}t.UserTrustLevel=p;class f{constructor(e,t,n,r){this.crossSigningVerified=e,this.tofu=t,this.localVerified=n,this.trustCrossSignedDevices=r}static fromUserTrustLevel(e,t,n){return new f(e.isCrossSigningVerified(),e.isTofu(),t,n)}isVerified(){return Boolean(this.isLocallyVerified()||this.trustCrossSignedDevices&&this.isCrossSigningVerified())}isCrossSigningVerified(){return this.crossSigningVerified}isLocallyVerified(){return this.localVerified}isTofu(){return this.tofu}}function y(e,t){return{getCrossSigningKeyCache:async function(n,r){const i=await new Promise((t=>e.doTxn("readonly",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(r=>{e.getSecretStorePrivateKey(r,t,n)}))));if(i&&i.ciphertext){const e=Buffer.from(t.pickleKey),r=await(0,c.decryptAES)(i,e,n);return(0,o.decodeBase64)(r)}return i},storeCrossSigningKeyCache:async function(n,r){if(!(r instanceof Uint8Array))throw new Error(`storeCrossSigningKeyCache expects Uint8Array, got ${r}`);const i=Buffer.from(t.pickleKey),s=await(0,c.encryptAES)((0,o.encodeBase64)(r),i,n);return e.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{e.storeSecretStorePrivateKey(t,n,s)}))}}}function m(e,t,n){if(e.getUserId()===t)return s.logger.log("Cross-signing: Self-verification done; requesting keys"),new Promise(((t,r)=>{const i=e,a=i.crypto.crossSigningInfo,c=new u(a.userId,{getCrossSigningKey:async e=>{s.logger.debug("Cross-signing: requesting secret",e,n);const{promise:t}=i.requestSecret(`m.cross_signing.${e}`,[n]),r=await t,a=(0,o.decodeBase64)(r);return Uint8Array.from(a)}},a.getCacheCallbacks());c.keys=a.keys;const d=new Promise((e=>{setTimeout(e,l,new Error("Timeout"))})),h=(async()=>{const e=await i.crypto.getSessionBackupPrivateKey();if(!e){s.logger.info("No cached backup key found. Requesting...");const e=i.requestSecret("m.megolm_backup.v1",[n]),t=await e.promise;s.logger.info("Got key backup key, decoding...");const r=(0,o.decodeBase64)(t);s.logger.info("Decoded backup key, storing..."),await i.crypto.storeSessionBackupPrivateKey(Uint8Array.from(r)),s.logger.info("Backup key stored. Starting backup restore...");const a=await i.getKeyBackupVersion();i.restoreKeyBackupWithCache(void 0,void 0,a).then((()=>{s.logger.info("Backup restored.")}))}})();return Promise.race([Promise.all([c.getCrossSigningKey("master"),c.getCrossSigningKey("self_signing"),c.getCrossSigningKey("user_signing"),h]),d]).then(t,r)})).catch((e=>{s.logger.warn("Cross-signing: failure while requesting keys:",e)}))}t.DeviceTrustLevel=f},3637:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.TrackingStatus=t.DeviceList=void 0;var i=r(n(4344)),o=n(6471),s=n(1949),a=n(4984),c=p(n(9485)),l=n(7896),d=n(3926),u=n(9392),h=n(529);function g(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(g=function(e){return e?n:t})(e)}function p(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=g(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}let f;t.TrackingStatus=f,function(e){e[e["NotTracked"]=0]="NotTracked",e[e["PendingDownload"]=1]="PendingDownload",e[e["DownloadInProgress"]=2]="DownloadInProgress",e[e["UpToDate"]=3]="UpToDate"}(f||(t.TrackingStatus=f={}));class y extends u.TypedEventEmitter{constructor(e,t,n,r=250){super(),this.cryptoStore=t,this.keyDownloadChunkSize=r,(0,i.default)(this,"devices",{}),(0,i.default)(this,"crossSigningInfo",{}),(0,i.default)(this,"userByIdentityKey",{}),(0,i.default)(this,"deviceTrackingStatus",{}),(0,i.default)(this,"syncToken",null),(0,i.default)(this,"keyDownloadsInProgressByUser",{}),(0,i.default)(this,"dirty",!1),(0,i.default)(this,"savePromise",null),(0,i.default)(this,"resolveSavePromise",null),(0,i.default)(this,"savePromiseTime",null),(0,i.default)(this,"saveTimer",null),(0,i.default)(this,"hasFetched",null),(0,i.default)(this,"serialiser",void 0),this.serialiser=new m(e,n,this)}async load(){await this.cryptoStore.doTxn("readonly",[l.IndexedDBCryptoStore.STORE_DEVICE_DATA],(e=>{this.cryptoStore.getEndToEndDeviceData(e,(e=>{this.hasFetched=Boolean(e&&e.devices),this.devices=e?e.devices:{},this.crossSigningInfo=e&&e.crossSigningInfo||{},this.deviceTrackingStatus=e?e.trackingStatus:{},this.syncToken=e?e.syncToken:null,this.userByIdentityKey={};for(const t of Object.keys(this.devices)){const e=this.devices[t];for(const n of Object.keys(e)){const r=e[n].keys["curve25519:"+n];void 0!==r&&(this.userByIdentityKey[r]=t)}}}))}));for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]==f.DownloadInProgress&&(this.deviceTrackingStatus[e]=f.PendingDownload)}stop(){null!==this.saveTimer&&clearTimeout(this.saveTimer)}async saveIfDirty(e=500){if(!this.dirty)return Promise.resolve(!1);const t=Date.now()+e;this.savePromiseTime&&t<this.savePromiseTime&&(clearTimeout(this.saveTimer),this.saveTimer=null,this.savePromiseTime=null);let n=this.savePromise;if(null===n&&(n=new Promise((e=>{this.resolveSavePromise=e})),this.savePromise=n),null===this.saveTimer){const n=this.resolveSavePromise;this.savePromiseTime=t,this.saveTimer=setTimeout((()=>{o.logger.log("Saving device tracking data",this.syncToken),this.savePromiseTime=null,this.saveTimer=null,this.savePromise=null,this.resolveSavePromise=null,this.cryptoStore.doTxn("readwrite",[l.IndexedDBCryptoStore.STORE_DEVICE_DATA],(e=>{this.cryptoStore.storeEndToEndDeviceData({devices:this.devices,crossSigningInfo:this.crossSigningInfo,trackingStatus:this.deviceTrackingStatus,syncToken:this.syncToken},e)})).then((()=>{this.dirty=!1,n(!0)}),(e=>{o.logger.error("Failed to save device tracking data",this.syncToken),o.logger.error(e)}))}),e)}return n}getSyncToken(){return this.syncToken}setSyncToken(e){this.syncToken=e}downloadKeys(e,t){const n=[],r=[];if(e.forEach((e=>{const i=this.deviceTrackingStatus[e];this.keyDownloadsInProgressByUser[e]?(o.logger.log(`downloadKeys: already have a download in progress for ${e}: awaiting its result`),r.push(this.keyDownloadsInProgressByUser[e])):(t||i!=f.UpToDate)&&n.push(e)})),0!=n.length){o.logger.log("downloadKeys: downloading for",n);const e=this.doKeyDownload(n);r.push(e)}return 0===r.length&&o.logger.log("downloadKeys: already have all necessary keys"),Promise.all(r).then((()=>this.getDevicesFromStore(e)))}getDevicesFromStore(e){const t={};return e.forEach((e=>{t[e]={};const n=this.getStoredDevicesForUser(e)||[];n.forEach((function(n){t[e][n.deviceId]=n}))})),t}getKnownUserIds(){return Object.keys(this.devices)}getStoredDevicesForUser(e){const t=this.devices[e];if(!t)return null;const n=[];for(const r in t)t.hasOwnProperty(r)&&n.push(s.DeviceInfo.fromStorage(t[r],r));return n}getRawStoredDevicesForUser(e){return this.devices[e]}getStoredCrossSigningForUser(e){return this.crossSigningInfo[e]?a.CrossSigningInfo.fromStorage(this.crossSigningInfo[e],e):null}storeCrossSigningForUser(e,t){this.crossSigningInfo[e]=t,this.dirty=!0}getStoredDevice(e,t){const n=this.devices[e];if(n&&n[t])return s.DeviceInfo.fromStorage(n[t],t)}getUserByIdentityKey(e,t){return e!==c.OLM_ALGORITHM&&e!==c.MEGOLM_ALGORITHM?null:this.userByIdentityKey[t]}getDeviceByIdentityKey(e,t){const n=this.getUserByIdentityKey(e,t);if(!n)return null;const r=this.devices[n];if(!r)return null;for(const i in r){if(!r.hasOwnProperty(i))continue;const e=r[i];for(const n in e.keys){if(!e.keys.hasOwnProperty(n))continue;if(0!==n.indexOf("curve25519:"))continue;const r=e.keys[n];if(r==t)return s.DeviceInfo.fromStorage(e,i)}}return null}storeDevicesForUser(e,t){this.setRawStoredDevicesForUser(e,t),this.dirty=!0}startTrackingDeviceList(e){if("string"!==typeof e)throw new Error("userId must be a string; was "+e);this.deviceTrackingStatus[e]||(o.logger.log("Now tracking device list for "+e),this.deviceTrackingStatus[e]=f.PendingDownload,this.dirty=!0)}stopTrackingDeviceList(e){this.deviceTrackingStatus[e]&&(o.logger.log("No longer tracking device list for "+e),this.deviceTrackingStatus[e]=f.NotTracked,this.dirty=!0)}stopTrackingAllDeviceLists(){for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]=f.NotTracked;this.dirty=!0}invalidateUserDeviceList(e){this.deviceTrackingStatus[e]&&(o.logger.log("Marking device list outdated for",e),this.deviceTrackingStatus[e]=f.PendingDownload,this.dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();const e=[];for(const t of Object.keys(this.deviceTrackingStatus)){const n=this.deviceTrackingStatus[t];n==f.PendingDownload&&e.push(t)}return this.doKeyDownload(e)}setRawStoredDevicesForUser(e,t){if(void 0!==this.devices[e])for(const[n,r]of Object.entries(this.devices[e])){const e=r.keys["curve25519:"+n];delete this.userByIdentityKey[e]}this.devices[e]=t;for(const[n,r]of Object.entries(t)){const t=r.keys["curve25519:"+n];this.userByIdentityKey[t]=e}}setRawStoredCrossSigningForUser(e,t){this.crossSigningInfo[e]=t}doKeyDownload(e){if(0===e.length)return Promise.resolve();const t=this.serialiser.updateDevicesForUsers(e,this.syncToken).then((()=>{n(!0)}),(t=>{throw o.logger.error("Error downloading keys for "+e+":",t),n(!1),t}));e.forEach((e=>{this.keyDownloadsInProgressByUser[e]=t;const n=this.deviceTrackingStatus[e];n==f.PendingDownload&&(this.deviceTrackingStatus[e]=f.DownloadInProgress)}));const n=n=>{this.emit(h.CryptoEvent.WillUpdateDevices,e,!this.hasFetched),e.forEach((e=>{if(this.dirty=!0,this.keyDownloadsInProgressByUser[e]!==t)return void o.logger.log("Another update in the queue for",e,"- not marking up-to-date");delete this.keyDownloadsInProgressByUser[e];const r=this.deviceTrackingStatus[e];r==f.DownloadInProgress&&(n?(this.deviceTrackingStatus[e]=f.UpToDate,o.logger.log("Device list for",e,"now up to date")):this.deviceTrackingStatus[e]=f.PendingDownload)})),this.saveIfDirty(),this.emit(h.CryptoEvent.DevicesUpdated,e,!this.hasFetched),this.hasFetched=!0};return t}}t.DeviceList=y;class m{constructor(e,t,n){this.baseApis=e,this.olmDevice=t,this.deviceList=n,(0,i.default)(this,"downloadInProgress",!1),(0,i.default)(this,"keyDownloadsQueuedByUser",{}),(0,i.default)(this,"queuedQueryDeferred",null),(0,i.default)(this,"syncToken",null)}updateDevicesForUsers(e,t){return e.forEach((e=>{this.keyDownloadsQueuedByUser[e]=!0})),this.queuedQueryDeferred||(this.queuedQueryDeferred=(0,d.defer)()),this.syncToken=t,this.downloadInProgress?(o.logger.log("Queued key download for",e),this.queuedQueryDeferred.promise):this.doQueuedQueries()}doQueuedQueries(){if(this.downloadInProgress)throw new Error("DeviceListUpdateSerialiser.doQueuedQueries called with request active");const e=Object.keys(this.keyDownloadsQueuedByUser);this.keyDownloadsQueuedByUser={};const t=this.queuedQueryDeferred;this.queuedQueryDeferred=null,o.logger.log("Starting key download for",e),this.downloadInProgress=!0;const n={};this.syncToken&&(n.token=this.syncToken);const r=[];for(let i=0;i<e.length;i+=this.deviceList.keyDownloadChunkSize){const t=e.slice(i,i+this.deviceList.keyDownloadChunkSize);r.push((()=>this.baseApis.downloadKeysForUsers(t,n)))}return(0,d.chunkPromises)(r,3).then((async t=>{const n=Object.assign({},...t.map((e=>e.device_keys||{}))),r=Object.assign({},...t.map((e=>e.master_keys||{}))),i=Object.assign({},...t.map((e=>e.self_signing_keys||{}))),s=Object.assign({},...t.map((e=>e.user_signing_keys||{})));for(const c of e){await(0,d.sleep)(5);try{await this.processQueryResponseForUser(c,n[c],{master:r[c],self_signing:i[c],user_signing:s[c]})}catch(a){o.logger.error(`Error processing keys for ${c}:`,a)}}})).then((()=>{o.logger.log("Completed key download for "+e),this.downloadInProgress=!1,t.resolve(),this.queuedQueryDeferred&&this.doQueuedQueries()}),(n=>{o.logger.warn("Error downloading keys for "+e+":",n),this.downloadInProgress=!1,t.reject(n)})),t.promise}async processQueryResponseForUser(e,t,n){o.logger.log("got device keys for "+e+":",t),o.logger.log("got cross-signing keys for "+e+":",n);{const n={},r=this.deviceList.getRawStoredDevicesForUser(e);r&&Object.keys(r).forEach((e=>{const t=s.DeviceInfo.fromStorage(r[e],e);n[e]=t})),await v(this.olmDevice,e,n,t||{},this.baseApis.getUserId(),this.baseApis.deviceId);const i={};Object.keys(n).forEach((e=>{i[e]=n[e].toStorage()})),this.deviceList.setRawStoredDevicesForUser(e,i)}if(n&&(n.master||n.self_signing||n.user_signing)){const t=this.deviceList.getStoredCrossSigningForUser(e)||new a.CrossSigningInfo(e);t.setKeys(n),this.deviceList.setRawStoredCrossSigningForUser(e,t.toStorage()),this.deviceList.emit(h.CryptoEvent.UserCrossSigningUpdated,e)}}}async function v(e,t,n,r,i,s){let a=!1;for(const c in n)if(n.hasOwnProperty(c)&&!(c in r)){if(t===i&&c===s){o.logger.warn(`Local device ${c} missing from sync, skipping removal`);continue}o.logger.log("Device "+t+":"+c+" has been removed"),delete n[c],a=!0}for(const c in r){if(!r.hasOwnProperty(c))continue;const i=r[c];i.user_id===t?i.device_id===c?await E(e,n,i)&&(a=!0):o.logger.warn("Mismatched device_id "+i.device_id+" in keys from "+t+":"+c):o.logger.warn("Mismatched user_id "+i.user_id+" in keys from "+t+":"+c)}return a}async function E(e,t,n){if(!n.keys)return!1;const r=n.device_id,i=n.user_id,a="ed25519:"+r,l=n.keys[a];if(!l)return o.logger.warn("Device "+i+":"+r+" has no ed25519 key"),!1;const d=n.unsigned||{},u=n.signatures||{};try{await c.verifySignature(e,n,i,r,l)}catch(g){return o.logger.warn("Unable to verify signature on device "+i+":"+r+":"+g),!1}let h;if(r in t){if(h=t[r],h.getFingerprint()!=l)return o.logger.warn("Ed25519 key for device "+i+":"+r+" has changed"),!1}else t[r]=h=new s.DeviceInfo(r);return h.keys=n.keys||{},h.algorithms=n.algorithms||[],h.unsigned=d,h.signatures=u,!0}},6733:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.EncryptionSetupOperation=t.EncryptionSetupBuilder=void 0;var i=r(n(4344)),o=n(6471),s=n(2842),a=n(4984),c=n(7896),l=n(5354),d=n(5346),u=n(9392);class h{constructor(e,t){(0,i.default)(this,"accountDataClientAdapter",void 0),(0,i.default)(this,"crossSigningCallbacks",void 0),(0,i.default)(this,"ssssCryptoCallbacks",void 0),(0,i.default)(this,"crossSigningKeys",null),(0,i.default)(this,"keySignatures",null),(0,i.default)(this,"keyBackupInfo",null),(0,i.default)(this,"sessionBackupPrivateKey",void 0),this.accountDataClientAdapter=new p(e),this.crossSigningCallbacks=new f,this.ssssCryptoCallbacks=new y(t)}addCrossSigningKeys(e,t){this.crossSigningKeys={authUpload:e,keys:t}}addSessionBackup(e){this.keyBackupInfo=e}addSessionBackupPrivateKeyToCache(e){this.sessionBackupPrivateKey=e}addKeySignature(e,t,n){this.keySignatures||(this.keySignatures={});const r=this.keySignatures[e]||{};this.keySignatures[e]=r,r[t]=n}async setAccountData(e,t){await this.accountDataClientAdapter.setAccountData(e,t)}buildOperation(){const e=this.accountDataClientAdapter.values;return new g(e,this.crossSigningKeys,this.keyBackupInfo,this.keySignatures)}async persist(e){if(this.crossSigningKeys){const t=(0,a.createCryptoStoreCacheCallbacks)(e.cryptoStore,e.olmDevice);for(const e of["master","self_signing","user_signing"]){o.logger.log(`Cache ${e} cross-signing private key locally`);const n=this.crossSigningCallbacks.privateKeys.get(e);await t.storeCrossSigningKeyCache(e,n)}await e.cryptoStore.doTxn("readwrite",[c.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{e.cryptoStore.storeCrossSigningKeys(t,this.crossSigningKeys.keys)}))}this.sessionBackupPrivateKey&&await e.storeSessionBackupPrivateKey(this.sessionBackupPrivateKey)}}t.EncryptionSetupBuilder=h;class g{constructor(e,t,n,r){this.accountData=e,this.crossSigningKeys=t,this.keyBackupInfo=n,this.keySignatures=r}async apply(e){const t=e.baseApis;if(this.crossSigningKeys){const n={};for(const[e,t]of Object.entries(this.crossSigningKeys.keys))n[e+"_key"]=t;await this.crossSigningKeys.authUpload((e=>t.uploadDeviceSigningKeys(e,n))),e.crossSigningInfo.setKeys(this.crossSigningKeys.keys)}if(this.accountData)for(const[n,r]of this.accountData)await t.setAccountData(n,r);this.keySignatures&&await t.uploadKeySignatures(this.keySignatures),this.keyBackupInfo&&(this.keyBackupInfo.version?await t.http.authedRequest(void 0,l.Method.Put,"/room_keys/version/"+this.keyBackupInfo.version,void 0,{algorithm:this.keyBackupInfo.algorithm,auth_data:this.keyBackupInfo.auth_data},{prefix:l.PREFIX_UNSTABLE}):await t.http.authedRequest(void 0,l.Method.Post,"/room_keys/version",void 0,this.keyBackupInfo,{prefix:l.PREFIX_UNSTABLE}))}}t.EncryptionSetupOperation=g;class p extends u.TypedEventEmitter{constructor(e){super(),this.existingValues=e,(0,i.default)(this,"values",new Map)}getAccountDataFromServer(e){return Promise.resolve(this.getAccountData(e))}getAccountData(e){const t=this.values.get(e);if(t)return t;const n=this.existingValues[e];return n?n.getContent():null}setAccountData(e,t){const n=this.values.get(e);return this.values.set(e,t),Promise.resolve().then((()=>{const r=new s.MatrixEvent({type:e,content:t});return this.emit(d.ClientEvent.AccountData,r,n),{}}))}}class f{constructor(){(0,i.default)(this,"privateKeys",new Map)}getCrossSigningKeyCache(e,t){return this.getCrossSigningKey(e,t)}storeCrossSigningKeyCache(e,t){return this.privateKeys.set(e,t),Promise.resolve()}getCrossSigningKey(e,t){return Promise.resolve(this.privateKeys.get(e))}saveCrossSigningKeys(e){for(const[t,n]of Object.entries(e))this.privateKeys.set(t,n)}}class y{constructor(e){this.delegateCryptoCallbacks=e,(0,i.default)(this,"privateKeys",new Map)}async getSecretStorageKey({keys:e},t){var n;for(const r of Object.keys(e)){const e=this.privateKeys.get(r);if(e)return[r,e]}if(null!==this&&void 0!==this&&null!==(n=this.delegateCryptoCallbacks)&&void 0!==n&&n.getSecretStorageKey){const n=await this.delegateCryptoCallbacks.getSecretStorageKey({keys:e},t);if(n){const[e,t]=n;this.privateKeys.set(e,t)}return n}return null}addPrivateKey(e,t,n){var r,i;this.privateKeys.set(e,n),null===(r=this.delegateCryptoCallbacks)||void 0===r||null===(i=r.cacheSecretStorageKey)||void 0===i||i.call(r,e,t,n)}}},1677:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.WITHHELD_MESSAGES=t.OlmDevice=void 0;var i=r(n(4344)),o=n(6471),s=n(7896),a=l(n(4148));function c(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(c=function(e){return e?n:t})(e)}function l(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=c(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}const d=49152;function u(e){if(void 0===e)throw new Error("payloadString undefined");if(e.length>d){const t=new Error("Message too long ("+e.length+" bytes). The maximum for an encrypted message is "+d+" bytes.");throw t["data"]={errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"},t}}class h{constructor(e){this.cryptoStore=e,(0,i.default)(this,"pickleKey","DEFAULT_KEY"),(0,i.default)(this,"deviceCurve25519Key",null),(0,i.default)(this,"deviceEd25519Key",null),(0,i.default)(this,"maxOneTimeKeys",null),(0,i.default)(this,"outboundGroupSessionStore",{}),(0,i.default)(this,"inboundGroupSessionMessageIndexes",{}),(0,i.default)(this,"sessionsInProgress",{}),(0,i.default)(this,"olmPrekeyPromise",Promise.resolve())}static getOlmVersion(){return n.g.Olm.get_library_version()}async init({pickleKey:e,fromExportedDevice:t}={}){let r;const i=new n.g.Olm.Account;try{t?(e&&o.logger.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),this.pickleKey=t.pickleKey,await this.initialiseFromExportedDevice(t,i)):(e&&(this.pickleKey=e),await this.initialiseAccount(i)),r=JSON.parse(i.identity_keys()),this.maxOneTimeKeys=i.max_number_of_one_time_keys()}finally{i.free()}this.deviceCurve25519Key=r.curve25519,this.deviceEd25519Key=r.ed25519}async initialiseFromExportedDevice(e,t){await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ACCOUNT,s.IndexedDBCryptoStore.STORE_SESSIONS],(t=>{this.cryptoStore.storeAccount(t,e.pickledAccount),e.sessions.forEach((e=>{const{deviceKey:n,sessionId:r}=e,i={session:e.session,lastReceivedMessageTs:e.lastReceivedMessageTs};this.cryptoStore.storeEndToEndSession(n,r,i,t)}))})),t.unpickle(this.pickleKey,e.pickledAccount)}async initialiseAccount(e){await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{this.cryptoStore.getAccount(t,(n=>{null!==n?e.unpickle(this.pickleKey,n):(e.create(),n=e.pickle(this.pickleKey),this.cryptoStore.storeAccount(t,n))}))}))}getAccount(e,t){this.cryptoStore.getAccount(e,(e=>{const r=new n.g.Olm.Account;try{r.unpickle(this.pickleKey,e),t(r)}finally{r.free()}}))}storeAccount(e,t){this.cryptoStore.storeAccount(e,t.pickle(this.pickleKey))}async export(){const e={pickleKey:this.pickleKey};return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_ACCOUNT,s.IndexedDBCryptoStore.STORE_SESSIONS],(t=>{this.cryptoStore.getAccount(t,(t=>{e.pickledAccount=t})),e.sessions=[],this.cryptoStore.getAllEndToEndSessions(t,(t=>{e.sessions.push(t)}))})),e}getSession(e,t,n,r){this.cryptoStore.getEndToEndSession(e,t,n,(e=>{this.unpickleSession(e,r)}))}unpickleSession(e,t){const r=new n.g.Olm.Session;try{r.unpickle(this.pickleKey,e.session);const n=Object.assign({},e,{session:r});t(n)}finally{r.free()}}saveSession(e,t,n){const r=t.session.session_id(),i=Object.assign(t,{session:t.session.pickle(this.pickleKey)});this.cryptoStore.storeEndToEndSession(e,r,i,n)}getUtility(e){const t=new n.g.Olm.Utility;try{return e(t)}finally{t.free()}}async sign(e){let t;return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_ACCOUNT],(n=>{this.getAccount(n,(n=>{t=n.sign(e)}))})),t}async getOneTimeKeys(){let e;return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{this.getAccount(t,(t=>{e=JSON.parse(t.one_time_keys())}))})),e}maxNumberOfOneTimeKeys(){return this.maxOneTimeKeys}async markKeysAsPublished(){await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.getAccount(e,(t=>{t.mark_keys_as_published(),this.storeAccount(e,t)}))}))}generateOneTimeKeys(e){return this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{this.getAccount(t,(n=>{n.generate_one_time_keys(e),this.storeAccount(t,n)}))}))}async generateFallbackKey(){await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.getAccount(e,(t=>{t.generate_fallback_key(),this.storeAccount(e,t)}))}))}async getFallbackKey(){let e;return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{this.getAccount(t,(t=>{e=JSON.parse(t.unpublished_fallback_key())}))})),e}async forgetOldFallbackKey(){await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.getAccount(e,(t=>{t.forget_old_fallback_key(),this.storeAccount(e,t)}))}))}async createOutboundSession(e,t){let r;return await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ACCOUNT,s.IndexedDBCryptoStore.STORE_SESSIONS],(i=>{this.getAccount(i,(o=>{const s=new n.g.Olm.Session;try{s.create_outbound(o,e,t),r=s.session_id(),this.storeAccount(i,o);const n={session:s,lastReceivedMessageTs:Date.now()};this.saveSession(e,n,i)}finally{s.free()}}))}),o.logger.withPrefix("[createOutboundSession]")),r}async createInboundSession(e,t,r){if(0!==t)throw new Error("Need messageType == 0 to create inbound session");let i;return await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ACCOUNT,s.IndexedDBCryptoStore.STORE_SESSIONS],(o=>{this.getAccount(o,(s=>{const a=new n.g.Olm.Session;try{a.create_inbound_from(s,e,r),s.remove_one_time_keys(a),this.storeAccount(o,s);const n=a.decrypt(t,r),c={session:a,lastReceivedMessageTs:Date.now()};this.saveSession(e,c,o),i={payload:n,session_id:a.session_id()}}finally{a.free()}}))}),o.logger.withPrefix("[createInboundSession]")),i}async getSessionIdsForDevice(e){const t=o.logger.withPrefix("[getSessionIdsForDevice]");if(this.sessionsInProgress[e]){t.debug(`Waiting for Olm session for ${e} to be created`);try{await this.sessionsInProgress[e]}catch(r){}}let n;return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_SESSIONS],(t=>{this.cryptoStore.getEndToEndSessions(e,t,(e=>{n=Object.keys(e)}))}),t),n}async getSessionIdForDevice(e,t=!1,n){const r=await this.getSessionInfoForDevice(e,t,n);if(0===r.length)return null;let i=0;for(let o=1;o<r.length;o++){const e=r[o],t=void 0===e.lastReceivedMessageTs?0:e.lastReceivedMessageTs,n=r[i],s=void 0===n.lastReceivedMessageTs?0:n.lastReceivedMessageTs;(t>s||t===s&&e.sessionId<n.sessionId)&&(i=o)}return r[i].sessionId}async getSessionInfoForDevice(e,t=!1,n=o.logger){if(n=n.withPrefix("[getSessionInfoForDevice]"),this.sessionsInProgress[e]&&!t){n.debug(`Waiting for Olm session for ${e} to be created`);try{await this.sessionsInProgress[e]}catch(i){}}const r=[];return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_SESSIONS],(t=>{this.cryptoStore.getEndToEndSessions(e,t,(e=>{const t=Object.keys(e).sort();for(const n of t)this.unpickleSession(e[n],(e=>{r.push({lastReceivedMessageTs:e.lastReceivedMessageTs,hasReceivedMessage:e.session.has_received_message(),sessionId:n})}))}))}),n),r}async encryptMessage(e,t,n){let r;return u(n),await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_SESSIONS],(i=>{this.getSession(e,t,i,(s=>{const a=s.session.describe();o.logger.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+a),r=s.session.encrypt(n),this.saveSession(e,s,i)}))}),o.logger.withPrefix("[encryptMessage]")),r}async decryptMessage(e,t,n,r){let i;return await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_SESSIONS],(s=>{this.getSession(e,t,s,(a=>{const c=a.session.describe();o.logger.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+c),i=a.session.decrypt(n,r),a.lastReceivedMessageTs=Date.now(),this.saveSession(e,a,s)}))}),o.logger.withPrefix("[decryptMessage]")),i}async matchesSession(e,t,n,r){if(0!==n)return!1;let i;return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_SESSIONS],(n=>{this.getSession(e,t,n,(e=>{i=e.session.matches_inbound(r)}))}),o.logger.withPrefix("[matchesSession]")),i}async recordSessionProblem(e,t,n){await this.cryptoStore.storeEndToEndSessionProblem(e,t,n)}sessionMayHaveProblems(e,t){return this.cryptoStore.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.cryptoStore.filterOutNotifiedErrorDevices(e)}saveOutboundGroupSession(e){this.outboundGroupSessionStore[e.session_id()]=e.pickle(this.pickleKey)}getOutboundGroupSession(e,t){const r=this.outboundGroupSessionStore[e];if(void 0===r)throw new Error("Unknown outbound group session "+e);const i=new n.g.Olm.OutboundGroupSession;try{return i.unpickle(this.pickleKey,r),t(i)}finally{i.free()}}createOutboundGroupSession(){const e=new n.g.Olm.OutboundGroupSession;try{return e.create(),this.saveOutboundGroupSession(e),e.session_id()}finally{e.free()}}encryptGroupMessage(e,t){return o.logger.log(`encrypting msg with megolm session ${e}`),u(t),this.getOutboundGroupSession(e,(e=>{const n=e.encrypt(t);return this.saveOutboundGroupSession(e),n}))}getOutboundGroupSessionKey(e){return this.getOutboundGroupSession(e,(function(e){return{chain_index:e.message_index(),key:e.session_key()}}))}unpickleInboundGroupSession(e,t){const r=new n.g.Olm.InboundGroupSession;try{return r.unpickle(this.pickleKey,e.session),t(r)}finally{r.free()}}getInboundGroupSession(e,t,n,r,i){this.cryptoStore.getEndToEndInboundGroupSession(t,n,r,((t,n)=>{if(null!==t){if(null!==e&&e!==t.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+t.room_id+", was "+e+")");this.unpickleInboundGroupSession(t,(e=>{i(e,t,n)}))}else i(null,null,n)}))}async addInboundGroupSession(e,t,r,i,a,c,l,d={}){await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD,s.IndexedDBCryptoStore.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],(s=>{this.getInboundGroupSession(e,t,i,s,((u,h)=>{const g=new n.g.Olm.InboundGroupSession;try{if(l?g.import_session(a):g.create(a),i!=g.session_id())throw new Error("Mismatched group session ID from senderKey: "+t);if(u&&(o.logger.log("Update for megolm session "+t+"/"+i),u.first_known_index()<=g.first_known_index()&&(u.first_known_index()!=g.first_known_index()||d.untrusted||!h.untrusted)))return void o.logger.log(`Keeping existing megolm session ${i}`);o.logger.info("Storing megolm session "+t+"/"+i+" with first index "+g.first_known_index());const n=Object.assign({},d,{room_id:e,session:g.pickle(this.pickleKey),keysClaimed:c,forwardingCurve25519KeyChain:r});this.cryptoStore.storeEndToEndInboundGroupSession(t,i,n,s),!u&&d.sharedHistory&&this.cryptoStore.addSharedHistoryInboundGroupSession(e,t,i,s)}finally{g.free()}}))}),o.logger.withPrefix("[addInboundGroupSession]"))}async addInboundGroupSessionWithheld(e,t,n,r,i){await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(o=>{this.cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,n,{room_id:e,code:r,reason:i},o)}))}async decryptGroupMessage(e,t,n,r,i,c){let l,d;if(await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(o=>{this.getInboundGroupSession(e,t,n,o,((e,s,u)=>{if(null===e)return u&&(d=new a.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",p(u),{session:t+"|"+n})),void(l=null);let h;try{h=e.decrypt(r)}catch(f){return void(d=f&&"OLM.UNKNOWN_MESSAGE_INDEX"===f.message&&u?new a.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",p(u),{session:t+"|"+n}):f)}let g=h.plaintext;if(void 0===g)g=h;else{const e=t+"|"+n+"|"+h.message_index;if(e in this.inboundGroupSessionMessageIndexes){const t=this.inboundGroupSessionMessageIndexes[e];if(t.id!==i||t.timestamp!==c)return void(d=new Error("Duplicate message index, possible replay attack: "+e))}this.inboundGroupSessionMessageIndexes[e]={id:i,timestamp:c}}s.session=e.pickle(this.pickleKey),this.cryptoStore.storeEndToEndInboundGroupSession(t,n,s,o),l={result:g,keysClaimed:s.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:s.forwardingCurve25519KeyChain||[],untrusted:s.untrusted}}))}),o.logger.withPrefix("[decryptGroupMessage]")),d)throw d;return l}async hasInboundSessionKeys(e,t,n){let r;return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(i=>{this.cryptoStore.getEndToEndInboundGroupSession(t,n,i,(i=>{null!==i?e!==i.room_id?(o.logger.warn(`requested keys for inbound group session ${t}|${n}, with incorrect room_id (expected ${i.room_id}, was ${e})`),r=!1):r=!0:r=!1}))}),o.logger.withPrefix("[hasInboundSessionKeys]")),r}async getInboundGroupSessionKey(e,t,n,r){let i;return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(o=>{this.getInboundGroupSession(e,t,n,o,((e,t)=>{if(null===e)return void(i=null);void 0===r&&(r=e.first_known_index());const n=e.export_session(r),o=t.keysClaimed||{},s=o.ed25519||null;i={chain_index:r,key:n,forwarding_curve25519_key_chain:t.forwardingCurve25519KeyChain||[],sender_claimed_ed25519_key:s,shared_history:t.sharedHistory||!1}}))}),o.logger.withPrefix("[getInboundGroupSessionKey]")),i}exportInboundGroupSession(e,t,n){return this.unpickleInboundGroupSession(n,(r=>{const i=r.first_known_index();return{sender_key:e,sender_claimed_keys:n.keysClaimed,room_id:n.room_id,session_id:t,session_key:r.export_session(i),forwarding_curve25519_key_chain:n.forwardingCurve25519KeyChain||[],first_known_index:r.first_known_index(),"org.matrix.msc3061.shared_history":n.sharedHistory||!1}}))}async getSharedHistoryInboundGroupSessions(e){let t;return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],(n=>{t=this.cryptoStore.getSharedHistoryInboundGroupSessions(e,n)}),o.logger.withPrefix("[getSharedHistoryInboundGroupSessionsForRoom]")),t}verifySignature(e,t,n){this.getUtility((function(r){r.ed25519_verify(e,t,n)}))}}t.OlmDevice=h;const g={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function p(e){return e.code&&e.code in g?g[e.code]:e.reason?e.reason:"decryption key withheld"}t.WITHHELD_MESSAGES=g},6831:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomKeyRequestState=t.OutgoingRoomKeyRequestManager=void 0;var i=r(n(4344)),o=n(6471),s=n(7778);const a=500;let c;t.RoomKeyRequestState=c,function(e){e[e["Unsent"]=0]="Unsent",e[e["Sent"]=1]="Sent",e[e["CancellationPending"]=2]="CancellationPending",e[e["CancellationPendingAndWillResend"]=3]="CancellationPendingAndWillResend"}(c||(t.RoomKeyRequestState=c={}));class l{constructor(e,t,n){this.baseApis=e,this.deviceId=t,this.cryptoStore=n,(0,i.default)(this,"sendOutgoingRoomKeyRequestsTimer",null),(0,i.default)(this,"sendOutgoingRoomKeyRequestsRunning",!1),(0,i.default)(this,"clientRunning",!1)}start(){this.clientRunning=!0}stop(){o.logger.log("stopping OutgoingRoomKeyRequestManager"),this.clientRunning=!1}sendQueuedRequests(){this.startTimer()}async queueRoomKeyRequest(e,t,n=!1){const r=await this.cryptoStore.getOutgoingRoomKeyRequest(e);if(r)switch(r.state){case c.CancellationPendingAndWillResend:case c.Unsent:return;case c.CancellationPending:{const e=n?c.CancellationPendingAndWillResend:c.Sent;await this.cryptoStore.updateOutgoingRoomKeyRequest(r.requestId,c.CancellationPending,{state:e,cancellationTxnId:this.baseApis.makeTxnId()});break}case c.Sent:if(n){const s=c.CancellationPendingAndWillResend,a=await this.cryptoStore.updateOutgoingRoomKeyRequest(r.requestId,c.Sent,{state:s,cancellationTxnId:this.baseApis.makeTxnId(),requestTxnId:this.baseApis.makeTxnId()});if(!a)return this.queueRoomKeyRequest(e,t,n);try{await this.sendOutgoingRoomKeyRequestCancellation(a,!0)}catch(i){o.logger.error("Error sending room key request cancellation; will retry later.",i)}}break;default:throw new Error("unhandled state: "+r.state)}else await this.cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:this.baseApis.makeTxnId(),state:c.Unsent})}cancelRoomKeyRequest(e){return this.cryptoStore.getOutgoingRoomKeyRequest(e).then((t=>{if(t)switch(t.state){case c.CancellationPending:case c.CancellationPendingAndWillResend:return;case c.Unsent:return o.logger.log("deleting unnecessary room key request for "+d(e)),this.cryptoStore.deleteOutgoingRoomKeyRequest(t.requestId,c.Unsent);case c.Sent:return this.cryptoStore.updateOutgoingRoomKeyRequest(t.requestId,c.Sent,{state:c.CancellationPending,cancellationTxnId:this.baseApis.makeTxnId()}).then((t=>{t?this.sendOutgoingRoomKeyRequestCancellation(t).catch((e=>{o.logger.error("Error sending room key request cancellation; will retry later.",e),this.startTimer()})):o.logger.log("Tried to cancel room key request for "+d(e)+" but it was already cancelled in another tab")}));default:throw new Error("unhandled state: "+t.state)}}))}getOutgoingSentRoomKeyRequest(e,t){return this.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[c.Sent])}async cancelAndResendAllOutgoingRequests(){const e=await this.cryptoStore.getAllOutgoingRoomKeyRequestsByState(c.Sent);return Promise.all(e.map((({requestBody:e,recipients:t})=>this.queueRoomKeyRequest(e,t,!0))))}startTimer(){if(this.sendOutgoingRoomKeyRequestsTimer)return;const e=()=>{if(this.sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");this.sendOutgoingRoomKeyRequestsRunning=!0,this.sendOutgoingRoomKeyRequests().finally((()=>{this.sendOutgoingRoomKeyRequestsRunning=!1})).catch((e=>{o.logger.warn(`error in OutgoingRoomKeyRequestManager: ${e}`)}))};this.sendOutgoingRoomKeyRequestsTimer=setTimeout(e,a)}sendOutgoingRoomKeyRequests(){return this.clientRunning?this.cryptoStore.getOutgoingRoomKeyRequestByState([c.CancellationPending,c.CancellationPendingAndWillResend,c.Unsent]).then((e=>{if(!e)return void(this.sendOutgoingRoomKeyRequestsTimer=null);let t;switch(e.state){case c.Unsent:t=this.sendOutgoingRoomKeyRequest(e);break;case c.CancellationPending:t=this.sendOutgoingRoomKeyRequestCancellation(e);break;case c.CancellationPendingAndWillResend:t=this.sendOutgoingRoomKeyRequestCancellation(e,!0);break}return t.then((()=>this.sendOutgoingRoomKeyRequests())).catch((e=>{o.logger.error("Error sending room key request; will retry later.",e),this.sendOutgoingRoomKeyRequestsTimer=null}))})):(this.sendOutgoingRoomKeyRequestsTimer=null,Promise.resolve())}sendOutgoingRoomKeyRequest(e){o.logger.log(`Requesting keys for ${d(e.requestBody)} from ${u(e.recipients)}(id ${e.requestId})`);const t={action:"request",requesting_device_id:this.deviceId,request_id:e.requestId,body:e.requestBody};return this.sendMessageToDevices(t,e.recipients,e.requestTxnId||e.requestId).then((()=>this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,c.Unsent,{state:c.Sent})))}sendOutgoingRoomKeyRequestCancellation(e,t=!1){o.logger.log(`Sending cancellation for key request for ${d(e.requestBody)} to ${u(e.recipients)} (cancellation id ${e.cancellationTxnId})`);const n={action:"request_cancellation",requesting_device_id:this.deviceId,request_id:e.requestId};return this.sendMessageToDevices(n,e.recipients,e.cancellationTxnId).then((()=>t?this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,c.CancellationPendingAndWillResend,{state:c.Unsent}):this.cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,c.CancellationPending)))}sendMessageToDevices(e,t,n){const r={};for(const i of t)r[i.userId]||(r[i.userId]={}),r[i.userId][i.deviceId]=e;return this.baseApis.sendToDevice(s.EventType.RoomKeyRequest,r,n)}}function d(e){return e.room_id+" / "+e.session_id}function u(e){return"["+e.map((e=>`${e.userId}:${e.deviceId}`)).join(",")+"]"}t.OutgoingRoomKeyRequestManager=l},3616:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomList=void 0;var i=r(n(4344)),o=n(7896);class s{constructor(e){this.cryptoStore=e,(0,i.default)(this,"roomEncryption",{})}async init(){await this.cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ROOMS],(e=>{this.cryptoStore.getEndToEndRooms(e,(e=>{this.roomEncryption=e}))}))}getRoomEncryption(e){return this.roomEncryption[e]||null}isRoomEncrypted(e){return Boolean(this.getRoomEncryption(e))}async setRoomEncryption(e,t){this.roomEncryption[e]=t,await this.cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ROOMS],(n=>{this.cryptoStore.storeEndToEndRoom(e,t,n)}))}}t.RoomList=s},5869:function(e,t,n){"use strict";n(1703),n(6699);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.SecretStorage=t.SECRET_STORAGE_ALGORITHM_V1_AES=void 0;var i=r(n(4344)),o=n(6471),s=u(n(9485)),a=n(5789),c=n(5470),l=n(5346);function d(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(d=function(e){return e?n:t})(e)}function u(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=d(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}const h="m.secret_storage.v1.aes-hmac-sha2";t.SECRET_STORAGE_ALGORITHM_V1_AES=h;class g{constructor(e,t,n){this.accountDataAdapter=e,this.cryptoCallbacks=t,this.baseApis=n,(0,i.default)(this,"requests",new Map)}async getDefaultKeyId(){const e=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return e?e.key:null}setDefaultKeyId(e){return new Promise(((t,n)=>{const r=n=>{"m.secret_storage.default_key"===n.getType()&&n.getContent().key===e&&(this.accountDataAdapter.removeListener(l.ClientEvent.AccountData,r),t())};this.accountDataAdapter.on(l.ClientEvent.AccountData,r),this.accountDataAdapter.setAccountData("m.secret_storage.default_key",{key:e}).catch((e=>{this.accountDataAdapter.removeListener(l.ClientEvent.AccountData,r),n(e)}))}))}async addKey(e,t,n){const r={algorithm:e};if(t||(t={}),t.name&&(r.name=t.name),e!==h)throw new Error(`Unknown key algorithm ${e}`);if(t.passphrase&&(r.passphrase=t.passphrase),t.key){const{iv:e,mac:n}=await(0,c.calculateKeyCheck)(t.key);r.iv=e,r.mac=n}if(!n)do{n=(0,a.randomString)(32)}while(await this.accountDataAdapter.getAccountDataFromServer(`m.secret_storage.key.${n}`));return await this.accountDataAdapter.setAccountData(`m.secret_storage.key.${n}`,r),{keyId:n,keyInfo:r}}async getKey(e){if(e||(e=await this.getDefaultKeyId()),!e)return null;const t=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);return t?[e,t]:null}async hasKey(e){return Boolean(await this.getKey(e))}async checkKey(e,t){if(t.algorithm===h){if(t.mac){const{mac:n}=await(0,c.calculateKeyCheck)(e,t.iv);return t.mac.replace(/=+$/g,"")===n.replace(/=+$/g,"")}return!0}throw new Error("Unknown algorithm")}async store(e,t,n){const r={};if(!n){const e=await this.getDefaultKeyId();if(!e)throw new Error("No keys specified and no default key present");n=[e]}if(0===n.length)throw new Error("Zero keys given to encrypt with!");for(const i of n){const n=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+i);if(!n)throw new Error("Unknown key: "+i);if(n.algorithm===h){const o={[i]:n},[,s]=await this.getSecretStorageKey(o,e);r[i]=await s.encrypt(t)}else o.logger.warn("unknown algorithm for secret storage key "+i+": "+n.algorithm)}await this.accountDataAdapter.setAccountData(e,{encrypted:r})}async get(e){const t=await this.accountDataAdapter.getAccountDataFromServer(e);if(!t)return;if(!t.encrypted)throw new Error("Content is not encrypted!");const n={};for(const o of Object.keys(t.encrypted)){const e=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+o),r=t.encrypted[o];e.algorithm===h&&r.iv&&r.ciphertext&&r.mac&&(n[o]=e)}if(0===Object.keys(n).length)throw new Error(`Could not decrypt ${e} because none of the keys it is encrypted with are for a supported algorithm`);let r,i;try{[r,i]=await this.getSecretStorageKey(n,e);const o=t.encrypted[r];return o.passthrough?(0,s.encodeBase64)(i.get_private_key()):i.decrypt(o)}finally{i&&i.free&&i.free()}}async isStored(e){const t=await this.accountDataAdapter.getAccountDataFromServer(e);if(null===t||void 0===t||!t.encrypted)return null;const n={};for(const r of Object.keys(t.encrypted)){const e=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+r);if(!e)continue;const i=t.encrypted[r];e.algorithm===h&&i.iv&&i.ciphertext&&i.mac&&(n[r]=e)}return Object.keys(n).length?n:null}request(e,t){const n=this.baseApis.makeTxnId();let r,i;const s=new Promise(((e,t)=>{r=e,i=t}));this.requests.set(n,{name:e,devices:t,resolve:r,reject:i});const a=e=>{const r={action:"request_cancellation",requesting_device_id:this.baseApis.deviceId,request_id:n},o={};for(const n of t)o[n]=r;this.baseApis.sendToDevice("m.secret.request",{[this.baseApis.getUserId()]:o}),i(new Error(e||"Cancelled"))},c={name:e,action:"request",requesting_device_id:this.baseApis.deviceId,request_id:n},l={};for(const o of t)l[o]=c;return o.logger.info(`Request secret ${e} from ${t}, id ${n}`),this.baseApis.sendToDevice("m.secret.request",{[this.baseApis.getUserId()]:l}),{requestId:n,promise:s,cancel:a}}async onRequestReceived(e){const t=e.getSender(),n=e.getContent();if(t!==this.baseApis.getUserId()||!(n.name&&n.action&&n.requesting_device_id&&n.request_id))return;const r=n.requesting_device_id;if("request_cancellation"===n.action);else if("request"===n.action){if(r===this.baseApis.deviceId)return;if(o.logger.info("received request for secret ("+t+", "+r+", "+n.request_id+")"),!this.cryptoCallbacks.onSecretRequested)return;const e=await this.cryptoCallbacks.onSecretRequested(t,r,n.request_id,n.name,this.baseApis.checkDeviceTrust(t,r));if(e){o.logger.info(`Preparing ${n.name} secret for ${r}`);const i={type:"m.secret.send",content:{request_id:n.request_id,secret:e}},a={algorithm:s.OLM_ALGORITHM,sender_key:this.baseApis.crypto.olmDevice.deviceCurve25519Key,ciphertext:{}};await s.ensureOlmSessionsForDevices(this.baseApis.crypto.olmDevice,this.baseApis,{[t]:[this.baseApis.getStoredDevice(t,r)]}),await s.encryptMessageForDevice(a.ciphertext,this.baseApis.getUserId(),this.baseApis.deviceId,this.baseApis.crypto.olmDevice,t,this.baseApis.getStoredDevice(t,r),i);const c={[t]:{[r]:a}};o.logger.info(`Sending ${n.name} secret for ${r}`),this.baseApis.sendToDevice("m.room.encrypted",c)}else o.logger.info(`Request denied for ${n.name} secret for ${r}`)}}onSecretReceived(e){if(e.getSender()!==this.baseApis.getUserId())return;const t=e.getContent();o.logger.log("got secret share for request",t.request_id);const n=this.requests.get(t.request_id);if(n){const r=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(s.OLM_ALGORITHM,e.getSenderKey());if(!r)return void o.logger.log("secret share from unknown device with key",e.getSenderKey());if(!n.devices.includes(r.deviceId))return void o.logger.log("unsolicited secret share from device",r.deviceId);o.logger.log(`Successfully received secret ${n.name} from ${r.deviceId}`),n.resolve(t.secret)}}async getSecretStorageKey(e,t){if(!this.cryptoCallbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");const n=await this.cryptoCallbacks.getSecretStorageKey({keys:e},t);if(!n)throw new Error("getSecretStorageKey callback returned falsey");if(n.length<2)throw new Error("getSecretStorageKey callback returned invalid data");const[r,i]=n;if(!e[r])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[r].algorithm===h){const e={encrypt:function(e){return(0,c.encryptAES)(e,i,t)},decrypt:function(e){return(0,c.decryptAES)(e,i,t)}};return[r,e]}throw new Error("Unknown key type: "+e[r].algorithm)}}t.SecretStorage=g},5470:function(e,t,n){"use strict";n(8675),n(3462),n(7380),n(1118),n(1703),Object.defineProperty(t,"__esModule",{value:!0}),t.calculateKeyCheck=y,t.decryptAES=p,t.encryptAES=g;var r=n(3926),i=n(9485);const o="undefined"!==typeof window&&window.crypto?window.crypto.subtle||window.crypto.webkitSubtle:null,s=new Uint8Array(8);async function a(e,t,n,o){const s=(0,r.getCrypto)();if(!s)throw new Error("No usable crypto implementation");let a;o?a=(0,i.decodeBase64)(o):(a=s.randomBytes(16),a[8]&=127);const[c,d]=l(t,n),u=s.createCipheriv("aes-256-ctr",c,a),h=Buffer.concat([u.update(e,"utf8"),u.final()]),g=s.createHmac("sha256",d).update(h).digest("base64");return{iv:(0,i.encodeBase64)(a),ciphertext:h.toString("base64"),mac:g}}async function c(e,t,n){const o=(0,r.getCrypto)();if(!o)throw new Error("No usable crypto implementation");const[s,a]=l(t,n),c=o.createHmac("sha256",a).update(Buffer.from(e.ciphertext,"base64")).digest("base64").replace(/=+$/g,"");if(c!==e.mac.replace(/=+$/g,""))throw new Error(`Error decrypting secret ${n}: bad MAC`);const d=o.createDecipheriv("aes-256-ctr",s,(0,i.decodeBase64)(e.iv));return d.update(e.ciphertext,"base64","utf8")+d.final("utf8")}function l(e,t){const n=(0,r.getCrypto)(),i=n.createHmac("sha256",s).update(e).digest(),o=Buffer.alloc(1,1),a=n.createHmac("sha256",i).update(t,"utf8").update(o).digest();o[0]=2;const c=n.createHmac("sha256",i).update(a).update(t,"utf8").update(o).digest();return[a,c]}async function d(e,t,n,r){let s;r?s=(0,i.decodeBase64)(r):(s=new Uint8Array(16),window.crypto.getRandomValues(s),s[8]&=127);const[a,c]=await h(t,n),l=(new TextEncoder).encode(e),d=await o.encrypt({name:"AES-CTR",counter:s,length:64},a,l),u=await o.sign({name:"HMAC"},c,d);return{iv:(0,i.encodeBase64)(s),ciphertext:(0,i.encodeBase64)(d),mac:(0,i.encodeBase64)(u)}}async function u(e,t,n){const[r,s]=await h(t,n),a=(0,i.decodeBase64)(e.ciphertext);if(!await o.verify({name:"HMAC"},s,(0,i.decodeBase64)(e.mac),a))throw new Error(`Error decrypting secret ${n}: bad MAC`);const c=await o.decrypt({name:"AES-CTR",counter:(0,i.decodeBase64)(e.iv),length:64},r,a);return(new TextDecoder).decode(new Uint8Array(c))}async function h(e,t){const n=await o.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),r=await o.deriveBits({name:"HKDF",salt:s,info:(new TextEncoder).encode(t),hash:"SHA-256"},n,512),i=r.slice(0,32),a=r.slice(32),c=o.importKey("raw",i,{name:"AES-CTR"},!1,["encrypt","decrypt"]),l=o.importKey("raw",a,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([c,l])}function g(e,t,n,r){return o?d(e,t,n,r):a(e,t,n,r)}function p(e,t,n){return o?u(e,t,n):c(e,t,n)}const f="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function y(e,t){return g(f,e,"",t)}},4059:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.UnknownDeviceError=t.EncryptionAlgorithm=t.ENCRYPTION_CLASSES=t.DecryptionError=t.DecryptionAlgorithm=t.DECRYPTION_CLASSES=void 0,t.registerAlgorithm=h;var i=r(n(4344));const o={};t.ENCRYPTION_CLASSES=o;const s={};t.DECRYPTION_CLASSES=s;class a{constructor(e){(0,i.default)(this,"userId",void 0),(0,i.default)(this,"deviceId",void 0),(0,i.default)(this,"crypto",void 0),(0,i.default)(this,"olmDevice",void 0),(0,i.default)(this,"baseApis",void 0),(0,i.default)(this,"roomId",void 0),this.userId=e.userId,this.deviceId=e.deviceId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}prepareToEncrypt(e){}onRoomMembership(e,t,n){}}t.EncryptionAlgorithm=a;class c{constructor(e){(0,i.default)(this,"userId",void 0),(0,i.default)(this,"crypto",void 0),(0,i.default)(this,"olmDevice",void 0),(0,i.default)(this,"baseApis",void 0),(0,i.default)(this,"roomId",void 0),this.userId=e.userId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}async onRoomKeyEvent(e){}async importRoomKey(e,t){}hasKeysForKeyRequest(e){return Promise.resolve(!1)}shareKeysWithDevice(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}async retryDecryptionFromSender(e){return!1}}t.DecryptionAlgorithm=c;class l extends Error{constructor(e,t,n){super(t),this.code=e,(0,i.default)(this,"detailedString",void 0),this.code=e,this.name="DecryptionError",this.detailedString=d(this,n)}}function d(e,t){let n=e.name+"[msg: "+e.message;return t&&(n+=", "+Object.keys(t).map((e=>e+": "+t[e])).join(", ")),n+="]",n}t.DecryptionError=l;class u extends Error{constructor(e,t){super(e),this.devices=t,this.name="UnknownDeviceError",this.devices=t}}function h(e,t,n){o[e]=t,s[e]=n}t.UnknownDeviceError=u},4148:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n(7625),n(489);var r=n(4059);Object.keys(r).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===r[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}}))}))},489:function(e,t,n){"use strict";n(6699);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.isRoomSharedHistory=u;var i=r(n(4344)),o=n(6471),s=d(n(9485)),a=n(4059),c=n(1677);function l(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(l=function(e){return e?n:t})(e)}function d(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=l(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}function u(e){var t,n;const r=null===e||void 0===e||null===(t=e.currentState)||void 0===t?void 0:t.getStateEvents("m.room.history_visibility",""),i=null===r||void 0===r||null===(n=r.getContent())||void 0===n?void 0:n.history_visibility;return["world_readable","shared"].includes(i)}class h{constructor(e,t=!1){this.sessionId=e,this.sharedHistory=t,(0,i.default)(this,"useCount",0),(0,i.default)(this,"creationTime",void 0),(0,i.default)(this,"sharedWithDevices",{}),(0,i.default)(this,"blockedDevicesNotified",{}),this.creationTime=(new Date).getTime()}needsRotation(e,t){const n=(new Date).getTime()-this.creationTime;return(this.useCount>=e||n>=t)&&(o.logger.log("Rotating megolm session after "+this.useCount+" messages, "+n+"ms"),!0)}markSharedWithDevice(e,t,n,r){this.sharedWithDevices[e]||(this.sharedWithDevices[e]={}),this.sharedWithDevices[e][t]={deviceKey:n,messageIndex:r}}markNotifiedBlockedDevice(e,t){this.blockedDevicesNotified[e]||(this.blockedDevicesNotified[e]={}),this.blockedDevicesNotified[e][t]=!0}sharedWithTooManyDevices(e){for(const t in this.sharedWithDevices)if(this.sharedWithDevices.hasOwnProperty(t)){if(!e.hasOwnProperty(t))return o.logger.log("Starting new megolm session because we shared with "+t),!0;for(const n in this.sharedWithDevices[t])if(this.sharedWithDevices[t].hasOwnProperty(n)&&!e[t].hasOwnProperty(n))return o.logger.log("Starting new megolm session because we shared with "+t+":"+n),!0}return!1}}class g extends a.EncryptionAlgorithm{constructor(e){var t,n,r,o;super(e),(0,i.default)(this,"setupPromise",Promise.resolve(null)),(0,i.default)(this,"outboundSessions",{}),(0,i.default)(this,"sessionRotationPeriodMsgs",void 0),(0,i.default)(this,"sessionRotationPeriodMs",void 0),(0,i.default)(this,"encryptionPreparation",void 0),this.sessionRotationPeriodMsgs=null!==(t=null===(n=e.config)||void 0===n?void 0:n.rotation_period_msgs)&&void 0!==t?t:100,this.sessionRotationPeriodMs=null!==(r=null===(o=e.config)||void 0===o?void 0:o.rotation_period_ms)&&void 0!==r?r:6048e5}async ensureOutboundSession(e,t,n,r=!1){const i=async i=>{const s=u(e),a=await this.prepareSession(t,s,i);try{await this.shareSession(t,s,r,n,a)}catch(c){o.logger.error(`Failed to ensure outbound session in ${this.roomId}`,c)}return a},s=this.setupPromise.then(i);return s.catch((e=>{o.logger.error(`Failed to setup outbound session in ${this.roomId}`,e)})),this.setupPromise=s,s}async prepareSession(e,t,n){var r,i;return n&&t!==n.sharedHistory&&(n=null),null!==(r=n)&&void 0!==r&&r.needsRotation(this.sessionRotationPeriodMsgs,this.sessionRotationPeriodMs)&&(o.logger.log("Starting new megolm session because we need to rotate."),n=null),null!==(i=n)&&void 0!==i&&i.sharedWithTooManyDevices(e)&&(n=null),n||(o.logger.log(`Starting new megolm session for room ${this.roomId}`),n=await this.prepareNewSession(t),o.logger.log(`Started new megolm session ${n.sessionId} for room ${this.roomId}`),this.outboundSessions[n.sessionId]=n),n}async shareSession(e,t,n,r,i){const a={};for(const[o,s]of Object.entries(e))for(const[e,t]of Object.entries(s)){const n=t.getIdentityKey();n!=this.olmDevice.deviceCurve25519Key&&(i.sharedWithDevices[o]&&void 0!==i.sharedWithDevices[o][e]||(a[o]=a[o]||[],a[o].push(t)))}const c=this.olmDevice.getOutboundGroupSessionKey(i.sessionId),l={type:"m.room_key",content:{algorithm:s.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:i.sessionId,session_key:c.key,chain_index:c.chain_index,"org.matrix.msc3061.shared_history":t}},[d,u]=await s.getExistingOlmSessions(this.olmDevice,this.baseApis,a);await Promise.all([(async()=>{o.logger.debug(`Sharing keys with existing Olm sessions in ${this.roomId}`,u),await this.shareKeyWithOlmSessions(i,c,l,u),o.logger.debug(`Shared keys with existing Olm sessions in ${this.roomId}`)})(),(async()=>{o.logger.debug(`Sharing keys (start phase 1) with new Olm sessions in ${this.roomId}`,d);const e=[],t=Date.now(),r=[];await this.shareKeyWithDevices(i,c,l,d,e,n?1e4:2e3,r),o.logger.debug(`Shared keys (end phase 1) with new Olm sessions in ${this.roomId}`),!n&&Date.now()-t<1e4?(async()=>{const t={},n=new Set;for(const e of r)n.add(e);const s=[];for(const{userId:r,deviceInfo:i}of e){const e=r.slice(r.indexOf(":")+1);n.has(e)?(t[r]=t[r]||[],t[r].push(i)):s.push({userId:r,deviceInfo:i})}o.logger.debug(`Sharing keys (start phase 2) with new Olm sessions in ${this.roomId}`),await this.shareKeyWithDevices(i,c,l,t,s,3e4),o.logger.debug(`Shared keys (end phase 2) with new Olm sessions in ${this.roomId}`),await this.notifyFailedOlmDevices(i,c,s)})():await this.notifyFailedOlmDevices(i,c,e),o.logger.debug(`Shared keys (all phases done) with new Olm sessions in ${this.roomId}`)})(),(async()=>{o.logger.debug(`There are ${Object.entries(r).length} blocked devices in ${this.roomId}`,Object.entries(r)),o.logger.debug(`Notifying newly blocked devices in ${this.roomId}`);const e={};let t=0;for(const[n,o]of Object.entries(r))for(const[r,s]of Object.entries(o))i.blockedDevicesNotified[n]&&void 0!==i.blockedDevicesNotified[n][r]||(e[n]=e[n]||{},e[n][r]={device:s},t++);await this.notifyBlockedDevices(i,e),o.logger.debug(`Notified ${t} newly blocked devices in ${this.roomId}`,e)})()])}async prepareNewSession(e){const t=this.olmDevice.createOutboundGroupSession(),n=this.olmDevice.getOutboundGroupSessionKey(t);return await this.olmDevice.addInboundGroupSession(this.roomId,this.olmDevice.deviceCurve25519Key,[],t,n.key,{ed25519:this.olmDevice.deviceEd25519Key},!1,{sharedHistory:e}),this.crypto.backupManager.backupGroupSession(this.olmDevice.deviceCurve25519Key,t),new h(t,e)}getDevicesWithoutSessions(e,t,n=[]){for(const[r,i]of Object.entries(t)){const t=e[r];for(const e of i){const i=e.deviceId,o=t[i];o.sessionId||(n.push({userId:r,deviceInfo:e}),delete t[i])}}return n}splitDevices(e){const t=20;let n=[];const r=[n];for(const[i,o]of Object.entries(e)){for(const e of Object.values(o))n.push({userId:i,deviceInfo:e.device});n.length>t&&(n=[],r.push(n))}return 0===n.length&&r.pop(),r}encryptAndSendKeysToDevices(e,t,n,r){const i={},a=new Map,c=[];for(let o=0;o<n.length;o++){const e={algorithm:s.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}},t=n[o],l=t.userId,d=t.deviceInfo,u=d.deviceId;let h=a.get(l);void 0===h&&(h=new Map,a.set(l,h)),h.set(u,d),i[l]||(i[l]={}),i[l][u]=e,c.push(s.encryptMessageForDevice(e.ciphertext,this.userId,this.deviceId,this.olmDevice,l,d,r))}return Promise.all(c).then((()=>{for(const e of Object.keys(i)){for(const t of Object.keys(i[e]))0===Object.keys(i[e][t].ciphertext).length&&(o.logger.log("No ciphertext for device "+e+":"+t+": pruning"),delete i[e][t]);0===Object.keys(i[e]).length&&(o.logger.log("Pruned all devices for user "+e),delete i[e])}if(0!==Object.keys(i).length)return this.baseApis.sendToDevice("m.room.encrypted",i).then((()=>{for(const n of Object.keys(i))for(const r of Object.keys(i[n]))e.markSharedWithDevice(n,r,a.get(n).get(r).getIdentityKey(),t)}));o.logger.log("No users left to send to: aborting")}))}async sendBlockedNotificationsToDevices(e,t,n){const r={};for(const i of t){const e=i.userId,t=i.deviceInfo,o=t.deviceInfo,s=o.deviceId,a=Object.assign({},n);a.code=t.code,a.reason=t.reason,"m.no_olm"===a.code&&(delete a.room_id,delete a.session_id),r[e]||(r[e]={}),r[e][s]=a}await this.baseApis.sendToDevice("org.matrix.room_key.withheld",r),await this.baseApis.sendToDevice("m.room_key.withheld",r);for(const i of Object.keys(r))for(const t of Object.keys(r[i]))e.markNotifiedBlockedDevice(i,t)}async reshareKeyWithDevice(e,t,n,r){const i=this.outboundSessions[t];if(!i)return void o.logger.debug(`megolm session ${t} not found: not re-sharing keys`);if(void 0===i.sharedWithDevices[n])return void o.logger.debug(`megolm session ${t} never shared with user ${n}`);const a=i.sharedWithDevices[n][r.deviceId];if(void 0===a)return void o.logger.debug("megolm session ID "+t+" never shared with device "+n+":"+r.deviceId);if(a.deviceKey!==r.getIdentityKey())return void o.logger.warn(`Session has been shared with device ${r.deviceId} but with identity key ${a.deviceKey}. Key is now ${r.getIdentityKey()}!`);const c=await this.olmDevice.getInboundGroupSessionKey(this.roomId,e,t,a.messageIndex);if(!c)return void o.logger.warn(`No inbound session key found for megolm ${t}: not re-sharing keys`);await s.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,{[n]:[r]});const l={type:"m.forwarded_room_key",content:{algorithm:s.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:t,session_key:c.key,chain_index:c.chain_index,sender_key:e,sender_claimed_ed25519_key:c.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:c.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":c.shared_history||!1}},d={algorithm:s.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};await s.encryptMessageForDevice(d.ciphertext,this.userId,this.deviceId,this.olmDevice,n,r,l),await this.baseApis.sendToDevice("m.room.encrypted",{[n]:{[r.deviceId]:d}}),o.logger.debug(`Re-shared key for megolm session ${t} with ${n}:${r.deviceId}`)}async shareKeyWithDevices(e,t,n,r,i,a,c){var l;o.logger.debug(`Ensuring Olm sessions for devices in ${this.roomId}`);const d=await s.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,r,!1,a,c,null===(l=o.logger.withPrefix)||void 0===l?void 0:l.call(o.logger,`[${this.roomId}]`));o.logger.debug(`Ensured Olm sessions for devices in ${this.roomId}`),this.getDevicesWithoutSessions(d,r,i),o.logger.debug(`Sharing keys with newly created Olm sessions in ${this.roomId}`),await this.shareKeyWithOlmSessions(e,t,n,d),o.logger.debug(`Shared keys with newly created Olm sessions in ${this.roomId}`)}async shareKeyWithOlmSessions(e,t,n,r){const i=this.splitDevices(r);for(let a=0;a<i.length;a++){const r=`megolm keys for ${e.sessionId} in ${this.roomId} (slice ${a+1}/${i.length})`;try{o.logger.debug(`Sharing ${r}`,i[a].map((e=>`${e.userId}/${e.deviceInfo.deviceId}`))),await this.encryptAndSendKeysToDevices(e,t.chain_index,i[a],n),o.logger.debug(`Shared ${r}`)}catch(s){throw o.logger.error(`Failed to share ${r}`),s}}}async notifyFailedOlmDevices(e,t,n){o.logger.debug(`Notifying ${n.length} devices we failed to create Olm sessions in ${this.roomId}`);for(const{userId:o,deviceInfo:s}of n){const n=s.deviceId;e.markSharedWithDevice(o,n,s.getIdentityKey(),t.chain_index)}const r=await this.olmDevice.filterOutNotifiedErrorDevices(n);o.logger.debug(`Need to notify ${r.length} failed devices which haven't been notified before in ${this.roomId}`);const i={};for(const{userId:o,deviceInfo:s}of r)i[o]=i[o]||{},i[o][s.deviceId]={device:{code:"m.no_olm",reason:c.WITHHELD_MESSAGES["m.no_olm"],deviceInfo:s}};await this.notifyBlockedDevices(e,i),o.logger.debug(`Notified ${r.length} devices we failed to create Olm sessions in ${this.roomId}`)}async notifyBlockedDevices(e,t){const n={room_id:this.roomId,session_id:e.sessionId,algorithm:s.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key},r=this.splitDevices(t);for(let s=0;s<r.length;s++)try{await this.sendBlockedNotificationsToDevices(e,r[s],n),o.logger.log(`Completed blacklist notification for ${e.sessionId} in ${this.roomId} (slice ${s+1}/${r.length})`)}catch(i){throw o.logger.log(`blacklist notification for ${e.sessionId} in ${this.roomId} (slice ${s+1}/${r.length}) failed`),i}}prepareToEncrypt(e){if(null==this.encryptionPreparation)o.logger.debug(`Preparing to encrypt events for ${this.roomId}`),this.encryptionPreparation={startTime:Date.now(),promise:(async()=>{try{o.logger.debug(`Getting devices in ${this.roomId}`);const[t,n]=await this.getDevicesInRoom(e);this.crypto.getGlobalErrorOnUnknownDevices()&&this.removeUnknownDevices(t),o.logger.debug(`Ensuring outbound session in ${this.roomId}`),await this.ensureOutboundSession(e,t,n,!0),o.logger.debug(`Ready to encrypt events for ${this.roomId}`)}catch(t){o.logger.error(`Failed to prepare to encrypt events for ${this.roomId}`,t)}finally{delete this.encryptionPreparation}})()};else{const e=Date.now()-this.encryptionPreparation.startTime;o.logger.debug(`Already started preparing to encrypt for ${this.roomId} ${e} ms ago, skipping`)}}async encryptMessage(e,t,n){if(o.logger.log(`Starting to encrypt event for ${this.roomId}`),null!=this.encryptionPreparation)try{await this.encryptionPreparation.promise}catch(u){}const[r,i]=await this.getDevicesInRoom(e);this.crypto.getGlobalErrorOnUnknownDevices()&&this.checkForUnknownDevices(r);const a=await this.ensureOutboundSession(e,r,i),c={room_id:this.roomId,type:t,content:n},l=this.olmDevice.encryptGroupMessage(a.sessionId,JSON.stringify(c)),d={algorithm:s.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:l,session_id:a.sessionId,device_id:this.deviceId};return a.useCount++,d}forceDiscardSession(){this.setupPromise=this.setupPromise.then((()=>null))}checkForUnknownDevices(e){const t={};if(Object.keys(e).forEach((n=>{Object.keys(e[n]).forEach((r=>{const i=e[n][r];i.isUnverified()&&!i.isKnown()&&(t[n]||(t[n]={}),t[n][r]=i)}))})),Object.keys(t).length)throw new a.UnknownDeviceError("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)}removeUnknownDevices(e){for(const[t,n]of Object.entries(e)){for(const[e,t]of Object.entries(n))t.isUnverified()&&!t.isKnown()&&delete n[e];0===Object.keys(n).length&&delete e[t]}}async getDevicesInRoom(e){const t=await e.getEncryptionTargetMembers(),n=t.map((function(e){return e.userId}));let r=this.crypto.getGlobalBlacklistUnverifiedDevices();"boolean"===typeof e.getBlacklistUnverifiedDevices()&&(r=e.getBlacklistUnverifiedDevices());const i=await this.crypto.downloadKeys(n,!1),o={};for(const s in i){if(!i.hasOwnProperty(s))continue;const e=i[s];for(const t in e){if(!e.hasOwnProperty(t))continue;const n=this.crypto.checkDeviceTrust(s,t);if(e[t].isBlocked()||!n.isVerified()&&r){o[s]||(o[s]={});const n=e[t].isBlocked();o[s][t]={code:n?"m.blacklisted":"m.unverified",reason:c.WITHHELD_MESSAGES[n?"m.blacklisted":"m.unverified"],deviceInfo:e[t]},delete e[t]}}}return[i,o]}}class p extends a.DecryptionAlgorithm{constructor(...e){super(...e),(0,i.default)(this,"pendingEvents",{}),(0,i.default)(this,"olmlib",s)}async decryptEvent(e){const t=e.getWireContent();if(!t.sender_key||!t.session_id||!t.ciphertext)throw new a.DecryptionError("MEGOLM_MISSING_FIELDS","Missing fields in input");let n;this.addEventToPendingList(e);try{n=await this.olmDevice.decryptGroupMessage(e.getRoomId(),t.sender_key,t.session_id,t.ciphertext,e.getId(),e.getTs())}catch(i){if("DecryptionError"===i.name)throw i;let n="OLM_DECRYPT_GROUP_MESSAGE_ERROR";throw i&&"OLM.UNKNOWN_MESSAGE_INDEX"===i.message&&(this.requestKeysForEvent(e),n="OLM_UNKNOWN_MESSAGE_INDEX"),new a.DecryptionError(n,i?i.toString():"Unknown Error: Error is undefined",{session:t.sender_key+"|"+t.session_id})}if(null===n){this.crypto.backupManager.queryKeyBackupRateLimited(e.getRoomId(),t.session_id).catch((()=>{})),this.requestKeysForEvent(e);const n=await this.olmDevice.sessionMayHaveProblems(t.sender_key,e.getTs()-12e4);if(n){let e=f[n.type]||f.unknown;throw n.fixed&&(e+=" Trying to create a new secure channel and re-requesting the keys."),new a.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",e,{session:t.sender_key+"|"+t.session_id})}throw new a.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID","The sender's device has not sent us the keys for this message.",{session:t.sender_key+"|"+t.session_id})}this.removeEventFromPendingList(e);const r=JSON.parse(n.result);if(r.room_id!==e.getRoomId())throw new a.DecryptionError("MEGOLM_BAD_ROOM","Message intended for room "+r.room_id);return{clearEvent:r,senderCurve25519Key:n.senderKey,claimedEd25519Key:n.keysClaimed.ed25519,forwardingCurve25519KeyChain:n.forwardingCurve25519KeyChain,untrusted:n.untrusted}}requestKeysForEvent(e){const t=e.getWireContent(),n=e.getKeyRequestRecipients(this.userId);this.crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},n)}addEventToPendingList(e){var t;const n=e.getWireContent(),r=n.sender_key,i=n.session_id;this.pendingEvents[r]||(this.pendingEvents[r]=new Map);const o=this.pendingEvents[r];o.has(i)||o.set(i,new Set),null===(t=o.get(i))||void 0===t||t.add(e)}removeEventFromPendingList(e){const t=e.getWireContent(),n=t.sender_key,r=t.session_id,i=this.pendingEvents[n],o=null===i||void 0===i?void 0:i.get(r);o&&(o.delete(e),0===o.size&&i.delete(r),0===i.size&&delete this.pendingEvents[n])}async onRoomKeyEvent(e){const t=e.getContent();let n,r=e.getSenderKey(),i=[],s=!1;if(!t.room_id||!t.session_key||!t.session_id||!t.algorithm)return void o.logger.error("key event is missing fields");if(!r)return void o.logger.error("key event has no sender key (not encrypted?)");if("m.forwarded_room_key"==e.getType()){if(s=!0,i=Array.isArray(t.forwarding_curve25519_key_chain)?t.forwarding_curve25519_key_chain:[],i=i.slice(),i.push(r),!t.sender_key)return void o.logger.error("forwarded_room_key event is missing sender_key field");r=t.sender_key;const e=t.sender_claimed_ed25519_key;if(!e)return void o.logger.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");n={ed25519:e}}else n=e.getKeysClaimed();const a={};t["org.matrix.msc3061.shared_history"]&&(a.sharedHistory=!0);try{await this.olmDevice.addInboundGroupSession(t.room_id,r,i,t.session_id,t.session_key,n,s,a),await this.retryDecryption(r,t.session_id)&&this.crypto.cancelRoomKeyRequest({algorithm:t.algorithm,room_id:t.room_id,session_id:t.session_id,sender_key:r}),await this.crypto.backupManager.backupGroupSession(r,t.session_id)}catch(c){o.logger.error(`Error handling m.room_key_event: ${c}`)}}async onRoomKeyWithheldEvent(e){const t=e.getContent(),n=t.sender_key;if("m.no_olm"===t.code){const r=e.getSender();if(o.logger.warn(`${r}:${n} was unable to establish an olm session with us`),await this.olmDevice.getSessionIdForDevice(n))return o.logger.debug("New session already created.  Not creating a new one."),await this.olmDevice.recordSessionProblem(n,"no_olm",!0),void this.retryDecryptionFromSender(n);let i=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,n);if(!i&&(await this.crypto.downloadKeys([r],!1),i=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,n),!i))return o.logger.info("Couldn't find device for identity key "+n+": not establishing session"),await this.olmDevice.recordSessionProblem(n,"no_olm",!1),void this.retryDecryptionFromSender(n);await s.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,{[r]:[i]},!1);const a={algorithm:s.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};await s.encryptMessageForDevice(a.ciphertext,this.userId,void 0,this.olmDevice,r,i,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(n,"no_olm",!0),this.retryDecryptionFromSender(n),await this.baseApis.sendToDevice("m.room.encrypted",{[r]:{[i.deviceId]:a}})}else await this.olmDevice.addInboundGroupSessionWithheld(t.room_id,n,t.session_id,t.code,t.reason)}hasKeysForKeyRequest(e){const t=e.requestBody;return this.olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)}shareKeysWithDevice(e){const t=e.userId,n=e.deviceId,r=this.crypto.getStoredDevice(t,n),i=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,{[t]:[r]}).then((e=>{const r=e[t][n];return r.sessionId?(o.logger.log("sharing keys for session "+i.sender_key+"|"+i.session_id+" with device "+t+":"+n),this.buildKeyForwardingMessage(i.room_id,i.sender_key,i.session_id)):null})).then((e=>{const i={algorithm:s.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};return this.olmlib.encryptMessageForDevice(i.ciphertext,this.userId,void 0,this.olmDevice,t,r,e).then((()=>{const e={[t]:{[n]:i}};return this.baseApis.sendToDevice("m.room.encrypted",e)}))}))}async buildKeyForwardingMessage(e,t,n){const r=await this.olmDevice.getInboundGroupSessionKey(e,t,n);return{type:"m.forwarded_room_key",content:{algorithm:s.MEGOLM_ALGORITHM,room_id:e,sender_key:t,sender_claimed_ed25519_key:r.sender_claimed_ed25519_key,session_id:n,session_key:r.key,chain_index:r.chain_index,forwarding_curve25519_key_chain:r.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":r.shared_history||!1}}}importRoomKey(e,t={}){const n={};return(t.untrusted||e.untrusted)&&(n.untrusted=!0),e["org.matrix.msc3061.shared_history"]&&(n.sharedHistory=!0),this.olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0,n).then((()=>{"backup"!==t.source&&this.crypto.backupManager.backupGroupSession(e.sender_key,e.session_id).catch((e=>{o.logger.log("Failed to back up megolm session",e)})),this.retryDecryption(e.sender_key,e.session_id)}))}async retryDecryption(e,t){var n;const r=this.pendingEvents[e];if(!r)return!0;const i=r.get(t);return!i||(o.logger.debug("Retrying decryption on events",[...i]),await Promise.all([...i].map((async e=>{try{await e.attemptDecryption(this.crypto,{isRetry:!0})}catch(t){}}))),!(null!==(n=this.pendingEvents[e])&&void 0!==n&&n.has(t)))}async retryDecryptionFromSender(e){const t=this.pendingEvents[e];return!t||(delete this.pendingEvents[e],await Promise.all([...t].map((async([e,t])=>{await Promise.all([...t].map((async e=>{try{await e.attemptDecryption(this.crypto)}catch(t){}})))}))),!this.pendingEvents[e])}async sendSharedHistoryInboundSessions(e){await s.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,e),o.logger.log("sendSharedHistoryInboundSessions to users",Object.keys(e));const t=await this.olmDevice.getSharedHistoryInboundGroupSessions(this.roomId);o.logger.log("shared-history sessions",t);for(const[n,r]of t){const t=await this.buildKeyForwardingMessage(this.roomId,n,r),i=[],a={};for(const[n,r]of Object.entries(e)){a[n]={};for(const e of r){const r={algorithm:s.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};a[n][e.deviceId]=r,i.push(s.encryptMessageForDevice(r.ciphertext,this.userId,void 0,this.olmDevice,n,e,t))}}await Promise.all(i);for(const e of Object.keys(a)){for(const t of Object.keys(a[e]))0===Object.keys(a[e][t].ciphertext).length&&(o.logger.log("No ciphertext for device "+e+":"+t+": pruning"),delete a[e][t]);0===Object.keys(a[e]).length&&(o.logger.log("Pruned all devices for user "+e),delete a[e])}if(0===Object.keys(a).length)return void o.logger.log("No users left to send to: aborting");await this.baseApis.sendToDevice("m.room.encrypted",a)}}}const f={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};(0,a.registerAlgorithm)(s.MEGOLM_ALGORITHM,g,p)},7625:function(e,t,n){"use strict";n(1703);var r=n(3965),i=r(n(4344)),o=n(6471),s=d(n(9485)),a=n(1949),c=n(4059);function l(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(l=function(e){return e?n:t})(e)}function d(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=l(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}const u=a.DeviceInfo.DeviceVerification;class h extends c.EncryptionAlgorithm{constructor(...e){super(...e),(0,i.default)(this,"sessionPrepared",!1),(0,i.default)(this,"prepPromise",null)}ensureSession(e){return this.prepPromise?this.prepPromise:this.sessionPrepared?Promise.resolve():(this.prepPromise=this.crypto.downloadKeys(e).then((()=>this.crypto.ensureOlmSessionsForUsers(e))).then((()=>{this.sessionPrepared=!0})).finally((()=>{this.prepPromise=null})),this.prepPromise)}async encryptMessage(e,t,n){const r=await e.getEncryptionTargetMembers(),i=r.map((function(e){return e.userId}));await this.ensureSession(i);const o={room_id:e.roomId,type:t,content:n},a={algorithm:s.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}},c=[];for(let l=0;l<i.length;++l){const e=i[l],t=this.crypto.getStoredDevicesForUser(e)||[];for(let n=0;n<t.length;++n){const r=t[n],i=r.getIdentityKey();i!=this.olmDevice.deviceCurve25519Key&&(r.verified!=u.BLOCKED&&c.push(s.encryptMessageForDevice(a.ciphertext,this.userId,this.deviceId,this.olmDevice,e,r,o)))}}return Promise.all(c).then((()=>a))}}class g extends c.DecryptionAlgorithm{async decryptEvent(e){const t=e.getWireContent(),n=t.sender_key,r=t.ciphertext;if(!r)throw new c.DecryptionError("OLM_MISSING_CIPHERTEXT","Missing ciphertext");if(!(this.olmDevice.deviceCurve25519Key in r))throw new c.DecryptionError("OLM_NOT_INCLUDED_IN_RECIPIENTS","Not included in recipients");const i=r[this.olmDevice.deviceCurve25519Key];let o;try{o=await this.decryptMessage(n,i)}catch(l){throw new c.DecryptionError("OLM_BAD_ENCRYPTED_MESSAGE","Bad Encrypted Message",{sender:n,err:l})}const s=JSON.parse(o);if(s.recipient!=this.userId)throw new c.DecryptionError("OLM_BAD_RECIPIENT","Message was intented for "+s.recipient);if(s.recipient_keys.ed25519!=this.olmDevice.deviceEd25519Key)throw new c.DecryptionError("OLM_BAD_RECIPIENT_KEY","Message not intended for this device",{intended:s.recipient_keys.ed25519,our_key:this.olmDevice.deviceEd25519Key});if(s.sender!=e.getSender())throw new c.DecryptionError("OLM_FORWARDED_MESSAGE","Message forwarded from "+s.sender,{reported_sender:e.getSender()});if(s.room_id!==e.getRoomId())throw new c.DecryptionError("OLM_BAD_ROOM","Message intended for room "+s.room_id,{reported_room:e.getRoomId()||"ROOM_ID_UNDEFINED"});const a=s.keys||{};return{clearEvent:s,senderCurve25519Key:n,claimedEd25519Key:a.ed25519||null}}decryptMessage(e,t){if(0!==t.type)return this.reallyDecryptMessage(e,t);{const n=this.olmDevice.olmPrekeyPromise.then((()=>this.reallyDecryptMessage(e,t)));return this.olmDevice.olmPrekeyPromise=n.catch((()=>{})),n}}async reallyDecryptMessage(e,t){const n=await this.olmDevice.getSessionIdsForDevice(e),r={};for(let a=0;a<n.length;a++){const i=n[a];try{const n=await this.olmDevice.decryptMessage(e,i,t.type,t.body);return o.logger.log("Decrypted Olm message from "+e+" with session "+i),n}catch(s){const n=await this.olmDevice.matchesSession(e,i,t.type,t.body);if(n)throw new Error("Error decrypting prekey message with existing session id "+i+": "+s.message);r[i]=s.message}}if(0!==t.type){if(0===n.length)throw new Error("No existing sessions");throw new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(r))}let i;try{i=await this.olmDevice.createInboundSession(e,t.type,t.body)}catch(s){throw r["(new)"]=s.message,new Error("Error decrypting prekey message: "+JSON.stringify(r))}return o.logger.log("created new inbound Olm session ID "+i.session_id+" with "+e),i.payload}}(0,c.registerAlgorithm)(s.OLM_ALGORITHM,h,g)},9168:function(e,t){"use strict";let n;Object.defineProperty(t,"__esModule",{value:!0}),t.CrossSigningKey=void 0,t.CrossSigningKey=n,function(e){e["Master"]="master",e["SelfSigning"]="self_signing",e["UserSigning"]="user_signing"}(n||(t.CrossSigningKey=n={}))},8862:function(e,t,n){"use strict";n(1703),n(8675),n(3462),n(7380),n(1118);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.algorithmsByName=t.DefaultAlgorithm=t.Curve25519=t.BackupManager=t.Aes256=void 0;var i=r(n(4344)),o=n(9528),s=n(6471),a=n(9485),c=n(4791),l=n(3926),d=n(7896),u=n(4897),h=n(5470),g=n(3698),p=n(529);const f=200,y=5e3;class m{constructor(e,t){this.baseApis=e,this.getKey=t,(0,i.default)(this,"algorithm",void 0),(0,i.default)(this,"backupInfo",void 0),(0,i.default)(this,"checkedForBackup",void 0),(0,i.default)(this,"sendingBackups",void 0),(0,i.default)(this,"sessionLastCheckAttemptedTime",{}),this.checkedForBackup=!1,this.sendingBackups=!1}get version(){return this.backupInfo&&this.backupInfo.version}static checkBackupVersion(e){const t=w[e.algorithm];if(!t)throw new Error("Unknown backup algorithm: "+e.algorithm);if("object"!==typeof e.auth_data)throw new Error("Invalid backup data returned");return t.checkBackupVersion(e)}static makeAlgorithm(e,t){const n=w[e.algorithm];if(!n)throw new Error("Unknown backup algorithm");return n.init(e.auth_data,t)}async enableKeyBackup(e){this.backupInfo=e,this.algorithm&&this.algorithm.free(),this.algorithm=await m.makeAlgorithm(e,this.getKey),this.baseApis.emit(p.CryptoEvent.KeyBackupStatus,!0),this.scheduleKeyBackupSend()}disableKeyBackup(){this.algorithm&&this.algorithm.free(),this.algorithm=void 0,this.backupInfo=void 0,this.baseApis.emit(p.CryptoEvent.KeyBackupStatus,!1)}getKeyBackupEnabled(){return this.checkedForBackup?Boolean(this.algorithm):null}async prepareKeyBackupVersion(e,t){const n=t?w[t]:_;if(!n)throw new Error("Unknown backup algorithm");const[r,i]=await n.prepare(e),o=(0,u.encodeRecoveryKey)(r);return{algorithm:n.algorithmName,auth_data:i,recovery_key:o,privateKey:r}}async createKeyBackupVersion(e){this.algorithm=await m.makeAlgorithm(e,this.getKey)}async checkAndStart(){if(s.logger.log("Checking key backup status..."),this.baseApis.isGuest())return s.logger.log("Skipping key backup check since user is guest"),this.checkedForBackup=!0,null;let e;try{e=await this.baseApis.getKeyBackupVersion()}catch(n){return s.logger.log("Error checking for active key backup",n),404===n.httpStatus&&(this.checkedForBackup=!0),null}this.checkedForBackup=!0;const t=await this.isKeyBackupTrusted(e);return t.usable&&!this.backupInfo?(s.logger.log("Found usable key backup v"+e.version+": enabling key backups"),await this.enableKeyBackup(e)):!t.usable&&this.backupInfo?(s.logger.log("No usable key backup: disabling key backup"),this.disableKeyBackup()):t.usable||this.backupInfo?t.usable&&this.backupInfo&&(e.version!==this.backupInfo.version?(s.logger.log("On backup version "+this.backupInfo.version+" but found version "+e.version+": switching."),this.disableKeyBackup(),await this.enableKeyBackup(e),await this.scheduleAllGroupSessionsForBackup()):s.logger.log("Backup version "+e.version+" still current")):s.logger.log("No usable key backup: not enabling key backup"),{backupInfo:e,trustInfo:t}}async checkKeyBackup(){return this.checkedForBackup=!1,this.checkAndStart()}async queryKeyBackupRateLimited(e,t){if(!this.backupInfo)return;const n=(new Date).getTime();(!this.sessionLastCheckAttemptedTime[t]||n-this.sessionLastCheckAttemptedTime[t]>y)&&(this.sessionLastCheckAttemptedTime[t]=n,await this.baseApis.restoreKeyBackupWithCache(e,t,this.backupInfo,{}))}async isKeyBackupTrusted(e){const t={usable:!1,trusted_locally:!1,sigs:[]};if(!e||!e.algorithm||!e.auth_data||!e.auth_data.signatures)return s.logger.info("Key backup is absent or missing required data"),t;const n=await this.baseApis.crypto.getSessionBackupPrivateKey();if(n){let r;try{r=await m.makeAlgorithm(e,(async()=>n)),await r.keyMatches(n)&&(s.logger.info("Backup is trusted locally"),t.trusted_locally=!0)}catch{}finally{r&&r.free()}}const r=e.auth_data.signatures[this.baseApis.getUserId()]||{};for(const o of Object.keys(r)){const n=o.split(":");if("ed25519"!==n[0]){s.logger.log("Ignoring unknown signature type: "+n[0]);continue}const r={deviceId:n[1]},c=this.baseApis.crypto.crossSigningInfo.getId();if(c===r.deviceId){r.crossSigningId=!0;try{await(0,a.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,this.baseApis.getUserId(),r.deviceId,c),r.valid=!0}catch(i){s.logger.warn("Bad signature from cross signing key "+c,i),r.valid=!1}t.sigs.push(r);continue}const l=this.baseApis.crypto.deviceList.getStoredDevice(this.baseApis.getUserId(),r.deviceId);if(l){r.device=l,r.deviceTrust=this.baseApis.checkDeviceTrust(this.baseApis.getUserId(),r.deviceId);try{await(0,a.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,this.baseApis.getUserId(),l.deviceId,l.getFingerprint()),r.valid=!0}catch(i){s.logger.info("Bad signature from key ID "+o+" userID "+this.baseApis.getUserId()+" device ID "+l.deviceId+" fingerprint: "+l.getFingerprint(),e.auth_data,i),r.valid=!1}}else r.valid=null,s.logger.info("Ignoring signature from unknown key "+o);t.sigs.push(r)}return t.usable=t.sigs.some((e=>e.valid&&(e.device&&e.deviceTrust.isVerified()||e.crossSigningId))),t.usable=t.usable||t.trusted_locally,t}async scheduleKeyBackupSend(e=1e4){if(!this.sendingBackups){this.sendingBackups=!0;try{const n=Math.random()*e;await(0,l.sleep)(n);let r=0;for(;;){if(!this.algorithm)return;try{const e=await this.backupPendingKeys(f);if(0===e)return;r=0}catch(t){if(r++,s.logger.log("Key backup request failed",t),t.data&&("M_NOT_FOUND"==t.data.errcode||"M_WRONG_ROOM_KEYS_VERSION"==t.data.errcode))throw await this.checkKeyBackup(),this.baseApis.crypto.emit(p.CryptoEvent.KeyBackupFailed,t.data.errcode),t}r&&await(0,l.sleep)(1e3*Math.pow(2,Math.min(r-1,4)))}}finally{this.sendingBackups=!1}}}async backupPendingKeys(e){const t=await this.baseApis.crypto.cryptoStore.getSessionsNeedingBackup(e);if(!t.length)return 0;let n=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();this.baseApis.crypto.emit(p.CryptoEvent.KeyBackupSessionsRemaining,n);const r={};for(const i of t){const e=i.sessionData.room_id;void 0===r[e]&&(r[e]={sessions:{}});const t=this.baseApis.crypto.olmDevice.exportInboundGroupSession(i.senderKey,i.sessionId,i.sessionData);t.algorithm=a.MEGOLM_ALGORITHM;const n=(t.forwarding_curve25519_key_chain||[]).length,o=this.baseApis.crypto.deviceList.getUserByIdentityKey(a.MEGOLM_ALGORITHM,i.senderKey),s=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(a.MEGOLM_ALGORITHM,i.senderKey),c=this.baseApis.crypto.checkDeviceInfoTrust(o,s).isVerified();r[e]["sessions"][i.sessionId]={first_message_index:t.first_known_index,forwarded_count:n,is_verified:c,session_data:await this.algorithm.encryptSession(t)}}return await this.baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:r}),await this.baseApis.crypto.cryptoStore.unmarkSessionsNeedingBackup(t),n=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup(),this.baseApis.crypto.emit(p.CryptoEvent.KeyBackupSessionsRemaining,n),t.length}async backupGroupSession(e,t){await this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([{senderKey:e,sessionId:t}]),this.backupInfo&&this.scheduleKeyBackupSend()}async scheduleAllGroupSessionsForBackup(){await this.flagAllGroupSessionsForBackup(),this.scheduleKeyBackupSend(0)}async flagAllGroupSessionsForBackup(){await this.baseApis.crypto.cryptoStore.doTxn("readwrite",[d.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,d.IndexedDBCryptoStore.STORE_BACKUP],(e=>{this.baseApis.crypto.cryptoStore.getAllEndToEndInboundGroupSessions(e,(t=>{null!==t&&this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([t],e)}))}));const e=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();return this.baseApis.emit(p.CryptoEvent.KeyBackupSessionsRemaining,e),e}countSessionsNeedingBackup(){return this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup()}}t.BackupManager=m;class v{constructor(e,t,n){this.authData=e,this.publicKey=t,this.getKey=n}static async init(e,t){if(!e||!("public_key"in e))throw new Error("auth_data missing required information");const r=new n.g.Olm.PkEncryption;return r.set_recipient_key(e.public_key),new v(e,r,t)}static async prepare(e){const t=new n.g.Olm.PkDecryption;try{const r={};if(e)if(e instanceof Uint8Array)r.public_key=t.init_with_private_key(e);else{const n=await(0,c.keyFromPassphrase)(e);r.private_key_salt=n.salt,r.private_key_iterations=n.iterations,r.public_key=t.init_with_private_key(n.key)}else r.public_key=t.generate_key();const i=new n.g.Olm.PkEncryption;return i.set_recipient_key(r.public_key),[t.get_private_key(),r]}finally{t.free()}}static checkBackupVersion(e){if(!("public_key"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!0}async encryptSession(e){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,this.publicKey.encrypt(JSON.stringify(t))}async decryptSessions(e){const t=await this.getKey(),r=new n.g.Olm.PkDecryption;try{const n=r.init_with_private_key(t);if(n!==this.authData.public_key)throw{errcode:o.MatrixClient.RESTORE_BACKUP_ERROR_BAD_KEY};const a=[];for(const[t,o]of Object.entries(e))try{const e=JSON.parse(r.decrypt(o.session_data.ephemeral,o.session_data.mac,o.session_data.ciphertext));e.session_id=t,a.push(e)}catch(i){s.logger.log("Failed to decrypt megolm session from backup",i,o)}return a}finally{r.free()}}async keyMatches(e){const t=new n.g.Olm.PkDecryption;let r;try{r=t.init_with_private_key(e)}finally{t.free()}return r===this.authData.public_key}free(){this.publicKey.free()}}function E(e){var t;const n=(0,l.getCrypto)();if(n)return n.randomBytes(e);if(null!==(t=window)&&void 0!==t&&t.crypto){const t=new Uint8Array(e);return window.crypto.getRandomValues(t),t}throw new Error("No usable crypto implementation")}t.Curve25519=v,(0,i.default)(v,"algorithmName","m.megolm_backup.v1.curve25519-aes-sha2");const S=new g.UnstableValue(null,"org.matrix.msc3270.v1.aes-hmac-sha2");class b{constructor(e,t){this.authData=e,this.key=t}static async init(e,t){if(!e)throw new Error("auth_data missing");const n=await t();if(e.mac){const{mac:t}=await(0,h.calculateKeyCheck)(n,e.iv);if(e.mac.replace(/=+$/g,"")!==t.replace(/=+/g,""))throw new Error("Key does not match")}return new b(e,n)}static async prepare(e){let t;const n={};if(e)if(e instanceof Uint8Array)t=new Uint8Array(e);else{const r=await(0,c.keyFromPassphrase)(e);n.private_key_salt=r.salt,n.private_key_iterations=r.iterations,t=r.key}else t=E(32);const{iv:r,mac:i}=await(0,h.calculateKeyCheck)(t);return n.iv=r,n.mac=i,[t,n]}static checkBackupVersion(e){if(!("iv"in e.auth_data)||!("mac"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!1}encryptSession(e){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,(0,h.encryptAES)(JSON.stringify(t),this.key,e.session_id)}async decryptSessions(e){const t=[];for(const[r,i]of Object.entries(e))try{const e=JSON.parse(await(0,h.decryptAES)(i.session_data,this.key,r));e.session_id=r,t.push(e)}catch(n){s.logger.log("Failed to decrypt megolm session from backup",n,i)}return t}async keyMatches(e){if(this.authData.mac){const{mac:t}=await(0,h.calculateKeyCheck)(e,this.authData.iv);return this.authData.mac.replace(/=+$/g,"")===t.replace(/=+/g,"")}return!0}free(){this.key.fill(0)}}t.Aes256=b,(0,i.default)(b,"algorithmName",S.name);const w={[v.algorithmName]:v,[b.algorithmName]:b};t.algorithmsByName=w;const _=v;t.DefaultAlgorithm=_},7205:function(e,t,n){"use strict";n(8675),n(3462),n(7380),n(1118);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.DehydrationManager=t.DEHYDRATION_ALGORITHM=void 0;var i=r(n(4344)),o=r(n(7577)),s=n(9485),a=n(7896),c=n(5470),l=n(6471),d=n(5354);const u="org.matrix.msc2697.v1.olm.libolm_pickle";t.DEHYDRATION_ALGORITHM=u;const h=6048e5;class g{constructor(e){this.crypto=e,(0,i.default)(this,"inProgress",!1),(0,i.default)(this,"timeoutId",void 0),(0,i.default)(this,"key",void 0),(0,i.default)(this,"keyInfo",void 0),(0,i.default)(this,"deviceDisplayName",void 0),this.getDehydrationKeyFromCache()}getDehydrationKeyFromCache(){return this.crypto.cryptoStore.doTxn("readonly",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.crypto.cryptoStore.getSecretStorePrivateKey(e,(async e=>{if(e){const{key:t,keyInfo:r,deviceDisplayName:i,time:o}=e,a=Buffer.from(this.crypto.olmDevice.pickleKey),l=await(0,c.decryptAES)(t,a,u);this.key=(0,s.decodeBase64)(l),this.keyInfo=r,this.deviceDisplayName=i;const d=Date.now(),g=Math.max(1,o+h-d);this.timeoutId=n.g.setTimeout(this.dehydrateDevice.bind(this),g)}}),"dehydration")}))}async setKeyAndQueueDehydration(e,t={},n){const r=await this.setKey(e,t,n);r||this.dehydrateDevice()}async setKey(e,t={},r){if(!e)return this.timeoutId&&(n.g.clearTimeout(this.timeoutId),this.timeoutId=void 0),await this.crypto.cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",null)})),this.key=void 0,void(this.keyInfo=void 0);let i=this.key&&e.length==this.key.length;for(let n=0;i&&n<e.length;n++)e[n]!=this.key[n]&&(i=!1);return i||(this.key=e,this.keyInfo=t,this.deviceDisplayName=r),i}async dehydrateDevice(){if(this.inProgress)l.logger.log("Dehydration already in progress -- not starting new dehydration");else{this.inProgress=!0,this.timeoutId&&(n.g.clearTimeout(this.timeoutId),this.timeoutId=void 0);try{const e=Buffer.from(this.crypto.olmDevice.pickleKey),t=await(0,c.encryptAES)((0,s.encodeBase64)(this.key),e,u);await this.crypto.cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",{keyInfo:this.keyInfo,key:t,deviceDisplayName:this.deviceDisplayName,time:Date.now()})})),l.logger.log("Attempting to dehydrate device"),l.logger.log("Creating account");const r=new n.g.Olm.Account;r.create();const i=JSON.parse(r.identity_keys()),g=r.max_number_of_one_time_keys();r.generate_one_time_keys(g/2),r.generate_fallback_key();const p=JSON.parse(r.one_time_keys()),f=JSON.parse(r.fallback_key());r.mark_keys_as_published();const y=r.pickle(new Uint8Array(this.key)),m={algorithm:u,account:y};this.keyInfo.passphrase&&(m.passphrase=this.keyInfo.passphrase),l.logger.log("Uploading account to server");const v=await this.crypto.baseApis.http.authedRequest(void 0,d.Method.Put,"/dehydrated_device",void 0,{device_data:m,initial_device_display_name:this.deviceDisplayName},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"}),E=v.device_id;l.logger.log("Preparing device keys",E);const S={algorithms:this.crypto.supportedAlgorithms,device_id:E,user_id:this.crypto.userId,keys:{[`ed25519:${E}`]:i.ed25519,[`curve25519:${E}`]:i.curve25519}},b=r.sign(o.default.stringify(S));S.signatures={[this.crypto.userId]:{[`ed25519:${E}`]:b}},this.crypto.crossSigningInfo.getId("self_signing")&&await this.crypto.crossSigningInfo.signObject(S,"self_signing"),l.logger.log("Preparing one-time keys");const w={};for(const[n,s]of Object.entries(p.curve25519)){const e={key:s},t=r.sign(o.default.stringify(e));e.signatures={[this.crypto.userId]:{[`ed25519:${E}`]:t}},w[`signed_curve25519:${n}`]=e}l.logger.log("Preparing fallback keys");const _={};for(const[n,s]of Object.entries(f.curve25519)){const e={key:s,fallback:!0},t=r.sign(o.default.stringify(e));e.signatures={[this.crypto.userId]:{[`ed25519:${E}`]:t}},_[`signed_curve25519:${n}`]=e}return l.logger.log("Uploading keys to server"),await this.crypto.baseApis.http.authedRequest(void 0,d.Method.Post,"/keys/upload/"+encodeURI(E),void 0,{device_keys:S,one_time_keys:w,"org.matrix.msc2732.fallback_keys":_}),l.logger.log("Done dehydrating"),this.timeoutId=n.g.setTimeout(this.dehydrateDevice.bind(this),h),E}finally{this.inProgress=!1}}}stop(){this.timeoutId&&(n.g.clearTimeout(this.timeoutId),this.timeoutId=void 0)}}t.DehydrationManager=g},1949:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceInfo=void 0;var i,o=r(n(4344));(function(e){e[e["Blocked"]=-1]="Blocked",e[e["Unverified"]=0]="Unverified",e[e["Verified"]=1]="Verified"})(i||(i={}));class s{static fromStorage(e,t){const n=new s(t);for(const r in e)e.hasOwnProperty(r)&&(n[r]=e[r]);return n}constructor(e){this.deviceId=e,(0,o.default)(this,"algorithms",void 0),(0,o.default)(this,"keys",{}),(0,o.default)(this,"verified",i.Unverified),(0,o.default)(this,"known",!1),(0,o.default)(this,"unsigned",{}),(0,o.default)(this,"signatures",{})}toStorage(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}}getFingerprint(){return this.keys["ed25519:"+this.deviceId]}getIdentityKey(){return this.keys["curve25519:"+this.deviceId]}getDisplayName(){return this.unsigned.device_display_name||null}isBlocked(){return this.verified==i.Blocked}isVerified(){return this.verified==i.Verified}isUnverified(){return this.verified==i.Unverified}isKnown(){return!0===this.known}}t.DeviceInfo=s,(0,o.default)(s,"DeviceVerification",{VERIFIED:i.Verified,UNVERIFIED:i.Unverified,BLOCKED:i.Blocked})},529:function(e,t,n){"use strict";n(1703),n(8675),n(3462),n(7380),n(1118),n(6699);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.IncomingRoomKeyRequest=t.CryptoEvent=t.Crypto=void 0,t.fixBackupKey=V,t.isCryptoAvailable=K,t.verificationMethods=void 0;var i=r(n(4344)),o=r(n(7577)),s=n(4111),a=n(6471),c=n(1677),l=N(n(9485)),d=n(3637),u=n(1949),h=N(n(4148)),g=n(4984),p=n(6733),f=n(5869),y=n(6831),m=n(7896),v=n(7264),E=n(6681),S=n(4791),b=n(4897),w=n(5691),_=n(5632),T=n(6321),I=n(1105),R=n(5592),k=n(5470),O=n(7205),C=n(8862),P=n(2139),M=n(3078),D=n(2842),A=n(9528),U=n(9392);function L(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(L=function(e){return e?n:t})(e)}function N(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=L(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}const B=u.DeviceInfo.DeviceVerification,j={[v.ReciprocateQRCode.NAME]:v.ReciprocateQRCode,[E.SAS.NAME]:E.SAS,[v.SHOW_QR_CODE_METHOD]:I.IllegalMethod,[v.SCAN_QR_CODE_METHOD]:I.IllegalMethod},x={RECIPROCATE_QR_CODE:v.ReciprocateQRCode.NAME,SAS:E.SAS.NAME};function K(){return Boolean(n.g.Olm)}t.verificationMethods=x;const F=36e5;let q;t.CryptoEvent=q,function(e){e["DeviceVerificationChanged"]="deviceVerificationChanged",e["UserTrustStatusChanged"]="userTrustStatusChanged",e["UserCrossSigningUpdated"]="userCrossSigningUpdated",e["RoomKeyRequest"]="crypto.roomKeyRequest",e["RoomKeyRequestCancellation"]="crypto.roomKeyRequestCancellation",e["KeyBackupStatus"]="crypto.keyBackupStatus",e["KeyBackupFailed"]="crypto.keyBackupFailed",e["KeyBackupSessionsRemaining"]="crypto.keyBackupSessionsRemaining",e["KeySignatureUploadFailure"]="crypto.keySignatureUploadFailure",e["VerificationRequest"]="crypto.verification.request",e["Warning"]="crypto.warning",e["WillUpdateDevices"]="crypto.willUpdateDevices",e["DevicesUpdated"]="crypto.devicesUpdated",e["KeysChanged"]="crossSigning.keysChanged"}(q||(t.CryptoEvent=q={}));class $ extends U.TypedEventEmitter{static getOlmVersion(){return c.OlmDevice.getOlmVersion()}constructor(e,t,n,r,o,u,p){if(super(),this.baseApis=e,this.userId=t,this.deviceId=n,this.clientStore=r,this.cryptoStore=o,this.roomList=u,(0,i.default)(this,"backupManager",void 0),(0,i.default)(this,"crossSigningInfo",void 0),(0,i.default)(this,"olmDevice",void 0),(0,i.default)(this,"deviceList",void 0),(0,i.default)(this,"dehydrationManager",void 0),(0,i.default)(this,"secretStorage",void 0),(0,i.default)(this,"reEmitter",void 0),(0,i.default)(this,"verificationMethods",void 0),(0,i.default)(this,"supportedAlgorithms",void 0),(0,i.default)(this,"outgoingRoomKeyRequestManager",void 0),(0,i.default)(this,"toDeviceVerificationRequests",void 0),(0,i.default)(this,"inRoomVerificationRequests",void 0),(0,i.default)(this,"trustCrossSignedDevices",!0),(0,i.default)(this,"lastOneTimeKeyCheck",null),(0,i.default)(this,"oneTimeKeyCheckInProgress",!1),(0,i.default)(this,"roomEncryptors",{}),(0,i.default)(this,"roomDecryptors",{}),(0,i.default)(this,"deviceKeys",{}),(0,i.default)(this,"globalBlacklistUnverifiedDevices",!1),(0,i.default)(this,"globalErrorOnUnknownDevices",!0),(0,i.default)(this,"receivedRoomKeyRequests",[]),(0,i.default)(this,"receivedRoomKeyRequestCancellations",[]),(0,i.default)(this,"processingRoomKeyRequests",!1),(0,i.default)(this,"lazyLoadMembers",!1),(0,i.default)(this,"roomDeviceTrackingState",{}),(0,i.default)(this,"lastNewSessionForced",{}),(0,i.default)(this,"sendKeyRequestsImmediately",!1),(0,i.default)(this,"oneTimeKeyCount",void 0),(0,i.default)(this,"needsNewFallback",void 0),(0,i.default)(this,"fallbackCleanup",void 0),(0,i.default)(this,"onDeviceListUserCrossSigningUpdated",(async e=>{if(e===this.userId){const t=this.deviceList.getStoredCrossSigningForUser(e),n=t?t.getId():null,r=this.crossSigningInfo.getId(),i=r!==n;r&&n&&!i?await this.checkOwnCrossSigningTrust():(this.storeTrustedSelfKeys(null),this.emit(q.KeysChanged,{}),this.emit(q.UserTrustStatusChanged,this.userId,this.checkUserTrust(e)))}else{await this.checkDeviceVerifications(e);const t=this.deviceList.getStoredCrossSigningForUser(e);t&&(t.updateCrossSigningVerifiedBefore(this.checkUserTrust(e).isCrossSigningVerified()),this.deviceList.setRawStoredCrossSigningForUser(e,t.toStorage())),this.emit(q.UserTrustStatusChanged,e,this.checkUserTrust(e))}})),(0,i.default)(this,"onMembership",((e,t,n)=>{try{this.onRoomMembership(e,t,n)}catch(r){a.logger.error("Error handling membership change:",r)}})),(0,i.default)(this,"onToDeviceEvent",(e=>{try{a.logger.log(`received to_device ${e.getType()} from: ${e.getSender()} id: ${e.getId()}`),"m.room_key"==e.getType()||"m.forwarded_room_key"==e.getType()?this.onRoomKeyEvent(e):"m.room_key_request"==e.getType()?this.onRoomKeyRequestEvent(e):"m.secret.request"===e.getType()?this.secretStorage.onRequestReceived(e):"m.secret.send"===e.getType()?this.secretStorage.onSecretReceived(e):"m.room_key.withheld"===e.getType()||"org.matrix.room_key.withheld"===e.getType()?this.onRoomKeyWithheldEvent(e):e.getContent().transaction_id?this.onKeyVerificationMessage(e):"m.bad.encrypted"===e.getContent().msgtype?this.onToDeviceBadEncrypted(e):(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&(e.isBeingDecrypted()||e.attemptDecryption(this),e.once(D.MatrixEventEvent.Decrypted,(e=>{this.onToDeviceEvent(e)})))}catch(t){a.logger.error("Error handling toDeviceEvent:",t)}})),(0,i.default)(this,"onTimelineEvent",((e,t,n,r,{liveEvent:i=!0}={})=>{if(!_.InRoomChannel.validateEvent(e,this.baseApis))return;const o=e=>{const t=new _.InRoomChannel(this.baseApis,e.getRoomId());return new w.VerificationRequest(t,this.verificationMethods,this.baseApis)};this.handleVerificationEvent(e,this.inRoomVerificationRequests,o,i)})),this.reEmitter=new s.TypedReEmitter(this),p){this.verificationMethods=new Map;for(const e of p)"string"===typeof e?j[e]&&this.verificationMethods.set(e,j[e]):e["NAME"]?this.verificationMethods.set(e["NAME"],e):a.logger.warn(`Excluding unknown verification method ${e}`)}else this.verificationMethods=new Map(Object.entries(j));this.backupManager=new C.BackupManager(e,(async()=>{const e=await this.getSessionBackupPrivateKey();if(e)return e;const t=await this.getSecret("m.megolm_backup.v1");if(t){const e=V(t);if(e){const[t]=await this.getSecretStorageKey();await this.storeSecret("m.megolm_backup.v1",e,[t])}return l.decodeBase64(e||t)}if(this.baseApis.cryptoCallbacks&&this.baseApis.cryptoCallbacks.getBackupKey)return this.baseApis.cryptoCallbacks.getBackupKey();throw new Error("Unable to get private key")})),this.olmDevice=new c.OlmDevice(o),this.deviceList=new d.DeviceList(e,o,this.olmDevice),this.deviceList.on(q.UserCrossSigningUpdated,this.onDeviceListUserCrossSigningUpdated),this.reEmitter.reEmit(this.deviceList,[q.DevicesUpdated,q.WillUpdateDevices]),this.supportedAlgorithms=Object.keys(h.DECRYPTION_CLASSES),this.outgoingRoomKeyRequestManager=new y.OutgoingRoomKeyRequestManager(e,this.deviceId,this.cryptoStore),this.toDeviceVerificationRequests=new T.ToDeviceRequests,this.inRoomVerificationRequests=new _.InRoomRequests;const m=this.baseApis.cryptoCallbacks||{},v=(0,g.createCryptoStoreCacheCallbacks)(o,this.olmDevice);this.crossSigningInfo=new g.CrossSigningInfo(t,m,v),this.secretStorage=new f.SecretStorage(e,m,e),this.dehydrationManager=new O.DehydrationManager(this),!m.getCrossSigningKey&&m.getSecretStorageKey&&(m.getCrossSigningKey=async e=>g.CrossSigningInfo.getFromSecretStorage(e,this.secretStorage))}async init({exportedOlmDevice:e,pickleKey:t}={}){a.logger.log("Crypto: initialising Olm..."),await n.g.Olm.init(),a.logger.log(e?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),await this.olmDevice.init({fromExportedDevice:e,pickleKey:t}),a.logger.log("Crypto: loading device list..."),await this.deviceList.load(),this.deviceKeys["ed25519:"+this.deviceId]=this.olmDevice.deviceEd25519Key,this.deviceKeys["curve25519:"+this.deviceId]=this.olmDevice.deviceCurve25519Key,a.logger.log("Crypto: fetching own devices...");let r=this.deviceList.getRawStoredDevicesForUser(this.userId);if(r||(r={}),!r[this.deviceId]){a.logger.log("Crypto: adding this device to the store...");const e={keys:this.deviceKeys,algorithms:this.supportedAlgorithms,verified:B.VERIFIED,known:!0};r[this.deviceId]=e,this.deviceList.storeDevicesForUser(this.userId,r),this.deviceList.saveIfDirty()}await this.cryptoStore.doTxn("readonly",[m.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.cryptoStore.getCrossSigningKeys(e,(e=>{e&&0!==Object.keys(e).length&&(a.logger.log("Loaded cross-signing public keys from crypto store"),this.crossSigningInfo.setKeys(e))}))})),this.deviceList.startTrackingDeviceList(this.userId),a.logger.log("Crypto: checking for key backup..."),this.backupManager.checkAndStart()}getCryptoTrustCrossSignedDevices(){return this.trustCrossSignedDevices}setCryptoTrustCrossSignedDevices(e){this.trustCrossSignedDevices=e;for(const t of this.deviceList.getKnownUserIds()){const e=this.deviceList.getRawStoredDevicesForUser(t);for(const n of Object.keys(e)){const e=this.checkDeviceTrust(t,n);if(!e.isLocallyVerified()&&e.isCrossSigningVerified()){const e=this.deviceList.getStoredDevice(t,n);this.emit(q.DeviceVerificationChanged,t,n,e)}}}}async createRecoveryKeyFromPassphrase(e){const t=new n.g.Olm.PkDecryption;try{const n={};if(e){const r=await(0,S.keyFromPassphrase)(e);n.passphrase={algorithm:"m.pbkdf2",iterations:r.iterations,salt:r.salt},n.pubkey=t.init_with_private_key(r.key)}else n.pubkey=t.generate_key();const r=t.get_private_key(),i=(0,b.encodeRecoveryKey)(r);return{keyInfo:n,encodedPrivateKey:i,privateKey:r}}finally{t&&t.free()}}async isCrossSigningReady(){const e=this.crossSigningInfo.getId(),t=await this.crossSigningInfo.isStoredInKeyCache()||await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage);return!(!e||!t)}async isSecretStorageReady(){const e=await this.secretStorage.hasKey(),t=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),n=!this.backupManager.getKeyBackupEnabled()||await this.baseApis.isKeyBackupKeyStored();return!!(e&&t&&n)}async bootstrapCrossSigning({authUploadDeviceSigningKeys:e,setupNewCrossSigning:t}={}){a.logger.log("Bootstrapping cross-signing");const n=this.baseApis.cryptoCallbacks,r=new p.EncryptionSetupBuilder(this.baseApis.store.accountData,n),i=new g.CrossSigningInfo(this.userId,r.crossSigningCallbacks,r.crossSigningCallbacks),o=async()=>{i.resetKeys(),await this.signObject(i.keys.master),r.addCrossSigningKeys(e,i.keys);const t=this.deviceList.getStoredDevice(this.userId,this.deviceId),n=await i.signDevice(this.userId,t);r.addKeySignature(this.userId,this.deviceId,n),this.backupManager.backupInfo&&(await i.signObject(this.backupManager.backupInfo.auth_data,"master"),r.addSessionBackup(this.backupManager.backupInfo))},s=this.crossSigningInfo.getId(),c=await this.crossSigningInfo.isStoredInKeyCache(),l=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),d=c||l;a.logger.log({setupNewCrossSigning:t,publicKeysOnDevice:s,privateKeysInCache:c,privateKeysInStorage:l,privateKeysExistSomewhere:d}),!d||t?(a.logger.log("Cross-signing private keys not found locally or in secret storage, creating new keys"),await o()):s&&c?a.logger.log("Cross-signing public keys trusted and private keys found locally"):l&&(a.logger.log("Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),await this.checkOwnCrossSigningTrust({allowPrivateKeyRequests:!0}));const u=r.crossSigningCallbacks.privateKeys;if(u.size&&!this.baseApis.cryptoCallbacks.saveCrossSigningKeys){const e=new f.SecretStorage(r.accountDataClientAdapter,r.ssssCryptoCallbacks);await e.hasKey()&&(a.logger.log("Storing new cross-signing private keys in secret storage"),await g.CrossSigningInfo.storeInSecretStorage(u,e))}const h=r.buildOperation();await h.apply(this),await r.persist(this),a.logger.log("Cross-signing ready")}async bootstrapSecretStorage({createSecretStorageKey:e=(async()=>({})),keyBackupInfo:t,setupNewKeyBackup:n,setupNewSecretStorage:r,getKeyBackupPassphrase:i}={}){a.logger.log("Bootstrapping Secure Secret Storage");const o=this.baseApis.cryptoCallbacks,s=new p.EncryptionSetupBuilder(this.baseApis.store.accountData,o),c=new f.SecretStorage(s.accountDataClientAdapter,s.ssssCryptoCallbacks);let d=null;const u=async(e,t)=>{t&&(e.key=t);const{keyId:n,keyInfo:r}=await c.addKey(f.SECRET_STORAGE_ALGORITHM_V1_AES,e);return t&&s.ssssCryptoCallbacks.addPrivateKey(n,r,t),await c.setDefaultKeyId(n),n},h=async(e,t)=>{if(!t.mac){const n=await this.baseApis.cryptoCallbacks.getSecretStorageKey({keys:{[e]:t}},"");if(n){const r=n[1];s.ssssCryptoCallbacks.addPrivateKey(e,t,r);const{iv:i,mac:o}=await(0,k.calculateKeyCheck)(r);t.iv=i,t.mac=o,await s.setAccountData(`m.secret_storage.key.${e}`,t)}}},y=async e=>{if(this.crossSigningInfo.getId()&&await this.crossSigningInfo.isStoredInKeyCache("master"))try{a.logger.log("Adding cross-signing signature to key backup"),await this.crossSigningInfo.signObject(e,"master")}catch(t){a.logger.error("Signing key backup with cross-signing keys failed",t)}else a.logger.warn("Cross-signing keys not available, skipping signature on key backup")},m=await this.getSecretStorageKey(),[v,E]=m||[null,null],S=!r&&E&&E.algorithm===f.SECRET_STORAGE_ALGORITHM_V1_AES;if(a.logger.log({keyBackupInfo:t,setupNewKeyBackup:n,setupNewSecretStorage:r,storageExists:S,oldKeyInfo:E}),S||t)if(!S&&t){a.logger.log("Secret storage does not exist, using key backup key");const e=await this.getSessionBackupPrivateKey()||await i(),n={};t.auth_data.private_key_salt&&t.auth_data.private_key_iterations&&(n.passphrase={algorithm:"m.pbkdf2",iterations:t.auth_data.private_key_iterations,salt:t.auth_data.private_key_salt,bits:256}),d=await u(n,e),await c.store("m.megolm_backup.v1",l.encodeBase64(e),[d]),await y(t.auth_data),s.addSessionBackup(t)}else a.logger.log("Secret storage exists"),E&&E.algorithm===f.SECRET_STORAGE_ALGORITHM_V1_AES&&await h(v,E);else{a.logger.log("Secret storage does not exist, creating new storage key");const{keyInfo:t={},privateKey:n}=await e();d=await u(t,n)}if(!this.baseApis.cryptoCallbacks.saveCrossSigningKeys&&await this.isCrossSigningReady()&&(d||!await this.crossSigningInfo.isStoredInSecretStorage(c))){a.logger.log("Copying cross-signing private keys from cache to secret storage");const e=await this.crossSigningInfo.getCrossSigningKeysFromCache();await g.CrossSigningInfo.storeInSecretStorage(e,c)}if(n&&!t){a.logger.log("Creating new message key backup version");const e=await this.baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1}),t=(0,b.decodeRecoveryKey)(e.recovery_key);await c.store("m.megolm_backup.v1",l.encodeBase64(t));const n={algorithm:e.algorithm,auth_data:e.auth_data};await y(n.auth_data),await this.signObject(n.auth_data),s.addSessionBackup(n)}const w=await c.get("m.megolm_backup.v1");if(w){a.logger.info("Got session backup key from secret storage: caching");const e=V(w);e&&await c.store("m.megolm_backup.v1",e,[d||v]);const t=new Uint8Array(l.decodeBase64(e||w));s.addSessionBackupPrivateKeyToCache(t)}else if(this.backupManager.getKeyBackupEnabled()){const e=await this.getSessionBackupPrivateKey()||await i();if(!e)return void a.logger.error("Key backup is enabled but couldn't get key backup key!");a.logger.info("Got session backup key from cache/user that wasn't in SSSS: saving to SSSS"),await c.store("m.megolm_backup.v1",l.encodeBase64(e))}const _=s.buildOperation();await _.apply(this),await s.persist(this),a.logger.log("Secure Secret Storage ready")}addSecretStorageKey(e,t,n){return this.secretStorage.addKey(e,t,n)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}getSecretStorageKey(e){return this.secretStorage.getKey(e)}storeSecret(e,t,n){return this.secretStorage.store(e,t,n)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){return t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(this.userId))),this.secretStorage.request(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}checkSecretStoragePrivateKey(e,t){let r=null;try{r=new n.g.Olm.PkDecryption;const i=r.init_with_private_key(e);return i===t}finally{r&&r.free()}}async getSessionBackupPrivateKey(){let e=await new Promise((e=>{this.cryptoStore.doTxn("readonly",[m.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{this.cryptoStore.getSecretStorePrivateKey(t,e,"m.megolm_backup.v1")}))}));if(e&&"string"===typeof e&&(e=new Uint8Array(l.decodeBase64(V(e)||e)),await this.storeSessionBackupPrivateKey(e)),e&&e.ciphertext){const t=Buffer.from(this.olmDevice.pickleKey),n=await(0,k.decryptAES)(e,t,"m.megolm_backup.v1");e=l.decodeBase64(n)}return e}async storeSessionBackupPrivateKey(e){if(!(e instanceof Uint8Array))throw new Error(`storeSessionBackupPrivateKey expects Uint8Array, got ${e}`);const t=Buffer.from(this.olmDevice.pickleKey),n=await(0,k.encryptAES)(l.encodeBase64(e),t,"m.megolm_backup.v1");return this.cryptoStore.doTxn("readwrite",[m.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.cryptoStore.storeSecretStorePrivateKey(e,"m.megolm_backup.v1",n)}))}checkCrossSigningPrivateKey(e,t){let r=null;try{r=new n.g.Olm.PkSigning;const i=r.init_with_seed(e);return i===t}finally{r&&r.free()}}async afterCrossSigningLocalKeyChange(){a.logger.info("Starting cross-signing key change post-processing");const e=this.deviceList.getStoredDevice(this.userId,this.deviceId),t=await this.crossSigningInfo.signDevice(this.userId,e);a.logger.info(`Starting background key sig upload for ${this.deviceId}`);const n=({shouldEmit:e=!1})=>this.baseApis.uploadKeySignatures({[this.userId]:{[this.deviceId]:t}}).then((t=>{const{failures:r}=t||{};if(Object.keys(r||[]).length>0)throw e&&this.baseApis.emit(q.KeySignatureUploadFailure,r,"afterCrossSigningLocalKeyChange",n),new R.KeySignatureUploadError("Key upload failed",{failures:r});a.logger.info(`Finished background key sig upload for ${this.deviceId}`)})).catch((e=>{a.logger.error(`Error during background key sig upload for ${this.deviceId}`,e)}));n({shouldEmit:!0});const r=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(r){a.logger.info("Starting device verification upgrade");const e={};for(const[t,n]of Object.entries(this.deviceList.crossSigningInfo)){const r=await this.checkForDeviceVerificationUpgrade(t,g.CrossSigningInfo.fromStorage(n,t));r&&(e[t]=r)}if(Object.keys(e).length>0){a.logger.info(`Found ${Object.keys(e).length} verif users to upgrade`);try{const t=await r({users:e});if(t)for(const n of t)n in e&&await this.baseApis.setDeviceVerified(n,e[n].crossSigningInfo.getId())}catch(i){a.logger.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",i)}}a.logger.info("Finished device verification upgrade")}a.logger.info("Finished cross-signing key change post-processing")}async checkForDeviceVerificationUpgrade(e,t){const n=this.crossSigningInfo.checkUserTrust(t);if(t.firstUse&&!n.isVerified()){const n=this.deviceList.getRawStoredDevicesForUser(e),r=await this.checkForValidDeviceSignature(e,t.keys.master,n);if(r.length)return{devices:r.map((e=>u.DeviceInfo.fromStorage(n[e],e))),crossSigningInfo:t}}}async checkForValidDeviceSignature(e,t,n){const r=[];if(n&&t.signatures&&t.signatures[e])for(const o of Object.keys(t.signatures[e])){const[,s]=o.split(":",2);if(s in n&&n[s].verified===B.VERIFIED)try{await l.verifySignature(this.olmDevice,t,e,s,n[s].keys[o]),r.push(s)}catch(i){}}return r}getCrossSigningId(e){return this.crossSigningInfo.getId(e)}getStoredCrossSigningForUser(e){return this.deviceList.getStoredCrossSigningForUser(e)}checkUserTrust(e){const t=this.deviceList.getStoredCrossSigningForUser(e);return t?this.crossSigningInfo.checkUserTrust(t):new g.UserTrustLevel(!1,!1,!1)}checkDeviceTrust(e,t){const n=this.deviceList.getStoredDevice(e,t);return this.checkDeviceInfoTrust(e,n)}checkDeviceInfoTrust(e,t){const n=!(!t||!t.isVerified()),r=this.deviceList.getStoredCrossSigningForUser(e);if(t&&r){const i=this.trustCrossSignedDevices||e===this.userId;return this.crossSigningInfo.checkDeviceTrust(r,t,n,i)}return new g.DeviceTrustLevel(!1,!1,n,!1)}checkIfOwnDeviceCrossSigned(e){const t=this.deviceList.getStoredDevice(this.userId,e),n=this.deviceList.getStoredCrossSigningForUser(this.userId);return n.checkDeviceTrust(n,t,!1,!0).isCrossSigningVerified()}async checkOwnCrossSigningTrust({allowPrivateKeyRequests:e=!1}={}){const t=this.userId;await this.downloadKeys([this.userId]);const n=await this.crossSigningInfo.getCrossSigningKeysFromCache(),r=this.deviceList.getStoredCrossSigningForUser(t);if(!r)return void a.logger.error("Got cross-signing update event for user "+t+" but no new cross-signing information found!");const i=r.getId(),o=this.crossSigningInfo.getId()!==i,s=r.getId()&&!n.has("master");if(o&&a.logger.info("Got new master public key",i),e&&(o||s)){a.logger.info("Attempting to retrieve cross-signing master private key");let e=null;try{const t=await this.crossSigningInfo.getCrossSigningKey("master",i);e=t[1],a.logger.info("Got cross-signing master private key")}finally{e&&e.free()}}const c=this.crossSigningInfo.getId("self_signing"),l=this.crossSigningInfo.getId("user_signing");this.storeTrustedSelfKeys(r.keys);const d=c!==r.getId("self_signing"),u=l!==r.getId("user_signing"),h=r.getId("self_signing")&&!n.has("self_signing"),g=r.getId("user_signing")&&!n.has("user_signing"),p={};if(d&&a.logger.info("Got new self-signing key",r.getId("self_signing")),e&&(d||h)){a.logger.info("Attempting to retrieve cross-signing self-signing private key");let e=null;try{const t=await this.crossSigningInfo.getCrossSigningKey("self_signing",r.getId("self_signing"));e=t[1],a.logger.info("Got cross-signing self-signing private key")}finally{e&&e.free()}const t=this.deviceList.getStoredDevice(this.userId,this.deviceId),n=await this.crossSigningInfo.signDevice(this.userId,t);p[this.deviceId]=n}if(u&&a.logger.info("Got new user-signing key",r.getId("user_signing")),e&&(u||g)){a.logger.info("Attempting to retrieve cross-signing user-signing private key");let e=null;try{const t=await this.crossSigningInfo.getCrossSigningKey("user_signing",r.getId("user_signing"));e=t[1],a.logger.info("Got cross-signing user-signing private key")}finally{e&&e.free()}}if(o){const e=this.crossSigningInfo.keys.master;await this.signObject(e);const t=e.signatures[this.userId]["ed25519:"+this.deviceId];p[this.crossSigningInfo.getId()]=Object.assign({},e,{signatures:{[this.userId]:{["ed25519:"+this.deviceId]:t}}})}const f=Object.keys(p);if(f.length){const e=({shouldEmit:t=!1})=>(a.logger.info(`Starting background key sig upload for ${f}`),this.baseApis.uploadKeySignatures({[this.userId]:p}).then((n=>{const{failures:r}=n||{};if(a.logger.info(`Finished background key sig upload for ${f}`),Object.keys(r||[]).length>0)throw t&&this.baseApis.emit(q.KeySignatureUploadFailure,r,"checkOwnCrossSigningTrust",e),new R.KeySignatureUploadError("Key upload failed",{failures:r})})).catch((e=>{a.logger.error(`Error during background key sig upload for ${f}`,e)})));e({shouldEmit:!0})}this.emit(q.UserTrustStatusChanged,t,this.checkUserTrust(t)),o&&(this.emit(q.KeysChanged,{}),await this.afterCrossSigningLocalKeyChange()),await this.backupManager.checkKeyBackup()}async storeTrustedSelfKeys(e){e?this.crossSigningInfo.setKeys(e):this.crossSigningInfo.clearKeys(),await this.cryptoStore.doTxn("readwrite",[m.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.cryptoStore.storeCrossSigningKeys(e,this.crossSigningInfo.keys)}))}async checkDeviceVerifications(e){const t=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(t){if(a.logger.info(`Starting device verification upgrade for ${e}`),this.crossSigningInfo.keys.user_signing){const n=this.deviceList.getStoredCrossSigningForUser(e);if(n){const r=await this.checkForDeviceVerificationUpgrade(e,n);if(r){const i=await t({users:{[e]:r}});i.includes(e)&&await this.baseApis.setDeviceVerified(e,n.getId())}}}a.logger.info(`Finished device verification upgrade for ${e}`)}}enableLazyLoading(){this.lazyLoadMembers=!0}registerEventHandlers(e){e.on(M.RoomMemberEvent.Membership,this.onMembership),e.on(A.ClientEvent.ToDeviceEvent,this.onToDeviceEvent),e.on(P.RoomEvent.Timeline,this.onTimelineEvent),e.on(D.MatrixEventEvent.Decrypted,this.onTimelineEvent)}start(){this.outgoingRoomKeyRequestManager.start()}stop(){this.outgoingRoomKeyRequestManager.stop(),this.deviceList.stop(),this.dehydrationManager.stop()}getDeviceEd25519Key(){return this.olmDevice.deviceEd25519Key}getDeviceCurve25519Key(){return this.olmDevice.deviceCurve25519Key}setGlobalBlacklistUnverifiedDevices(e){this.globalBlacklistUnverifiedDevices=e}getGlobalBlacklistUnverifiedDevices(){return this.globalBlacklistUnverifiedDevices}setGlobalErrorOnUnknownDevices(e){this.globalErrorOnUnknownDevices=e}getGlobalErrorOnUnknownDevices(){return this.globalErrorOnUnknownDevices}uploadDeviceKeys(){const e={algorithms:this.supportedAlgorithms,device_id:this.deviceId,keys:this.deviceKeys,user_id:this.userId};return this.signObject(e).then((()=>this.baseApis.uploadKeysRequest({device_keys:e})))}updateOneTimeKeyCount(e){if(!isFinite(e))throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number");this.oneTimeKeyCount=e}setNeedsNewFallback(e){this.needsNewFallback=!!e}getNeedsNewFallback(){return this.needsNewFallback}maybeUploadOneTimeKeys(){const e=6e4,t=5;if(this.oneTimeKeyCheckInProgress)return;const n=Date.now();if(null!==this.lastOneTimeKeyCheck&&n-this.lastOneTimeKeyCheck<e)return;this.lastOneTimeKeyCheck=n;const r=this.olmDevice.maxNumberOfOneTimeKeys(),i=Math.floor(r/2),o=async e=>{while(i>e||this.getNeedsNewFallback()){if(i>e){a.logger.info("generating oneTimeKeys");const n=Math.min(i-e,t);await this.olmDevice.generateOneTimeKeys(n)}if(this.getNeedsNewFallback()){const e=await this.olmDevice.getFallbackKey();e.curve25519&&0!=Object.keys(e.curve25519).length||(a.logger.info("generating fallback key"),this.fallbackCleanup&&(clearTimeout(this.fallbackCleanup),delete this.fallbackCleanup),await this.olmDevice.generateFallbackKey())}a.logger.info("calling uploadOneTimeKeys");const n=await this.uploadOneTimeKeys();if(!n.one_time_key_counts||!n.one_time_key_counts.signed_curve25519)throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519");e=n.one_time_key_counts.signed_curve25519}};this.oneTimeKeyCheckInProgress=!0,Promise.resolve().then((()=>void 0!==this.oneTimeKeyCount?Promise.resolve(this.oneTimeKeyCount):this.baseApis.uploadKeysRequest({}).then((e=>e.one_time_key_counts.signed_curve25519||0)))).then((e=>o(e))).catch((e=>{a.logger.error("Error uploading one-time keys",e.stack||e)})).finally((()=>{this.oneTimeKeyCount=void 0,this.oneTimeKeyCheckInProgress=!1}))}async uploadOneTimeKeys(){const e=[];let t;if(this.getNeedsNewFallback()){t={};const n=await this.olmDevice.getFallbackKey();for(const[r,i]of Object.entries(n.curve25519)){const n={key:i,fallback:!0};t["signed_curve25519:"+r]=n,e.push(this.signObject(n))}this.setNeedsNewFallback(!1)}const n=await this.olmDevice.getOneTimeKeys(),r={};for(const s in n.curve25519)if(n.curve25519.hasOwnProperty(s)){const t={key:n.curve25519[s]};r["signed_curve25519:"+s]=t,e.push(this.signObject(t))}await Promise.all(e);const i={one_time_keys:r};t&&(i["org.matrix.msc2732.fallback_keys"]=t,i["fallback_keys"]=t);const o=await this.baseApis.uploadKeysRequest(i);return t&&(this.fallbackCleanup=setTimeout((()=>{delete this.fallbackCleanup,this.olmDevice.forgetOldFallbackKey()}),36e5)),await this.olmDevice.markKeysAsPublished(),o}downloadKeys(e,t){return this.deviceList.downloadKeys(e,t)}getStoredDevicesForUser(e){return this.deviceList.getStoredDevicesForUser(e)}getStoredDevice(e,t){return this.deviceList.getStoredDevice(e,t)}saveDeviceList(e){return this.deviceList.saveIfDirty(e)}async setDeviceVerification(e,t,n,r,i){void 0===n&&(n=null),void 0===r&&(r=null),void 0===i&&(i=null);const o=this.deviceList.getStoredCrossSigningForUser(e);if(o&&o.getId()===t){if(null!==r||null!==i)throw new Error("Cannot set blocked or known for a cross-signing key");if(!n)throw new Error("Cannot set a cross-signing key as unverified");if(this.crossSigningInfo.getId()||e!==this.crossSigningInfo.userId||(this.storeTrustedSelfKeys(o.keys),this.emit(q.UserTrustStatusChanged,this.userId,this.checkUserTrust(e))),e!==this.userId){a.logger.info("Master key "+o.getId()+" for "+e+" marked verified. Signing...");const n=await this.crossSigningInfo.signUser(o);if(n){const r=async({shouldEmit:i=!1})=>{a.logger.info("Uploading signature for "+e+"...");const o=await this.baseApis.uploadKeySignatures({[e]:{[t]:n}}),{failures:s}=o||{};if(Object.keys(s||[]).length>0)throw i&&this.baseApis.emit(q.KeySignatureUploadFailure,s,"setDeviceVerification",r),new R.KeySignatureUploadError("Key upload failed",{failures:s})};await r({shouldEmit:!0})}return n}return o}const s=this.deviceList.getRawStoredDevicesForUser(e);if(!s||!s[t])throw new Error("Unknown device "+e+":"+t);const c=s[t];let l=c.verified;n?l=B.VERIFIED:null!==n&&l==B.VERIFIED&&(l=B.UNVERIFIED),r?l=B.BLOCKED:null!==r&&l==B.BLOCKED&&(l=B.UNVERIFIED);let d=c.known;if(null!==i&&(d=i),c.verified===l&&c.known===d||(c.verified=l,c.known=d,this.deviceList.storeDevicesForUser(e,s),this.deviceList.saveIfDirty()),n&&e===this.userId){let n;a.logger.info("Own device "+t+" marked verified: signing");const r=this.checkDeviceTrust(e,t);if(r.isCrossSigningVerified()?a.logger.log(`Own device ${t} already cross-signing verified`):n=await this.crossSigningInfo.signDevice(e,u.DeviceInfo.fromStorage(c,t)),n){const r=async({shouldEmit:i=!1})=>{a.logger.info("Uploading signature for "+t);const o=await this.baseApis.uploadKeySignatures({[e]:{[t]:n}}),{failures:s}=o||{};if(Object.keys(s||[]).length>0)throw i&&this.baseApis.emit(q.KeySignatureUploadFailure,s,"setDeviceVerification",r),new R.KeySignatureUploadError("Key upload failed",{failures:s})};await r({shouldEmit:!0})}}const h=u.DeviceInfo.fromStorage(c,t);return this.emit(q.DeviceVerificationChanged,e,t,h),h}findVerificationRequestDMInProgress(e){return this.inRoomVerificationRequests.findRequestInProgress(e)}getVerificationRequestsToDeviceInProgress(e){return this.toDeviceVerificationRequests.getRequestsInProgress(e)}requestVerificationDM(e,t){const n=this.inRoomVerificationRequests.findRequestInProgress(t);if(n)return Promise.resolve(n);const r=new _.InRoomChannel(this.baseApis,t,e);return this.requestVerificationWithChannel(e,r,this.inRoomVerificationRequests)}requestVerification(e,t){t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(e)));const n=this.toDeviceVerificationRequests.findRequestInProgress(e,t);if(n)return Promise.resolve(n);const r=new T.ToDeviceChannel(this.baseApis,e,t,T.ToDeviceChannel.makeTransactionId());return this.requestVerificationWithChannel(e,r,this.toDeviceVerificationRequests)}async requestVerificationWithChannel(e,t,n){let r=new w.VerificationRequest(t,this.verificationMethods,this.baseApis);t.transactionId&&n.setRequestByChannel(t,r),await r.sendRequest();const i=n.getRequestByChannel(t);return i?r=i:(a.logger.log(`Crypto: adding new request to requestsByTxnId with id ${t.transactionId} ${t.roomId}`),n.setRequestByChannel(t,r)),r}beginKeyVerification(e,t,n,r=null){let i;if(r){if(i=this.toDeviceVerificationRequests.getRequestBySenderAndTxnId(t,r),!i)throw new Error(`No request found for user ${t} with transactionId ${r}`)}else{r=T.ToDeviceChannel.makeTransactionId();const e=new T.ToDeviceChannel(this.baseApis,t,[n],r,n);i=new w.VerificationRequest(e,this.verificationMethods,this.baseApis),this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,r,i)}return i.beginKeyVerification(e,{userId:t,deviceId:n})}async legacyDeviceVerification(e,t,n){const r=T.ToDeviceChannel.makeTransactionId(),i=new T.ToDeviceChannel(this.baseApis,e,[t],r,t),o=new w.VerificationRequest(i,this.verificationMethods,this.baseApis);this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(e,r,o);const s=o.beginKeyVerification(n,{userId:e,deviceId:t});return await Promise.race([s.verify(),o.waitFor((e=>e.started))]),o}async getOlmSessionsForUser(e){const t=this.getStoredDevicesForUser(e)||[],n={};for(let r=0;r<t.length;++r){const e=t[r],i=e.getIdentityKey(),o=await this.olmDevice.getSessionInfoForDevice(i);n[e.deviceId]={deviceIdKey:i,sessions:o}}return n}getEventSenderDeviceInfo(e){const t=e.getSenderKey(),n=e.getWireContent().algorithm;if(!t||!n)return null;const r=e.getForwardingCurve25519KeyChain();if(r.length>0)return null;if(e.isKeySourceUntrusted())return null;const i=this.deviceList.getDeviceByIdentityKey(n,t);if(null===i)return null;const o=e.getClaimedEd25519Key();return o?o!==i.getFingerprint()?(a.logger.warn("Event "+e.getId()+" claims ed25519 key "+o+" but sender device has key "+i.getFingerprint()),null):i:(a.logger.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)}getEventEncryptionInfo(e){const t={};if(t.senderKey=e.getSenderKey(),t.algorithm=e.getWireContent().algorithm,!t.senderKey||!t.algorithm)return t.encrypted=!1,t;t.encrypted=!0;const n=e.getForwardingCurve25519KeyChain();n.length>0||e.isKeySourceUntrusted()?t.authenticated=!1:t.authenticated=!0,t.sender=this.deviceList.getDeviceByIdentityKey(t.algorithm,t.senderKey);const r=e.getClaimedEd25519Key();return r||(a.logger.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),t.mismatchedSender=!0),t.sender&&r!==t.sender.getFingerprint()&&(a.logger.warn("Event "+e.getId()+" claims ed25519 key "+r+"but sender device has key "+t.sender.getFingerprint()),t.mismatchedSender=!0),t}forceDiscardSession(e){const t=this.roomEncryptors[e];if(void 0===t)throw new Error("Room not encrypted");if(void 0===t.forceDiscardSession)throw new Error("Room encryption algorithm doesn't support session discarding");t.forceDiscardSession()}async setRoomEncryption(e,t,n){if(!t.algorithm)return void a.logger.log("Ignoring setRoomEncryption with no algorithm");const r=this.roomList.getRoomEncryption(e);if(r&&JSON.stringify(r)!=JSON.stringify(t))return void a.logger.error("Ignoring m.room.encryption event which requests a change of config in "+e);const i=this.roomEncryptors[e];if(i)return;let o=null;r||(o=this.roomList.setRoomEncryption(e,t));const s=h.ENCRYPTION_CLASSES[t.algorithm];if(!s)throw new Error("Unable to encrypt with "+t.algorithm);const c=new s({userId:this.userId,deviceId:this.deviceId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:e,config:t});this.roomEncryptors[e]=c,o&&await o,this.lazyLoadMembers?a.logger.log("Enabling encryption in "+e):(a.logger.log("Enabling encryption in "+e+"; starting to track device lists for all users therein"),await this.trackRoomDevices(e),n||this.deviceList.refreshOutdatedDeviceLists())}trackRoomDevices(e){const t=async()=>{if(!this.roomEncryptors[e])return;const t=this.clientStore.getRoom(e);if(!t)throw new Error(`Unable to start tracking devices in unknown room ${e}`);a.logger.log(`Starting to track devices for room ${e} ...`);const n=await t.getEncryptionTargetMembers();n.forEach((e=>{this.deviceList.startTrackingDeviceList(e.userId)}))};let n=this.roomDeviceTrackingState[e];return n||(n=t(),this.roomDeviceTrackingState[e]=n.catch((t=>{throw this.roomDeviceTrackingState[e]=null,t}))),n}ensureOlmSessionsForUsers(e,t){const n={};for(let r=0;r<e.length;++r){const t=e[r];n[t]=[];const i=this.getStoredDevicesForUser(t)||[];for(let e=0;e<i.length;++e){const r=i[e],o=r.getIdentityKey();o!=this.olmDevice.deviceCurve25519Key&&(r.verified!=B.BLOCKED&&n[t].push(r))}}return l.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,n,t)}async exportRoomKeys(){const e=[];return await this.cryptoStore.doTxn("readonly",[m.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS],(t=>{this.cryptoStore.getAllEndToEndInboundGroupSessions(t,(t=>{if(null===t)return;const n=this.olmDevice.exportInboundGroupSession(t.senderKey,t.sessionId,t.sessionData);delete n.first_known_index,n.algorithm=l.MEGOLM_ALGORITHM,e.push(n)}))})),e}importRoomKeys(e,t={}){let n=0,r=0;const i=e.length;function o(){t.progressCallback({stage:"load_keys",successes:n,failures:r,total:i})}return Promise.all(e.map((e=>{if(!e.room_id||!e.algorithm)return a.logger.warn("ignoring room key entry with missing fields",e),r++,t.progressCallback&&o(),null;const i=this.getRoomDecryptor(e.room_id,e.algorithm);return i.importRoomKey(e,t).finally((()=>{n++,t.progressCallback&&o()}))}))).then()}countSessionsNeedingBackup(){return this.backupManager.countSessionsNeedingBackup()}prepareToEncrypt(e){const t=this.roomEncryptors[e.roomId];t&&t.prepareToEncrypt(e)}async encryptEvent(e,t){if(!t)throw new Error("Cannot send encrypted messages in unknown rooms");const n=e.getRoomId(),r=this.roomEncryptors[n];if(!r)throw new Error("Room was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");this.roomDeviceTrackingState[n]||this.trackRoomDevices(n),await this.roomDeviceTrackingState[n];let i=e.getContent();const o=i["m.relates_to"];o&&(i=Object.assign({},i),delete i["m.relates_to"]);const s=i["io.element.performance_metrics"];s&&(i=Object.assign({},i),delete i["io.element.performance_metrics"]);const a=await r.encryptMessage(t,e.getType(),i);o&&(a["m.relates_to"]=o),s&&(a["io.element.performance_metrics"]=s),e.makeEncrypted("m.room.encrypted",a,this.olmDevice.deviceCurve25519Key,this.olmDevice.deviceEd25519Key)}async decryptEvent(e){if(e.isRedacted()){const t=new D.MatrixEvent(e.getUnsigned().redacted_because),n=await this.decryptEvent(t);return{clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{},unsigned:{redacted_because:n.clearEvent}}}}{const t=e.getWireContent(),n=this.getRoomDecryptor(e.getRoomId(),t.algorithm);return n.decryptEvent(e)}}async handleDeviceListChanges(e,t){e.oldSyncToken&&await this.evalDeviceListChanges(t)}requestRoomKey(e,t,n=!1){return this.outgoingRoomKeyRequestManager.queueRoomKeyRequest(e,t,n).then((()=>{this.sendKeyRequestsImmediately&&this.outgoingRoomKeyRequestManager.sendQueuedRequests()})).catch((e=>{a.logger.error("Error requesting key for event",e)}))}cancelRoomKeyRequest(e){this.outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch((e=>{a.logger.warn("Error clearing pending room key requests",e)}))}async cancelAndResendAllOutgoingKeyRequests(){await this.outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()}async onCryptoEvent(e){const t=e.getRoomId(),n=e.getContent();try{await this.setRoomEncryption(t,n,!0)}catch(r){a.logger.error("Error configuring encryption in room "+t+":",r)}}async onSyncWillProcess(e){e.oldSyncToken||(a.logger.log("Initial sync performed - resetting device tracking state"),this.deviceList.stopTrackingAllDeviceLists(),this.deviceList.startTrackingDeviceList(this.userId),this.roomDeviceTrackingState={}),this.sendKeyRequestsImmediately=!1}async onSyncCompleted(e){this.deviceList.setSyncToken(e.nextSyncToken),this.deviceList.saveIfDirty(),this.deviceList.startTrackingDeviceList(this.userId),this.deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(this.maybeUploadOneTimeKeys(),this.processReceivedRoomKeyRequests(),this.outgoingRoomKeyRequestManager.sendQueuedRequests(),this.sendKeyRequestsImmediately=!0)}async evalDeviceListChanges(e){if(e.changed&&Array.isArray(e.changed)&&e.changed.forEach((e=>{this.deviceList.invalidateUserDeviceList(e)})),e.left&&Array.isArray(e.left)&&e.left.length){const t=new Set(await this.getTrackedE2eUsers());e.left.forEach((e=>{t.has(e)||this.deviceList.stopTrackingDeviceList(e)}))}}async getTrackedE2eUsers(){const e=[];for(const t of this.getTrackedE2eRooms()){const n=await t.getEncryptionTargetMembers();for(const t of n)e.push(t.userId)}return e}getTrackedE2eRooms(){return this.clientStore.getRooms().filter((e=>{const t=this.roomEncryptors[e.roomId];if(!t)return!1;if(!this.roomDeviceTrackingState[e.roomId])return!1;const n=e.getMyMembership();return"join"===n||"invite"===n}))}onRoomKeyEvent(e){const t=e.getContent();if(!t.room_id||!t.algorithm)return void a.logger.error("key event is missing fields");this.backupManager.checkedForBackup||this.backupManager.checkAndStart();const n=this.getRoomDecryptor(t.room_id,t.algorithm);n.onRoomKeyEvent(e)}onRoomKeyWithheldEvent(e){const t=e.getContent();if("m.no_olm"!==t.code&&(!t.room_id||!t.session_id)||!t.algorithm||!t.sender_key)return void a.logger.error("key withheld event is missing fields");a.logger.info(`Got room key withheld event from ${e.getSender()} (${t.sender_key}) for ${t.algorithm}/${t.room_id}/${t.session_id} with reason ${t.code} (${t.reason})`);const n=this.getRoomDecryptor(t.room_id,t.algorithm);if(n.onRoomKeyWithheldEvent&&n.onRoomKeyWithheldEvent(e),!t.room_id){const e=this.getRoomDecryptors(t.algorithm);for(const n of e)n.retryDecryptionFromSender(t.sender_key)}}onKeyVerificationMessage(e){if(!T.ToDeviceChannel.validateEvent(e,this.baseApis))return;const t=e=>{if(!T.ToDeviceChannel.canCreateRequest(T.ToDeviceChannel.getEventType(e)))return;const t=e.getContent(),n=t&&t.from_device;if(!n)return;const r=e.getSender(),i=new T.ToDeviceChannel(this.baseApis,r,[n]);return new w.VerificationRequest(i,this.verificationMethods,this.baseApis)};this.handleVerificationEvent(e,this.toDeviceVerificationRequests,t)}async handleVerificationEvent(e,t,n,r=!0){if(e.isSending()&&e.status!=D.EventStatus.SENT){let t,n;try{await new Promise(((r,i)=>{t=r,n=()=>{e.status==D.EventStatus.CANCELLED&&i(new Error("Event status set to CANCELLED."))},e.once(D.MatrixEventEvent.LocalEventIdReplaced,t),e.on(D.MatrixEventEvent.Status,n)}))}catch(c){return void a.logger.error("error while waiting for the verification event to be sent: ",c)}finally{e.removeListener(D.MatrixEventEvent.LocalEventIdReplaced,t),e.removeListener(D.MatrixEventEvent.Status,n)}}let i=t.getRequest(e),o=!1;if(!i){if(i=n(e),!i)return void a.logger.log(`Crypto: could not find VerificationRequest for ${e.getType()}, and could not create one, so ignoring.`);o=!0,t.setRequest(e,i)}e.setVerificationRequest(i);try{await i.channel.handleEvent(e,i,r)}catch(c){a.logger.error("error while handling verification event",c)}const s=o&&!i.initiatedByMe&&!i.invalid&&!i.observeOnly;s&&this.baseApis.emit(q.VerificationRequest,i)}async onToDeviceBadEncrypted(e){const t=e.getWireContent(),n=e.getSender(),r=t.algorithm,i=t.sender_key,o=()=>{const e=this.getRoomDecryptors(l.MEGOLM_ALGORITHM);for(const t of e)t.retryDecryptionFromSender(i)};if(void 0===n||void 0===i||void 0===i)return;this.lastNewSessionForced[n]=this.lastNewSessionForced[n]||{};const s=this.lastNewSessionForced[n][i]||0;if(s+F>Date.now())return a.logger.debug("New session already forced with device "+n+":"+i+" at "+s+": not forcing another"),await this.olmDevice.recordSessionProblem(i,"wedged",!0),void o();let c=this.deviceList.getDeviceByIdentityKey(r,i);if(!c&&(await this.downloadKeys([n],!1),c=this.deviceList.getDeviceByIdentityKey(r,i),!c))return a.logger.info("Couldn't find device for identity key "+i+": not re-establishing session"),await this.olmDevice.recordSessionProblem(i,"wedged",!1),void o();const d={};d[n]=[c],await l.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,d,!0),this.lastNewSessionForced[n][i]=Date.now();const u={algorithm:l.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};await l.encryptMessageForDevice(u.ciphertext,this.userId,this.deviceId,this.olmDevice,n,c,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(i,"wedged",!0),o(),await this.baseApis.sendToDevice("m.room.encrypted",{[n]:{[c.deviceId]:u}});const h=await this.outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(n,c.deviceId);for(const a of h)this.requestRoomKey(a.requestBody,a.recipients,!0)}onRoomMembership(e,t,n){const r=t.roomId,i=this.roomEncryptors[r];i&&(this.roomDeviceTrackingState[r]&&("join"==t.membership?(a.logger.log("Join event for "+t.userId+" in "+r),this.deviceList.startTrackingDeviceList(t.userId)):"invite"==t.membership&&this.clientStore.getRoom(r).shouldEncryptForInvitedMembers()&&(a.logger.log("Invite event for "+t.userId+" in "+r),this.deviceList.startTrackingDeviceList(t.userId))),i.onRoomMembership(e,t,n))}onRoomKeyRequestEvent(e){const t=e.getContent();if("request"===t.action){const t=new G(e);this.receivedRoomKeyRequests.push(t)}else if("request_cancellation"===t.action){const t=new W(e);this.receivedRoomKeyRequestCancellations.push(t)}}async processReceivedRoomKeyRequests(){if(!this.processingRoomKeyRequests){this.processingRoomKeyRequests=!0;try{const e=this.receivedRoomKeyRequests;this.receivedRoomKeyRequests=[];const t=this.receivedRoomKeyRequestCancellations;this.receivedRoomKeyRequestCancellations=[],await Promise.all(e.map((e=>this.processReceivedRoomKeyRequest(e)))),await Promise.all(t.map((e=>this.processReceivedRoomKeyRequestCancellation(e))))}catch(e){a.logger.error(`Error processing room key requsts: ${e}`)}finally{this.processingRoomKeyRequests=!1}}}async processReceivedRoomKeyRequest(e){const t=e.userId,n=e.deviceId,r=e.requestBody,i=r.room_id,o=r.algorithm;if(a.logger.log(`m.room_key_request from ${t}:${n} for ${i} / ${r.session_id} (id ${e.requestId})`),t!==this.userId){if(!this.roomEncryptors[i])return void a.logger.debug(`room key request for unencrypted room ${i}`);const e=this.roomEncryptors[i],o=this.deviceList.getStoredDevice(t,n);if(!o)return void a.logger.debug(`Ignoring keyshare for unknown device ${t}:${n}`);try{await e.reshareKeyWithDevice(r.sender_key,r.session_id,t,o)}catch(c){a.logger.warn("Failed to re-share keys for session "+r.session_id+" with device "+t+":"+o.deviceId,c)}return}if(n===this.deviceId)return void a.logger.log("Ignoring room key request from ourselves");if(!this.roomDecryptors[i])return void a.logger.log(`room key request for unencrypted room ${i}`);const s=this.roomDecryptors[i][o];if(s)if(await s.hasKeysForKeyRequest(e)){if(e.share=()=>{s.shareKeysWithDevice(e)},this.checkDeviceTrust(t,n).isVerified())return a.logger.log("device is already verified: sharing keys"),void e.share();this.emit(q.RoomKeyRequest,e)}else a.logger.log(`room key request for unknown session ${i} / `+r.session_id);else a.logger.log(`room key request for unknown alg ${o} in room ${i}`)}async processReceivedRoomKeyRequestCancellation(e){a.logger.log(`m.room_key_request cancellation for ${e.userId}:${e.deviceId} (id ${e.requestId})`),this.emit(q.RoomKeyRequestCancellation,e)}getRoomDecryptor(e,t){let n,r;if(e=e||null,e&&(n=this.roomDecryptors[e],n||(this.roomDecryptors[e]=n={}),r=n[t],r))return r;const i=h.DECRYPTION_CLASSES[t];if(!i)throw new h.DecryptionError("UNKNOWN_ENCRYPTION_ALGORITHM",'Unknown encryption algorithm "'+t+'".');return r=new i({userId:this.userId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:e}),n&&(n[t]=r),r}getRoomDecryptors(e){const t=[];for(const n of Object.values(this.roomDecryptors))e in n&&t.push(n[e]);return t}async signObject(e){const t=e.signatures||{},n=e.unsigned;delete e.signatures,delete e.unsigned,t[this.userId]=t[this.userId]||{},t[this.userId]["ed25519:"+this.deviceId]=await this.olmDevice.sign(o.default.stringify(e)),e.signatures=t,void 0!==n&&(e.unsigned=n)}}function V(e){if("string"!==typeof e||e.indexOf(",")<0)return null;const t=Uint8Array.from(e.split(","),(e=>parseInt(e)));return l.encodeBase64(t)}t.Crypto=$;class G{constructor(e){(0,i.default)(this,"userId",void 0),(0,i.default)(this,"deviceId",void 0),(0,i.default)(this,"requestId",void 0),(0,i.default)(this,"requestBody",void 0),(0,i.default)(this,"share",void 0);const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id,this.requestBody=t.body||{},this.share=()=>{throw new Error("don't know how to share keys for this request yet")}}}t.IncomingRoomKeyRequest=G;class W{constructor(e){(0,i.default)(this,"userId",void 0),(0,i.default)(this,"deviceId",void 0),(0,i.default)(this,"requestId",void 0);const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id}}},4791:function(e,t,n){"use strict";n(1703),n(8675),n(3462),n(7380),n(1118),Object.defineProperty(t,"__esModule",{value:!0}),t.deriveKey=d,t.keyFromAuthData=c,t.keyFromPassphrase=l;var r=n(5789),i=n(3926);const o="undefined"!==typeof window&&window.crypto?window.crypto.subtle||window.crypto.webkitSubtle:null,s=5e5,a=256;function c(e,t){if(!n.g.Olm)throw new Error("Olm is not available");if(!e.private_key_salt||!e.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return d(t,e.private_key_salt,e.private_key_iterations,e.private_key_bits||a)}async function l(e){if(!n.g.Olm)throw new Error("Olm is not available");const t=(0,r.randomString)(32),i=await d(e,t,s,a);return{key:i,salt:t,iterations:s}}async function d(e,t,n,r=a){return o?u(e,t,n,r):h(e,t,n,r)}async function u(e,t,r,i){const o=n.g.crypto.subtle,s=n.g.TextEncoder;if(!o||!s)throw new Error("Password-based backup is not avaiable on this platform");const a=await o.importKey("raw",(new s).encode(e),{name:"PBKDF2"},!1,["deriveBits"]),c=await o.deriveBits({name:"PBKDF2",salt:(new s).encode(t),iterations:r,hash:"SHA-512"},a,i);return new Uint8Array(c)}async function h(e,t,n,r){const o=(0,i.getCrypto)();if(!o)throw new Error("No usable crypto implementation");return o.pbkdf2Sync(e,Buffer.from(t,"binary"),n,r,"sha512")}},9485:function(e,t,n){"use strict";n(1703),n(8675),n(3462),n(7380),n(1118);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.OLM_ALGORITHM=t.MEGOLM_BACKUP_ALGORITHM=t.MEGOLM_ALGORITHM=void 0,t.decodeBase64=E,t.encodeBase64=m,t.encodeUnpaddedBase64=v,t.encryptMessageForDevice=d,t.ensureOlmSessionsForDevices=h,t.getExistingOlmSessions=u,t.pkSign=f,t.pkVerify=y,t.verifySignature=p;var i,o=r(n(7577)),s=n(6471);(function(e){e["Olm"]="m.olm.v1.curve25519-aes-sha2",e["Megolm"]="m.megolm.v1.aes-sha2",e["MegolmBackup"]="m.megolm_backup.v1.curve25519-aes-sha2"})(i||(i={}));const a=i.Olm;t.OLM_ALGORITHM=a;const c=i.Megolm;t.MEGOLM_ALGORITHM=c;const l=i.MegolmBackup;async function d(e,t,n,r,i,o,a){const c=o.getIdentityKey(),l=await r.getSessionIdForDevice(c);if(null===l)return;s.logger.log("Using sessionid "+l+" for device "+i+":"+o.deviceId);const d={sender:t,sender_device:n,keys:{ed25519:r.deviceEd25519Key},recipient:i,recipient_keys:{ed25519:o.getFingerprint()}};Object.assign(d,a),e[c]=await r.encryptMessage(c,l,JSON.stringify(d))}async function u(e,t,n){const r={},i={},o=[];for(const[s,a]of Object.entries(n))for(const t of a){const n=t.deviceId,a=t.getIdentityKey();o.push((async()=>{const o=await e.getSessionIdForDevice(a,!0);null===o?(r[s]=r[s]||[],r[s].push(t)):(i[s]=i[s]||{},i[s][n]={device:t,sessionId:o})})())}return await Promise.all(o),[r,i]}async function h(e,t,n,r=!1,i,o,a=s.logger){"number"===typeof r&&(a=o,o=i,i=r,r=!1);const c=[],l={},d={};for(const[,s]of Object.entries(n))for(const t of s){const n=t.getIdentityKey();n!==e.deviceCurve25519Key&&(e.sessionsInProgress[n]||(e.sessionsInProgress[n]=new Promise((t=>{d[n]=r=>{delete e.sessionsInProgress[n],t(r)}}))))}for(const[s,g]of Object.entries(n)){l[s]={};for(const t of g){const n=t.deviceId,i=t.getIdentityKey();if(i===e.deviceCurve25519Key){a.info("Attempted to start session with ourself! Ignoring"),l[s][n]={device:t,sessionId:null};continue}const o=`for ${i} (${s}:${n})`,u=await e.getSessionIdForDevice(i,!!d[i],a);null!==u&&d[i]&&d[i](),(null===u||r)&&(r?a.info(`Forcing new Olm session ${o}`):a.info(`Making new Olm session ${o}`),c.push([s,n])),l[s][n]={device:t,sessionId:u}}}if(0===c.length)return l;const u="signed_curve25519";let h,p=`one-time keys for ${c.length} devices`;try{a.debug(`Claiming ${p}`),h=await t.claimOneTimeKeys(c,u,i),a.debug(`Claimed ${p}`)}catch(m){for(const e of Object.values(d))e();throw a.log(`Failed to claim ${p}`,m,c),m}o&&"failures"in h&&o.push(...Object.keys(h.failures));const f=h.one_time_keys||{},y=[];for(const[s,v]of Object.entries(n)){const t=f[s]||{};for(let n=0;n<v.length;n++){const i=v[n],o=i.deviceId,c=i.getIdentityKey();if(c===e.deviceCurve25519Key)continue;if(l[s][o].sessionId&&!r)continue;const h=t[o]||{};let p=null;for(const e in h)0===e.indexOf(u+":")&&(p=h[e]);p?y.push(g(e,p,s,i).then((e=>{d[c]&&d[c](e),l[s][o].sessionId=e}),(e=>{throw d[c]&&d[c](),e}))):(a.warn(`No one-time keys (alg=${u}) for device ${s}:${o}`),d[c]&&d[c]())}}return p=`Olm sessions for ${y.length} devices`,a.debug(`Starting ${p}`),await Promise.all(y),a.debug(`Started ${p}`),l}async function g(e,t,n,r){const i=r.deviceId;try{await p(e,t,n,i,r.getFingerprint())}catch(a){return s.logger.error("Unable to verify signature on one-time key for device "+n+":"+i+":",a),null}let o;try{o=await e.createOutboundSession(r.getIdentityKey(),t.key)}catch(a){return s.logger.error("Error starting olm session with device "+n+":"+i+": "+a),null}return s.logger.log("Started new olm sessionid "+o+" for device "+n+":"+i),o}async function p(e,t,n,r,i){const s="ed25519:"+r,a=t.signatures||{},c=a[n]||{},l=c[s];if(!l)throw Error("No signature");const d=Object.assign({},t);"unsigned"in d&&delete d.unsigned,delete d.signatures;const u=o.default.stringify(d);e.verifySignature(i,u,l)}function f(e,t,r,i){let s=!1;if(t instanceof Uint8Array){const e=new n.g.Olm.PkSigning;i=e.init_with_seed(t),t=e,s=!0}const a=e.signatures||{};delete e.signatures;const c=e.unsigned;e.unsigned&&delete e.unsigned;try{const n=a[r]||{};return a[r]=n,n["ed25519:"+i]=t.sign(o.default.stringify(e))}finally{e.signatures=a,c&&(e.unsigned=c),s&&t.free()}}function y(e,t,r){const i="ed25519:"+t;if(!(e.signatures&&e.signatures[r]&&e.signatures[r][i]))throw new Error("No signature");const s=e.signatures[r][i],a=new n.g.Olm.Utility,c=e.signatures;delete e.signatures;const l=e.unsigned;e.unsigned&&delete e.unsigned;try{a.ed25519_verify(t,o.default.stringify(e),s)}finally{e.signatures=c,l&&(e.unsigned=l),a.free()}}function m(e){return Buffer.from(e).toString("base64")}function v(e){return m(e).replace(/=+$/g,"")}function E(e){return Buffer.from(e,"base64")}t.MEGOLM_BACKUP_ALGORITHM=l},4897:function(e,t,n){"use strict";n(1703),n(8675),n(3462),n(7380),n(1118),Object.defineProperty(t,"__esModule",{value:!0}),t.decodeRecoveryKey=c,t.encodeRecoveryKey=a;var r=o(n(7575));function i(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(i=function(e){return e?n:t})(e)}function o(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=i(t);if(n&&n.has(e))return n.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var a=o?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(r,s,a):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}const s=[139,1];function a(e){const t=Buffer.alloc(s.length+e.length+1);t.set(s,0),t.set(e,s.length);let n=0;for(let r=0;r<t.length-1;++r)n^=t[r];t[t.length-1]=n;const i=r.encode(t);return i.match(/.{1,4}/g).join(" ")}function c(e){const t=r.decode(e.replace(/ /g,""));let i=0;for(const n of t)i^=n;if(0!==i)throw new Error("Incorrect parity");for(let n=0;n<s.length;++n)if(t[n]!==s[n])throw new Error("Incorrect prefix");if(t.length!==s.length+n.g.Olm.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");return Uint8Array.from(t.slice(s.length,s.length+n.g.Olm.PRIVATE_KEY_LENGTH))}},4049:function(e,t,n){"use strict";n(1703),n(6699);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.VERSION=t.Backend=void 0,t.upgradeDatabase=h;var i=r(n(4344)),o=n(6471),s=c(n(3926));function a(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(a=function(e){return e?n:t})(e)}function c(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=a(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}const l=10;t.VERSION=l;const d=!1;class u{constructor(e){this.db=e,(0,i.default)(this,"nextTxnId",0),e.onversionchange=()=>{o.logger.log(`versionchange for indexeddb ${this.db.name}: closing`),e.close()}}async startup(){return this}async deleteAllData(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return new Promise(((n,r)=>{const i=this.db.transaction("outgoingRoomKeyRequests","readwrite");i.onerror=r,this._getOutgoingRoomKeyRequest(i,t,(r=>{if(r)return o.logger.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),void n(r);o.logger.log(`enqueueing key request for ${t.room_id} / `+t.session_id),i.oncomplete=()=>{n(e)};const s=i.objectStore("outgoingRoomKeyRequests");s.add(e)}))}))}getOutgoingRoomKeyRequest(e){return new Promise(((t,n)=>{const r=this.db.transaction("outgoingRoomKeyRequests","readonly");r.onerror=n,this._getOutgoingRoomKeyRequest(r,e,(e=>{t(e)}))}))}_getOutgoingRoomKeyRequest(e,t,n){const r=e.objectStore("outgoingRoomKeyRequests"),i=r.index("session"),o=i.openCursor([t.room_id,t.session_id]);o.onsuccess=()=>{const e=o.result;if(!e)return void n(null);const r=e.value;s.deepCompare(r.requestBody,t)?n(r):e.continue()}}getOutgoingRoomKeyRequestByState(e){if(0===e.length)return Promise.resolve(null);let t,n=0;function r(){const i=this.result;if(i)return void(t=i.value);if(n++,n>=e.length)return;const o=e[n],s=this.source.openCursor(o);s.onsuccess=r}const i=this.db.transaction("outgoingRoomKeyRequests","readonly"),o=i.objectStore("outgoingRoomKeyRequests"),s=e[n],a=o.index("state").openCursor(s);return a.onsuccess=r,f(i).then((()=>t))}getAllOutgoingRoomKeyRequestsByState(e){return new Promise(((t,n)=>{const r=this.db.transaction("outgoingRoomKeyRequests","readonly"),i=r.objectStore("outgoingRoomKeyRequests"),o=i.index("state"),s=o.getAll(e);s.onsuccess=()=>t(s.result),s.onerror=()=>n(s.error)}))}getOutgoingRoomKeyRequestsByTarget(e,t,n){let r=0;const i=[];function o(){const s=this.result;if(s){const n=s.value;n.recipients.includes({userId:e,deviceId:t})&&i.push(n),s.continue()}else{if(r++,r>=n.length)return;const e=n[r],t=this.source.openCursor(e);t.onsuccess=o}}const s=this.db.transaction("outgoingRoomKeyRequests","readonly"),a=s.objectStore("outgoingRoomKeyRequests"),c=n[r],l=a.index("state").openCursor(c);return l.onsuccess=o,f(s).then((()=>i))}updateOutgoingRoomKeyRequest(e,t,n){let r=null;function i(){const e=this.result;if(!e)return;const i=e.value;i.state==t?(Object.assign(i,n),e.update(i),r=i):o.logger.warn(`Cannot update room key request from ${t} as it was already updated to ${i.state}`)}const s=this.db.transaction("outgoingRoomKeyRequests","readwrite"),a=s.objectStore("outgoingRoomKeyRequests").openCursor(e);return a.onsuccess=i,f(s).then((()=>r))}deleteOutgoingRoomKeyRequest(e,t){const n=this.db.transaction("outgoingRoomKeyRequests","readwrite"),r=n.objectStore("outgoingRoomKeyRequests").openCursor(e);return r.onsuccess=()=>{const e=r.result;if(!e)return;const n=e.value;n.state==t?e.delete():o.logger.warn(`Cannot delete room key request in state ${n.state} (expected ${t})`)},f(n)}getAccount(e,t){const n=e.objectStore("account"),r=n.get("-");r.onsuccess=function(){try{t(r.result||null)}catch(n){p(e,n)}}}storeAccount(e,t){const n=e.objectStore("account");n.put(t,"-")}getCrossSigningKeys(e,t){const n=e.objectStore("account"),r=n.get("crossSigningKeys");r.onsuccess=function(){try{t(r.result||null)}catch(n){p(e,n)}}}getSecretStorePrivateKey(e,t,n){const r=e.objectStore("account"),i=r.get(`ssss_cache:${n}`);i.onsuccess=function(){try{t(i.result||null)}catch(n){p(e,n)}}}storeCrossSigningKeys(e,t){const n=e.objectStore("account");n.put(t,"crossSigningKeys")}storeSecretStorePrivateKey(e,t,n){const r=e.objectStore("account");r.put(n,`ssss_cache:${t}`)}countEndToEndSessions(e,t){const n=e.objectStore("sessions"),r=n.count();r.onsuccess=function(){try{t(r.result)}catch(n){p(e,n)}}}getEndToEndSessions(e,t,n){const r=t.objectStore("sessions"),i=r.index("deviceKey"),o=i.openCursor(e),s={};o.onsuccess=function(){const e=o.result;if(e)s[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{n(s)}catch(r){p(t,r)}}}getEndToEndSession(e,t,n,r){const i=n.objectStore("sessions"),o=i.get([e,t]);o.onsuccess=function(){try{o.result?r({session:o.result.session,lastReceivedMessageTs:o.result.lastReceivedMessageTs}):r(null)}catch(e){p(n,e)}}}getAllEndToEndSessions(e,t){const n=e.objectStore("sessions"),r=n.openCursor();r.onsuccess=function(){try{const e=r.result;e?(t(e.value),e.continue()):t(null)}catch(n){p(e,n)}}}storeEndToEndSession(e,t,n,r){const i=r.objectStore("sessions");i.put({deviceKey:e,sessionId:t,session:n.session,lastReceivedMessageTs:n.lastReceivedMessageTs})}async storeEndToEndSessionProblem(e,t,n){const r=this.db.transaction("session_problems","readwrite"),i=r.objectStore("session_problems");return i.put({deviceKey:e,type:t,fixed:n,time:Date.now()}),f(r)}async getEndToEndSessionProblem(e,t){let n;const r=this.db.transaction("session_problems","readwrite"),i=r.objectStore("session_problems"),o=i.index("deviceKey"),s=o.getAll(e);return s.onsuccess=()=>{const e=s.result;if(!e.length)return void(n=null);e.sort(((e,t)=>e.time-t.time));const r=e[e.length-1];for(const i of e)if(i.time>t)return void(n=Object.assign({},i,{fixed:r.fixed}));n=r.fixed?null:r},await f(r),n}async filterOutNotifiedErrorDevices(e){const t=this.db.transaction("notified_error_devices","readwrite"),n=t.objectStore("notified_error_devices"),r=[];return await Promise.all(e.map((e=>new Promise((t=>{const{userId:i,deviceInfo:o}=e,s=n.get([i,o.deviceId]);s.onsuccess=function(){s.result||(n.put({userId:i,deviceId:o.deviceId}),r.push(e)),t()}}))))),r}getEndToEndInboundGroupSession(e,t,n,r){let i=!1,o=!1;const s=n.objectStore("inbound_group_sessions"),a=s.get([e,t]);a.onsuccess=function(){try{i=a.result?a.result.session:null,!1!==o&&r(i,o)}catch(e){p(n,e)}};const c=n.objectStore("inbound_group_sessions_withheld"),l=c.get([e,t]);l.onsuccess=function(){try{o=l.result?l.result.session:null,!1!==i&&r(i,o)}catch(e){p(n,e)}}}getAllEndToEndInboundGroupSessions(e,t){const n=e.objectStore("inbound_group_sessions"),r=n.openCursor();r.onsuccess=function(){const n=r.result;if(n){try{t({senderKey:n.value.senderCurve25519Key,sessionId:n.value.sessionId,sessionData:n.value.session})}catch(i){p(e,i)}n.continue()}else try{t(null)}catch(i){p(e,i)}}}addEndToEndInboundGroupSession(e,t,n,r){const i=r.objectStore("inbound_group_sessions"),s=i.add({senderCurve25519Key:e,sessionId:t,session:n});s.onerror=n=>{"ConstraintError"===s.error.name?(n.stopPropagation(),n.preventDefault(),o.logger.log("Ignoring duplicate inbound group session: "+e+" / "+t)):p(r,new Error("Failed to add inbound group session: "+s.error))}}storeEndToEndInboundGroupSession(e,t,n,r){const i=r.objectStore("inbound_group_sessions");i.put({senderCurve25519Key:e,sessionId:t,session:n})}storeEndToEndInboundGroupSessionWithheld(e,t,n,r){const i=r.objectStore("inbound_group_sessions_withheld");i.put({senderCurve25519Key:e,sessionId:t,session:n})}getEndToEndDeviceData(e,t){const n=e.objectStore("device_data"),r=n.get("-");r.onsuccess=function(){try{t(r.result||null)}catch(n){p(e,n)}}}storeEndToEndDeviceData(e,t){const n=t.objectStore("device_data");n.put(e,"-")}storeEndToEndRoom(e,t,n){const r=n.objectStore("rooms");r.put(t,e)}getEndToEndRooms(e,t){const n={},r=e.objectStore("rooms"),i=r.openCursor();i.onsuccess=function(){const r=i.result;if(r)n[r.key]=r.value,r.continue();else try{t(n)}catch(o){p(e,o)}}}getSessionsNeedingBackup(e){return new Promise(((t,n)=>{const r=[],i=this.db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");i.onerror=n,i.oncomplete=function(){t(r)};const o=i.objectStore("sessions_needing_backup"),s=i.objectStore("inbound_group_sessions"),a=o.openCursor();a.onsuccess=function(){const t=a.result;if(t){const n=s.get(t.key);n.onsuccess=function(){r.push({senderKey:n.result.senderCurve25519Key,sessionId:n.result.sessionId,sessionData:n.result.session})},(!e||r.length<e)&&t.continue()}}}))}countSessionsNeedingBackup(e){e||(e=this.db.transaction("sessions_needing_backup","readonly"));const t=e.objectStore("sessions_needing_backup");return new Promise(((e,n)=>{const r=t.count();r.onerror=n,r.onsuccess=()=>e(r.result)}))}async unmarkSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));const n=t.objectStore("sessions_needing_backup");await Promise.all(e.map((e=>new Promise(((t,r)=>{const i=n.delete([e.senderKey,e.sessionId]);i.onsuccess=t,i.onerror=r})))))}async markSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));const n=t.objectStore("sessions_needing_backup");await Promise.all(e.map((e=>new Promise(((t,r)=>{const i=n.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});i.onsuccess=t,i.onerror=r})))))}addSharedHistoryInboundGroupSession(e,t,n,r){r||(r=this.db.transaction("shared_history_inbound_group_sessions","readwrite"));const i=r.objectStore("shared_history_inbound_group_sessions"),o=i.get([e]);o.onsuccess=()=>{const{sessions:r}=o.result||{sessions:[]};r.push([t,n]),i.put({roomId:e,sessions:r})}}getSharedHistoryInboundGroupSessions(e,t){t||(t=this.db.transaction("shared_history_inbound_group_sessions","readonly"));const n=t.objectStore("shared_history_inbound_group_sessions"),r=n.get([e]);return new Promise(((e,t)=>{r.onsuccess=()=>{const{sessions:t}=r.result||{sessions:[]};e(t)},r.onerror=t}))}doTxn(e,t,n,r=o.logger){let i,s;if(d){const n=this.nextTxnId++;i=Date.now(),s=`${e} crypto store transaction ${n} in ${t}`,r.debug(`Starting ${s}`)}const a=this.db.transaction(t,e),c=f(a),l=n(a);return d&&c.then((()=>{const e=Date.now()-i;r.debug(`Finished ${s}, took ${e} ms`)}),(()=>{const e=Date.now()-i;r.error(`Failed ${s}, took ${e} ms`)})),c.then((()=>l))}}function h(e,t){if(o.logger.log(`Upgrading IndexedDBCryptoStore from version ${t} to ${l}`),t<1&&g(e),t<2&&e.createObjectStore("account"),t<3){const t=e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]});t.createIndex("deviceKey","deviceKey")}if(t<4&&e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]}),t<5&&e.createObjectStore("device_data"),t<6&&e.createObjectStore("rooms"),t<7&&e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]}),t<8&&e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]}),t<9){const t=e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]});t.createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})}t<10&&e.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})}function g(e){const t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}function p(e,t){e._mx_abortexception=t;try{e.abort()}catch(t){}}function f(e){return new Promise(((t,n)=>{e.oncomplete=()=>{void 0!==e._mx_abortexception&&n(e._mx_abortexception),t(null)},e.onerror=t=>{void 0!==e._mx_abortexception?n(e._mx_abortexception):(o.logger.log("Error performing indexeddb txn",t),n(e.error))},e.onabort=t=>{void 0!==e._mx_abortexception?n(e._mx_abortexception):(o.logger.log("Error performing indexeddb txn",t),n(e.error))}}))}t.Backend=u},7896:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.IndexedDBCryptoStore=void 0;var i=r(n(4344)),o=n(6471),s=n(587),a=n(1911),c=h(n(4049)),l=n(5592),d=h(n(3989));function u(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(u=function(e){return e?n:t})(e)}function h(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=u(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}class g{static exists(e,t){return d.exists(e,t)}constructor(e,t){this.indexedDB=e,this.dbName=t,(0,i.default)(this,"backendPromise",null),(0,i.default)(this,"backend",null)}startup(){return this.backendPromise||(this.backendPromise=new Promise(((e,t)=>{if(!this.indexedDB)return void t(new Error("no indexeddb support available"));o.logger.log(`connecting to indexeddb ${this.dbName}`);const n=this.indexedDB.open(this.dbName,c.VERSION);n.onupgradeneeded=e=>{const t=n.result,r=e.oldVersion;c.upgradeDatabase(t,r)},n.onblocked=()=>{o.logger.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},n.onerror=e=>{o.logger.log("Error connecting to indexeddb",e),t(n.error)},n.onsuccess=()=>{const t=n.result;o.logger.log(`connected to indexeddb ${this.dbName}`),e(new c.Backend(t))}})).then((e=>e.doTxn("readonly",[g.STORE_INBOUND_GROUP_SESSIONS,g.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(t=>{e.getEndToEndInboundGroupSession("","",t,(()=>{}))})).then((()=>e)))).catch((e=>{if("VersionError"===e.name)throw o.logger.warn("Crypto DB is too new for us to use!",e),new l.InvalidCryptoStoreError(l.InvalidCryptoStoreError.TOO_NEW);o.logger.warn(`unable to connect to indexeddb ${this.dbName}: falling back to localStorage store: ${e}`);try{return new s.LocalStorageCryptoStore(n.g.localStorage)}catch(e){return o.logger.warn(`unable to open localStorage: falling back to in-memory store: ${e}`),new a.MemoryCryptoStore}})).then((e=>(this.backend=e,e)))),this.backendPromise}deleteAllData(){return new Promise(((e,t)=>{if(!this.indexedDB)return void t(new Error("no indexeddb support available"));o.logger.log(`Removing indexeddb instance: ${this.dbName}`);const n=this.indexedDB.deleteDatabase(this.dbName);n.onblocked=()=>{o.logger.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},n.onerror=e=>{o.logger.log("Error deleting data from indexeddb",e),t(n.error)},n.onsuccess=()=>{o.logger.log(`Removed indexeddb instance: ${this.dbName}`),e()}})).catch((e=>{o.logger.warn(`unable to delete IndexedDBCryptoStore: ${e}`)}))}getOrAddOutgoingRoomKeyRequest(e){return this.backend.getOrAddOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequest(e){return this.backend.getOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequestByState(e){return this.backend.getOutgoingRoomKeyRequestByState(e)}getAllOutgoingRoomKeyRequestsByState(e){return this.backend.getAllOutgoingRoomKeyRequestsByState(e)}getOutgoingRoomKeyRequestsByTarget(e,t,n){return this.backend.getOutgoingRoomKeyRequestsByTarget(e,t,n)}updateOutgoingRoomKeyRequest(e,t,n){return this.backend.updateOutgoingRoomKeyRequest(e,t,n)}deleteOutgoingRoomKeyRequest(e,t){return this.backend.deleteOutgoingRoomKeyRequest(e,t)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,n){this.backend.getSecretStorePrivateKey(e,t,n)}storeCrossSigningKeys(e,t){this.backend.storeCrossSigningKeys(e,t)}storeSecretStorePrivateKey(e,t,n){this.backend.storeSecretStorePrivateKey(e,t,n)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,n,r){this.backend.getEndToEndSession(e,t,n,r)}getEndToEndSessions(e,t,n){this.backend.getEndToEndSessions(e,t,n)}getAllEndToEndSessions(e,t){this.backend.getAllEndToEndSessions(e,t)}storeEndToEndSession(e,t,n,r){this.backend.storeEndToEndSession(e,t,n,r)}storeEndToEndSessionProblem(e,t,n){return this.backend.storeEndToEndSessionProblem(e,t,n)}getEndToEndSessionProblem(e,t){return this.backend.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.backend.filterOutNotifiedErrorDevices(e)}getEndToEndInboundGroupSession(e,t,n,r){this.backend.getEndToEndInboundGroupSession(e,t,n,r)}getAllEndToEndInboundGroupSessions(e,t){this.backend.getAllEndToEndInboundGroupSessions(e,t)}addEndToEndInboundGroupSession(e,t,n,r){this.backend.addEndToEndInboundGroupSession(e,t,n,r)}storeEndToEndInboundGroupSession(e,t,n,r){this.backend.storeEndToEndInboundGroupSession(e,t,n,r)}storeEndToEndInboundGroupSessionWithheld(e,t,n,r){this.backend.storeEndToEndInboundGroupSessionWithheld(e,t,n,r)}storeEndToEndDeviceData(e,t){this.backend.storeEndToEndDeviceData(e,t)}getEndToEndDeviceData(e,t){this.backend.getEndToEndDeviceData(e,t)}storeEndToEndRoom(e,t,n){this.backend.storeEndToEndRoom(e,t,n)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}getSessionsNeedingBackup(e){return this.backend.getSessionsNeedingBackup(e)}countSessionsNeedingBackup(e){return this.backend.countSessionsNeedingBackup(e)}unmarkSessionsNeedingBackup(e,t){return this.backend.unmarkSessionsNeedingBackup(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}addSharedHistoryInboundGroupSession(e,t,n,r){this.backend.addSharedHistoryInboundGroupSession(e,t,n,r)}getSharedHistoryInboundGroupSessions(e,t){return this.backend.getSharedHistoryInboundGroupSessions(e,t)}doTxn(e,t,n,r){return this.backend.doTxn(e,t,n,r)}}t.IndexedDBCryptoStore=g,(0,i.default)(g,"STORE_ACCOUNT","account"),(0,i.default)(g,"STORE_SESSIONS","sessions"),(0,i.default)(g,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions"),(0,i.default)(g,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld"),(0,i.default)(g,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions"),(0,i.default)(g,"STORE_DEVICE_DATA","device_data"),(0,i.default)(g,"STORE_ROOMS","rooms"),(0,i.default)(g,"STORE_BACKUP","sessions_needing_backup")},587:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LocalStorageCryptoStore=void 0;var r=n(6471),i=n(1911);const o="crypto.",s=o+"account",a=o+"cross_signing_keys",c=o+"notified_error_devices",l=o+"device_data",d=o+"inboundgroupsessions/",u=o+"inboundgroupsessions.withheld/",h=o+"rooms/",g=o+"sessionsneedingbackup";function p(e){return o+"sessions/"+e}function f(e){return o+"session.problems/"+e}function y(e,t){return d+e+"/"+t}function m(e,t){return u+e+"/"+t}function v(e){return h+e}class E extends i.MemoryCryptoStore{static exists(e){const t=e.length;for(let n=0;n<t;n++)if(e.key(n).startsWith(o))return!0;return!1}constructor(e){super(),this.store=e}countEndToEndSessions(e,t){let n=0;for(let r=0;r<this.store.length;++r)this.store.key(r).startsWith(p(""))&&++n;t(n)}_getEndToEndSessions(e){const t=S(this.store,p(e)),n={};for(const[r,i]of Object.entries(t||{}))n[r]="string"===typeof i?{session:i}:i;return n}getEndToEndSession(e,t,n,r){const i=this._getEndToEndSessions(e);r(i[t]||{})}getEndToEndSessions(e,t,n){n(this._getEndToEndSessions(e)||{})}getAllEndToEndSessions(e,t){for(let n=0;n<this.store.length;++n)if(this.store.key(n).startsWith(p(""))){const e=this.store.key(n).split("/")[1];for(const n of Object.values(this._getEndToEndSessions(e)))t(n)}}storeEndToEndSession(e,t,n,r){const i=this._getEndToEndSessions(e)||{};i[t]=n,b(this.store,p(e),i)}async storeEndToEndSessionProblem(e,t,n){const r=f(e),i=S(this.store,r)||[];i.push({type:t,fixed:n,time:Date.now()}),i.sort(((e,t)=>e.time-t.time)),b(this.store,r,i)}async getEndToEndSessionProblem(e,t){const n=f(e),r=S(this.store,n)||[];if(!r.length)return null;const i=r[r.length-1];for(const o of r)if(o.time>t)return Object.assign({},o,{fixed:i.fixed});return i.fixed?null:i}async filterOutNotifiedErrorDevices(e){const t=S(this.store,c)||{},n=[];for(const r of e){const{userId:e,deviceInfo:i}=r;e in t?i.deviceId in t[e]||(n.push(r),t[e][i.deviceId]=!0):(n.push(r),t[e]={[i.deviceId]:!0})}return b(this.store,c,t),n}getEndToEndInboundGroupSession(e,t,n,r){r(S(this.store,y(e,t)),S(this.store,m(e,t)))}getAllEndToEndInboundGroupSessions(e,t){for(let n=0;n<this.store.length;++n){const e=this.store.key(n);e.startsWith(d)&&t({senderKey:e.slice(d.length,d.length+43),sessionId:e.slice(d.length+44),sessionData:S(this.store,e)})}t(null)}addEndToEndInboundGroupSession(e,t,n,r){const i=S(this.store,y(e,t));i||this.storeEndToEndInboundGroupSession(e,t,n,r)}storeEndToEndInboundGroupSession(e,t,n,r){b(this.store,y(e,t),n)}storeEndToEndInboundGroupSessionWithheld(e,t,n,r){b(this.store,m(e,t),n)}getEndToEndDeviceData(e,t){t(S(this.store,l))}storeEndToEndDeviceData(e,t){b(this.store,l,e)}storeEndToEndRoom(e,t,n){b(this.store,v(e),t)}getEndToEndRooms(e,t){const n={},r=v("");for(let i=0;i<this.store.length;++i){const e=this.store.key(i);if(e.startsWith(r)){const t=e.slice(r.length);n[t]=S(this.store,e)}}t(n)}getSessionsNeedingBackup(e){const t=S(this.store,g)||{},n=[];for(const r in t)if(Object.prototype.hasOwnProperty.call(t,r)){const t=r.slice(0,43),i=r.slice(44);if(this.getEndToEndInboundGroupSession(t,i,null,(e=>{n.push({senderKey:t,sessionId:i,sessionData:e})})),e&&n.length>=e)break}return Promise.resolve(n)}countSessionsNeedingBackup(){const e=S(this.store,g)||{};return Promise.resolve(Object.keys(e).length)}unmarkSessionsNeedingBackup(e){const t=S(this.store,g)||{};for(const n of e)delete t[n.senderKey+"/"+n.sessionId];return b(this.store,g,t),Promise.resolve()}markSessionsNeedingBackup(e){const t=S(this.store,g)||{};for(const n of e)t[n.senderKey+"/"+n.sessionId]=!0;return b(this.store,g,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(s),Promise.resolve()}getAccount(e,t){const n=S(this.store,s);t(n)}storeAccount(e,t){b(this.store,s,t)}getCrossSigningKeys(e,t){const n=S(this.store,a);t(n)}getSecretStorePrivateKey(e,t,n){const r=S(this.store,o+`ssss_cache.${n}`);t(r)}storeCrossSigningKeys(e,t){b(this.store,a,t)}storeSecretStorePrivateKey(e,t,n){b(this.store,o+`ssss_cache.${t}`,n)}doTxn(e,t,n){return Promise.resolve(n(null))}}function S(e,t){try{return JSON.parse(e.getItem(t))}catch(n){r.logger.log("Error: Failed to get key %s: %s",t,n.stack||n),r.logger.log(n.stack)}return null}function b(e,t,n){e.setItem(t,JSON.stringify(n))}t.LocalStorageCryptoStore=E},1911:function(e,t,n){"use strict";n(6699);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.MemoryCryptoStore=void 0;var i=r(n(4344)),o=n(6471),s=c(n(3926));function a(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(a=function(e){return e?n:t})(e)}function c(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=a(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class u{constructor(){(0,i.default)(this,"outgoingRoomKeyRequests",[]),(0,i.default)(this,"account",null),(0,i.default)(this,"crossSigningKeys",null),(0,i.default)(this,"privateKeys",{}),(0,i.default)(this,"sessions",{}),(0,i.default)(this,"sessionProblems",{}),(0,i.default)(this,"notifiedErrorDevices",{}),(0,i.default)(this,"inboundGroupSessions",{}),(0,i.default)(this,"inboundGroupSessionsWithheld",{}),(0,i.default)(this,"deviceData",null),(0,i.default)(this,"rooms",{}),(0,i.default)(this,"sessionsNeedingBackup",{}),(0,i.default)(this,"sharedHistoryInboundGroupSessions",{})}async startup(){return this}deleteAllData(){return Promise.resolve()}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return s.promiseTry((()=>{const n=this._getOutgoingRoomKeyRequest(t);return n?(o.logger.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),n):(o.logger.log(`enqueueing key request for ${t.room_id} / `+t.session_id),this.outgoingRoomKeyRequests.push(e),e)}))}getOutgoingRoomKeyRequest(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}_getOutgoingRoomKeyRequest(e){for(const t of this.outgoingRoomKeyRequests)if(s.deepCompare(t.requestBody,e))return t;return null}getOutgoingRoomKeyRequestByState(e){for(const t of this.outgoingRoomKeyRequests)for(const n of e)if(t.state===n)return Promise.resolve(t);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(e){return Promise.resolve(this.outgoingRoomKeyRequests.filter((t=>t.state==e)))}getOutgoingRoomKeyRequestsByTarget(e,t,n){const r=[];for(const i of this.outgoingRoomKeyRequests)for(const o of n)i.state===o&&i.recipients.includes({userId:e,deviceId:t})&&r.push(i);return Promise.resolve(r)}updateOutgoingRoomKeyRequest(e,t,n){for(const r of this.outgoingRoomKeyRequests)if(r.requestId===e)return r.state!==t?(o.logger.warn(`Cannot update room key request from ${t} as it was already updated to ${r.state}`),Promise.resolve(null)):(Object.assign(r,n),Promise.resolve(r));return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(e,t){for(let n=0;n<this.outgoingRoomKeyRequests.length;n++){const r=this.outgoingRoomKeyRequests[n];if(r.requestId===e)return r.state!=t?(o.logger.warn(`Cannot delete room key request in state ${r.state} (expected ${t})`),Promise.resolve(null)):(this.outgoingRoomKeyRequests.splice(n,1),Promise.resolve(r))}return Promise.resolve(null)}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,n){const r=this.privateKeys[n];t(r||null)}storeCrossSigningKeys(e,t){this.crossSigningKeys=t}storeSecretStorePrivateKey(e,t,n){this.privateKeys[t]=n}countEndToEndSessions(e,t){t(Object.keys(this.sessions).length)}getEndToEndSession(e,t,n,r){const i=this.sessions[e]||{};r(i[t]||null)}getEndToEndSessions(e,t,n){n(this.sessions[e]||{})}getAllEndToEndSessions(e,t){Object.entries(this.sessions).forEach((([e,n])=>{Object.entries(n).forEach((([n,r])=>{t(d(d({},r),{},{deviceKey:e,sessionId:n}))}))}))}storeEndToEndSession(e,t,n,r){let i=this.sessions[e];void 0===i&&(i={},this.sessions[e]=i),i[t]=n}async storeEndToEndSessionProblem(e,t,n){const r=this.sessionProblems[e]=this.sessionProblems[e]||[];r.push({type:t,fixed:n,time:Date.now()}),r.sort(((e,t)=>e.time-t.time))}async getEndToEndSessionProblem(e,t){const n=this.sessionProblems[e]||[];if(!n.length)return null;const r=n[n.length-1];for(const i of n)if(i.time>t)return Object.assign({},i,{fixed:r.fixed});return r.fixed?null:r}async filterOutNotifiedErrorDevices(e){const t=this.notifiedErrorDevices,n=[];for(const r of e){const{userId:e,deviceInfo:i}=r;e in t?i.deviceId in t[e]||(n.push(r),t[e][i.deviceId]=!0):(n.push(r),t[e]={[i.deviceId]:!0})}return n}getEndToEndInboundGroupSession(e,t,n,r){const i=e+"/"+t;r(this.inboundGroupSessions[i]||null,this.inboundGroupSessionsWithheld[i]||null)}getAllEndToEndInboundGroupSessions(e,t){for(const n of Object.keys(this.inboundGroupSessions))t({senderKey:n.slice(0,43),sessionId:n.slice(44),sessionData:this.inboundGroupSessions[n]});t(null)}addEndToEndInboundGroupSession(e,t,n,r){const i=e+"/"+t;void 0===this.inboundGroupSessions[i]&&(this.inboundGroupSessions[i]=n)}storeEndToEndInboundGroupSession(e,t,n,r){this.inboundGroupSessions[e+"/"+t]=n}storeEndToEndInboundGroupSessionWithheld(e,t,n,r){const i=e+"/"+t;this.inboundGroupSessionsWithheld[i]=n}getEndToEndDeviceData(e,t){t(this.deviceData)}storeEndToEndDeviceData(e,t){this.deviceData=e}storeEndToEndRoom(e,t,n){this.rooms[e]=t}getEndToEndRooms(e,t){t(this.rooms)}getSessionsNeedingBackup(e){const t=[];for(const n in this.sessionsNeedingBackup)if(this.inboundGroupSessions[n]&&(t.push({senderKey:n.slice(0,43),sessionId:n.slice(44),sessionData:this.inboundGroupSessions[n]}),e&&n.length>=e))break;return Promise.resolve(t)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this.sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;delete this.sessionsNeedingBackup[e]}return Promise.resolve()}markSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;this.sessionsNeedingBackup[e]=!0}return Promise.resolve()}addSharedHistoryInboundGroupSession(e,t,n){const r=this.sharedHistoryInboundGroupSessions[e]||[];r.push([t,n]),this.sharedHistoryInboundGroupSessions[e]=r}getSharedHistoryInboundGroupSessions(e){return Promise.resolve(this.sharedHistoryInboundGroupSessions[e]||[])}doTxn(e,t,n){return Promise.resolve(n(null))}}t.MemoryCryptoStore=u},2102:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.VerificationEvent=t.VerificationBase=t.SwitchStartEventError=void 0;var i=r(n(4344)),o=n(2842),s=n(6471),a=n(1949),c=n(7270),l=n(4984),d=n(9392);const u=new Error("Verification timed out");class h extends Error{constructor(e){super(),this.startEvent=e}}let g;t.SwitchStartEventError=h,t.VerificationEvent=g,function(e){e["Cancel"]="cancel"}(g||(t.VerificationEvent=g={}));class p extends d.TypedEventEmitter{constructor(e,t,n,r,o,s){super(),this.channel=e,this.baseApis=t,this.userId=n,this.deviceId=r,this.startEvent=o,this.request=s,(0,i.default)(this,"cancelled",!1),(0,i.default)(this,"_done",!1),(0,i.default)(this,"promise",null),(0,i.default)(this,"transactionTimeoutTimer",null),(0,i.default)(this,"expectedEvent",void 0),(0,i.default)(this,"resolve",void 0),(0,i.default)(this,"reject",void 0),(0,i.default)(this,"resolveEvent",void 0),(0,i.default)(this,"rejectEvent",void 0),(0,i.default)(this,"started",void 0),(0,i.default)(this,"doVerification",void 0)}get initiatedByMe(){if(!this.startEvent)return!0;const e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this.baseApis.getUserId()&&t.from_device===this.baseApis.getDeviceId()}get hasBeenCancelled(){return this.cancelled}resetTimer(){s.logger.info("Refreshing/starting the verification transaction timeout timer"),null!==this.transactionTimeoutTimer&&clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=setTimeout((()=>{this._done||this.cancelled||(s.logger.info("Triggering verification timeout"),this.cancel(u))}),6e5)}endTimer(){null!==this.transactionTimeoutTimer&&(clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=null)}send(e,t){return this.channel.send(e,t)}waitForEvent(e){if(this._done)return Promise.reject(new Error("Verification is already done"));const t=this.request.getEventFromOtherParty(e);return t?Promise.resolve(t):(this.expectedEvent=e,new Promise(((e,t)=>{this.resolveEvent=e,this.rejectEvent=t})))}canSwitchStartEvent(e){return!1}switchStartEvent(e){if(this.canSwitchStartEvent(e))if(s.logger.log("Verification Base: switching verification start event",{restartingFlow:!!this.rejectEvent}),this.rejectEvent){const t=this.rejectEvent;this.rejectEvent=void 0,t(new h(e))}else this.startEvent=e}handleEvent(e){if(!this._done)if(e.getType()===this.expectedEvent)"m.key.verification.done"!==this.expectedEvent&&(this.expectedEvent=void 0,this.rejectEvent=void 0,this.resetTimer(),this.resolveEvent(e));else if("m.key.verification.cancel"===e.getType()){const t=this.reject;if(this.reject=void 0,t){const n=e.getContent(),{reason:r,code:i}=n;t(new Error(`Other side cancelled verification because ${r} (${i})`))}}else if(this.expectedEvent){const t=new Error("Unexpected message: expecting "+this.expectedEvent+" but got "+e.getType());if(this.expectedEvent=void 0,this.rejectEvent){const e=this.rejectEvent;this.rejectEvent=void 0,e(t)}this.cancel(t)}}done(){if(this.endTimer(),!this._done)return this.request.onVerifierFinished(),this.resolve(),(0,l.requestKeysDuringVerification)(this.baseApis,this.userId,this.deviceId)}cancel(e){if(this.endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId)if(e===u){const e=(0,c.newTimeoutError)();this.send(e.getType(),e.getContent())}else if(e instanceof o.MatrixEvent){const t=e.getSender();if(t!==this.userId){const t=e.getContent();"m.key.verification.cancel"===e.getType()?(t.code=t.code||"m.unknown",t.reason=t.reason||t.body||"Unknown reason",this.send("m.key.verification.cancel",t)):this.send("m.key.verification.cancel",{code:"m.unknown",reason:t.body||"Unknown reason"})}}else this.send("m.key.verification.cancel",{code:"m.unknown",reason:e.toString()});null!==this.promise?this.reject&&this.reject(e):this.promise=Promise.reject(e),this.emit(g.Cancel,e)}}verify(){return this.promise||(this.promise=new Promise(((e,t)=>{this.resolve=(...t)=>{this._done=!0,this.endTimer(),e(...t)},this.reject=e=>{this._done=!0,this.endTimer(),t(e)}})),this.doVerification&&!this.started&&(this.started=!0,this.resetTimer(),Promise.resolve(this.doVerification()).then(this.done.bind(this),this.cancel.bind(this)))),this.promise}async verifyKeys(e,t,n){const r=[];for(const[i,o]of Object.entries(t)){const t=i.split(":",2)[1],c=this.baseApis.getStoredDevice(e,t);if(c)n(i,c,o),r.push(t);else{const c=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(e);c&&c.getId()===t?(n(i,a.DeviceInfo.fromStorage({keys:{[i]:t}},t),o),r.push(t)):s.logger.warn(`verification: Could not find device ${t} to verify`)}}if(!r.length)throw new Error("No devices could be verified");s.logger.info("Verification completed! Marking devices verified: ",r);for(const i of r)await this.baseApis.setDeviceVerified(e,i)}get events(){}}t.VerificationBase=p},7270:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.errorFactory=o,t.errorFromEvent=h,t.newUserCancelledError=t.newUnknownMethodError=t.newUnexpectedMessageError=t.newTimeoutError=t.newKeyMismatchError=t.newInvalidMessageError=void 0,t.newVerificationError=i;var r=n(2842);function i(e,t,n){const i=Object.assign({},{code:e,reason:t},n);return new r.MatrixEvent({type:"m.key.verification.cancel",content:i})}function o(e,t){return function(n){return i(e,t,n)}}const s=o("m.user","Cancelled by user");t.newUserCancelledError=s;const a=o("m.timeout","Timed out");t.newTimeoutError=a;const c=o("m.unknown_method","Unknown method");t.newUnknownMethodError=c;const l=o("m.unexpected_message","Unexpected message");t.newUnexpectedMessageError=l;const d=o("m.key_mismatch","Key mismatch");t.newKeyMismatchError=d;const u=o("m.invalid_message","Invalid message");function h(e){const t=e.getContent();if(t){const{code:e,reason:n}=t;return{code:e,reason:n}}return{code:"Unknown error",reason:"m.unknown"}}t.newInvalidMessageError=u},1105:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.IllegalMethod=void 0;var i=r(n(4344)),o=n(2102);class s extends o.VerificationBase{constructor(...e){super(...e),(0,i.default)(this,"doVerification",(async()=>{throw new Error("Verification is not possible with this method")}))}static factory(e,t,n,r,i,o){return new s(e,t,n,r,i,o)}static get NAME(){return"org.matrix.illegal_method"}}t.IllegalMethod=s},7264:function(e,t,n){"use strict";n(1703),n(8675),n(3462),n(7380),n(1118);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.SHOW_QR_CODE_METHOD=t.SCAN_QR_CODE_METHOD=t.ReciprocateQRCode=t.QrCodeEvent=t.QRCodeData=void 0;var i=r(n(4344)),o=n(2102),s=n(7270),a=n(9485),c=n(6471);const l="m.qr_code.show.v1";t.SHOW_QR_CODE_METHOD=l;const d="m.qr_code.scan.v1";let u;t.SCAN_QR_CODE_METHOD=d,t.QrCodeEvent=u,function(e){e["ShowReciprocateQr"]="show_reciprocate_qr"}(u||(t.QrCodeEvent=u={}));class h extends o.VerificationBase{constructor(...e){super(...e),(0,i.default)(this,"reciprocateQREvent",void 0),(0,i.default)(this,"doVerification",(async()=>{if(!this.startEvent)throw new Error("It is not currently possible to start verificationwith this method yet.");const{qrCodeData:e}=this.request;if(this.startEvent.getContent()["secret"]!==e.encodedSharedSecret)throw(0,s.newKeyMismatchError)();await new Promise(((e,t)=>{this.reciprocateQREvent={confirm:e,cancel:()=>t((0,s.newUserCancelledError)())},this.emit(u.ShowReciprocateQr,this.reciprocateQREvent)}));const t={};switch(e.mode){case f.VerifyOtherUser:{const n=e.otherUserMasterKey;t[`ed25519:${n}`]=n;break}case f.VerifySelfTrusted:{const n=this.request.targetDevice.deviceId;t[`ed25519:${n}`]=e.otherDeviceKey;break}case f.VerifySelfUntrusted:{const n=e.myMasterKey;t[`ed25519:${n}`]=n;break}}await this.verifyKeys(this.userId,t,((e,n,r)=>{const i=t[e];if(!i)throw(0,s.newKeyMismatchError)();if(r!==i)throw c.logger.error("key ID from key info does not match"),(0,s.newKeyMismatchError)();for(const o in n.keys){if(!o.startsWith("ed25519"))continue;const e=t[o];if(!e)throw(0,s.newKeyMismatchError)();if(n.keys[o]!==e)throw c.logger.error("master key does not match"),(0,s.newKeyMismatchError)()}}))}))}static factory(e,t,n,r,i,o){return new h(e,t,n,r,i,o)}static get NAME(){return"m.reciprocate.v1"}}t.ReciprocateQRCode=h;const g=2,p="MATRIX";var f;(function(e){e[e["VerifyOtherUser"]=0]="VerifyOtherUser",e[e["VerifySelfTrusted"]=1]="VerifySelfTrusted",e[e["VerifySelfUntrusted"]=2]="VerifySelfUntrusted"})(f||(f={}));class y{constructor(e,t,n,r,i,o){this.mode=e,this.sharedSecret=t,this.otherUserMasterKey=n,this.otherDeviceKey=r,this.myMasterKey=i,this.buffer=o}static async create(e,t){const n=y.generateSharedSecret(),r=y.determineMode(e,t);let i=null,o=null,s=null;if(r===f.VerifyOtherUser){const n=t.getStoredCrossSigningForUser(e.otherUserId);i=n.getId("master")}else if(r===f.VerifySelfTrusted)o=await y.getOtherDeviceKey(e,t);else if(r===f.VerifySelfUntrusted){const e=t.getUserId(),n=t.getStoredCrossSigningForUser(e);s=n.getId("master")}const a=y.generateQrData(e,t,r,n,i,o,s),c=y.generateBuffer(a);return new y(r,n,i,o,s,c)}get encodedSharedSecret(){return this.sharedSecret}getBuffer(){return this.buffer}static generateSharedSecret(){const e=new Uint8Array(11);return n.g.crypto.getRandomValues(e),(0,a.encodeUnpaddedBase64)(e)}static async getOtherDeviceKey(e,t){const n=t.getUserId(),r=e.targetDevice,i=r?r.deviceId:null,o=t.getStoredDevice(n,i);if(!o)throw new Error("could not find device "+i);return o.getFingerprint()}static determineMode(e,t){const n=t.getUserId(),r=e.otherUserId;let i=f.VerifyOtherUser;if(n===r){const e=t.checkUserTrust(n);i=e.isCrossSigningVerified()?f.VerifySelfTrusted:f.VerifySelfUntrusted}return i}static generateQrData(e,t,n,r,i,o,s){const a=t.getUserId(),c=e.channel.transactionId,l={prefix:p,version:g,mode:n,transactionId:c,firstKeyB64:"",secondKeyB64:"",secretB64:r},d=t.getStoredCrossSigningForUser(a);return n===f.VerifyOtherUser?(l.firstKeyB64=d.getId("master"),l.secondKeyB64=i):n===f.VerifySelfTrusted?(l.firstKeyB64=d.getId("master"),l.secondKeyB64=o):n===f.VerifySelfUntrusted&&(l.firstKeyB64=t.getDeviceEd25519Key(),l.secondKeyB64=s),l}static generateBuffer(e){let t=Buffer.alloc(0);const n=e=>{const n=Buffer.from([e]);t=Buffer.concat([t,n])},r=e=>{const n=Buffer.alloc(2);n.writeInt16BE(e,0),t=Buffer.concat([t,n])},i=(e,n,i=!0)=>{const o=Buffer.from(e,n);i&&r(o.byteLength),t=Buffer.concat([t,o])},o=e=>{const n=(0,a.decodeBase64)(e),r=Buffer.from(n);t=Buffer.concat([t,r])};return i(e.prefix,"ascii",!1),n(e.version),n(e.mode),i(e.transactionId,"utf-8"),o(e.firstKeyB64),o(e.secondKeyB64),o(e.secretB64),t}}t.QRCodeData=y},6681:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.SasEvent=t.SAS=void 0;var i=r(n(4344)),o=r(n(7577)),s=n(2102),a=n(7270),c=n(6471);const l="m.key.verification.start",d=["m.key.verification.accept","m.key.verification.key","m.key.verification.mac"];let u;const h=(0,a.errorFactory)("m.mismatched_sas","Mismatched short authentication string"),g=(0,a.errorFactory)("m.mismatched_commitment","Mismatched commitment");function p(e){return[1e3+(e[0]<<5|e[1]>>3),1e3+((7&e[1])<<10|e[2]<<2|e[3]>>6),1e3+((63&e[3])<<7|e[4]>>1)]}const f=[["","dog"],["","cat"],["","lion"],["","horse"],["","unicorn"],["","pig"],["","elephant"],["","rabbit"],["","panda"],["","rooster"],["","penguin"],["","turtle"],["","fish"],["","octopus"],["","butterfly"],["","flower"],["","tree"],["","cactus"],["","mushroom"],["","globe"],["","moon"],["","cloud"],["","fire"],["","banana"],["","apple"],["","strawberry"],["","corn"],["","pizza"],["","cake"],["","heart"],["","smiley"],["","robot"],["","hat"],["","glasses"],["","spanner"],["","santa"],["","thumbs up"],["","umbrella"],["","hourglass"],["","clock"],["","gift"],["","light bulb"],["","book"],["","pencil"],["","paperclip"],["","scissors"],["","lock"],["","key"],["","hammer"],["","telephone"],["","flag"],["","train"],["","bicycle"],["","aeroplane"],["","rocket"],["","trophy"],["","ball"],["","guitar"],["","trumpet"],["","bell"],["","anchor"],["","headphones"],["","folder"],["","pin"]];function y(e){const t=[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2],e[3]>>2,(3&e[3])<<4|e[4]>>4,(15&e[4])<<2|e[5]>>6];return t.map((e=>f[e]))}const m={decimal:p,emoji:y};function v(e,t){const n={};for(const r of t)r in m&&(n[r]=m[r](e));return n}const E={"hkdf-hmac-sha256":"calculate_mac","hmac-sha256":"calculate_mac_long_kdf"};function S(e,t){return function(...n){const r=e[E[t]],i=r.apply(e,n);return c.logger.log("SAS calculateMAC:",t,n,i),i}}const b={"curve25519-hkdf-sha256":function(e,t,n){const r=`${e.baseApis.getUserId()}|${e.baseApis.deviceId}|${e.ourSASPubKey}|`,i=`${e.userId}|${e.deviceId}|${e.theirSASPubKey}|`,o="MATRIX_KEY_VERIFICATION_SAS|"+(e.initiatedByMe?r+i:i+r)+e.channel.transactionId;return t.generate_bytes(o,n)},curve25519:function(e,t,n){const r=`${e.baseApis.getUserId()}${e.baseApis.deviceId}`,i=`${e.userId}${e.deviceId}`,o="MATRIX_KEY_VERIFICATION_SAS"+(e.initiatedByMe?r+i:i+r)+e.channel.transactionId;return t.generate_bytes(o,n)}},w=["curve25519-hkdf-sha256","curve25519"],_=["sha256"],T=["hkdf-hmac-sha256","hmac-sha256"],I=Object.keys(m),R=new Set(w),k=new Set(_),O=new Set(T),C=new Set(I);function P(e,t){return e instanceof Array?e.filter((e=>t.has(e))):[]}let M;t.SasEvent=M,function(e){e["ShowSas"]="show_sas"}(M||(t.SasEvent=M={}));class D extends s.VerificationBase{constructor(...e){super(...e),(0,i.default)(this,"waitingForAccept",void 0),(0,i.default)(this,"ourSASPubKey",void 0),(0,i.default)(this,"theirSASPubKey",void 0),(0,i.default)(this,"sasEvent",void 0),(0,i.default)(this,"doVerification",(async()=>{await n.g.Olm.init(),u=u||new n.g.Olm.Utility,await this.baseApis.downloadKeys([this.userId]);let e=!1;do{try{return this.initiatedByMe?await this.doSendVerification():await this.doRespondVerification()}catch(t){if(!(t instanceof s.SwitchStartEventError))throw t;this.startEvent=t.startEvent,e=!0}}while(e)}))}static get NAME(){return"m.sas.v1"}get events(){return d}canSwitchStartEvent(e){if(e.getType()!==l)return!1;const t=e.getContent();return t&&t.method===D.NAME&&this.waitingForAccept}async sendStart(){const e=this.channel.completeContent(l,{method:D.NAME,from_device:this.baseApis.deviceId,key_agreement_protocols:w,hashes:_,message_authentication_codes:T,short_authentication_string:I});return await this.channel.sendCompleted(l,e),e}async doSendVerification(){let e,t;if(this.waitingForAccept=!0,e=this.startEvent?this.channel.completedContentFromEvent(this.startEvent):await this.sendStart(),!this.initiatedByMe)throw new s.SwitchStartEventError(this.startEvent);try{t=await this.waitForEvent("m.key.verification.accept")}finally{this.waitingForAccept=!1}let r=t.getContent();const i=P(r.short_authentication_string,C);if(!(R.has(r.key_agreement_protocol)&&k.has(r.hash)&&O.has(r.message_authentication_code)&&i.length))throw(0,a.newUnknownMethodError)();if("string"!==typeof r.commitment)throw(0,a.newInvalidMessageError)();const c=r.key_agreement_protocol,l=r.message_authentication_code,d=r.commitment,p=new n.g.Olm.SAS;try{this.ourSASPubKey=p.get_pubkey(),await this.send("m.key.verification.key",{key:this.ourSASPubKey}),t=await this.waitForEvent("m.key.verification.key"),r=t.getContent();const n=r.key+o.default.stringify(e);if(u.sha256(n)!==d)throw g();this.theirSASPubKey=r.key,p.set_their_key(r.key);const s=b[c](this,p,6),f=new Promise(((e,t)=>{this.sasEvent={sas:v(s,i),confirm:async()=>{try{await this.sendMAC(p,l),e()}catch(n){t(n)}},cancel:()=>t((0,a.newUserCancelledError)()),mismatch:()=>t(h())},this.emit(M.ShowSas,this.sasEvent)}));[t]=await Promise.all([this.waitForEvent("m.key.verification.mac").then((e=>(this.expectedEvent="m.key.verification.done",e))),f]),r=t.getContent(),await this.checkMAC(p,r,l)}finally{p.free()}}async doRespondVerification(){let e=this.channel.completedContentFromEvent(this.startEvent);const t=P(w,new Set(e.key_agreement_protocols))[0],r=P(_,new Set(e.hashes))[0],i=P(T,new Set(e.message_authentication_codes))[0],s=P(e.short_authentication_string,C);if(void 0===t||void 0===r||void 0===i||!s.length)throw(0,a.newUnknownMethodError)();const c=new n.g.Olm.SAS;try{const n=c.get_pubkey()+o.default.stringify(e);await this.send("m.key.verification.accept",{key_agreement_protocol:t,hash:r,message_authentication_code:i,short_authentication_string:s,commitment:u.sha256(n)});let l=await this.waitForEvent("m.key.verification.key");e=l.getContent(),this.theirSASPubKey=e.key,c.set_their_key(e.key),this.ourSASPubKey=c.get_pubkey(),await this.send("m.key.verification.key",{key:this.ourSASPubKey});const d=b[t](this,c,6),g=new Promise(((e,t)=>{this.sasEvent={sas:v(d,s),confirm:async()=>{try{await this.sendMAC(c,i),e()}catch(n){t(n)}},cancel:()=>t((0,a.newUserCancelledError)()),mismatch:()=>t(h())},this.emit(M.ShowSas,this.sasEvent)}));[l]=await Promise.all([this.waitForEvent("m.key.verification.mac").then((e=>(this.expectedEvent="m.key.verification.done",e))),g]),e=l.getContent(),await this.checkMAC(c,e,i)}finally{c.free()}}sendMAC(e,t){const n={},r=[],i="MATRIX_KEY_VERIFICATION_MAC"+this.baseApis.getUserId()+this.baseApis.deviceId+this.userId+this.deviceId+this.channel.transactionId,o=`ed25519:${this.baseApis.deviceId}`;n[o]=S(e,t)(this.baseApis.getDeviceEd25519Key(),i+o),r.push(o);const s=this.baseApis.getCrossSigningId();if(s){const o=`ed25519:${s}`;n[o]=S(e,t)(s,i+o),r.push(o)}const a=S(e,t)(r.sort().join(","),i+"KEY_IDS");return this.send("m.key.verification.mac",{mac:n,keys:a})}async checkMAC(e,t,n){const r="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this.baseApis.getUserId()+this.baseApis.deviceId+this.channel.transactionId;if(t.keys!==S(e,n)(Object.keys(t.mac).sort().join(","),r+"KEY_IDS"))throw(0,a.newKeyMismatchError)();await this.verifyKeys(this.userId,t.mac,((t,i,o)=>{if(o!==S(e,n)(i.keys[t],r+t))throw(0,a.newKeyMismatchError)()}))}}t.SAS=D},5632:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.InRoomRequests=t.InRoomChannel=void 0;var i=r(n(4344)),o=n(5691),s=n(6471),a=n(7778);const c=a.EventType.RoomMessage,l="m.reference",d="m.relates_to";class u{constructor(e,t,n=null){this.client=e,this.roomId=t,this.userId=n,(0,i.default)(this,"requestEventId",null)}get receiveStartFromOtherDevices(){return!0}get transactionId(){return this.requestEventId}static getOtherPartyUserId(e,t){const n=u.getEventType(e);if(n!==o.REQUEST_TYPE)return;const r=t.getUserId(),i=e.getSender(),s=e.getContent(),a=s.to;return i===r?a:a===r?i:void 0}getTimestamp(e){return e.getTs()}static canCreateRequest(e){return e===o.REQUEST_TYPE}canCreateRequest(e){return u.canCreateRequest(e)}static getTransactionId(e){if(u.getEventType(e)===o.REQUEST_TYPE)return e.getId();{const t=e.getRelation();if(t&&t.rel_type===l)return t.event_id}}static validateEvent(e,t){const n=u.getTransactionId(e);if("string"!==typeof n||0===n.length)return!1;const r=u.getEventType(e),i=e.getContent();if(r===o.REQUEST_TYPE){if(!i||"string"!==typeof i.to||!i.to.length)return s.logger.log("InRoomChannel: validateEvent: no valid to "+(i&&i.to)),!1;if(!u.getOtherPartyUserId(e,t))return s.logger.log(`InRoomChannel: validateEvent: not directed to or sent by me: ${e.getSender()}, ${i&&i.to}`),!1}return o.VerificationRequest.validateEvent(r,e,t)}static getEventType(e){const t=e.getType();if(t===c){const t=e.getContent();if(t){const{msgtype:e}=t;if(e===o.REQUEST_TYPE)return o.REQUEST_TYPE}}return t&&t!==o.REQUEST_TYPE?t:""}handleEvent(e,t,n=!1){if(t.hasEventId(e.getId()))return;const r=u.getEventType(e);if(e.getRoomId()!==this.roomId)return;if(null===this.userId){const t=u.getOtherPartyUserId(e,this.client);t&&(this.userId=t)}const i=this.client.getUserId(),o=e.getSender();if(null!==this.userId&&o!==i&&o!==this.userId)return void s.logger.log(`InRoomChannel: ignoring verification event from non-participating sender ${o}`);null===this.requestEventId&&(this.requestEventId=u.getTransactionId(e));const a=!!e.getUnsigned().transaction_id,c=e.getSender()===this.client.getUserId();return t.handleEvent(r,e,n,a,c)}completedContentFromEvent(e){const t=Object.assign({},e.getContent());return t[d]=e.getRelation(),t}completeContent(e,t){return t=Object.assign({},t),e!==o.REQUEST_TYPE&&e!==o.READY_TYPE&&e!==o.START_TYPE||(t.from_device=this.client.getDeviceId()),e===o.REQUEST_TYPE?t={body:this.client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:o.REQUEST_TYPE,to:this.userId,from_device:t.from_device,methods:t.methods}:t[d]={rel_type:l,event_id:this.transactionId},t}send(e,t){const n=this.completeContent(e,t);return this.sendCompleted(e,n)}async sendCompleted(e,t){let n=e;e===o.REQUEST_TYPE&&(n=c);const r=await this.client.sendEvent(this.roomId,n,t);e===o.REQUEST_TYPE&&(this.requestEventId=r.event_id)}}t.InRoomChannel=u;class h{constructor(){(0,i.default)(this,"requestsByRoomId",new Map)}getRequest(e){const t=e.getRoomId(),n=u.getTransactionId(e);return this.getRequestByTxnId(t,n)}getRequestByChannel(e){return this.getRequestByTxnId(e.roomId,e.transactionId)}getRequestByTxnId(e,t){const n=this.requestsByRoomId.get(e);if(n)return n.get(t)}setRequest(e,t){this.doSetRequest(e.getRoomId(),u.getTransactionId(e),t)}setRequestByChannel(e,t){this.doSetRequest(e.roomId,e.transactionId,t)}doSetRequest(e,t,n){let r=this.requestsByRoomId.get(e);r||(r=new Map,this.requestsByRoomId.set(e,r)),r.set(t,n)}removeRequest(e){const t=e.getRoomId(),n=this.requestsByRoomId.get(t);n&&(n.delete(u.getTransactionId(e)),0===n.size&&this.requestsByRoomId.delete(t))}findRequestInProgress(e){const t=this.requestsByRoomId.get(e);if(t)for(const n of t.values())if(n.pending)return n}}t.InRoomRequests=h},6321:function(e,t,n){"use strict";n(6699);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.ToDeviceRequests=t.ToDeviceChannel=void 0;var i=r(n(4344)),o=n(5789),s=n(6471),a=n(5691),c=n(7270),l=n(2842);class d{constructor(e,t,n,r=null,o=null){this.client=e,this.userId=t,this.devices=n,this.transactionId=r,this.deviceId=o,(0,i.default)(this,"request",void 0)}isToDevices(e){if(e.length===this.devices.length){for(const t of e)if(!this.devices.includes(t))return!1;return!0}return!1}static getEventType(e){return e.getType()}static getTransactionId(e){const t=e.getContent();return t&&t.transaction_id}static canCreateRequest(e){return e===a.REQUEST_TYPE||e===a.START_TYPE}canCreateRequest(e){return d.canCreateRequest(e)}static validateEvent(e,t){if(e.isCancelled())return s.logger.warn("Ignoring flagged verification request from "+e.getSender()),!1;const n=e.getContent();if(!n)return s.logger.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!n.transaction_id)return s.logger.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;const r=e.getType();if(r===a.REQUEST_TYPE){if(!Number.isFinite(n.timestamp))return s.logger.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&n.from_device==t.getDeviceId())return s.logger.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return a.VerificationRequest.validateEvent(r,e,t)}getTimestamp(e){const t=e.getContent();return t&&t.timestamp}async handleEvent(e,t,n=!1){const r=e.getType(),i=e.getContent();if(r===a.REQUEST_TYPE||r===a.READY_TYPE||r===a.START_TYPE){this.transactionId||(this.transactionId=i.transaction_id);const e=i.from_device;if(!this.deviceId&&this.devices.includes(e)&&(this.deviceId=e),!this.deviceId||this.deviceId!==e){const t=this.completeContent(a.CANCEL_TYPE,(0,c.errorFromEvent)((0,c.newUnexpectedMessageError)()));return this.sendToDevices(a.CANCEL_TYPE,t,[e])}}const o=t.phase===a.PHASE_STARTED||t.phase===a.PHASE_READY;await t.handleEvent(e.getType(),e,n,!1,!1);const s=t.phase===a.PHASE_STARTED||t.phase===a.PHASE_READY,l=r===a.START_TYPE||r===a.READY_TYPE;if(l&&!o&&s&&this.deviceId){const e=this.devices.filter((e=>e!==this.deviceId&&e!==this.client.getDeviceId()));if(e.length){const t=this.completeContent(a.CANCEL_TYPE,{code:"m.accepted",reason:"Verification request accepted by another device"});await this.sendToDevices(a.CANCEL_TYPE,t,e)}}}completedContentFromEvent(e){return e.getContent()}completeContent(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),e!==a.REQUEST_TYPE&&e!==a.READY_TYPE&&e!==a.START_TYPE||(t.from_device=this.client.getDeviceId()),e===a.REQUEST_TYPE&&(t.timestamp=Date.now()),t}send(e,t={}){e!==a.REQUEST_TYPE&&e!==a.START_TYPE||this.transactionId||(this.transactionId=d.makeTransactionId());const n=this.completeContent(e,t);return this.sendCompleted(e,n)}async sendCompleted(e,t){let n;n=e===a.REQUEST_TYPE||e===a.CANCEL_TYPE&&!this.deviceId?await this.sendToDevices(e,t,this.devices):await this.sendToDevices(e,t,[this.deviceId]);const r=new l.MatrixEvent({sender:this.client.getUserId(),content:t,type:e});return await this.request.handleEvent(e,r,!0,!0,!0),n}async sendToDevices(e,t,n){if(n.length){const r={};for(const e of n)r[e]=t;await this.client.sendToDevice(e,{[this.userId]:r})}}static makeTransactionId(){return(0,o.randomString)(32)}}t.ToDeviceChannel=d;class u{constructor(){(0,i.default)(this,"requestsByUserId",new Map)}getRequest(e){return this.getRequestBySenderAndTxnId(e.getSender(),d.getTransactionId(e))}getRequestByChannel(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}getRequestBySenderAndTxnId(e,t){const n=this.requestsByUserId.get(e);if(n)return n.get(t)}setRequest(e,t){this.setRequestBySenderAndTxnId(e.getSender(),d.getTransactionId(e),t)}setRequestByChannel(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}setRequestBySenderAndTxnId(e,t,n){let r=this.requestsByUserId.get(e);r||(r=new Map,this.requestsByUserId.set(e,r)),r.set(t,n)}removeRequest(e){const t=e.getSender(),n=this.requestsByUserId.get(t);n&&(n.delete(d.getTransactionId(e)),0===n.size&&this.requestsByUserId.delete(t))}findRequestInProgress(e,t){const n=this.requestsByUserId.get(e);if(n)for(const r of n.values())if(r.pending&&r.channel.isToDevices(t))return r}getRequestsInProgress(e){const t=this.requestsByUserId.get(e);return t?Array.from(t.values()).filter((e=>e.pending)):[]}}t.ToDeviceRequests=u},5691:function(e,t,n){"use strict";n(6699),n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.VerificationRequestEvent=t.VerificationRequest=t.START_TYPE=t.REQUEST_TYPE=t.READY_TYPE=t.Phase=t.PHASE_UNSENT=t.PHASE_STARTED=t.PHASE_REQUESTED=t.PHASE_READY=t.PHASE_DONE=t.PHASE_CANCELLED=t.EVENT_PREFIX=t.DONE_TYPE=t.CANCEL_TYPE=void 0;var i=r(n(4344)),o=n(6471),s=n(7270),a=n(7264),c=n(9392);const l=6e5,d=12e4,u=3e3,h="m.key.verification.";t.EVENT_PREFIX=h;const g=h+"request";t.REQUEST_TYPE=g;const p=h+"start";t.START_TYPE=p;const f=h+"cancel";t.CANCEL_TYPE=f;const y=h+"done";t.DONE_TYPE=y;const m=h+"ready";let v;t.READY_TYPE=m,t.Phase=v,function(e){e[e["Unsent"]=1]="Unsent",e[e["Requested"]=2]="Requested",e[e["Ready"]=3]="Ready",e[e["Started"]=4]="Started",e[e["Cancelled"]=5]="Cancelled",e[e["Done"]=6]="Done"}(v||(t.Phase=v={}));const E=v.Unsent;t.PHASE_UNSENT=E;const S=v.Requested;t.PHASE_REQUESTED=S;const b=v.Ready;t.PHASE_READY=b;const w=v.Started;t.PHASE_STARTED=w;const _=v.Cancelled;t.PHASE_CANCELLED=_;const T=v.Done;let I;t.PHASE_DONE=T,t.VerificationRequestEvent=I,function(e){e["Change"]="change"}(I||(t.VerificationRequestEvent=I={}));class R extends c.TypedEventEmitter{constructor(e,t,n){super(),this.channel=e,this.verificationMethods=t,this.client=n,(0,i.default)(this,"eventsByUs",new Map),(0,i.default)(this,"eventsByThem",new Map),(0,i.default)(this,"_observeOnly",!1),(0,i.default)(this,"timeoutTimer",null),(0,i.default)(this,"_accepting",!1),(0,i.default)(this,"_declining",!1),(0,i.default)(this,"verifierHasFinished",!1),(0,i.default)(this,"_cancelled",!1),(0,i.default)(this,"_chosenMethod",null),(0,i.default)(this,"_qrCodeData",null),(0,i.default)(this,"requestReceivedAt",null),(0,i.default)(this,"commonMethods",[]),(0,i.default)(this,"_phase",void 0),(0,i.default)(this,"_cancellingUserId",void 0),(0,i.default)(this,"_verifier",void 0),(0,i.default)(this,"cancelOnTimeout",(async()=>{try{this.initiatedByMe?await this.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):await this.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(e){o.logger.error("Error while cancelling verification request",e)}})),this.channel.request=this,this.setPhase(E,!1)}static validateEvent(e,t,n){const r=t.getContent();return!(!e||!e.startsWith(h))&&(r?e!==g&&e!==m||Array.isArray(r.methods)?e!==g&&e!==m&&e!==p||"string"===typeof r.from_device&&0!==r.from_device.length||(o.logger.log("VerificationRequest: validateEvent: fail because from_device"),!1):(o.logger.log("VerificationRequest: validateEvent: fail because methods"),!1):(o.logger.log("VerificationRequest: validateEvent: no content"),!1))}get invalid(){return this.phase===E}get requested(){return this.phase===S}get cancelled(){return this.phase===_}get ready(){return this.phase===b}get started(){return this.phase===w}get done(){return this.phase===T}get methods(){return this.commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(e){let t=this.channel.getTimestamp(e)+l;if(this.requestReceivedAt&&!this.initiatedByMe&&this.phase<=S){const e=this.requestReceivedAt+d;t=Math.min(t,e)}return Math.max(0,t-Date.now())}get timeout(){const e=this.getEventByEither(g);return e?this.calculateEventTimeout(e):0}get requestEvent(){return this.getEventByEither(g)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return this.phase<b&&!this._accepting&&!this._declining}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&this._phase!==T&&this._phase!==_}get qrCodeData(){return this._qrCodeData}otherPartySupportsMethod(e,t=!1){if(!t&&!this.ready&&!this.started)return!1;const n=this.eventsByThem.get(g)||this.eventsByThem.get(m);if(!n){if(this.started&&this.initiatedByMe){const t=this.eventsByUs.get(p),n=t&&t.getContent(),r=n&&n.method;return e==r}return!1}const r=n.getContent();if(!r)return!1;const{methods:i}=r;return!!Array.isArray(i)&&i.includes(e)}get initiatedByMe(){const e=this.eventsByUs.size+this.eventsByThem.size===0;if(this._phase===E&&e)return!0;const t=this.eventsByUs.has(g),n=this.eventsByThem.has(g);if(t&&!n)return!0;if(!t&&n)return!1;const r=this.eventsByUs.has(p),i=this.eventsByThem.has(p);return!(!r||i)}get requestingUserId(){return this.initiatedByMe?this.client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this.client.getUserId()}get otherUserId(){return this.channel.userId}get isSelfVerification(){return this.client.getUserId()===this.otherUserId}get cancellingUserId(){const e=this.eventsByUs.get(f),t=this.eventsByThem.get(f);return e&&(!t||e.getId()<t.getId())?e.getSender():t?t.getSender():void 0}get cancellationCode(){const e=this.getEventByEither(f);return e?e.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){const e=this.eventsByThem.get(g)||this.eventsByThem.get(m)||this.eventsByThem.get(p),t=e.getContent(),n=t.from_device;return{userId:this.otherUserId,deviceId:n}}beginKeyVerification(e,t=null){if(!this.observeOnly&&!this._verifier){const n=this.phase===S||this.phase===b||this.phase===E&&this.channel.canCreateRequest(p);if(n){if(this.commonMethods.length&&!this.commonMethods.includes(e))throw(0,s.newUnknownMethodError)();if(this._verifier=this.createVerifier(e,null,t),!this._verifier)throw(0,s.newUnknownMethodError)();this._chosenMethod=e}}return this._verifier}async sendRequest(){if(!this.observeOnly&&this._phase===E){const e=[...this.verificationMethods.keys()];await this.channel.send(g,{methods:e})}}async cancel({reason:e="User declined",code:t="m.user"}={}){if(!this.observeOnly&&this._phase!==_){if(this._declining=!0,this.emit(I.Change),this._verifier)return this._verifier.cancel((0,s.errorFactory)(t,e)());this._cancellingUserId=this.client.getUserId(),await this.channel.send(f,{code:t,reason:e})}}async accept(){if(!this.observeOnly&&this.phase===S&&!this.initiatedByMe){const e=[...this.verificationMethods.keys()];this._accepting=!0,this.emit(I.Change),await this.channel.send(m,{methods:e})}}waitFor(e){return new Promise(((t,n)=>{const r=()=>{let i=!1;return e(this)?(t(this),i=!0):this.cancelled&&(n(new Error("cancelled")),i=!0),i&&this.off(I.Change,r),i};r()||this.on(I.Change,r)}))}setPhase(e,t=!0){this._phase=e,t&&this.emit(I.Change)}getEventByEither(e){return this.eventsByThem.get(e)||this.eventsByUs.get(e)}getEventBy(e,t=!1){return t?this.eventsByThem.get(e):this.eventsByUs.get(e)}calculatePhaseTransitions(){const e=[{phase:E}],t=()=>e[e.length-1].phase,n=this.eventsByThem.has(g),r=this.getEventBy(g,n);r&&e.push({phase:S,event:r});const i=r&&this.getEventBy(m,!n);let o;if(i&&t()===S&&e.push({phase:b,event:i}),i||!r){const e=this.eventsByThem.get(p),t=this.eventsByUs.get(p);o=e&&t?e.getSender()<t.getSender()?e:t:e||t}else o=this.getEventBy(p,!n);if(o){const n=t()===S&&r.getSender()!==o.getSender(),i=t()===E&&this.channel.canCreateRequest(p);(n||t()===b||i)&&e.push({phase:w,event:o})}const s=this.eventsByUs.get(y);(this.verifierHasFinished||s&&t()===w)&&e.push({phase:T});const a=this.getEventByEither(f);return(this._cancelled||a)&&t()!==T?(e.push({phase:_,event:a}),e):e}transitionToPhase(e){const{phase:t,event:n}=e;if((t===S||t===b)&&!this.wasSentByOwnDevice(n)){const e=n.getContent();this.commonMethods=e.methods.filter((e=>this.verificationMethods.has(e)))}if(this.observeOnly||t!==S&&t!==w&&t!==b||this.channel.receiveStartFromOtherDevices&&this.wasSentByOwnUser(n)&&!this.wasSentByOwnDevice(n)&&(this._observeOnly=!0),t===w){const{method:e}=n.getContent();this._verifier||this.observeOnly||(this._verifier=this.createVerifier(e,n),this._verifier?this._chosenMethod=e:this.cancel({code:"m.unknown_method",reason:`Unknown method: ${e}`}))}}applyPhaseTransitions(){const e=this.calculatePhaseTransitions(),t=e.findIndex((e=>e.phase===this.phase)),n=e.slice(t+1);for(const r of n)this.transitionToPhase(r);return n}isWinningStartRace(e){if(e.getType()!==p)return!1;const t=this._verifier.startEvent;let n,r;if(this.isSelfVerification)if(t){const e=t.getContent();n=e&&e.from_device}else n=this.client.getDeviceId();else n=t?t.getSender():this.client.getUserId();if(this.isSelfVerification){const t=e.getContent();r=t&&t.from_device}else r=e.getSender();return r<n}hasEventId(e){for(const t of this.eventsByUs.values())if(t.getId()===e)return!0;for(const t of this.eventsByThem.values())if(t.getId()===e)return!0;return!1}async handleEvent(e,t,n,r,i){if(this.done||this.cancelled)return;const s=this._observeOnly;if(this.adjustObserveOnly(t,n),!this.observeOnly&&!r&&await this.cancelOnError(e,t))return;const c=i?this.eventsByUs.has(e):this.eventsByThem.has(e);if(c)return;const l=this.phase;this.addEvent(e,t,i);const d=this.applyPhaseTransitions();try{if(this._verifier&&!this.observeOnly){const n=this.isWinningStartRace(t);if(this._verifier.canSwitchStartEvent(t)&&n)this._verifier.switchStartEvent(t);else if(!r){var u;(e===f||null!==(u=this._verifier.events)&&void 0!==u&&u.includes(e))&&this._verifier.handleEvent(t)}}if(d.length){if(n&&d.some((e=>e.phase===b))){const e=this.otherPartySupportsMethod(a.SCAN_QR_CODE_METHOD,!0);e&&(this._qrCodeData=await a.QRCodeData.create(this,this.client))}const e=d[d.length-1],{phase:t}=e;this.setupTimeout(t),this.setPhase(t)}else this._observeOnly!==s&&this.emit(I.Change)}finally{o.logger.log(`Verification request ${this.channel.transactionId}: ${e} event with id:${t.getId()}, content:${JSON.stringify(t.getContent())} deviceId:${this.channel.deviceId}, sender:${t.getSender()}, isSentByUs:${i}, isLiveEvent:${n}, isRemoteEcho:${r}, phase:${l}=>${this.phase}, observeOnly:${s}=>${this._observeOnly}`)}}setupTimeout(e){const t=!this.timeoutTimer&&!this.observeOnly&&e===S;if(t&&(this.timeoutTimer=setTimeout(this.cancelOnTimeout,this.timeout)),this.timeoutTimer){const t=e===w||e===b||e===T||e===_;t&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null)}}async cancelOnError(e,t){if(e===p){const e=t.getContent().method;if(!this.verificationMethods.has(e))return await this.cancel((0,s.errorFromEvent)((0,s.newUnknownMethodError)())),!0}const n=e===g&&this.phase!==E,r=e===m&&this.phase!==S&&this.phase!==w;if(this.phase!==E&&(n||r)){o.logger.warn(`Cancelling, unexpected ${e} verification event from ${t.getSender()}`);const n=`Unexpected ${e} event in phase ${this.phase}`;return await this.cancel((0,s.errorFromEvent)((0,s.newUnexpectedMessageError)({reason:n}))),!0}return!1}adjustObserveOnly(e,t=!1){t||(this._observeOnly=!0),this.calculateEventTimeout(e)<u&&(this._observeOnly=!0)}addEvent(e,t,n=!1){if(n?this.eventsByUs.set(e,t):this.eventsByThem.set(e,t),e===g){for(const[e,t]of this.eventsByThem.entries())t.getSender()!==this.otherUserId&&this.eventsByThem.delete(e);this.requestReceivedAt=Date.now()}}createVerifier(e,t=null,n=null){n||(n=this.targetDevice);const{userId:r,deviceId:i}=n,s=this.verificationMethods.get(e);if(s)return new s(this.channel,this.client,r,i,t,this);o.logger.warn("could not find verifier constructor for method",e)}wasSentByOwnUser(e){return e.getSender()===this.client.getUserId()}wasSentByOwnDevice(e){if(!this.wasSentByOwnUser(e))return!1;const t=e.getContent();return!(!t||t.from_device!==this.client.getDeviceId())}onVerifierCancelled(){this._cancelled=!0;const e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}onVerifierFinished(){this.channel.send("m.key.verification.done",{}),this.verifierHasFinished=!0;const e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}getEventFromOtherParty(e){return this.eventsByThem.get(e)}}t.VerificationRequest=R},5592:function(e,t,n){"use strict";function r(e,t){const n=`Store is invalid because ${e}, please stop the client, delete all data and start the client again`,r=Reflect.construct(Error,[n]);return Reflect.setPrototypeOf(r,Reflect.getPrototypeOf(this)),r.reason=e,r.value=t,r}function i(e){const t=`Crypto store is invalid because ${e}, please stop the client, delete all data and start the client again`,n=Reflect.construct(Error,[t]);return Reflect.setPrototypeOf(n,Reflect.getPrototypeOf(this)),n.reason=e,n.name="InvalidCryptoStoreError",n}n(1703),Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidCryptoStoreError=i,t.InvalidStoreError=r,t.KeySignatureUploadError=void 0,r.TOGGLED_LAZY_LOADING="TOGGLED_LAZY_LOADING",r.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(r,Error),i.TOO_NEW="TOO_NEW",i.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(i,Error);class o extends Error{constructor(e,t){super(e),this.value=t}}t.KeySignatureUploadError=o},3071:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.eventMapperFor=c;var i=r(n(4344)),o=n(2842);function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){let n=Boolean(t.preventReEmit);const r=!1!==t.decrypt;function i(t){const i=e.getRoom(t.room_id);let s;i&&void 0===t.state_key&&(s=i.findEventById(t.event_id)),!s||s.status?s=new o.MatrixEvent(t):(s.setUnsigned(a(a({},s.getUnsigned()),t.unsigned)),n=!0);const c=null===i||void 0===i?void 0:i.findThreadForEvent(s);return c&&s.setThread(c),s.isEncrypted()&&(n||e.reEmitter.reEmit(s,[o.MatrixEventEvent.Decrypted]),r&&e.decryptEventIfNeeded(s)),n||(e.reEmitter.reEmit(s,[o.MatrixEventEvent.Replaced,o.MatrixEventEvent.VisibilityChange]),null===i||void 0===i||i.reEmitter.reEmit(s,[o.MatrixEventEvent.BeforeRedaction])),s}return i}},6037:function(e,t,n){"use strict";n(6699),Object.defineProperty(t,"__esModule",{value:!0}),t.FilterComponent=void 0;var r=n(1356);function i(e,t){if(t.endsWith("*")){const n=t.slice(0,-1);return e.slice(0,n.length)===n}return e===t}class o{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,n;const i=(null===(t=e.getUnsigned())||void 0===t?void 0:t["m.relations"])||{},o=Object.keys(i),s=[];return this.userId&&null!==i&&void 0!==i&&null!==(n=i[r.THREAD_RELATION_TYPE.name])&&void 0!==n&&n.current_user_participated&&s.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url,o,s)}toJSON(){return{types:this.filterJson.types||null,not_types:this.filterJson.not_types||[],rooms:this.filterJson.rooms||null,not_rooms:this.filterJson.not_rooms||[],senders:this.filterJson.senders||null,not_senders:this.filterJson.not_senders||[],contains_url:this.filterJson.contains_url||null,[r.FILTER_RELATED_BY_SENDERS.name]:this.filterJson[r.FILTER_RELATED_BY_SENDERS.name]||[],[r.FILTER_RELATED_BY_REL_TYPES.name]:this.filterJson[r.FILTER_RELATED_BY_REL_TYPES.name]||[]}}checkFields(e,t,n,o,s,a){const c={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return i(n,e)}};for(let r=0;r<Object.keys(c).length;r++){const e=Object.keys(c)[r],t=c[e],n="not_"+e,i=this.filterJson[n];if(null!==i&&void 0!==i&&i.some(t))return!1;const o=this.filterJson[e];if(o&&!o.some(t))return!1}const l=this.filterJson.contains_url;if(void 0!==l&&l!==o)return!1;const d=this.filterJson[r.FILTER_RELATED_BY_REL_TYPES.name];if(void 0!==d&&!this.arrayMatchesFilter(d,s))return!1;const u=this.filterJson[r.FILTER_RELATED_BY_SENDERS.name];return!(void 0!==u&&!this.arrayMatchesFilter(u,a))}arrayMatchesFilter(e,t){return t.length>0&&e.every((e=>t.includes(e)))}filter(e){return e.filter(this.check,this)}limit(){return void 0!==this.filterJson.limit?this.filterJson.limit:10}}t.FilterComponent=o},9097:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.Filter=void 0;var i=r(n(4344)),o=n(6037);function s(e,t,n){const r=t.split(".");let i=e;for(let o=0;o<r.length-1;o++)i[r[o]]||(i[r[o]]={}),i=i[r[o]];i[r[r.length-1]]=n}class a{static fromJson(e,t,n){const r=new a(e,t);return r.setDefinition(n),r}constructor(e,t){this.userId=e,this.filterId=t,(0,i.default)(this,"definition",{}),(0,i.default)(this,"roomFilter",void 0),(0,i.default)(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;const t=e.room,n={};t&&(t.rooms&&(n.rooms=t.rooms),t.rooms&&(n.not_rooms=t.not_rooms)),this.roomFilter=new o.FilterComponent(n,this.userId),this.roomTimelineFilter=new o.FilterComponent((null===t||void 0===t?void 0:t.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomTimelineFilter.filter(this.roomFilter.filter(e))}setTimelineLimit(e){s(this.definition,"room.timeline.limit",e)}setLazyLoadMembers(e){s(this.definition,"room.state.lazy_load_members",!!e)}setIncludeLeaveRooms(e){s(this.definition,"room.include_leave",e)}}t.Filter=a,(0,i.default)(a,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0})},5354:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.PREFIX_V3=t.PREFIX_V1=t.PREFIX_UNSTABLE=t.PREFIX_R0=t.PREFIX_MEDIA_R0=t.PREFIX_IDENTITY_V2=t.PREFIX_IDENTITY_V1=t.Method=t.MatrixHttpApi=t.MatrixError=t.HttpApiEvent=t.ConnectionError=t.AbortError=void 0,t.retryNetworkOperation=P;var i=r(n(4344)),o=n(192),s=d(n(3623)),a=d(n(3926)),c=n(6471);function l(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(l=function(e){return e?n:t})(e)}function d(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=l(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const g="/_matrix/client/r0";t.PREFIX_R0=g;const p="/_matrix/client/v1";t.PREFIX_V1=p;const f="/_matrix/client/v3";t.PREFIX_V3=f;const y="/_matrix/client/unstable";t.PREFIX_UNSTABLE=y;const m="/_matrix/identity/api/v1";t.PREFIX_IDENTITY_V1=m;const v="/_matrix/identity/v2";t.PREFIX_IDENTITY_V2=v;const E="/_matrix/media/r0";let S,b;t.PREFIX_MEDIA_R0=E,t.Method=S,function(e){e["Get"]="GET",e["Put"]="PUT",e["Post"]="POST",e["Delete"]="DELETE"}(S||(t.Method=S={})),t.HttpApiEvent=b,function(e){e["SessionLoggedOut"]="Session.logged_out",e["NoConsent"]="no_consent"}(b||(t.HttpApiEvent=b={}));class w{constructor(e,t){this.eventEmitter=e,this.opts=t,(0,i.default)(this,"uploads",[]),a.checkObjectHasKeys(t,["baseUrl","request","prefix"]),t.onlyData=!!t.onlyData,t.useAuthorizationHeader=!!t.useAuthorizationHeader}setIdBaseUrl(e){this.opts.idBaseUrl=e}getContentUri(){return{base:this.opts.baseUrl,path:"/_matrix/media/r0/upload",params:{access_token:this.opts.accessToken}}}uploadContent(e,t){a.isFunction(t)?t={callback:t}:t||(t={});const r=!1!==t.includeFilename,i=t.type||e.type||"application/octet-stream",o=t.name||e.name;let l=e;const d=l.stream;d&&"function"!==typeof d&&(c.logger.warn("Using `file.stream` as the content to upload. Future versions of the js-sdk will change this to expect `file` to be the content directly."),l=d);let u=t.rawResponse;void 0===u&&(n.g.XMLHttpRequest?u=!1:(c.logger.warn("Returning the raw JSON from uploadContent(). Future versions of the js-sdk will change this default, to return the parsed object. Set opts.rawResponse=false to change this behaviour now."),u=!0));let h=t.onlyContentUri;u||void 0!==h||(n.g.XMLHttpRequest?(c.logger.warn("Returning only the content-uri from uploadContent(). Future versions of the js-sdk will change this default, to return the whole response object. Set opts.onlyContentUri=false to change this behaviour now."),h=!0):h=!1);const g={loaded:0,total:0};let p,f=null;if(u||(f=function(e){let t=JSON.parse(e);if(h&&(t=t.content_uri,void 0===t))throw Error("Bad response");return t}),n.g.XMLHttpRequest){const e=a.defer(),c=new n.g.XMLHttpRequest,d=T(e,t.callback,this.opts.onlyData),u=function(){c.abort(),d(new Error("Timeout"))};let h=s.setTimeout(u,3e4);c.onreadystatechange=function(){let e;switch(c.readyState){case n.g.XMLHttpRequest.DONE:s.clearTimeout(h);try{if(0===c.status)throw new C;if(!c.responseText)throw new Error("No response body.");e=c.responseText,f&&(e=f(e))}catch(t){return t.httpStatus=c.status,void d(t)}d(void 0,c,e);break}},c.upload.addEventListener("progress",(function(e){s.clearTimeout(h),g.loaded=e.loaded,g.total=e.total,h=s.setTimeout(u,3e4),t.progressHandler&&t.progressHandler({loaded:e.loaded,total:e.total})}));let y=this.opts.baseUrl+"/_matrix/media/r0/upload";const m=[];r&&o&&m.push("filename="+encodeURIComponent(o)),this.opts.useAuthorizationHeader||m.push("access_token="+encodeURIComponent(this.opts.accessToken)),m.length>0&&(y+="?"+m.join("&")),c.open("POST",y),this.opts.useAuthorizationHeader&&c.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),c.setRequestHeader("Content-Type",i),c.send(l),p=e.promise,p.abort=c.abort.bind(c)}else{const e={};r&&o&&(e.filename=o);const n={"Content-Type":i};0===l.length&&(n["Content-Length"]="0"),p=this.authedRequest(t.callback,S.Post,"/upload",e,l,{prefix:"/_matrix/media/r0",headers:n,json:!1,bodyParser:f})}return g.promise=p.finally((()=>{for(let e=0;e<this.uploads.length;++e)if(this.uploads[e]===g)return void this.uploads.splice(e,1)})),g.promise.abort=p.abort,this.uploads.push(g),g.promise}cancelUpload(e){return!!e.abort&&(e.abort(),!0)}getCurrentUploads(){return this.uploads}idServerRequest(e,t,n,r,i,o){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");const s=this.opts.idBaseUrl+i+n;if(void 0!==e&&!a.isFunction(e))throw Error("Expected callback to be a function but got "+typeof e);const c={uri:s,method:t,withCredentials:!1,json:!0,_matrix_opts:this.opts,headers:{}};t===S.Get?c.qs=r:"object"===typeof r&&(c.json=r),o&&(c.headers["Authorization"]=`Bearer ${o}`);const l=a.defer();return this.opts.request(c,T(l,e,this.opts.onlyData)),l.promise}authedRequest(e,t,n,r,i,o){r||(r={});let s=o||{};this.opts.useAuthorizationHeader?(isFinite(o)&&(s={localTimeoutMs:o}),s.headers||(s.headers={}),s.headers.Authorization||(s.headers.Authorization="Bearer "+this.opts.accessToken),r.access_token&&delete r.access_token):r.access_token||(r.access_token=this.opts.accessToken);const a=this.request(e,t,n,r,i,s);return a.catch((e=>{var t;"M_UNKNOWN_TOKEN"!=e.errcode||null!==(t=s)&&void 0!==t&&t.inhibitLogoutEmit?"M_CONSENT_NOT_GIVEN"==e.errcode&&this.eventEmitter.emit(b.NoConsent,e.message,e.data.consent_uri):this.eventEmitter.emit(b.SessionLoggedOut,e)})),a}request(e,t,n,r,i,o){var s;const a=null!==(s=null===o||void 0===o?void 0:o.prefix)&&void 0!==s?s:this.opts.prefix,c=this.opts.baseUrl+a+n;return this.requestOtherUrl(e,t,c,r,i,o)}requestOtherUrl(e,t,n,r,i,o){let s=o||{};return isFinite(o)&&(s={localTimeoutMs:o}),this.doRequest(e,t,n,r,i,s)}getUrl(e,t,n){let r="";return t&&(r="?"+a.encodeParams(t)),this.opts.baseUrl+n+e+r}doRequest(e,t,n,r,i,o){var c;if(void 0!==e&&!a.isFunction(e))throw Error("Expected callback to be a function but got "+typeof e);this.opts.extraParams&&(r=h(h({},r||{}),this.opts.extraParams));const l=Object.assign({},o.headers||{});o||(o={});const d=null===(c=o.json)||void 0===c||c;let u=o.bodyParser;d&&(i&&(i=JSON.stringify(i),l["content-type"]="application/json"),l["accept"]||(l["accept"]="application/json"),void 0===u&&(u=function(e){return JSON.parse(e)}));const g=a.defer();let p,f,y=!1;const m=o.localTimeoutMs||this.opts.localTimeoutMs,v=()=>{m&&(p&&s.clearTimeout(p),p=s.setTimeout((function(){var e,t;y=!0,null===(e=f)||void 0===e||null===(t=e.abort)||void 0===t||t.call(e),g.reject(new k({error:"Locally timed out waiting for a response",errcode:"ORG.MATRIX.JSSDK_TIMEOUT",timeout:m}))}),m))};v();const E=g.promise;try{f=this.opts.request({uri:n,method:t,withCredentials:!1,qs:r,qsStringifyOptions:o.qsStringifyOptions,useQuerystring:!0,body:i,json:!1,timeout:m,headers:l||{},_matrix_opts:this.opts},((t,n,r)=>{if(m&&(s.clearTimeout(p),y))return;const i=T(g,e,this.opts.onlyData,u);i(t,n,r)})),f&&("onprogress"in f&&(f.onprogress=e=>{v()}),f.abort&&(E.abort=f.abort.bind(f)))}catch(S){g.reject(S),e&&e(S)}return E}}function _(e){return e.status||e.statusCode}function T(e,t,n=!1,r){return function(i,o,s){if(i){const e="AbortError"===i.name||"aborted"===i;e||i instanceof k||(i=new O("request failed",i))}let a=s;if(!i)try{_(o)>=400?i=I(o,s):r&&(a=r(s))}catch(c){i=new Error(`Error parsing server response: ${c}`)}if(i)e.reject(i),null===t||void 0===t||t(i);else if(n)e.resolve(a),null===t||void 0===t||t(null,a);else{const n={code:_(o),headers:o.headers,data:a};e.resolve(n),null===t||void 0===t||t(null,n)}}}function I(e,t){const n=_(e),r=R(e);let i;if(r)if("application/json"===r.type){const e="object"===typeof t?t:JSON.parse(t);i=new k(e)}else"text/plain"===r.type&&(i=new Error(`Server returned ${n} error: ${t}`));return i||(i=new Error(`Server returned ${n} error`)),i.httpStatus=n,i}function R(e){let t;if(e.getResponseHeader?t=e.getResponseHeader("Content-Type"):e.headers&&(t=e.headers["content-type"]||null),!t)return null;try{return(0,o.parse)(t)}catch(n){throw new Error(`Error parsing Content-Type '${t}': ${n}`)}}t.MatrixHttpApi=w;class k extends Error{constructor(e={}){super(`MatrixError: ${e.errcode}`),(0,i.default)(this,"errcode",void 0),(0,i.default)(this,"data",void 0),(0,i.default)(this,"httpStatus",void 0),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.message=e.error||"Unknown message",this.data=e}}t.MatrixError=k;class O extends Error{constructor(e,t){super(e+(t?`: ${t.message}`:""))}get name(){return"ConnectionError"}}t.ConnectionError=O;class C extends Error{constructor(){super("Operation aborted")}get name(){return"AbortError"}}async function P(e,t){let n=0,r=null;while(n<e)try{if(n>0){const e=1e3*Math.pow(2,n);c.logger.log(`network operation failed ${n} times, retrying in ${e}ms...`),await(0,a.sleep)(e)}return t()}catch(i){if(!(i instanceof O))throw i;n+=1,r=i}throw r}t.AbortError=C},3989:function(e,t){"use strict";function n(e,t){return new Promise(((n,r)=>{let i=!0;const o=e.open(t);o.onupgradeneeded=()=>{i=!1},o.onblocked=()=>r(o.error),o.onsuccess=()=>{const r=o.result;r.close(),i||e.deleteDatabase(t),n(i)},o.onerror=e=>r(o.error)}))}Object.defineProperty(t,"__esModule",{value:!0}),t.exists=n},1217:function(e,t,n){"use strict";n(1703),n(6699);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.InteractiveAuth=t.AuthType=void 0;var i=r(n(4344)),o=n(6471),s=n(3926);const a="m.login.email.identity",c="m.login.msisdn";let l;t.AuthType=l,function(e){e["Password"]="m.login.password",e["Recaptcha"]="m.login.recaptcha",e["Terms"]="m.login.terms",e["Email"]="m.login.email.identity",e["Msisdn"]="m.login.msisdn",e["Sso"]="m.login.sso",e["SsoUnstable"]="org.matrix.login.sso",e["Dummy"]="m.login.dummy",e["RegistrationToken"]="m.login.registration_token",e["UnstableRegistrationToken"]="org.matrix.msc3231.login.registration_token"}(l||(t.AuthType=l={}));class d extends Error{constructor(e,t,n){super(e),this.required_stages=t,this.flows=n,(0,i.default)(this,"name","NoAuthFlowFoundError")}}class u{constructor(e){var t;(0,i.default)(this,"matrixClient",void 0),(0,i.default)(this,"inputs",void 0),(0,i.default)(this,"clientSecret",void 0),(0,i.default)(this,"requestCallback",void 0),(0,i.default)(this,"busyChangedCallback",void 0),(0,i.default)(this,"stateUpdatedCallback",void 0),(0,i.default)(this,"requestEmailTokenCallback",void 0),(0,i.default)(this,"data",void 0),(0,i.default)(this,"emailSid",void 0),(0,i.default)(this,"requestingEmailToken",!1),(0,i.default)(this,"attemptAuthDeferred",null),(0,i.default)(this,"chosenFlow",null),(0,i.default)(this,"currentStage",null),(0,i.default)(this,"emailAttempt",1),(0,i.default)(this,"submitPromise",null),(0,i.default)(this,"requestEmailToken",(async()=>{if(this.requestingEmailToken)o.logger.warn("Could not request email token: Already requesting");else{o.logger.trace("Requesting email token. Attempt: "+this.emailAttempt),this.requestingEmailToken=!0;try{const e=await this.requestEmailTokenCallback(this.inputs.emailAddress,this.clientSecret,this.emailAttempt++,this.data.session);this.emailSid=e.sid,o.logger.trace("Email token request succeeded")}finally{this.requestingEmailToken=!1}}})),this.matrixClient=e.matrixClient,this.data=e.authData||{},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=null!==(t=e.emailSid)&&void 0!==t?t:null}attemptAuth(){var e;this.attemptAuthDeferred=(0,s.defer)();const t=this.attemptAuthDeferred.promise;if(null!==(e=this.data)&&void 0!==e&&e.flows)this.startNextAuthStage();else{var n;null===(n=this.busyChangedCallback)||void 0===n||n.call(this,!0);let e=null;this.data.session&&(e={session:this.data.session}),this.doRequest(e).finally((()=>{var e;null===(e=this.busyChangedCallback)||void 0===e||e.call(this,!1)}))}return t}async poll(){if(!this.data.session)return;if(!this.attemptAuthDeferred)return;if(this.submitPromise)return;let e={};if(this.currentStage==a&&this.emailSid){const t={sid:this.emailSid,client_secret:this.clientSecret};if(await this.matrixClient.doesServerRequireIdServerParam()){const e=new URL(this.matrixClient.getIdentityServerUrl());t.id_server=e.host}e={type:a,threepid_creds:t,threepidCreds:t}}this.submitAuthDict(e,!0)}getSessionId(){return this.data?this.data.session:void 0}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return null===(t=this.data.params)||void 0===t?void 0:t[e]}getChosenFlow(){return this.chosenFlow}async submitAuthDict(e,t=!1){if(!this.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");var n;t||(null===(n=this.busyChangedCallback)||void 0===n||n.call(this,!0));while(this.submitPromise)try{await this.submitPromise}catch(o){}let r;this.data.session?(r={session:this.data.session},Object.assign(r,e)):r=e;try{this.submitPromise=this.doRequest(r,t),await this.submitPromise}finally{var i;if(this.submitPromise=null,!t)null===(i=this.busyChangedCallback)||void 0===i||i.call(this,!1)}}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}async doRequest(e,t=!1){try{const n=await this.requestCallback(e,t);this.attemptAuthDeferred.resolve(n),this.attemptAuthDeferred=null}catch(s){var n,r;const e=null!==(n=null===(r=s.data)||void 0===r?void 0:r.flows)&&void 0!==n?n:null,c=this.data.flows||Boolean(e);var i;if(401!==s.httpStatus||!s.data||!c)if(t)o.logger.log("Background poll request failed doing UI auth: ignoring",s);else null===(i=this.attemptAuthDeferred)||void 0===i||i.reject(s);s.data.flows||s.data.completed||s.data.session||(s.data.flows=this.data.flows,s.data.completed=this.data.completed,s.data.session=this.data.session),this.data=s.data;try{this.startNextAuthStage()}catch(a){return this.attemptAuthDeferred.reject(a),void(this.attemptAuthDeferred=null)}if(!this.emailSid&&this.chosenFlow.stages.includes(l.Email))try{await this.requestEmailToken()}catch(a){this.attemptAuthDeferred.reject(a),this.attemptAuthDeferred=null}}}startNextAuthStage(){const e=this.chooseStage();if(!e)throw new Error("No incomplete flows from the server");if(this.currentStage=e,e===l.Dummy)return void this.submitAuthDict({type:"m.login.dummy"});if(this.data&&this.data.errcode||this.data.error)return void this.stateUpdatedCallback(e,{errcode:this.data.errcode||"",error:this.data.error||""});const t={};e==a&&(t.emailSid=this.emailSid),this.stateUpdatedCallback(e,t)}chooseStage(){null===this.chosenFlow&&(this.chosenFlow=this.chooseFlow()),o.logger.log("Active flow => %s",JSON.stringify(this.chosenFlow));const e=this.firstUncompletedStage(this.chosenFlow);return o.logger.log("Next stage: %s",e),e}chooseFlow(){const e=this.data.flows||[],t=Boolean(this.inputs.emailAddress)||Boolean(this.emailSid),n=Boolean(this.inputs.phoneCountry)&&Boolean(this.inputs.phoneNumber);for(const i of e){let e=!1,r=!1;for(const t of i.stages)t===a?e=!0:t==c&&(r=!0);if(e==t&&r==n)return i}const r=[];throw t&&r.push(a),n&&r.push(c),new d("No appropriate authentication flow found",r,e)}firstUncompletedStage(e){const t=this.data.completed||[];for(let n=0;n<e.stages.length;++n){const r=e.stages[n];if(-1===t.indexOf(r))return r}}}t.InteractiveAuth=u},6471:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.logger=void 0;var i=r(n(9245));const o="matrix";i.default.methodFactory=function(e,t,n){return function(...t){this.prefix&&t.unshift(this.prefix);const n="error"===e||"warn"===e||"trace"===e||"info"===e;return n?console[e](...t):console.log(...t)}};const s=i.default.getLogger(o);function a(e){e.withPrefix=function(e){const t=this.prefix||"";return c(t+e)}}function c(e){const t=i.default.getLogger(`${o}-${e}`);return t.prefix!==e&&(a(t),t.prefix=e,t.setLevel(i.default.levels.DEBUG,!1)),t}t.logger=s,s.setLevel(i.default.levels.DEBUG,!1),a(s)},5346:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r={request:!0,getRequest:!0,wrapRequest:!0,setCryptoStoreFactory:!0,createClient:!0,ContentHelpers:!0,createNewMatrixCall:!0};t.ContentHelpers=void 0,t.createClient=$,Object.defineProperty(t,"createNewMatrixCall",{enumerable:!0,get:function(){return U.createNewMatrixCall}}),t.getRequest=x,t.request=j,t.setCryptoStoreFactory=q,t.wrapRequest=K;var i=n(1911);Object.keys(i).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))}));var o=n(613);Object.keys(o).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))}));var s=n(2889);Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))}));var a=n(9528);Object.keys(a).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))}));var c=n(5354);Object.keys(c).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===c[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))}));var l=n(7911);Object.keys(l).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))}));var d=n(568);Object.keys(d).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))}));var u=n(5592);Object.keys(u).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))}));var h=n(9240);Object.keys(h).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===h[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))}));var g=n(2842);Object.keys(g).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===g[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))}));var p=n(2139);Object.keys(p).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))}));var f=n(8919);Object.keys(f).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===f[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))}));var y=n(3839);Object.keys(y).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))}));var m=n(3078);Object.keys(m).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===m[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))}));var v=n(8859);Object.keys(v).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===v[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))}));var E=n(6876);Object.keys(E).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===E[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))}));var S=n(9097);Object.keys(S).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===S[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))}));var b=n(104);Object.keys(b).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===b[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))}));var w=n(1217);Object.keys(w).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===w[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return w[e]}}))}));var _=n(5045);Object.keys(_).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===_[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return _[e]}}))}));var T=n(455);Object.keys(T).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===T[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return T[e]}}))}));var I=n(7896);Object.keys(I).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===I[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return I[e]}}))}));var R=n(2697);Object.keys(R).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===R[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return R[e]}}))}));var k=n(7778);Object.keys(k).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===k[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return k[e]}}))}));var O=n(9666);Object.keys(O).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===O[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return O[e]}}))}));var C=n(5718);Object.keys(C).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===C[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return C[e]}}))}));var P=n(1626);Object.keys(P).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===P[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return P[e]}}))}));var M=n(3250);Object.keys(M).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===M[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return M[e]}}))}));var D=n(2231);Object.keys(D).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===D[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return D[e]}}))}));var A=N(n(8652));t.ContentHelpers=A;var U=n(9393);function L(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(L=function(e){return e?n:t})(e)}function N(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=L(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}let B;function j(e){B=e}function x(){return B}function K(e){const t=B;B=function(n,r){return e(t,n,r)}}let F=()=>new i.MemoryCryptoStore;function q(e){F=e}function $(e){return"string"===typeof e&&(e={baseUrl:e}),e.request=e.request||B,e.store=e.store||new o.MemoryStore({localStorage:n.g.localStorage}),e.scheduler=e.scheduler||new s.MatrixScheduler,e.cryptoStore=e.cryptoStore||F(),new a.MatrixClient(e)}},143:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.MSC3089Branch=void 0;var i=r(n(4344)),o=n(7778),s=n(8919);function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class l{constructor(e,t,n){this.client=e,this.indexEvent=t,this.directory=n}get id(){const e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return!0===this.indexEvent.getContent()["active"]}get version(){var e;return null!==(e=this.indexEvent.getContent()["version"])&&void 0!==e?e:1}get roomId(){return this.indexEvent.getRoomId()}async delete(){await this.client.sendStateEvent(this.roomId,o.UNSTABLE_MSC3089_BRANCH.name,{},this.id),await this.client.redactEvent(this.roomId,this.id);const e=(await this.getVersionHistory())[1];e&&await e.delete()}getName(){return this.indexEvent.getContent()["name"]||"Unnamed File"}async setName(e){await this.client.sendStateEvent(this.roomId,o.UNSTABLE_MSC3089_BRANCH.name,c(c({},this.indexEvent.getContent()),{},{name:e}),this.id)}isLocked(){return this.indexEvent.getContent()["locked"]||!1}async setLocked(e){await this.client.sendStateEvent(this.roomId,o.UNSTABLE_MSC3089_BRANCH.name,c(c({},this.indexEvent.getContent()),{},{locked:e}),this.id)}async getFileInfo(){const e=await this.getFileEvent(),t=e.getOriginalContent()["file"],n=this.client.mxcUrlToHttp(t["url"]);if(!n)throw new Error(`No HTTP URL available for ${t["url"]}`);return{info:t,httpUrl:n}}async getFileEvent(){const e=this.client.getRoom(this.roomId);if(!e)throw new Error("Unknown room");let t=e.getUnfilteredTimelineSet().findEventById(this.id);while(!t&&e.getLiveTimeline().getState(s.EventTimeline.BACKWARDS).paginationToken)await this.client.scrollback(e,100),t=e.getUnfilteredTimelineSet().findEventById(this.id);if(!t)throw new Error("Failed to find event");return await this.client.decryptEventIfNeeded(t,{emit:!0,isRetry:!0}),t}async createNewVersion(e,t,n,r){const i=await this.directory.createFile(e,t,n,c(c({},null!==r&&void 0!==r?r:{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:o.RelationType.Replace,event_id:this.id}}));return await this.client.sendStateEvent(this.roomId,o.UNSTABLE_MSC3089_BRANCH.name,{active:!0,name:e,version:this.version+1},i["event_id"]),await this.client.sendStateEvent(this.roomId,o.UNSTABLE_MSC3089_BRANCH.name,c(c({},this.indexEvent.getContent()),{},{active:!1}),this.id),i}async getVersionHistory(){const e=[];e.push(this);const t=this.client.getRoom(this.roomId);if(!t)throw new Error("Invalid or unknown room");const n=[...t.getLiveTimeline().getEvents()].reverse();let r,i=await this.getFileEvent();do{if(r=n.find((e=>e.replacingEventId()===i.getId())),r){const t=this.directory.getFile(r.getId());if(!t)break;e.push(t),i=r}}while(r);return e}}t.MSC3089Branch=l},6783:function(e,t,n){"use strict";n(1703),n(6699);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.TreePermissions=t.MSC3089TreeSpace=t.DEFAULT_TREE_POWER_LEVELS_TEMPLATE=void 0;var i=r(n(4344)),o=r(n(9437)),s=n(7778),a=n(6471),c=n(3926),l=n(143),d=n(489);function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const g={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[s.EventType.RoomPowerLevels]:100,[s.EventType.RoomHistoryVisibility]:100,[s.EventType.RoomTombstone]:100,[s.EventType.RoomEncryption]:100,[s.EventType.RoomName]:50,[s.EventType.RoomMessage]:50,[s.EventType.RoomMessageEncrypted]:50,[s.EventType.Sticker]:50},users:{}};let p;t.DEFAULT_TREE_POWER_LEVELS_TEMPLATE=g,t.TreePermissions=p,function(e){e["Viewer"]="viewer",e["Editor"]="editor",e["Owner"]="owner"}(p||(t.TreePermissions=p={}));class f{constructor(e,t){if(this.client=e,this.roomId=t,(0,i.default)(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){const e=this.room.currentState.getStateEvents(s.EventType.SpaceParent);return null===e||void 0===e||!e.length||e.every((e=>{var t;return!(null!==(t=e.getContent())&&void 0!==t&&t["via"])}))}async setName(e){await this.client.sendStateEvent(this.roomId,s.EventType.RoomName,{name:e},"")}async invite(e,t=!0,n=!0){const r=[this.retryInvite(e)];return t&&r.push(...this.getDirectories().map((r=>r.invite(e,t,n)))),Promise.all(r).then((()=>{n&&(0,d.isRoomSharedHistory)(this.room)&&this.client.sendSharedHistoryKeys(this.roomId,[e])}))}retryInvite(e){return(0,c.simpleRetryOperation)((async()=>{await this.client.invite(this.roomId,e).catch((e=>{if("M_FORBIDDEN"===(null===e||void 0===e?void 0:e.errcode))throw new o.default.AbortError(e);throw e}))}))}async setPermissions(e,t){var n;const r=this.room.currentState.getStateEvents(s.EventType.RoomPowerLevels,"");if(Array.isArray(r))throw new Error("Unexpected return type for power levels");const i=r.getContent()||{},o=i["users_default"]||0,a=i["events_default"]||50,c=(null===(n=i["events"])||void 0===n?void 0:n[s.EventType.RoomPowerLevels])||100,l=i["users"]||{};switch(t){case p.Viewer:l[e]=o;break;case p.Editor:l[e]=a;break;case p.Owner:l[e]=c;break;default:throw new Error("Invalid role: "+t)}i["users"]=l,await this.client.sendStateEvent(this.roomId,s.EventType.RoomPowerLevels,i,"")}getPermissions(e){var t,n;const r=this.room.currentState.getStateEvents(s.EventType.RoomPowerLevels,"");if(Array.isArray(r))throw new Error("Unexpected return type for power levels");const i=r.getContent()||{},o=i["users_default"]||0,a=i["events_default"]||50,c=(null===(t=i["events"])||void 0===t?void 0:t[s.EventType.RoomPowerLevels])||100,l=(null===(n=i["users"])||void 0===n?void 0:n[e])||o;return l>=c?p.Owner:l>=a?p.Editor:p.Viewer}async createDirectory(e){const t=await this.client.unstableCreateFileTree(e);return await this.client.sendStateEvent(this.roomId,s.EventType.SpaceChild,{via:[this.client.getDomain()]},t.roomId),await this.client.sendStateEvent(t.roomId,s.EventType.SpaceParent,{via:[this.client.getDomain()]},this.roomId),t}getDirectories(){const e=[],t=this.room.currentState.getStateEvents(s.EventType.SpaceChild);for(const r of t)try{const t=r.getStateKey();if(t){const n=this.client.unstableGetFileTreeSpace(t);n&&e.push(n)}}catch(n){a.logger.warn("Unable to create tree space instance for listing. Are we joined?",n)}return e}getDirectory(e){return this.getDirectories().find((t=>t.roomId===e))}async delete(){const e=this.getDirectories();for(const r of e)await r.delete();const t=["invite","knock","join"],n=this.room.currentState.getStateEvents(s.EventType.RoomMember);for(const r of n){const e=r.getStateKey()!==this.client.getUserId();if(e&&t.includes(r.getContent().membership)){const e=r.getStateKey();if(!e)throw new Error("State key not found for branch");await this.client.kick(this.roomId,e,"Room deleted")}}await this.client.leave(this.roomId)}getOrderedChildren(e){const t=e.map((e=>({roomId:e.getStateKey(),order:e.getContent()["order"]}))).filter((e=>e.roomId));return t.sort(((e,t)=>{if(e.order&&!t.order)return-1;if(!e.order&&t.order)return 1;if(e.order||t.order)return(0,c.lexicographicCompare)(e.order,t.order);{var n,r,i,o;const a=this.client.getRoom(e.roomId),l=this.client.getRoom(t.roomId);if(!a||!l)return(0,c.lexicographicCompare)(e.roomId,t.roomId);const d=null!==(n=null===(r=a.currentState.getStateEvents(s.EventType.RoomCreate,""))||void 0===r?void 0:r.getTs())&&void 0!==n?n:0,u=null!==(i=null===(o=l.currentState.getStateEvents(s.EventType.RoomCreate,""))||void 0===o?void 0:o.getTs())&&void 0!==i?i:0;return d===u?(0,c.lexicographicCompare)(e.roomId,t.roomId):d-u}})),t}getParentRoom(){const e=this.room.currentState.getStateEvents(s.EventType.SpaceParent),t=e[0];if(!t)throw new Error("Expected to have a parent in a non-top level space");const n=t.getStateKey();if(!n)throw new Error("No state key found for parent");const r=this.client.getRoom(n);if(!r)throw new Error("Unable to locate room for parent");return r}getOrder(){if(this.isTopLevel)return-1;const e=this.getParentRoom(),t=e.currentState.getStateEvents(s.EventType.SpaceChild),n=this.getOrderedChildren(t);return n.findIndex((e=>e.roomId===this.roomId))}async setOrder(e){var t;if(this.isTopLevel)throw new Error("Cannot set order of top level spaces currently");const n=this.getParentRoom(),r=n.currentState.getStateEvents(s.EventType.SpaceChild),i=this.getOrderedChildren(r);e=Math.max(Math.min(e,i.length-1),0);const o=this.getOrder(),a=o<e;a&&e===i.length-1?e--:a||0!==e||e++;const l=i[a?e:e-1],d=i[a?e+1:e];let u=c.DEFAULT_ALPHABET[0],g=!1;if(l)if(e===i.length-1)null!==d&&void 0!==d&&d.order&&(u=(0,c.nextString)(d.order));else{const e=null===l||void 0===l?void 0:l.order,t=null===d||void 0===d?void 0:d.order;e&&t?u=e===t?(0,c.nextString)(e):(0,c.averageBetweenStrings)(e,t):e?u=(0,c.nextString)(e):t?u=(0,c.prevString)(t):g=!0}else null!==d&&void 0!==d&&d.order&&(u=(0,c.prevString)(d.order));if(g){let t;for(let r=0;r<=e;r++){const e=i[r];if(0===r&&(t=e.order),e.order)t=e.order;else{var p;t=t?(0,c.nextString)(t):c.DEFAULT_ALPHABET[0];const r=n.currentState.getStateEvents(s.EventType.SpaceChild,e.roomId),i=null!==(p=null===r||void 0===r?void 0:r.getContent())&&void 0!==p?p:{via:[this.client.getDomain()]};await this.client.sendStateEvent(n.roomId,s.EventType.SpaceChild,h(h({},i),{},{order:t}),e.roomId)}}t&&(u=(0,c.nextString)(t))}const f=n.currentState.getStateEvents(s.EventType.SpaceChild,this.roomId),y=null!==(t=null===f||void 0===f?void 0:f.getContent())&&void 0!==t?t:{via:[this.client.getDomain()]};await this.client.sendStateEvent(n.roomId,s.EventType.SpaceChild,h(h({},y),{},{order:u}),this.roomId)}async createFile(e,t,n,r){var i;const o=await this.client.uploadContent(t,{includeFilename:!1,onlyContentUri:!0,rawResponse:!1});n.url=o;const a={msgtype:s.MsgType.File,body:e,url:o,file:n};r=null!==(i=r)&&void 0!==i?i:{},r["m.new_content"]&&(r["m.new_content"]=a);const c=await this.client.sendMessage(this.roomId,h(h(h({},r),a),{},{[s.UNSTABLE_MSC3089_LEAF.name]:{}}));return await this.client.sendStateEvent(this.roomId,s.UNSTABLE_MSC3089_BRANCH.name,{active:!0,name:e},c["event_id"]),c}getFile(e){const t=this.room.currentState.getStateEvents(s.UNSTABLE_MSC3089_BRANCH.name,e);return t?new l.MSC3089Branch(this.client,t,this):null}listFiles(){return this.listAllFiles().filter((e=>e.isActive))}listAllFiles(){var e;const t=null!==(e=this.room.currentState.getStateEvents(s.UNSTABLE_MSC3089_BRANCH.name))&&void 0!==e?e:[];return t.map((e=>new l.MSC3089Branch(this.client,e,this)))}}t.MSC3089TreeSpace=f},9240:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.isTimestampInDuration=t.getBeaconInfoIdentifier=t.BeaconEvent=t.Beacon=void 0;var i=r(n(4344)),o=n(3786),s=n(8652),a=n(3926),c=n(9392);let l;t.BeaconEvent=l,function(e){e["New"]="Beacon.new",e["Update"]="Beacon.update",e["LivenessChange"]="Beacon.LivenessChange",e["Destroy"]="Beacon.Destroy",e["LocationUpdate"]="Beacon.LocationUpdate"}(l||(t.BeaconEvent=l={}));const d=(e,t,n)=>n>=e&&e+t>=n;t.isTimestampInDuration=d;const u=e=>`${e.getRoomId()}_${e.getStateKey()}`;t.getBeaconInfoIdentifier=u;class h extends c.TypedEventEmitter{constructor(e){super(),this.rootEvent=e,(0,i.default)(this,"roomId",void 0),(0,i.default)(this,"_beaconInfo",void 0),(0,i.default)(this,"_isLive",void 0),(0,i.default)(this,"livenessWatchTimeout",void 0),(0,i.default)(this,"_latestLocationEvent",void 0),(0,i.default)(this,"clearLatestLocation",(()=>{this._latestLocationEvent=void 0,this.emit(l.LocationUpdate,this.latestLocationState)})),this.setBeaconInfo(this.rootEvent),this.roomId=this.rootEvent.getRoomId()}get isLive(){return this._isLive}get identifier(){return u(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&(0,s.parseBeaconContent)(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(u(e)!==this.identifier)throw new Error("Invalid updating event");e.event.origin_server_ts<this.rootEvent.event.origin_server_ts||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(l.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(l.Destroy,this.identifier)}monitorLiveness(){var e;if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),this.isLive){var t,n;const e=(null===(t=this._beaconInfo)||void 0===t?void 0:t.timestamp)+(null===(n=this._beaconInfo)||void 0===n?void 0:n.timeout)-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout((()=>{this.monitorLiveness()}),e))}else if((null===(e=this._beaconInfo)||void 0===e?void 0:e.timestamp)>Date.now()){var r;this.livenessWatchTimeout=setTimeout((()=>{this.monitorLiveness()}),(null===(r=this.beaconInfo)||void 0===r?void 0:r.timestamp)-Date.now())}}addLocations(e){var t;if(!this.isLive)return;const n=e.filter((e=>{const t=e.getContent(),n=o.M_TIMESTAMP.findIn(t);return d(this._beaconInfo.timestamp,this._beaconInfo.timeout,n)&&(!this.latestLocationState||n>this.latestLocationState.timestamp)})),r=null===(t=n.sort(a.sortEventsByLatestContentTimestamp))||void 0===t?void 0:t[0];r&&(this._latestLocationEvent=r,this.emit(l.LocationUpdate,this.latestLocationState))}setBeaconInfo(e){this._beaconInfo=(0,s.parseBeaconInfoContent)(e.getContent()),this.checkLiveness()}checkLiveness(){var e,t,n,r,i;const o=this.isLive,s=(null===(e=this._beaconInfo)||void 0===e?void 0:e.timestamp)>Date.now()?(null===(t=this._beaconInfo)||void 0===t?void 0:t.timestamp)-36e4:null===(n=this._beaconInfo)||void 0===n?void 0:n.timestamp;this._isLive=(null===(r=this._beaconInfo)||void 0===r?void 0:r.live)&&d(s,null===(i=this._beaconInfo)||void 0===i?void 0:i.timeout,Date.now()),o!==this.isLive&&this.emit(l.LivenessChange,this.isLive,this)}}t.Beacon=h},6323:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.EventContext=void 0;var i=r(n(4344)),o=n(8919);class s{constructor(e){this.ourEvent=e,(0,i.default)(this,"timeline",void 0),(0,i.default)(this,"ourEventIndex",0),(0,i.default)(this,"paginateTokens",{[o.Direction.Backward]:null,[o.Direction.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(e=!1){return this.paginateTokens[e?o.Direction.Backward:o.Direction.Forward]}setPaginateToken(e,t=!1){this.paginateTokens[t?o.Direction.Backward:o.Direction.Forward]=e}addEvents(e,t=!1){t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}t.EventContext=s},1592:function(e,t){"use strict";let n;Object.defineProperty(t,"__esModule",{value:!0}),t.EventStatus=void 0,t.EventStatus=n,function(e){e["NOT_SENT"]="not_sent",e["ENCRYPTING"]="encrypting",e["SENDING"]="sending",e["QUEUED"]="queued",e["SENT"]="sent",e["CANCELLED"]="cancelled"}(n||(t.EventStatus=n={}))},3839:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.EventTimelineSet=t.DuplicateStrategy=void 0;var i=r(n(4344)),o=n(8919),s=n(6471),a=n(2139),c=n(9392),l=n(4925);const d=!0;let u,h;u=d?s.logger.log.bind(s.logger):function(){},t.DuplicateStrategy=h,function(e){e["Ignore"]="ignore",e["Replace"]="replace"}(h||(t.DuplicateStrategy=h={}));class g extends c.TypedEventEmitter{constructor(e,t={},n,r){var s,a,c;super(),this.room=e,this.thread=r,(0,i.default)(this,"relations",void 0),(0,i.default)(this,"timelineSupport",void 0),(0,i.default)(this,"displayPendingEvents",void 0),(0,i.default)(this,"liveTimeline",void 0),(0,i.default)(this,"timelines",void 0),(0,i.default)(this,"_eventIdToTimeline",void 0),(0,i.default)(this,"filter",void 0),this.timelineSupport=Boolean(t.timelineSupport),this.liveTimeline=new o.EventTimeline(this),this.displayPendingEvents=!1!==t.pendingEvents,this.timelines=[this.liveTimeline],this._eventIdToTimeline={},this.filter=t.filter,this.relations=null!==(s=null===(a=this.room)||void 0===a?void 0:a.relations)&&void 0!==s?s:new l.RelationsContainer(null!==(c=null===e||void 0===e?void 0:e.client)&&void 0!==c?c:n)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return this.room&&this.displayPendingEvents?this.room.getPendingEvents():[]}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline[e]}replaceEventId(e,t){const n=this._eventIdToTimeline[e];n&&(delete this._eventIdToTimeline[e],this._eventIdToTimeline[t]=n)}resetLiveTimeline(e,t){const n=!this.timelineSupport||!t,r=this.liveTimeline,i=n?r.forkLive(o.EventTimeline.FORWARDS):r.fork(o.EventTimeline.FORWARDS);n?(this.timelines=[i],this._eventIdToTimeline={}):this.timelines.push(i),t&&r.setPaginationToken(t,o.EventTimeline.FORWARDS),i.setPaginationToken(e,o.EventTimeline.BACKWARDS),this.liveTimeline=i,this.emit(a.RoomEvent.TimelineReset,this.room,this,n)}getTimelineForEvent(e){const t=this._eventIdToTimeline[e];return void 0===t?null:t}findEventById(e){const t=this.getTimelineForEvent(e);if(t)return t.getEvents().find((function(t){return t.getId()==e}))}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");const e=new o.EventTimeline(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,n,r){if(!n)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&n==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(this.filter&&(e=this.filter.filterRoomTimeline(e),!e.length))return;const i=t?o.EventTimeline.BACKWARDS:o.EventTimeline.FORWARDS,a=t?o.EventTimeline.FORWARDS:o.EventTimeline.BACKWARDS;let c=!1,l=!1;for(let d=0;d<e.length;d++){const r=e[d],h=r.getId(),g=this._eventIdToTimeline[h];if(!g){this.addEventToTimeline(r,n,{toStartOfTimeline:t}),l=!0,c=!0;continue}if(l=!1,g==n){u("Event "+h+" already in timeline "+n);continue}const p=n.getNeighbouringTimeline(i);if(p){u(g==p?"Event "+h+" in neighbouring timeline - switching to "+g:"Event "+h+" already in a different timeline "+g),n=g;continue}s.logger.info("Already have timeline for "+h+" - joining timeline "+n+" to "+g);const f=g===this.liveTimeline,y=n===this.liveTimeline,m=i===o.EventTimeline.BACKWARDS&&f,v=i===o.EventTimeline.FORWARDS&&y;m||v?(m&&s.logger.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+g+")"),v&&s.logger.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+n+")")):(n.setNeighbouringTimeline(g,i),g.setNeighbouringTimeline(n,a),n=g,c=!0)}if(l||!c){if(i===o.EventTimeline.FORWARDS&&n===this.liveTimeline)return s.logger.warn({lastEventWasNew:l,didUpdate:c}),void s.logger.warn(`Refusing to set forwards pagination token of live timeline ${n} to ${r}`);n.setPaginationToken(r,i)}}addLiveEvent(e,t,n=!1,r){let i,a=t||h.Ignore;if("object"===typeof t?({duplicateStrategy:a=h.Ignore,fromCache:n=!1,roomState:r,timelineWasEmpty:i}=t):void 0!==t&&s.logger.warn("Overload deprecated: `EventTimelineSet.addLiveEvent(event, duplicateStrategy?, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addLiveEvent(event, IAddLiveEventOptions)`"),this.filter){const t=this.filter.filterRoomTimeline([e]);if(!t.length)return}const c=this._eventIdToTimeline[e.getId()];if(c)if(a===h.Replace){u("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());const t=c.getEvents();for(let n=0;n<t.length;n++)if(t[n].getId()===e.getId()){r||(r=c.getState(o.EventTimeline.FORWARDS)),o.EventTimeline.setEventMetadata(e,r,!1),t[n]=e;break}}else u("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());else this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:n,roomState:r,timelineWasEmpty:i})}addEventToTimeline(e,t,n,r=!1,i){let o,c=!!n;"object"===typeof n?({toStartOfTimeline:c,fromCache:r=!1,roomState:i,timelineWasEmpty:o}=n):void 0!==n&&s.logger.warn("Overload deprecated: `EventTimelineSet.addEventToTimeline(event, timeline, toStartOfTimeline, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addEventToTimeline(event, timeline, IAddEventToTimelineOptions)`");const l=e.getId();t.addEvent(e,{toStartOfTimeline:c,roomState:i,timelineWasEmpty:o}),this._eventIdToTimeline[l]=t,this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this);const d={timeline:t,liveEvent:!c&&t==this.liveTimeline&&!r};this.emit(a.RoomEvent.Timeline,e,this.room,Boolean(c),!1,d)}handleRemoteEcho(e,t,n){const r=this._eventIdToTimeline[t];r?(delete this._eventIdToTimeline[t],this._eventIdToTimeline[n]=r):this.filter?this.filter.filterRoomTimeline([e]).length&&this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1}):this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1})}removeEvent(e){const t=this._eventIdToTimeline[e];if(!t)return null;const n=t.removeEvent(e);if(n){delete this._eventIdToTimeline[e];const r={timeline:t};this.emit(a.RoomEvent.Timeline,n,this.room,void 0,!0,r)}return n}compareEventOrdering(e,t){if(e==t)return 0;const n=this._eventIdToTimeline[e],r=this._eventIdToTimeline[t];if(void 0===n)return null;if(void 0===r)return null;if(n===r){let r,i;const o=n.getEvents();for(let n=0;n<o.length&&(void 0===r||void 0===i);n++){const s=o[n].getId();s==e&&(r=n),s==t&&(i=n)}return r-i}let i=n;while(i){if(i===r)return-1;i=i.getNeighbouringTimeline(o.EventTimeline.FORWARDS)}i=n;while(i){if(i===r)return 1;i=i.getNeighbouringTimeline(o.EventTimeline.BACKWARDS)}return null}canContain(e){if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");const{threadId:t,shouldLiveInRoom:n}=this.room.eventShouldLiveIn(e);return this.thread?this.thread.id===t:n}}t.EventTimelineSet=g},8919:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.EventTimeline=t.Direction=void 0;var i=r(n(4344)),o=n(6471),s=n(8859),a=n(7778);let c;t.Direction=c,function(e){e["Backward"]="b",e["Forward"]="f"}(c||(t.Direction=c={}));class l{static setEventMetadata(e,t,n){var r,i,o,s;null!==(r=e.sender)&&void 0!==r&&null!==(i=r.events)&&void 0!==i&&i.member||(e.sender=t.getSentinelMember(e.getSender())),null!==(o=e.target)&&void 0!==o&&null!==(s=o.events)&&void 0!==s&&s.member||e.getType()!==a.EventType.RoomMember||(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&n&&(e.forwardLooking=!1)}constructor(e){var t,n;this.eventTimelineSet=e,(0,i.default)(this,"roomId",void 0),(0,i.default)(this,"name",void 0),(0,i.default)(this,"events",[]),(0,i.default)(this,"baseIndex",0),(0,i.default)(this,"startState",void 0),(0,i.default)(this,"endState",void 0),(0,i.default)(this,"prevTimeline",void 0),(0,i.default)(this,"nextTimeline",void 0),(0,i.default)(this,"paginationRequests",{[c.Backward]:null,[c.Forward]:null}),this.roomId=null!==(t=null===(n=e.room)||void 0===n?void 0:n.roomId)&&void 0!==t?t:null,this.startState=new s.RoomState(this.roomId),this.startState.paginationToken=null,this.endState=new s.RoomState(this.roomId),this.endState.paginationToken=null,this.prevTimeline=null,this.nextTimeline=null,this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+(new Date).toISOString()}initialiseState(e,{timelineWasEmpty:t}={}){if(this.events.length>0)throw new Error("Cannot initialise state after events are added");for(const n of e)Object.freeze(n);this.startState.setStateEvents(e,{timelineWasEmpty:t}),this.endState.setStateEvents(e,{timelineWasEmpty:t})}forkLive(e){const t=this.getState(e),n=new l(this.eventTimelineSet);return n.startState=t.clone(),n.endState=t,this.endState=t.clone(),n}fork(e){const t=this.getState(e),n=new l(this.eventTimelineSet);return n.startState=t.clone(),n.endState=t.clone(),n}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==l.BACKWARDS)return this.startState;if(e==l.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.getState(e).paginationToken}setPaginationToken(e,t){this.getState(t).paginationToken=e}getNeighbouringTimeline(e){if(e==l.BACKWARDS)return this.prevTimeline;if(e==l.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==l.BACKWARDS)this.prevTimeline=e;else{if(t!=l.FORWARDS)throw new Error("Invalid direction '"+t+"'");this.nextTimeline=e}this.setPaginationToken(null,t)}addEvent(e,t,n){let r,i=!!t;"object"===typeof t?({toStartOfTimeline:i,roomState:n,timelineWasEmpty:r}=t):void 0!==t&&o.logger.warn("Overload deprecated: `EventTimeline.addEvent(event, toStartOfTimeline, roomState?)` is deprecated in favor of the overload with `EventTimeline.addEvent(event, IAddEventOptions)`"),n||(n=i?this.startState:this.endState);const s=this.getTimelineSet();let a;s.room&&(l.setEventMetadata(e,n,i),e.isState()&&s.room.getUnfilteredTimelineSet()===s&&(n.setStateEvents([e],{timelineWasEmpty:r}),e.sender&&("m.room.member"!==e.getType()||i)||l.setEventMetadata(e,n,i))),a=i?0:this.events.length,this.events.splice(a,0,e),i&&this.baseIndex++}removeEvent(e){for(let t=this.events.length-1;t>=0;t--){const n=this.events[t];if(n.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,n}return null}toString(){return this.name}}t.EventTimeline=l,(0,i.default)(l,"BACKWARDS",c.Backward),(0,i.default)(l,"FORWARDS",c.Forward)},2842:function(e,t,n){"use strict";n(6699),n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"EventStatus",{enumerable:!0,get:function(){return h.EventStatus}}),t.MatrixEventEvent=t.MatrixEvent=void 0;var i=r(n(4344)),o=n(3255),s=n(6471),a=n(7778),c=n(3926),l=n(1356),d=n(4111),u=n(9392),h=n(1592);const g={};function p(e){return g[e]||(g[e]=e),g[e]}const f=Object.freeze({visible:!0});let y;t.MatrixEventEvent=y,function(e){e["Decrypted"]="Event.decrypted",e["BeforeRedaction"]="Event.beforeRedaction",e["VisibilityChange"]="Event.visibilityChange",e["LocalEventIdReplaced"]="Event.localEventIdReplaced",e["Status"]="Event.status",e["Replaced"]="Event.replaced",e["RelationsCreated"]="Event.relationsCreated"}(y||(t.MatrixEventEvent=y={}));class m extends u.TypedEventEmitter{constructor(e={}){var t;super(),this.event=e,(0,i.default)(this,"pushActions",null),(0,i.default)(this,"_replacingEvent",null),(0,i.default)(this,"_localRedactionEvent",null),(0,i.default)(this,"_isCancelled",!1),(0,i.default)(this,"clearEvent",void 0),(0,i.default)(this,"visibility",f),(0,i.default)(this,"_hasCachedExtEv",!1),(0,i.default)(this,"_cachedExtEv",void 0),(0,i.default)(this,"senderCurve25519Key",null),(0,i.default)(this,"claimedEd25519Key",null),(0,i.default)(this,"forwardingCurve25519KeyChain",[]),(0,i.default)(this,"untrusted",null),(0,i.default)(this,"_decryptionPromise",null),(0,i.default)(this,"retryDecryption",!1),(0,i.default)(this,"txnId",null),(0,i.default)(this,"thread",null),(0,i.default)(this,"threadId",void 0),(0,i.default)(this,"localTimestamp",void 0),(0,i.default)(this,"sender",null),(0,i.default)(this,"target",null),(0,i.default)(this,"status",null),(0,i.default)(this,"error",null),(0,i.default)(this,"forwardLooking",!0),(0,i.default)(this,"verificationRequest",null),(0,i.default)(this,"reEmitter",void 0),["state_key","type","sender","room_id","membership"].forEach((t=>{"string"===typeof e[t]&&(e[t]=p(e[t]))})),["membership","avatar_url","displayname"].forEach((t=>{var n;"string"===typeof(null===(n=e.content)||void 0===n?void 0:n[t])&&(e.content[t]=p(e.content[t]))})),["rel_type"].forEach((t=>{var n,r;"string"===typeof(null===(n=e.content)||void 0===n||null===(r=n["m.relates_to"])||void 0===r?void 0:r[t])&&(e.content["m.relates_to"][t]=p(e.content["m.relates_to"][t]))})),this.txnId=e.txn_id||null,this.localTimestamp=Date.now()-(null!==(t=this.getAge())&&void 0!==t?t:0),this.reEmitter=new d.TypedReEmitter(this)}get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=o.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){const e=Object.assign({},this.getContent());if(this.getWireType()===a.EventType.RoomMessageEncrypted)for(const[t,n]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||void 0===e[t]&&(e[t]=n);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender||this.event.user_id}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getOriginalContent(){return this._localRedactionEvent?{}:this.clearEvent?this.clearEvent.content||{}:this.event.content||{}}getContent(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;const t=null===(e=this.getWireContent())||void 0===e?void 0:e["m.relates_to"];return(null===t||void 0===t?void 0:t.rel_type)===l.THREAD_RELATION_TYPE.name?t.event_id:(null===(n=this.getThread())||void 0===n?void 0:n.id)||this.threadId;var n}get isThreadRoot(){var e;const t=this.getServerAggregatedRelation(l.THREAD_RELATION_TYPE.name);return!!t||(null===(e=this.getThread())||void 0===e?void 0:e.id)===this.getId()}get replyEventId(){var e;const t=this.getContent()["m.relates_to"]||this.getWireContent()["m.relates_to"];return null===t||void 0===t||null===(e=t["m.in_reply_to"])||void 0===e?void 0:e.event_id}get relationEventId(){var e,t;return null===(e=this.getWireContent())||void 0===e||null===(t=e["m.relates_to"])||void 0===t?void 0:t.event_id}getPrevContent(){return this.getUnsigned().prev_content||this.event.prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age||this.event.age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return void 0!==this.event.state_key}makeEncrypted(e,t,n,r){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this.senderCurve25519Key=n,this.claimedEd25519Key=r}isBeingDecrypted(){return null!=this._decryptionPromise}getDecryptionPromise(){return this._decryptionPromise}isDecryptionFailure(){var e,t;return"m.bad.encrypted"===(null===(e=this.clearEvent)||void 0===e||null===(t=e.content)||void 0===t?void 0:t.msgtype)}shouldAttemptDecryption(){return!this.isRedacted()&&(!this.isBeingDecrypted()&&(!this.clearEvent&&!!this.isEncrypted()))}async attemptDecryption(e,t={}){if("boolean"===typeof t&&(t={isRetry:t}),!this.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");if(this.clearEvent&&!this.isDecryptionFailure())throw new Error("Attempt to decrypt event which has already been decrypted");return this._decryptionPromise?(s.logger.log(`Event ${this.getId()} already being decrypted; queueing a retry`),this.retryDecryption=!0,this._decryptionPromise):(this._decryptionPromise=this.decryptionLoop(e,t),this._decryptionPromise)}cancelAndResendKeyRequest(e,t){const n=this.getWireContent();return e.requestRoomKey({algorithm:n.algorithm,room_id:this.getRoomId(),session_id:n.session_id,sender_key:n.sender_key},this.getKeyRequestRecipients(t),!0)}getKeyRequestRecipients(e){const t=this.getWireContent(),n=[{userId:e,deviceId:"*"}],r=this.getSender();return r!==e&&n.push({userId:r,deviceId:t.device_id}),n}async decryptionLoop(e,t={}){await Promise.resolve();while(1){let r,i;this.retryDecryption=!1;try{e?(r=await e.decryptEvent(this),!0===t.isRetry&&s.logger.info(`Decrypted event on retry (id=${this.getId()})`)):r=this.badEncryptedMessage("Encryption not enabled")}catch(n){if("DecryptionError"!==n.name){const e=t.isRetry?"re":"";return s.logger.error(`Error ${e}decrypting event (id=${this.getId()}): ${n.stack||n}`),this._decryptionPromise=null,void(this.retryDecryption=!1)}if(i=n,this.retryDecryption){s.logger.log(`Got error decrypting event (id=${this.getId()}: ${n.detailedString}), but retrying`,n);continue}s.logger.warn(`Got error decrypting event (id=${this.getId()}: ${n.detailedString})`,n),r=this.badEncryptedMessage(n.message)}return this._decryptionPromise=null,this.retryDecryption=!1,this.setClearData(r),this.setPushActions(null),void(!1!==t.emit&&this.emit(y.Decrypted,this,i))}}badEncryptedMessage(e){return{clearEvent:{type:a.EventType.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: "+e+" **"}}}}setClearData(e){this.clearEvent=e.clearEvent,this.senderCurve25519Key=e.senderCurve25519Key||null,this.claimedEd25519Key=e.claimedEd25519Key||null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&this.event.type===a.EventType.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return{ed25519:this.claimedEd25519Key}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){const e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=null),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(y.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){const t=!e||e.visible,n=e?e.reason:null;let r=!1;this.visibility.visible!==e.visible?r=!0:this.visibility.visible||this.visibility["reason"]===n||(r=!0),r&&(this.visibility=t?f:Object.freeze({visible:!1,reason:n}),this.emit(y.VisibilityChange,this,t))}messageVisibility(){return this.visibility}makeRedacted(e){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit(y.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;for(const r in this.event)this.event.hasOwnProperty(r)&&!v.has(r)&&delete this.event[r];this.isEncrypted()&&(this.clearEvent=null);const t=E[this.getType()]||{},n=this.getContent();for(const r in n)n.hasOwnProperty(r)&&!t[r]&&delete n[r];this.invalidateExtensibleEvent()}isRedacted(){return Boolean(this.getUnsigned().redacted_because)}isRedaction(){return this.getType()===a.EventType.RoomRedaction}asVisibilityChange(){if(!a.EVENT_VISIBILITY_CHANGE_TYPE.matches(this.getType()))return null;const e=this.getRelation();if(!e||"m.reference"!=e.rel_type)return null;const t=e.event_id;if(!t)return null;const n=this.getWireContent(),r=!!n.visible,i=n.reason;return i&&"string"!=typeof i?null:{visible:r,reason:i,eventId:t}}isVisibilityEvent(){return a.EVENT_VISIBILITY_CHANGE_TYPE.matches(this.getType())}getRedactionEvent(){var e,t;return this.isRedacted()?null!==(e=this.clearEvent)&&void 0!==e&&e.unsigned?null===(t=this.clearEvent)||void 0===t?void 0:t.unsigned.redacted_because:this.event.unsigned.redacted_because?this.event.unsigned.redacted_because:{}:null}getPushActions(){return this.pushActions}setPushActions(e){this.pushActions=e}handleRemoteEcho(e){const t=this.getUnsigned(),n=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==n&&this.emit(y.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-this.getAge()}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(y.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(y.LocalEventIdReplaced,this)}isRelation(e){var t;const n=null===(t=this.getWireContent())||void 0===t?void 0:t["m.relates_to"];return(!this.isState()||(null===n||void 0===n?void 0:n.rel_type)!==a.RelationType.Replace)&&((null===n||void 0===n?void 0:n.rel_type)&&n.event_id&&(!e||n.rel_type===e))}getRelation(){return this.isRelation()?this.getWireContent()["m.relates_to"]:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=e,this.emit(y.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return null===(t=this.getUnsigned()["m.relations"])||void 0===t?void 0:t[e]}replacingEventId(){const e=this.getServerAggregatedRelation(a.RelationType.Replace);return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0}replacingEvent(){return this._replacingEvent}replacingEventDate(){const e=this.getServerAggregatedRelation(a.RelationType.Replace);if(e){const t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent)return this._replacingEvent.getDate()}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){const e=this.getRelation();return this.replyEventId?this.replyEventId:e?e.event_id:this.isRedaction()?this.event.redacts:void 0}hasAssocation(){return!!this.getAssociatedId()}updateAssociatedId(e){const t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(e=!0){this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){const e=new m(JSON.parse(JSON.stringify(this.event)));for(const[t,n]of Object.entries(this))"event"!==t&&(e[t]=n);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;const t=(0,c.deepSortedObjectEntries)(this.event),n=(0,c.deepSortedObjectEntries)(e.event);return JSON.stringify(t)===JSON.stringify(n)}toJSON(){const e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setVerificationRequest(e){this.verificationRequest=e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.thread=e,this.setThreadId(e.id),this.reEmitter.reEmit(e,[l.ThreadEvent.Update])}getThread(){return this.thread}setThreadId(e){this.threadId=e}}t.MatrixEvent=m;const v=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),E={[a.EventType.RoomMember]:{membership:1},[a.EventType.RoomCreate]:{creator:1},[a.EventType.RoomJoinRules]:{join_rule:1},[a.EventType.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},[a.EventType.RoomAliases]:{aliases:1}}},4925:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.RelationsContainer=void 0;var i=r(n(4344)),o=n(6718),s=n(2842);class a{constructor(e,t){this.client=e,this.room=t,(0,i.default)(this,"relations",{})}getChildEventsForEvent(e,t,n){var r,i;return null===(r=this.relations[e])||void 0===r||null===(i=r[t])||void 0===i?void 0:i[n]}getAllChildEventsForEvent(e){var t;const n=null!==(t=this.relations[e])&&void 0!==t?t:{},r=[];for(const i of Object.values(n))for(const e of Object.values(i))r.push(...e.getRelations());return r}aggregateParentEvent(e){const t=this.relations[e.getId()];if(t)for(const n of Object.values(t))for(const t of Object.values(n))t.setTargetEvent(e)}aggregateChildEvent(e,t){if(e.isRedacted()||e.status===s.EventStatus.CANCELLED)return;const n=e.getRelation();if(!n)return;const r=()=>{e.isDecryptionFailure()?e.once(s.MatrixEventEvent.Decrypted,r):this.aggregateChildEvent(e,t)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption())return void e.once(s.MatrixEventEvent.Decrypted,r);const{event_id:i,rel_type:a}=n,c=e.getType();let l=this.relations[i];l||(l=this.relations[i]={});let d=l[a];d||(d=l[a]={});let u=d[c];if(!u){var h,g,p;u=d[c]=new o.Relations(a,c,this.client);const e=null!==(h=this.room)&&void 0!==h?h:null===t||void 0===t?void 0:t.room,n=null!==(g=null!==(p=null===t||void 0===t?void 0:t.findEventById(i))&&void 0!==p?p:null===e||void 0===e?void 0:e.findEventById(i))&&void 0!==g?g:null===e||void 0===e?void 0:e.getPendingEvent(i);n&&u.setTargetEvent(n)}u.addEvent(e)}}t.RelationsContainer=a},6718:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.RelationsEvent=t.Relations=void 0;var i=r(n(4344)),o=n(2842),s=n(6471),a=n(7778),c=n(9392),l=n(2139);let d;t.RelationsEvent=d,function(e){e["Add"]="Relations.add",e["Remove"]="Relations.remove",e["Redaction"]="Relations.redaction"}(d||(t.RelationsEvent=d={}));class u extends c.TypedEventEmitter{constructor(e,t,n){super(),this.relationType=e,this.eventType=t,(0,i.default)(this,"relationEventIds",new Set),(0,i.default)(this,"relations",new Set),(0,i.default)(this,"annotationsByKey",{}),(0,i.default)(this,"annotationsBySender",{}),(0,i.default)(this,"sortedAnnotationsByKey",[]),(0,i.default)(this,"targetEvent",null),(0,i.default)(this,"creationEmitted",!1),(0,i.default)(this,"client",void 0),(0,i.default)(this,"onEventStatus",((e,t)=>{e.isSending()?t===o.EventStatus.CANCELLED&&(e.removeListener(o.MatrixEventEvent.Status,this.onEventStatus),this.removeEvent(e)):e.removeListener(o.MatrixEventEvent.Status,this.onEventStatus)})),(0,i.default)(this,"onBeforeRedaction",(async e=>{if(this.relations.has(e)){if(this.relations.delete(e),this.relationType===a.RelationType.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===a.RelationType.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.removeListener(o.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.emit(d.Redaction,e)}})),this.client=n instanceof l.Room?n.client:n}async addEvent(e){if(this.relationEventIds.has(e.getId()))return;const t=e.getRelation();if(!t)return void s.logger.error("Event must have relation info");const n=t.rel_type,r=e.getType();if(this.relationType===n&&this.eventType===r){if(e.isSending()&&e.on(o.MatrixEventEvent.Status,this.onEventStatus),this.relations.add(e),this.relationEventIds.add(e.getId()),this.relationType===a.RelationType.Annotation)this.addAnnotationToAggregation(e);else if(this.relationType===a.RelationType.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.on(o.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.emit(d.Add,e),this.maybeEmitCreated()}else s.logger.error("Event relation info doesn't match this container")}async removeEvent(e){if(!this.relations.has(e))return;const t=e.getRelation();if(!t)return void s.logger.error("Event must have relation info");const n=t.rel_type,r=e.getType();if(this.relationType===n&&this.eventType===r){if(this.relations.delete(e),this.relationType===a.RelationType.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===a.RelationType.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}this.emit(d.Remove,e)}else s.logger.error("Event relation info doesn't match this container")}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){const{key:t}=e.getRelation();if(!t)return;let n=this.annotationsByKey[t];n||(n=this.annotationsByKey[t]=new Set,this.sortedAnnotationsByKey.push([t,n])),n.add(e),this.sortedAnnotationsByKey.sort(((e,t)=>{const n=e[1],r=t[1];return r.size-n.size}));const r=e.getSender();let i=this.annotationsBySender[r];i||(i=this.annotationsBySender[r]=new Set),i.add(e)}removeAnnotationFromAggregation(e){const{key:t}=e.getRelation();if(!t)return;const n=this.annotationsByKey[t];n&&(n.delete(e),this.sortedAnnotationsByKey.sort(((e,t)=>{const n=e[1],r=t[1];return r.size-n.size})));const r=e.getSender(),i=this.annotationsBySender[r];i&&i.delete(e)}getSortedAnnotationsByKey(){return this.relationType!==a.RelationType.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==a.RelationType.Annotation?null:this.annotationsBySender}async getLastReplacement(){if(this.relationType!==a.RelationType.Replace)return null;if(!this.targetEvent)return null;const e=this.targetEvent.getServerAggregatedRelation(a.RelationType.Replace),t=null===e||void 0===e?void 0:e.origin_server_ts,n=this.getRelations().reduce(((e,n)=>n.getSender()!==this.targetEvent.getSender()||t&&t>n.getTs()||e&&e.getTs()>n.getTs()?e:n),null);return null!==n&&void 0!==n&&n.shouldAttemptDecryption()?await n.attemptDecryption(this.client.crypto):null!==n&&void 0!==n&&n.isBeingDecrypted()&&await n.getDecryptionPromise(),n}async setTargetEvent(e){if(!this.targetEvent){if(this.targetEvent=e,this.relationType===a.RelationType.Replace&&!this.targetEvent.isState()){const e=await this.getLastReplacement();e&&this.targetEvent.makeReplaced(e)}this.maybeEmitCreated()}}maybeEmitCreated(){this.creationEmitted||this.targetEvent&&this.relations.size&&(this.creationEmitted=!0,this.targetEvent.emit(o.MatrixEventEvent.RelationsCreated,this.relationType,this.eventType))}}t.Relations=u},3078:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomMemberEvent=t.RoomMember=void 0;var i=r(n(4344)),o=n(2697),s=u(n(3926)),a=n(6471),c=n(9392),l=n(7778);function d(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(d=function(e){return e?n:t})(e)}function u(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=d(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}let h;t.RoomMemberEvent=h,function(e){e["Membership"]="RoomMember.membership",e["Name"]="RoomMember.name",e["PowerLevel"]="RoomMember.powerLevel",e["Typing"]="RoomMember.typing"}(h||(t.RoomMemberEvent=h={}));class g extends c.TypedEventEmitter{constructor(e,t){super(),this.roomId=e,this.userId=t,(0,i.default)(this,"_isOutOfBand",!1),(0,i.default)(this,"_modified",void 0),(0,i.default)(this,"_requestedProfileInfo",void 0),(0,i.default)(this,"typing",!1),(0,i.default)(this,"name",void 0),(0,i.default)(this,"rawDisplayName",void 0),(0,i.default)(this,"powerLevel",0),(0,i.default)(this,"powerLevelNorm",0),(0,i.default)(this,"user",null),(0,i.default)(this,"membership",null),(0,i.default)(this,"disambiguate",!1),(0,i.default)(this,"events",{member:null}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){const n=e.getDirectionalContent().displayname;if(e.getType()!==l.EventType.RoomMember)return;this._isOutOfBand=!1,this.events.member=e;const r=this.membership;this.membership=e.getDirectionalContent().membership,void 0===this.membership&&a.logger.trace(`membership event with membership undefined (forwardLooking: ${e.forwardLooking})!`,e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=y(this.userId,n,t);const i=this.name;this.name=m(this.userId,n,t,this.disambiguate),this.rawDisplayName=s.removeDirectionOverrideChars(e.getDirectionalContent().displayname),this.rawDisplayName&&s.removeHiddenChars(this.rawDisplayName)||(this.rawDisplayName=this.userId),r!==this.membership&&(this.updateModifiedTime(),this.emit(h.Membership,e,this,r)),i!==this.name&&(this.updateModifiedTime(),this.emit(h.Name,e,this,i))}setPowerLevelEvent(e){if("m.room.power_levels"!==e.getType())return;const t=e.getDirectionalContent();let n=t.users_default||0;const r=t.users||{};Object.values(r).forEach((function(e){n=Math.max(n,e)}));const i=this.powerLevel,o=this.powerLevelNorm;void 0!==r[this.userId]&&Number.isInteger(r[this.userId])?this.powerLevel=r[this.userId]:void 0!==t.users_default?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,n>0&&(this.powerLevelNorm=100*this.powerLevel/n),i===this.powerLevel&&o===this.powerLevelNorm||(this.updateModifiedTime(),this.emit(h.PowerLevel,e,this))}setTypingEvent(e){if("m.typing"!==e.getType())return;const t=this.typing;this.typing=!1;const n=e.getContent().user_ids;Array.isArray(n)&&(-1!==n.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(h.Typing,e,this)))}updateModifiedTime(){this._modified=Date.now()}getLastModifiedTime(){return this._modified}isKicked(){return"leave"===this.membership&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){const e=this.events.member;let t=e.getContent(),n=e.getSender();if("join"===t.membership&&(t=e.getPrevContent(),n=e.getUnsigned().prev_sender),"invite"===t.membership&&t.is_direct)return n}}getAvatarUrl(e,t,n,r,i=!0,s){const a=this.getMxcAvatarUrl();if(!a&&!i)return null;const c=(0,o.getHttpUriForMxc)(e,a,t,n,r,s);return c||null}getMxcAvatarUrl(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:null}}t.RoomMember=g;const p=/@.+:.+/,f=/[\u200E\u200F\u202A-\u202F]/;function y(e,t,n){if(!t||t===e)return!1;if(!s.removeHiddenChars(t))return!1;if(!n)return!1;if(p.test(t))return!0;if(f.test(t))return!0;const r=n.getUserIdsWithDisplayName(t);return!!r.some((t=>t!==e))}function m(e,t,n,r){return r?s.removeDirectionOverrideChars(t)+" ("+e+")":t&&t!==e&&s.removeHiddenChars(t)?s.removeDirectionOverrideChars(t):e}},8859:function(e,t,n){"use strict";n(6699);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomStateEvent=t.RoomState=void 0;var i,o=r(n(4344)),s=n(3078),a=n(6471),c=m(n(3926)),l=n(7778),d=n(2842),u=n(5718),h=n(9392),g=n(9240),p=n(4111),f=n(7946);function y(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(y=function(e){return e?n:t})(e)}function m(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=y(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}function v(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function E(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?v(Object(n),!0).forEach((function(t){(0,o.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):v(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let S;(function(e){e[e["NotStarted"]=0]="NotStarted",e[e["InProgress"]=1]="InProgress",e[e["Finished"]=2]="Finished"})(i||(i={})),t.RoomStateEvent=S,function(e){e["Events"]="RoomState.events",e["Members"]="RoomState.members",e["NewMember"]="RoomState.newMember",e["Update"]="RoomState.update",e["BeaconLiveness"]="RoomState.BeaconLiveness",e["Marker"]="RoomState.Marker"}(S||(t.RoomStateEvent=S={}));class b extends h.TypedEventEmitter{constructor(e,t={status:i.NotStarted}){super(),this.roomId=e,this.oobMemberFlags=t,(0,o.default)(this,"reEmitter",new p.TypedReEmitter(this)),(0,o.default)(this,"sentinels",{}),(0,o.default)(this,"displayNameToUserIds",{}),(0,o.default)(this,"userIdsToDisplayNames",{}),(0,o.default)(this,"tokenToInvite",{}),(0,o.default)(this,"joinedMemberCount",null),(0,o.default)(this,"summaryJoinedMemberCount",null),(0,o.default)(this,"invitedMemberCount",null),(0,o.default)(this,"summaryInvitedMemberCount",null),(0,o.default)(this,"modified",void 0),(0,o.default)(this,"members",{}),(0,o.default)(this,"events",new Map),(0,o.default)(this,"paginationToken",null),(0,o.default)(this,"beacons",new Map),(0,o.default)(this,"_liveBeaconIds",[]),this.updateModifiedTime()}getJoinedMemberCount(){return null!==this.summaryJoinedMemberCount?this.summaryJoinedMemberCount:(null===this.joinedMemberCount&&(this.joinedMemberCount=this.getMembers().reduce(((e,t)=>"join"===t.membership?e+1:e),0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return null!==this.summaryInvitedMemberCount?this.summaryInvitedMemberCount:(null===this.invitedMemberCount&&(this.invitedMemberCount=this.getMembers().reduce(((e,t)=>"invite"===t.membership?e+1:e),0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter((t=>!e.includes(t.userId)))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;let t=this.sentinels[e];if(void 0===t){t=new s.RoomMember(this.roomId,e);const n=this.members[e];n&&t.setMembershipEvent(n.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return void 0===t?[]:null;if(void 0===t)return Array.from(this.events.get(e).values());const n=this.events.get(e).get(t);return n||null}get hasLiveBeacons(){var e;return!(null===(e=this.liveBeaconIds)||void 0===e||!e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){const e=new b(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=i.NotStarted,Array.from(this.events.values()).forEach((t=>{e.setStateEvents(Array.from(t.values()))})),this.oobMemberFlags.status=t,null!==this.summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this.summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==i.Finished&&this.getMembers().forEach((t=>{if(t.isOutOfBand()){const n=e.getMember(t.userId);n.markOutOfBand()}})),e}setUnknownStateEvents(e){const t=e.filter((e=>!this.events.has(e.getType())||!this.events.get(e.getType()).has(e.getStateKey())));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach((e=>{if(e.getRoomId()!==this.roomId)return;if(!e.isState())return;f.M_BEACON_INFO.matches(e.getType())&&this.setBeacon(e);const t=this.getStateEventMatching(e);this.setStateEvent(e),e.getType()===l.EventType.RoomMember&&(this.updateDisplayNameCache(e.getStateKey(),e.getContent().displayname),this.updateThirdPartyTokenCache(e)),this.emit(S.Events,e,this,t)})),this.onBeaconLivenessChange(),e.forEach((e=>{if(e.getRoomId()===this.roomId&&e.isState())if(e.getType()===l.EventType.RoomMember){const t=e.getStateKey();"leave"!==e.getContent().membership&&"ban"!==e.getContent().membership||(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);const n=this.getOrCreateMember(t,e);n.setMembershipEvent(e,this),this.updateMember(n),this.emit(S.Members,e,this,n)}else if(e.getType()===l.EventType.RoomPowerLevels){if(""!==e.getStateKey())return;const t=Object.values(this.members);t.forEach((t=>{const n=t.getLastModifiedTime();t.setPowerLevelEvent(e),n!==t.getLastModifiedTime()&&this.emit(S.Members,e,this,t)})),this.sentinels={}}else l.UNSTABLE_MSC2716_MARKER.matches(e.getType())&&this.emit(S.Marker,e,t)})),this.emit(S.Update,this)}processBeaconEvents(e,t){if(!e.length||!this.beacons.size)return;const n=[...this.beacons.values()].reduce(((e,t)=>E(E({},e),{},{[t.beaconInfoId]:t})),{}),r=(e,t)=>{if(!f.M_BEACON.matches(t.getType()))return;const r=n[e];r&&r.addLocations([t])};e.forEach((e=>{var i;const o=null===(i=e.getRelation())||void 0===i?void 0:i.event_id;n[o]&&(t.decryptEventIfNeeded(e),e.isBeingDecrypted()||e.isDecryptionFailure()?e.once(d.MatrixEventEvent.Decrypted,(async()=>{r(o,e)})):r(o,e))}))}getOrCreateMember(e,t){let n=this.members[e];return n||(n=new s.RoomMember(this.roomId,e),this.members[e]=n,this.emit(S.NewMember,t,this,n)),n}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){const t=(0,g.getBeaconInfoIdentifier)(e);if(this.beacons.has(t)){const r=this.beacons.get(t);var n;return e.isRedacted()?void(r.beaconInfoId===(null===(n=e.getRedactionEvent())||void 0===n?void 0:n["redacts"])&&(r.destroy(),this.beacons.delete(t))):r.update(e)}if(e.isRedacted())return;const r=new g.Beacon(e);this.reEmitter.reEmit(r,[g.BeaconEvent.New,g.BeaconEvent.Update,g.BeaconEvent.Destroy,g.BeaconEvent.LivenessChange]),this.emit(g.BeaconEvent.New,e,r),r.on(g.BeaconEvent.LivenessChange,this.onBeaconLivenessChange.bind(this)),r.on(g.BeaconEvent.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(r.identifier,r)}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter((e=>e.isLive)).map((e=>e.identifier)),this.emit(S.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,n;return null!==(t=null===(n=this.events.get(e.getType()))||void 0===n?void 0:n.get(e.getStateKey()))&&void 0!==t?t:null}updateMember(e){const t=this.getStateEvents(l.EventType.RoomPowerLevels,"");t&&e.setPowerLevelEvent(t),delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===i.NotStarted}markOutOfBandMembersStarted(){this.oobMemberFlags.status===i.NotStarted&&(this.oobMemberFlags.status=i.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===i.InProgress&&(this.oobMemberFlags.status=i.NotStarted)}clearOutOfBandMembers(){let e=0;Object.keys(this.members).forEach((t=>{const n=this.members[t];n.isOutOfBand()&&(++e,delete this.members[t])})),a.logger.log(`LL: RoomState removed ${e} members...`),this.oobMemberFlags.status=i.NotStarted}setOutOfBandMembers(e){a.logger.log(`LL: RoomState about to set ${e.length} OOB members ...`),this.oobMemberFlags.status===i.InProgress&&(a.logger.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=i.Finished,e.forEach((e=>this.setOutOfBandMember(e))),this.emit(S.Update,this))}setOutOfBandMember(e){if(e.getType()!==l.EventType.RoomMember)return;const t=e.getStateKey(),n=this.getMember(t);if(n&&!n.isOutOfBand())return;const r=this.getOrCreateMember(t,e);r.setMembershipEvent(e,this),r.markOutOfBand(),this.updateDisplayNameCache(r.userId,r.name),this.setStateEvent(e),this.updateMember(r),this.emit(S.Members,e,this,r)}setTypingEvent(e){Object.values(this.members).forEach((function(t){t.setTypingEvent(e)}))}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){return this.displayNameToUserIds[c.removeHiddenChars(e)]||[]}maySendRedactionForEvent(e,t){const n=this.getMember(t);if(!n||"leave"===n.membership)return!1;if(e.status||e.isRedacted())return!1;const r=this.maySendEvent(l.EventType.RoomRedaction,t);return e.getSender()===t?r:this.hasSufficientPowerLevelFor("redact",n.powerLevel)}hasSufficientPowerLevelFor(e,t){const n=this.getStateEvents(l.EventType.RoomPowerLevels,"");let r={};n&&(r=n.getContent());let i=50;return c.isNumber(r[e])&&(i=r[e]),t>=i}maySendMessage(e){return this.maySendEventOfType(l.EventType.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return!t.isGuest()&&this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,n){const r=this.getStateEvents(l.EventType.RoomPowerLevels,"");let i,o={},s=0,a=0,c=0;if(r){i=r.getContent(),o=i.events||{},s=Number.isSafeInteger(i.state_default)?i.state_default:50;const e=i.users&&i.users[t];Number.isSafeInteger(e)?c=e:Number.isSafeInteger(i.users_default)&&(c=i.users_default),Number.isSafeInteger(i.events_default)&&(a=i.events_default)}let d=n?s:a;return Number.isSafeInteger(o[e])&&(d=o[e]),c>=d}mayTriggerNotifOfType(e,t){const n=this.getMember(t);if(!n)return!1;const r=this.getStateEvents(l.EventType.RoomPowerLevels,"");let i=50;return r&&r.getContent()&&r.getContent().notifications&&c.isNumber(r.getContent().notifications[e])&&(i=r.getContent().notifications[e]),n.powerLevel>=i}getJoinRule(){var e;const t=this.getStateEvents(l.EventType.RoomJoinRules,""),n=null!==(e=null===t||void 0===t?void 0:t.getContent())&&void 0!==e?e:{};return n["join_rule"]||u.JoinRule.Invite}getHistoryVisibility(){var e;const t=this.getStateEvents(l.EventType.RoomHistoryVisibility,""),n=null!==(e=null===t||void 0===t?void 0:t.getContent())&&void 0!==e?e:{};return n["history_visibility"]||u.HistoryVisibility.Shared}getGuestAccess(){var e;const t=this.getStateEvents(l.EventType.RoomGuestAccess,""),n=null!==(e=null===t||void 0===t?void 0:t.getContent())&&void 0!==e?e:{};return n["guest_access"]||u.GuestAccess.Forbidden}updateThirdPartyTokenCache(e){if(!e.getContent().third_party_invite)return;const t=(e.getContent().third_party_invite.signed||{}).token;if(!t)return;const n=this.getStateEvents(l.EventType.RoomThirdPartyInvite,t);n&&(this.tokenToInvite[t]=e)}updateDisplayNameCache(e,t){const n=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],n){const t=c.removeHiddenChars(n),r=this.displayNameToUserIds[t];if(r){const n=r.filter((t=>t!==e));this.displayNameToUserIds[t]=n}}this.userIdsToDisplayNames[e]=t;const r=t&&c.removeHiddenChars(t);r&&(this.displayNameToUserIds[r]||(this.displayNameToUserIds[r]=[]),this.displayNameToUserIds[r].push(e))}}t.RoomState=b},2231:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoomSummary=void 0;class n{constructor(e,t){this.roomId=e}}t.RoomSummary=n},2139:function(e,t,n){"use strict";n(6699),n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomEvent=t.Room=t.NotificationCountType=t.KNOWN_SAFE_ROOM_VERSION=void 0;var i=r(n(4344)),o=n(3839),s=n(8919),a=n(2697),c=_(n(3926)),l=n(2842),d=n(1592),u=n(3078),h=n(2231),g=n(6471),p=n(4111),f=n(7778),y=n(9528),m=n(9097),v=n(1356),E=n(9392),S=n(6445),b=n(4925);function w(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(w=function(e){return e?n:t})(e)}function _(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=w(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}function T(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function I(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?T(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):T(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const R="9";t.KNOWN_SAFE_ROOM_VERSION=R;const k=["1","2","3","4","5","6","7","8","9"];function O(e,t,n){return new l.MatrixEvent({content:{[t.getId()]:{[n]:{[e]:{ts:t.getTs()}}}},type:"m.receipt",room_id:t.getRoomId()})}const C=0,P=1,M=30;let D,A;t.NotificationCountType=D,function(e){e["Highlight"]="highlight",e["Total"]="total"}(D||(t.NotificationCountType=D={})),t.RoomEvent=A,function(e){e["MyMembership"]="Room.myMembership",e["Tags"]="Room.tags",e["AccountData"]="Room.accountData",e["Receipt"]="Room.receipt",e["Name"]="Room.name",e["Redaction"]="Room.redaction",e["RedactionCancelled"]="Room.redactionCancelled",e["LocalEchoUpdated"]="Room.localEchoUpdated",e["Timeline"]="Room.timeline",e["TimelineReset"]="Room.timelineReset",e["TimelineRefresh"]="Room.TimelineRefresh",e["OldStateUpdated"]="Room.OldStateUpdated",e["CurrentStateUpdated"]="Room.CurrentStateUpdated",e["HistoryImportedWithinTimeline"]="Room.historyImportedWithinTimeline"}(A||(t.RoomEvent=A={}));class U extends E.TypedEventEmitter{constructor(e,t,n,r={}){super(),this.roomId=e,this.client=t,this.myUserId=n,this.opts=r,(0,i.default)(this,"reEmitter",void 0),(0,i.default)(this,"txnToEvent",{}),(0,i.default)(this,"receipts",{}),(0,i.default)(this,"receiptCacheByEventId",{}),(0,i.default)(this,"notificationCounts",{}),(0,i.default)(this,"timelineSets",void 0),(0,i.default)(this,"threadsTimelineSets",[]),(0,i.default)(this,"filteredTimelineSets",{}),(0,i.default)(this,"timelineNeedsRefresh",!1),(0,i.default)(this,"pendingEventList",void 0),(0,i.default)(this,"blacklistUnverifiedDevices",null),(0,i.default)(this,"selfMembership",null),(0,i.default)(this,"summaryHeroes",null),(0,i.default)(this,"getTypeWarning",!1),(0,i.default)(this,"getVersionWarning",!1),(0,i.default)(this,"membersPromise",void 0),(0,i.default)(this,"name",void 0),(0,i.default)(this,"normalizedName",void 0),(0,i.default)(this,"tags",{}),(0,i.default)(this,"accountData",{}),(0,i.default)(this,"summary",null),(0,i.default)(this,"storageToken",void 0),(0,i.default)(this,"timeline",void 0),(0,i.default)(this,"oldState",void 0),(0,i.default)(this,"currentState",void 0),(0,i.default)(this,"relations",new b.RelationsContainer(this.client,this)),(0,i.default)(this,"threads",new Map),(0,i.default)(this,"lastThread",void 0),(0,i.default)(this,"visibilityEvents",new Map),(0,i.default)(this,"threadTimelineSetsPromise",null),(0,i.default)(this,"threadsReady",!1),(0,i.default)(this,"applyRedaction",(e=>{if(e.isRedaction()){const t=e.event.redacts,n=this.findEventById(t);if(n){if(n.makeRedacted(e),n.isState()){const e=this.currentState.getStateEvents(n.getType(),n.getStateKey());e.getId()===n.getId()&&this.currentState.setStateEvents([n])}this.emit(A.Redaction,e,this),this.visibilityEvents.delete(t),n.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e)}}})),this.setMaxListeners(100),this.reEmitter=new p.TypedReEmitter(this),r.pendingEventOrdering=r.pendingEventOrdering||y.PendingEventOrdering.Chronological,this.name=e,this.timelineSets=[new o.EventTimelineSet(this,r)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[A.Timeline,A.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===y.PendingEventOrdering.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then((e=>{e.forEach((async e=>{const t=new l.MatrixEvent(e);t.getType()===f.EventType.RoomMessageEncrypted&&await t.attemptDecryption(this.client.crypto),t.setStatus(d.EventStatus.NOT_SENT),this.addPendingEvent(t,t.getTxnId())}))}))),this.opts.lazyLoadMembers?this.membersPromise=null:this.membersPromise=Promise.resolve(!1)}async createThreadsTimelineSets(){var e;if(this.threadTimelineSetsPromise)return this.threadTimelineSetsPromise;if(null!==(e=this.client)&&void 0!==e&&e.supportsExperimentalThreads())try{this.threadTimelineSetsPromise=Promise.all([this.createThreadTimelineSet(),this.createThreadTimelineSet(v.ThreadFilterType.My)]);const e=await this.threadTimelineSetsPromise;this.threadsTimelineSets.push(...e)}catch(t){this.threadTimelineSetsPromise=null}}decryptCriticalEvents(){const e=this.getEventReadUpTo(this.client.getUserId(),!0),t=this.getLiveTimeline().getEvents(),n=t.findIndex((t=>t.event.event_id===e)),r=t.slice(n).filter((e=>e.shouldAttemptDecryption())).reverse().map((e=>e.attemptDecryption(this.client.crypto,{isRetry:!0})));return Promise.allSettled(r)}decryptAllEvents(){const e=this.getUnfilteredTimelineSet().getLiveTimeline().getEvents().filter((e=>e.shouldAttemptDecryption())).reverse().map((e=>e.attemptDecryption(this.client.crypto,{isRetry:!0})));return Promise.allSettled(e)}getCreator(){var e;const t=this.currentState.getStateEvents(f.EventType.RoomCreate,"");return null!==(e=null===t||void 0===t?void 0:t.getContent()["creator"])&&void 0!==e?e:null}getVersion(){const e=this.currentState.getStateEvents(f.EventType.RoomCreate,"");if(!e)return this.getVersionWarning||(g.logger.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1";const t=e.getContent()["room_version"];return void 0===t?"1":t}shouldUpgradeToVersion(){return k.includes(this.getVersion())?null:R}async getRecommendedVersion(){const e=await this.client.getCapabilities();let t=e["m.room_versions"];if(!t){t={default:R,available:{}};for(const e of k)t.available[e]=y.RoomVersionStability.Stable}let n=this.checkVersionAgainstCapability(t);if(n.urgent&&n.needsUpgrade){g.logger.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");const e=await this.client.getCapabilities(!0);if(t=e["m.room_versions"],!t)return g.logger.warn("No room version capability - assuming upgrade required."),n;n=this.checkVersionAgainstCapability(t)}return n}checkVersionAgainstCapability(e){const t=this.getVersion();g.logger.log(`[${this.roomId}] Current version: ${t}`),g.logger.log(`[${this.roomId}] Version capability: `,e);const n={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return n;const r=Object.keys(e.available).filter((t=>"stable"===e.available[t]));return r.includes(t)||(n.version=e.default,n.needsUpgrade=!0,n.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),n.urgent?g.logger.warn(`URGENT upgrade required on ${this.roomId}`):g.logger.warn(`Non-urgent upgrade required on ${this.roomId}`)),n}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(f.EventType.RoomTombstone,e)}getPendingEvents(){if(this.opts.pendingEventOrdering!==y.PendingEventOrdering.Detached)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(this.opts.pendingEventOrdering!==y.PendingEventOrdering.Detached)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);const t=c.removeElement(this.pendingEventList,(function(t){return t.getId()==e}),!1);return this.savePendingEvents(),t}hasPendingEvent(e){return this.opts.pendingEventOrdering===y.PendingEventOrdering.Detached&&this.pendingEventList.some((t=>t.getId()===e))}getPendingEvent(e){return this.opts.pendingEventOrdering!==y.PendingEventOrdering.Detached?null:this.pendingEventList.find((t=>t.getId()===e))}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}getLastActiveTimestamp(){const e=this.getLiveTimeline(),t=e.getEvents();if(t.length){const e=t[t.length-1];return e.getTs()}return Number.MIN_SAFE_INTEGER}getMyMembership(){return this.selfMembership}getDMInviter(){if(this.myUserId){const e=this.getMember(this.myUserId);if(e)return e.getDMInviter()}if("invite"===this.selfMembership){const e=this.getInvitedAndJoinedMemberCount();if(2==e&&this.summaryHeroes.length)return this.summaryHeroes[0]}}guessDMUserId(){const e=this.getMember(this.myUserId);if(e){const t=e.getDMInviter();if(t)return t}const t=Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length;if(t)return this.summaryHeroes[0];const n=this.currentState.getMembers(),r=n.find((e=>e.userId!==this.myUserId));return r?r.userId:this.myUserId}getAvatarFallbackMember(){const e=this.getInvitedAndJoinedMemberCount();if(e>2)return;const t=Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length;if(t){const e=this.summaryHeroes.map((e=>this.getMember(e))).find((e=>!!e));if(e)return e}const n=this.currentState.getMembers();if(n.length<=2){const e=n.find((e=>e.userId!==this.myUserId));if(e)return e}if(t){const e=this.summaryHeroes.map((e=>this.client.getUser(e))).find((e=>!!e));if(e){const t=new u.RoomMember(this.roomId,e.userId);return t.user=e,t}}}updateMyMembership(e){const t=this.selfMembership;this.selfMembership=e,t!==e&&("leave"===e&&this.cleanupAfterLeaving(),this.emit(A.MyMembership,this,e,t))}async loadMembersFromServer(){const e=this.client.store.getSyncToken(),t=await this.client.members(this.roomId,void 0,"leave",e);return t.chunk}async loadMembers(){let e=!1,t=await this.client.store.getOutOfBandMembers(this.roomId);(null===t||this.client.isCryptoEnabled()&&this.client.isRoomEncrypted(this.roomId))&&(e=!0,t=await this.loadMembersFromServer(),g.logger.log(`LL: got ${t.length} members from server for room ${this.roomId}`));const n=t.map(this.client.getEventMapper());return{memberEvents:n,fromServer:e}}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();const e=this.loadMembers().then((e=>(this.currentState.setOutOfBandMembers(e.memberEvents),this.client.isCryptoEnabled()&&this.client.isRoomEncrypted(this.roomId)&&this.client.crypto.trackRoomDevices(this.roomId),e.fromServer))).catch((e=>{throw this.membersPromise=null,this.currentState.markOutOfBandMembersFailed(),e}));return e.then((e=>{if(e){const e=this.currentState.getMembers().filter((e=>e.isOutOfBand())).map((e=>e.events.member.event));g.logger.log(`LL: telling store to write ${e.length} members for room ${this.roomId}`);const t=this.client.store;return t.setOutOfBandMembers(this.roomId,e).catch((e=>{g.logger.log("LL: storing OOB room members failed, oh well",e)}))}})).catch((e=>{g.logger.error(e)})),this.membersPromise=e,this.membersPromise}async clearLoadedMembersIfNeeded(){this.opts.lazyLoadMembers&&this.membersPromise&&(await this.loadMembersIfNeeded(),await this.client.store.clearOutOfBandMembers(this.roomId),this.currentState.clearOutOfBandMembers(),this.membersPromise=null)}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch((e=>{g.logger.error(`error after clearing loaded members from room ${this.roomId} after leaving`),g.logger.log(e)}))}async refreshLiveTimeline(){const e=this.getLiveTimeline(),t=e.getPaginationToken(s.EventTimeline.FORWARDS),n=e.getPaginationToken(s.EventTimeline.BACKWARDS),r=e.getEvents(),i=r[r.length-1];g.logger.log(`[refreshLiveTimeline for ${this.roomId}] at mostRecentEventInTimeline=${i&&i.getId()} liveTimelineBefore=${e.toString()} forwardPaginationToken=${t} backwardPaginationToken=${n}`);const o=this.getUnfilteredTimelineSet();let a;i?(this.resetLiveTimeline(null,null),this.emit(A.TimelineRefresh,this,o),a=await this.client.getEventTimeline(o,i.getId())):a=await this.client.getLatestTimeline(o);const c=o.getLiveTimeline();!c||null===c.getPaginationToken(s.Direction.Forward)&&null===c.getPaginationToken(s.Direction.Backward)&&0===c.getEvents().length?(g.logger.log(`[refreshLiveTimeline for ${this.roomId}] using our new live timeline`),a.setPaginationToken(t,s.EventTimeline.FORWARDS),o.setLiveTimeline(a),this.fixUpLegacyTimelineFields()):g.logger.log(`[refreshLiveTimeline for ${this.roomId}] \`/sync\` or some other request beat us to creating a new live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history.`),this.setTimelineNeedsRefresh(!1),this.emit(A.TimelineRefresh,this,o)}resetLiveTimeline(e,t){for(let n=0;n<this.timelineSets.length;n++)this.timelineSets[n].resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){const e=this.oldState,t=this.currentState;this.timeline=this.getLiveTimeline().getEvents(),this.oldState=this.getLiveTimeline().getState(s.EventTimeline.BACKWARDS),this.currentState=this.getLiveTimeline().getState(s.EventTimeline.FORWARDS),e!==this.oldState&&this.emit(A.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&this.emit(A.CurrentStateUpdated,this,t,this.currentState)}async hasUnverifiedDevices(){if(!this.client.isRoomEncrypted(this.roomId))return!1;const e=await this.getEncryptionTargetMembers();for(const t of e){const e=this.client.getStoredDevicesForUser(t.userId);if(e.some((e=>e.isUnverified())))return!0}return!1}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){const t=this.findEventById(e),n=this.findThreadForEvent(t);return n?n.timelineSet.getLiveTimeline():this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){let t=this.getUnfilteredTimelineSet().findEventById(e);if(!t){const n=this.getThreads();for(let r=0;r<n.length;r++){const i=n[r];if(t=i.findEventById(e),t)return t}}return t}getUnreadNotificationCount(e=D.Total){return this.notificationCounts[e]}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t}setSummary(e){const t=e["m.heroes"],n=e["m.joined_member_count"],r=e["m.invited_member_count"];Number.isInteger(n)&&this.currentState.setJoinedMemberCount(n),Number.isInteger(r)&&this.currentState.setInvitedMemberCount(r),Array.isArray(t)&&(this.summaryHeroes=t.filter((e=>e!==this.myUserId)))}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return this.blacklistUnverifiedDevices}getAvatarUrl(e,t,n,r,i=!0){const o=this.currentState.getStateEvents(f.EventType.RoomAvatar,"");if(!o&&!i)return null;const s=o?o.getContent().url:null;return s?(0,a.getHttpUriForMxc)(e,s,t,n,r):null}getMxcAvatarUrl(){var e,t;return(null===(e=this.currentState.getStateEvents(f.EventType.RoomAvatar,""))||void 0===e||null===(t=e.getContent())||void 0===t?void 0:t.url)||null}getAliases(){const e=[],t=this.currentState.getStateEvents(f.EventType.RoomAliases);if(t)for(const n of t)if(Array.isArray(n.getContent().aliases)){const t=n.getContent().aliases.filter((e=>"string"===typeof e&&("#"===e[0]&&!!e.endsWith(`:${n.getStateKey()}`))));e.push(...t)}return e}getCanonicalAlias(){const e=this.currentState.getStateEvents(f.EventType.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){const e=this.currentState.getStateEvents(f.EventType.RoomCanonicalAlias,"");return e&&e.getContent().alt_aliases||[]}addEventsToTimeline(e,t,n,r){n.getTimelineSet().addEventsToTimeline(e,t,n,r)}getThread(e){return this.threads.get(e)}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership("join")}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter((function(t){return t.membership===e}))}async getEncryptionTargetMembers(){await this.loadMembersIfNeeded();let e=this.getMembersWithMembership("join");return this.shouldEncryptForInvitedMembers()&&(e=e.concat(this.getMembersWithMembership("invite"))),e}shouldEncryptForInvitedMembers(){var e;const t=this.currentState.getStateEvents(f.EventType.RoomHistoryVisibility,"");return"joined"!==(null===t||void 0===t||null===(e=t.getContent())||void 0===e?void 0:e.history_visibility)}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){const n=this.getMember(e);return!!n&&n.membership===t}getOrCreateFilteredTimelineSet(e,{prepopulateTimeline:t=!0,useSyncEvents:n=!0,pendingEvents:r=!0}={}){if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];const i=Object.assign({filter:e,pendingEvents:r},this.opts),a=new o.EventTimelineSet(this,i);this.reEmitter.reEmit(a,[A.Timeline,A.TimelineReset]),n&&(this.filteredTimelineSets[e.filterId]=a,this.timelineSets.push(a));const c=this.getLiveTimeline();if(t){c.getEvents().forEach((function(e){a.addLiveEvent(e)}));let e=c;while(e.getNeighbouringTimeline(s.EventTimeline.BACKWARDS))e=e.getNeighbouringTimeline(s.EventTimeline.BACKWARDS);a.getLiveTimeline().setPaginationToken(e.getPaginationToken(s.EventTimeline.BACKWARDS),s.EventTimeline.BACKWARDS)}else if(n){const e=c.getPaginationToken(s.Direction.Forward);a.getLiveTimeline().setPaginationToken(e,s.Direction.Backward)}return a}async getThreadListFilter(e=v.ThreadFilterType.All){const t=this.client.getUserId(),n=new m.Filter(t),r={room:{timeline:{[v.FILTER_RELATED_BY_REL_TYPES.name]:[v.THREAD_RELATION_TYPE.name]}}};e===v.ThreadFilterType.My&&(r.room.timeline[v.FILTER_RELATED_BY_SENDERS.name]=[t]),n.setDefinition(r);const i=await this.client.getOrCreateFilter(`THREAD_PANEL_${this.roomId}_${e}`,n);return n.filterId=i,n}async createThreadTimelineSet(e){let t;if(v.Thread.hasServerSideSupport){const n=await this.getThreadListFilter(e);t=this.getOrCreateFilteredTimelineSet(n,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else t=new o.EventTimelineSet(this,{pendingEvents:!1}),Array.from(this.threads).forEach((([,n])=>{if(0===n.length)return;const r=n.events.some((e=>e.getSender()===this.client.getUserId()));(e!==v.ThreadFilterType.My||r)&&t.getLiveTimeline().addEvent(n.rootEvent,{toStartOfTimeline:!1})}));return t}async fetchRoomThreads(){if(this.threadsReady||!this.client.supportsExperimentalThreads())return;const e=await this.getThreadListFilter(),{chunk:t}=await this.client.createMessagesRequest(this.roomId,"",Number.MAX_SAFE_INTEGER,s.Direction.Backward,e);if(!t.length)return;const n=t.map(this.client.getEventMapper()).sort(((e,t)=>{const n=e.getServerAggregatedRelation(f.RelationType.Thread),r=t.getServerAggregatedRelation(f.RelationType.Thread);return n.latest_event.origin_server_ts-r.latest_event.origin_server_ts}));let r;const i=this.getLiveTimeline().getState(s.EventTimeline.FORWARDS);for(const s of n){this.threadsTimelineSets[0].addLiveEvent(s,{duplicateStrategy:o.DuplicateStrategy.Ignore,fromCache:!1,roomState:i});const e=s.getServerAggregatedRelation(f.RelationType.Thread);e.current_user_participated&&(this.threadsTimelineSets[1].addLiveEvent(s,{duplicateStrategy:o.DuplicateStrategy.Ignore,fromCache:!1,roomState:i}),r=s),this.getThread(s.getId())||this.createThread(s.getId(),s,[],!0)}this.client.decryptEventIfNeeded(n[n.length-1]),r&&this.client.decryptEventIfNeeded(r),this.threadsReady=!0,this.on(v.ThreadEvent.NewReply,this.onThreadNewReply)}onThreadNewReply(e){for(const t of this.threadsTimelineSets)t.removeEvent(e.id),t.addLiveEvent(e.rootEvent)}removeFilteredTimelineSet(e){const t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];const n=this.timelineSets.indexOf(t);n>-1&&this.timelineSets.splice(n,1)}eventShouldLiveIn(e,t,n){var r;if(!this.client.supportsExperimentalThreads())return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||null!==n&&void 0!==n&&n.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};if(e.isRelation(v.THREAD_RELATION_TYPE.name))return{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:e.threadRootId};const i=e.getAssociatedId(),o=null!==(r=this.findEventById(i))&&void 0!==r?r:null===t||void 0===t?void 0:t.find((e=>e.getId()===i));return o&&(e.isRelation()||e.isRedaction())?this.eventShouldLiveIn(o,t,n):null!==n&&void 0!==n&&n.has(e.relationEventId)?{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.relationEventId}:{shouldLiveInRoom:!0,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;const{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t,n=!1){let r=this.getThread(e);if(r)r.addEvents(t,n);else{var i;const o=null!==(i=this.findEventById(e))&&void 0!==i?i:t.find((t=>t.getId()===e));r=this.createThread(e,o,t,n),this.emit(v.ThreadEvent.Update,r)}}processThreadedEvents(e,t){e.forEach(this.applyRedaction);const n={};for(const i of e){var r;const{threadId:e,shouldLiveInThread:t}=this.eventShouldLiveIn(i);t&&!n[e]&&(n[e]=[]),null===(r=n[e])||void 0===r||r.push(i)}Object.entries(n).map((([e,n])=>this.addThreadedEvents(e,n,t)))}createThread(e,t,n=[],r){var i;if(t){const e=this.relations.getAllChildEventsForEvent(t.getId());null!==e&&void 0!==e&&e.length&&(n=n.concat(e.filter((e=>!e.isRelation(f.RelationType.Replace)))))}const o=new v.Thread(e,t,{initialEvents:n,room:this,client:this.client});return this.threads.set(o.id,o),this.reEmitter.reEmit(o,[v.ThreadEvent.Update,v.ThreadEvent.NewReply,A.Timeline,A.TimelineReset]),(!this.lastThread||(null===(i=this.lastThread.rootEvent)||void 0===i?void 0:i.localTimestamp)<(null===t||void 0===t?void 0:t.localTimestamp))&&(this.lastThread=o),this.emit(v.ThreadEvent.New,o,r),this.threadsReady&&this.threadsTimelineSets.forEach((e=>{o.rootEvent&&(v.Thread.hasServerSideSupport?e.addLiveEvent(o.rootEvent):e.addEventToTimeline(o.rootEvent,e.getLiveTimeline(),r))})),o}processLiveEvent(e){if(this.applyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e),e.getUnsigned().transaction_id){const t=this.txnToEvent[e.getUnsigned().transaction_id];t&&this.handleRemoteEcho(e,t)}}addLiveEvent(e,t){const{duplicateStrategy:n,timelineWasEmpty:r,fromCache:i}=t;for(let o=0;o<this.timelineSets.length;o++)this.timelineSets[o].addLiveEvent(e,{duplicateStrategy:n,fromCache:i,timelineWasEmpty:r});e.sender&&e.getType()!==f.EventType.RoomRedaction&&this.addReceipt(O(e.sender.userId,e,S.ReceiptType.Read),!0)}addPendingEvent(e,t){if(e.status!==d.EventStatus.SENDING&&e.status!==d.EventStatus.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent[t])throw new Error("addPendingEvent called on an event with known txnId "+t);if(s.EventTimeline.setEventMetadata(e,this.getLiveTimeline().getState(s.EventTimeline.FORWARDS),!1),this.txnToEvent[t]=e,this.opts.pendingEventOrdering===y.PendingEventOrdering.Detached){if(this.pendingEventList.some((e=>e.status===d.EventStatus.NOT_SENT))&&(g.logger.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(d.EventStatus.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){var n;const t=e.event.redacts;let r=null===(n=this.pendingEventList)||void 0===n?void 0:n.find((e=>e.getId()===t));r||(r=this.findEventById(t)),r&&(r.markLocallyRedacted(e),this.emit(A.Redaction,e,this))}}else for(let r=0;r<this.timelineSets.length;r++){const t=this.timelineSets[r];t.getFilter()?t.getFilter().filterRoomTimeline([e]).length&&t.addEventToTimeline(e,t.getLiveTimeline(),{toStartOfTimeline:!1}):t.addEventToTimeline(e,t.getLiveTimeline(),{toStartOfTimeline:!1})}this.emit(A.LocalEchoUpdated,e,this,null,null)}savePendingEvents(){if(this.pendingEventList){const e=this.pendingEventList.map((e=>I(I({},e.event),{},{txn_id:e.getTxnId()}))).filter((e=>{const t=e.type===f.EventType.RoomMessageEncrypted,n=this.client.isRoomEncrypted(this.roomId);return t||!n}));this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent[e]}handleRemoteEcho(e,t){const n=t.getId(),r=e.getId(),i=t.status;g.logger.debug(`Got remote echo for event ${n} -> ${r} old status ${i}`),delete this.txnToEvent[e.getUnsigned().transaction_id],this.pendingEventList&&this.removePendingEvent(n),t.handleRemoteEcho(e.event);const{shouldLiveInRoom:o,threadId:s}=this.eventShouldLiveIn(e),a=this.getThread(s);if(null===a||void 0===a||a.timelineSet.handleRemoteEcho(t,n,r),o)for(let c=0;c<this.timelineSets.length;c++){const e=this.timelineSets[c];e.handleRemoteEcho(t,n,r)}this.emit(A.LocalEchoUpdated,t,this,n,i)}updatePendingEvent(e,t,n){if(g.logger.log(`setting pendingEvent status to ${t} in ${e.getRoomId()} event ID ${e.getId()} -> ${n}`),t==d.EventStatus.SENT&&!n)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==d.EventStatus.SENT){const e=this.getTimelineForEvent(n);if(e)return}const r=e.status,i=e.getId();if(!r)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");const o=L[r];if(!o||o.indexOf(t)<0)throw new Error("Invalid EventStatus transition "+r+"->"+t);if(e.setStatus(t),t==d.EventStatus.SENT){e.replaceLocalEventId(n);const{shouldLiveInRoom:t,threadId:r}=this.eventShouldLiveIn(e),o=this.getThread(r);if(null===o||void 0===o||o.timelineSet.replaceEventId(i,n),t)for(let e=0;e<this.timelineSets.length;e++)this.timelineSets[e].replaceEventId(i,n)}else if(t==d.EventStatus.CANCELLED){if(this.pendingEventList){const e=this.getPendingEvent(i);this.removePendingEvent(i),e.isRedaction()&&this.revertRedactionLocalEcho(e)}this.removeEvent(i)}this.savePendingEvents(),this.emit(A.LocalEchoUpdated,e,this,i,r)}revertRedactionLocalEcho(e){const t=e.event.redacts;if(!t)return;const n=this.getUnfilteredTimelineSet().findEventById(t);n&&(n.unmarkLocallyRedacted(),this.emit(A.RedactionCancelled,e,this),n.isRelation()&&this.aggregateNonLiveRelation(n))}addLiveEvents(e,t,n=!1){let r,i=t;if("object"===typeof t?({duplicateStrategy:i,fromCache:n=!1,timelineWasEmpty:r}=t):void 0!==t&&g.logger.warn("Overload deprecated: `Room.addLiveEvents(events, duplicateStrategy?, fromCache?)` is deprecated in favor of the overload with `Room.addLiveEvents(events, IAddLiveEventOptions)`"),i&&-1===["replace","ignore"].indexOf(i))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(let l=0;l<this.timelineSets.length;l++){const e=this.timelineSets[l].getLiveTimeline();if(e.getPaginationToken(s.EventTimeline.FORWARDS))throw new Error("live timeline "+l+" is no longer live - it has a pagination token ("+e.getPaginationToken(s.EventTimeline.FORWARDS)+")");if(e.getNeighbouringTimeline(s.EventTimeline.FORWARDS))throw new Error(`live timeline ${l} is no longer live - it has a neighbouring timeline`)}const o=this.findThreadRoots(e),a={};for(const s of e){var c;this.processLiveEvent(s);const{shouldLiveInRoom:t,shouldLiveInThread:l,threadId:d}=this.eventShouldLiveIn(s,e,o);l&&!a[d]&&(a[d]=[]),null===(c=a[d])||void 0===c||c.push(s),t&&this.addLiveEvent(s,{duplicateStrategy:i,fromCache:n,timelineWasEmpty:r})}Object.entries(a).forEach((([e,t])=>{this.addThreadedEvents(e,t,!1)}))}partitionThreadedEvents(e){const t=0,n=1;if(this.client.supportsExperimentalThreads()){const r=this.findThreadRoots(e);return e.reduce(((i,o)=>{const{shouldLiveInRoom:s,shouldLiveInThread:a,threadId:c}=this.eventShouldLiveIn(o,e,r);return s&&i[t].push(o),a&&(o.setThreadId(c),i[n].push(o)),i}),[[],[]])}return[e,[]]}findThreadRoots(e){const t=new Set;for(const n of e)n.isRelation(v.THREAD_RELATION_TYPE.name)&&t.add(n.relationEventId);return t}addEphemeralEvents(e){for(const t of e)"m.typing"===t.getType()?this.currentState.setTypingEvent(t):"m.receipt"===t.getType()&&this.addReceipt(t)}removeEvents(e){for(let t=0;t<e.length;++t)this.removeEvent(e[t])}removeEvent(e){let t=!1;for(let n=0;n<this.timelineSets.length;n++){const r=this.timelineSets[n].removeEvent(e);r&&(r.isRedaction()&&this.revertRedactionLocalEcho(r),t=!0)}return t}recalculate(){const e=this.currentState.getStateEvents(f.EventType.RoomMember,this.myUserId);if(e){const t=e.getContent().membership;if(this.updateMyMembership(t),"invite"===t){const t=e.getUnsigned().invite_room_state||[];t.forEach((e=>{const t=this.currentState.getStateEvents(e.type,e.state_key);t||this.currentState.setStateEvents([new l.MatrixEvent({type:e.type,state_key:e.state_key,content:e.content,event_id:"$fake"+Date.now(),room_id:this.roomId,user_id:this.myUserId})])}))}}const t=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=(0,c.normalize)(this.name),this.summary=new h.RoomSummary(this.roomId,{title:this.name}),t!==this.name&&this.emit(A.Name,this)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter((function(e){return[S.ReceiptType.Read,S.ReceiptType.ReadPrivate].includes(e.type)})).map((function(e){return e.userId}))}getReadReceiptForUserId(e,t=!1,n=S.ReceiptType.Read){var r,i;const[o,s]=null!==(r=null===(i=this.receipts[n])||void 0===i?void 0:i[e])&&void 0!==r?r:[];return t?o:null!==s&&void 0!==s?s:o}getEventReadUpTo(e,t=!1){var n,r,i,o;const s=this.getUnfilteredTimelineSet(),a=this.getReadReceiptForUserId(e,t,S.ReceiptType.Read),c=this.getReadReceiptForUserId(e,t,S.ReceiptType.ReadPrivate);let l;return null!==a&&void 0!==a&&a.eventId&&null!==c&&void 0!==c&&c.eventId&&(l=s.compareEventOrdering(null===a||void 0===a?void 0:a.eventId,null===c||void 0===c?void 0:c.eventId)),l||(l=(null===a||void 0===a||null===(n=a.data)||void 0===n?void 0:n.ts)-(null===c||void 0===c||null===(r=c.data)||void 0===r?void 0:r.ts)),l?l<0?null===c||void 0===c?void 0:c.eventId:null===a||void 0===a?void 0:a.eventId:null!==(i=null!==(o=null===c||void 0===c?void 0:c.eventId)&&void 0!==o?o:null===a||void 0===a?void 0:a.eventId)&&void 0!==i?i:null}hasUserReadEvent(e,t){const n=this.getEventReadUpTo(e,!1);if(n===t)return!0;if(this.timeline.length&&this.timeline[this.timeline.length-1].getSender()&&this.timeline[this.timeline.length-1].getSender()===e)return!0;for(let r=this.timeline.length-1;r>=0;--r){const e=this.timeline[r];if(e.getId()===t)return!1;if(e.getId()===n)return!0}return!1}getReceiptsForEvent(e){return this.receiptCacheByEventId[e.getId()]||[]}addReceipt(e,t=!1){this.addReceiptsToStructure(e,t),this.emit(A.Receipt,e,this)}addReceiptsToStructure(e,t){const n=e.getContent();Object.keys(n).forEach((e=>{Object.keys(n[e]).forEach((r=>{Object.keys(n[e][r]).forEach((i=>{var o,s;const a=n[e][r][i];this.receipts[r]||(this.receipts[r]={}),this.receipts[r][i]||(this.receipts[r][i]=[null,null]);const c=this.receipts[r][i];let l=c[C];var d;t&&(l=null!==(d=c[P])&&void 0!==d?d:c[C]);if(l){const t=this.getUnfilteredTimelineSet().compareEventOrdering(l.eventId,e);if(null!==t&&t>=0)return}const u={eventId:e,data:a},h=t?c[C]:u,g=t?u:c[P];let p=null;h&&g&&(p=this.getUnfilteredTimelineSet().compareEventOrdering(h.eventId,g.eventId));const f=null===p||p<0,y=null!==(o=c[P])&&void 0!==o?o:c[C];t&&f?c[P]=u:t||(c[C]=u,f||(c[P]=null));const m=null!==(s=c[P])&&void 0!==s?s:c[C];if(y!==m){if(y&&this.receiptCacheByEventId[y.eventId]){const e=y.eventId;this.receiptCacheByEventId[e]=this.receiptCacheByEventId[e].filter((e=>e.type!==r||e.userId!==i)),this.receiptCacheByEventId[e].length<1&&delete this.receiptCacheByEventId[e]}this.receiptCacheByEventId[e]||(this.receiptCacheByEventId[e]=[]),this.receiptCacheByEventId[e].push({userId:i,type:r,data:a})}}))}))}))}addLocalEchoReceipt(e,t,n){this.addReceipt(O(e,t,n),!0)}addTags(e){this.tags=e.getContent().tags||{},this.emit(A.Tags,e,this)}addAccountData(e){for(let t=0;t<e.length;t++){const n=e[t];"m.tag"===n.getType()&&this.addTags(n);const r=this.accountData[n.getType()];this.accountData[n.getType()]=n,this.emit(A.AccountData,n,this,r)}}getAccountData(e){return this.accountData[e]}maySendMessage(){return"join"===this.getMyMembership()&&(this.client.isRoomEncrypted(this.roomId)?this.currentState.maySendEvent(f.EventType.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(f.EventType.RoomMessage,this.myUserId))}canInvite(e){let t="join"===this.getMyMembership();const n=this.currentState.getStateEvents(f.EventType.RoomPowerLevels,""),r=n&&n.getContent(),i=this.getMember(e);return r&&i&&r.invite>i.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){const e=this.currentState.getStateEvents(f.EventType.RoomCreate,"");if(e)return e.getContent()[f.RoomCreateTypeField];this.getTypeWarning||(g.logger.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0)}isSpaceRoom(){return this.getType()===f.RoomType.Space}isCallRoom(){return this.getType()===f.RoomType.UnstableCall}isElementVideoRoom(){return this.getType()===f.RoomType.ElementVideo}calculateRoomName(e,t=!1){if(!t){const e=this.currentState.getStateEvents(f.EventType.RoomName,"");if(e&&e.getContent()&&e.getContent().name)return e.getContent().name}const n=this.getCanonicalAlias();if(n)return n;const r=this.currentState.getJoinedMemberCount(),i=this.currentState.getInvitedMemberCount();let o=r+i-1,s=[];const a=this.currentState.getStateEvents(f.UNSTABLE_ELEMENT_FUNCTIONAL_USERS.name,"");Array.isArray(null===a||void 0===a?void 0:a.getContent().service_members)&&(s=a.getContent().service_members);let l=null;if(this.summaryHeroes)l=[],this.summaryHeroes.forEach((e=>{if(s.includes(e))return void o--;const t=this.getMember(e);l.push(t?t.name:e)}));else{let t=this.currentState.getMembers().filter((t=>t.userId!==e&&("invite"===t.membership||"join"===t.membership)));t=t.filter((({userId:e})=>!s.includes(e)||(o--,!1))),t.sort(((e,t)=>c.compare(e.userId,t.userId))),t=t.slice(0,5),l=t.map((e=>e.name))}if(o)return N(l,o);const d=this.getMyMembership();if("join"==d){const e=this.currentState.getStateEvents(f.EventType.RoomThirdPartyInvite);if(e&&e.length){const t=e.map((e=>e.getContent().display_name));return`Inviting ${N(t)}`}}let u=l;return u.length||(u=this.currentState.getMembers().filter((t=>t.userId!==e&&"invite"!==t.membership&&"join"!==t.membership)).map((e=>e.name))),u.length?`Empty room (was ${N(u)})`:"Empty room"}applyNewVisibilityEvent(e){const t=e.asVisibilityChange();if(!t)return;const n=e.getSender();if(!n)return;const r=f.EVENT_VISIBILITY_CHANGE_TYPE.name&&this.currentState.maySendStateEvent(f.EVENT_VISIBILITY_CHANGE_TYPE.name,n)||f.EVENT_VISIBILITY_CHANGE_TYPE.altName&&this.currentState.maySendStateEvent(f.EVENT_VISIBILITY_CHANGE_TYPE.altName,n);if(!r)return;const i=this.visibilityEvents.get(t.eventId);if(i){let t=i.length-1;const n=Math.max(0,i.length-M);for(;t>=n;--t){const n=i[t];if(n.getTs()<e.getTs())break}-1===t?i.unshift(e):i.splice(t+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);const o=this.findEventById(t.eventId);o&&o.applyVisibilityEvent(t)}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");const t=e.getRelation(),n=t.event_id,r=this.visibilityEvents.get(n);if(!r)return;const i=r.findIndex((t=>t.getId()===e.getId()));if(-1!==i&&(r.splice(i,1),i===r.length)){const e=this.findEventById(n);if(!e)return;if(0===i)this.visibilityEvents.delete(n),e.applyVisibilityEvent();else{const t=r[r.length-1],n=t.asVisibilityChange();if(!n)throw new Error("at this stage, visibility changes should be well-formed");e.applyVisibilityEvent(n)}}}applyPendingVisibilityEvents(e){const t=this.visibilityEvents.get(e.getId());if(!t||0==t.length)return;const n=t[t.length-1],r=n.asVisibilityChange();r&&(r.visible,n.getTs()<e.getTs()||e.applyVisibilityEvent(r))}}t.Room=U;const L={[d.EventStatus.ENCRYPTING]:[d.EventStatus.SENDING,d.EventStatus.NOT_SENT,d.EventStatus.CANCELLED],[d.EventStatus.SENDING]:[d.EventStatus.ENCRYPTING,d.EventStatus.QUEUED,d.EventStatus.NOT_SENT,d.EventStatus.SENT],[d.EventStatus.QUEUED]:[d.EventStatus.SENDING,d.EventStatus.CANCELLED],[d.EventStatus.SENT]:[],[d.EventStatus.NOT_SENT]:[d.EventStatus.SENDING,d.EventStatus.QUEUED,d.EventStatus.CANCELLED],[d.EventStatus.CANCELLED]:[]};function N(e,t=e.length+1){const n=t-1;if(e.length){if(1===e.length&&n<=1)return e[0];if(2===e.length&&n<=2)return`${e[0]} and ${e[1]}`;{const t=n>1;return t?`${e[0]} and ${n} others`:`${e[0]} and 1 other`}}return"Empty room"}},895:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SearchResult=void 0;var r=n(6323);class i{static fromJson(e,t){const n=e.context||{};let o=(n.events_before||[]).map(t),s=(n.events_after||[]).map(t);const a=new r.EventContext(t(e.result)),c=a.ourEvent.threadRootId;return o=o.filter((e=>e.threadRootId===c)),s=s.filter((e=>e.threadRootId===c)),a.setPaginateToken(n.start,!0),a.addEvents(o,!0),a.addEvents(s,!1),a.setPaginateToken(n.end,!1),new i(e.rank,a)}constructor(e,t){this.rank=e,this.context=t}}t.SearchResult=i},1356:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.ThreadFilterType=t.ThreadEvent=t.Thread=t.THREAD_RELATION_TYPE=t.FILTER_RELATED_BY_SENDERS=t.FILTER_RELATED_BY_REL_TYPES=void 0;var i=r(n(4344)),o=n(5346),s=n(4111),a=n(2842),c=n(8919),l=n(3839),d=n(9392),u=n(3698),h=n(6471);function g(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function p(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?g(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):g(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let f;t.ThreadEvent=f,function(e){e["New"]="Thread.new",e["Update"]="Thread.update",e["NewReply"]="Thread.newReply",e["ViewThread"]="Thread.viewThread"}(f||(t.ThreadEvent=f={}));class y extends d.TypedEventEmitter{constructor(e,t,n){var r;if(super(),this.id=e,this.rootEvent=t,(0,i.default)(this,"timelineSet",void 0),(0,i.default)(this,"_currentUserParticipated",!1),(0,i.default)(this,"reEmitter",void 0),(0,i.default)(this,"lastEvent",void 0),(0,i.default)(this,"replyCount",0),(0,i.default)(this,"room",void 0),(0,i.default)(this,"client",void 0),(0,i.default)(this,"initialEventsFetched",!y.hasServerSideSupport),(0,i.default)(this,"onBeforeRedaction",((e,t)=>{null!==e&&void 0!==e&&e.isRelation(E.name)&&this.room.eventShouldLiveIn(e).threadId===this.id&&e.getId()!==this.id&&!t.status&&(this.replyCount--,this.emit(f.Update,this))})),(0,i.default)(this,"onRedaction",(e=>{var t;if(e.threadRootId!==this.id)return;const n=[...this.timelineSet.getLiveTimeline().getEvents()].reverse();this.lastEvent=null!==(t=n.find((e=>!e.isRedacted()&&e.isRelation(E.name))))&&void 0!==t?t:this.rootEvent,this.emit(f.Update,this)})),(0,i.default)(this,"onEcho",(e=>{if(e.threadRootId!==this.id)return;if(this.lastEvent===e)return;if(!e.isRelation(E.name))return;const t=e.isRelation(E.name);(!this.lastEvent||this.lastEvent.isRedacted()||t&&e.getId()!==this.lastEvent.getId()&&e.localTimestamp>this.lastEvent.localTimestamp)&&(this.lastEvent=e,this.lastEvent.getId()!==this.id&&(y.hasServerSideSupport&&this.replyCount++,this.emit(f.NewReply,this,e))),this.emit(f.Update,this)})),null===n||void 0===n||!n.room)throw new Error("element-web#22141: A thread requires a room in order to function");this.room=n.room,this.client=n.client,this.timelineSet=new l.EventTimelineSet(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new s.TypedReEmitter(this),this.reEmitter.reEmit(this.timelineSet,[o.RoomEvent.Timeline,o.RoomEvent.TimelineReset]),this.room.on(o.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.room.on(o.RoomEvent.Redaction,this.onRedaction),this.room.on(o.RoomEvent.LocalEchoUpdated,this.onEcho),this.timelineSet.on(o.RoomEvent.Timeline,this.onEcho),n.initialEvents&&this.addEvents(n.initialEvents,!1),this.initialiseThread(),null===(r=this.rootEvent)||void 0===r||r.setThread(this)}async fetchRootEvent(){var e;this.rootEvent=this.room.findEventById(this.id);try{const e=await this.client.fetchRoomEvent(this.roomId,this.id),t=this.client.getEventMapper();this.rootEvent=t(e)}catch(t){h.logger.error("Failed to fetch thread root to construct thread with",t)}null===(e=this.rootEvent)||void 0===e||e.setThread(this),this.emit(f.Update,this)}static setServerSideSupport(e,t){y.hasServerSideSupport=e,t||(m.setPreferUnstable(!0),v.setPreferUnstable(!0),E.setPreferUnstable(!0))}get roomState(){return this.room.getLiveTimeline().getState(c.EventTimeline.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState})}addEvents(e,t){e.forEach((e=>this.addEvent(e,t,!1))),this.emit(f.Update,this)}addEvent(e,t,n=!0){var r;if(e.setThread(this),this._currentUserParticipated||e.getSender()!==this.client.getUserId()||(this._currentUserParticipated=!0),y.hasServerSideSupport){if(!t&&this.initialEventsFetched&&e.localTimestamp>(null===(r=this.lastReply())||void 0===r?void 0:r.localTimestamp))this.fetchEditsWhereNeeded(e),this.addEventToTimeline(e,!1);else if(e.isRelation(o.RelationType.Annotation)||e.isRelation(o.RelationType.Replace))return this.timelineSet.relations.aggregateParentEvent(e),void this.timelineSet.relations.aggregateChildEvent(e,this.timelineSet)}else this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e,{});y.hasServerSideSupport&&this.rootEvent||!e.isRelation(E.name)||this.replyCount++,n&&this.emit(f.Update,this)}getRootEventBundledRelationship(e=this.rootEvent){return null===e||void 0===e?void 0:e.getServerAggregatedRelation(E.name)}async initialiseThread(){let e=this.getRootEventBundledRelationship();if(y.hasServerSideSupport&&!e&&(await this.fetchRootEvent(),e=this.getRootEventBundledRelationship()),y.hasServerSideSupport&&e){this.replyCount=e.count,this._currentUserParticipated=e.current_user_participated;const t=new a.MatrixEvent(p({room_id:this.rootEvent.getRoomId()},e.latest_event));this.setEventMetadata(t),t.setThread(this),this.lastEvent=t,this.fetchEditsWhereNeeded(t)}this.emit(f.Update,this)}async fetchEditsWhereNeeded(...e){return Promise.all(e.filter((e=>e.isEncrypted())).map((e=>{if(!e.isRelation())return this.client.relations(this.roomId,e.getId(),o.RelationType.Replace,e.getType(),{limit:1}).then((t=>{t.events.length&&e.makeReplaced(t.events[0])})).catch((e=>{h.logger.error("Failed to load edits for encrypted thread event",e)}))})))}async fetchInitialEvents(){this.initialEventsFetched||(await this.fetchEvents(),this.initialEventsFetched=!0)}setEventMetadata(e){c.EventTimeline.setEventMetadata(e,this.roomState,!1),e.setThread(this)}findEventById(e){var t;return(null===(t=this.lastEvent)||void 0===t?void 0:t.getId())===e?this.lastEvent:this.timelineSet.findEventById(e)}lastReply(e=(()=>!0)){for(let t=this.events.length-1;t>=0;t--){const n=this.events[t];if(e(n))return n}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount}get replyToEvent(){var e;return null!==(e=this.lastEvent)&&void 0!==e?e:this.lastReply()}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof a.MatrixEvent}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}async fetchEvents(e={limit:20,direction:c.Direction.Backward}){var t;let{originalEvent:n,events:r,prevBatch:i,nextBatch:o}=await this.client.relations(this.room.roomId,this.id,E.name,null,e);e.to||o||(r=[...r,n]),await this.fetchEditsWhereNeeded(...r),await Promise.all(r.map((e=>(this.setEventMetadata(e),this.client.decryptEventIfNeeded(e)))));const s=(null!==(t=e.direction)&&void 0!==t?t:c.Direction.Backward)===c.Direction.Backward;return this.timelineSet.addEventsToTimeline(r,s,this.liveTimeline,s?o:i),{originalEvent:n,events:r,prevBatch:i,nextBatch:o}}}t.Thread=y,(0,i.default)(y,"hasServerSideSupport",void 0);const m=new u.ServerControlledNamespacedValue("related_by_senders","io.element.relation_senders");t.FILTER_RELATED_BY_SENDERS=m;const v=new u.ServerControlledNamespacedValue("related_by_rel_types","io.element.relation_types");t.FILTER_RELATED_BY_REL_TYPES=v;const E=new u.ServerControlledNamespacedValue("m.thread","io.element.thread");let S;t.THREAD_RELATION_TYPE=E,t.ThreadFilterType=S,function(e){e[e["My"]=0]="My",e[e["All"]=1]="All"}(S||(t.ThreadFilterType=S={}))},9392:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TypedEventEmitter=t.EventEmitterEvents=void 0;var r=n(3793);let i;t.EventEmitterEvents=i,function(e){e["NewListener"]="newListener",e["RemoveListener"]="removeListener",e["Error"]="error"}(i||(t.EventEmitterEvents=i={}));class o extends r.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e,...t){return super.emit(e,...t)}eventNames(){return super.eventNames()}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}t.TypedEventEmitter=o},6876:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.UserEvent=t.User=void 0;var i=r(n(4344)),o=n(9392);let s;t.UserEvent=s,function(e){e["DisplayName"]="User.displayName",e["AvatarUrl"]="User.avatarUrl",e["Presence"]="User.presence",e["CurrentlyActive"]="User.currentlyActive",e["LastPresenceTs"]="User.lastPresenceTs"}(s||(t.UserEvent=s={}));class a extends o.TypedEventEmitter{constructor(e){super(),this.userId=e,(0,i.default)(this,"modified",void 0),(0,i.default)(this,"displayName",void 0),(0,i.default)(this,"rawDisplayName",void 0),(0,i.default)(this,"avatarUrl",void 0),(0,i.default)(this,"presenceStatusMsg",null),(0,i.default)(this,"presence","offline"),(0,i.default)(this,"lastActiveAgo",0),(0,i.default)(this,"lastPresenceTs",0),(0,i.default)(this,"currentlyActive",!1),(0,i.default)(this,"events",{presence:null,profile:null}),this.displayName=e,this.rawDisplayName=e,this.avatarUrl=null,this.updateModifiedTime()}setPresenceEvent(e){if("m.presence"!==e.getType())return;const t=null===this.events.presence;this.events.presence=e;const n=[];(e.getContent().presence!==this.presence||t)&&n.push(s.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&n.push(s.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&n.push(s.DisplayName),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&n.push(s.CurrentlyActive),this.presence=e.getContent().presence,n.push(s.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(let r=0;r<n.length;r++)this.emit(n[r],e,this)}setDisplayName(e){const t=this.displayName;this.displayName="string"===typeof e?e:void 0,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName="string"===typeof e?e:void 0}setAvatarUrl(e){const t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}t.User=a},541:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.PushProcessor=void 0;var i=r(n(4344)),o=n(3926),s=n(6471),a=n(9666),c=n(7778);function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const u=[a.PushRuleKind.Override,a.PushRuleKind.ContentSpecific,a.PushRuleKind.RoomSpecific,a.PushRuleKind.SenderSpecific,a.PushRuleKind.Underride],h=[{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:a.ConditionKind.EventMatch,key:"type",pattern:"m.reaction"}],actions:[a.PushRuleActionName.DontNotify]},{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:a.ConditionKind.EventMatch,key:"type",pattern:c.EventType.RoomServerAcl},{kind:a.ConditionKind.EventMatch,key:"state_key",pattern:""}],actions:[]}];class g{constructor(e){this.client=e}static actionListToActionsObject(e){const t={notify:!1,tweaks:{}};for(let n=0;n<e.length;++n){const r=e[n];r===a.PushRuleActionName.Notify?t.notify=!0:"object"===typeof r&&(void 0===r.value&&(r.value=!0),t.tweaks[r.set_tweak]=r.value)}return t}static rewriteDefaultRules(e){let t=JSON.parse(JSON.stringify(e));t||(t={}),t.global||(t.global={}),t.global.override||(t.global.override=[]);const n=t.global.override;for(const r of h){const e=n.find((e=>e.rule_id===r.rule_id));if(e)e.default=r.default,e.conditions=r.conditions,e.actions=r.actions;else{const e=r.rule_id;s.logger.warn(`Adding default global override for ${e}`),n.push(r)}}return t}matchingRuleFromKindSet(e,t){for(let n=0;n<u.length;++n){const r=u[n],i=t[r];if(i)for(let t=0;t<i.length;++t){const n=i[t];if(!n.enabled)continue;const o=this.templateRuleToRaw(r,n);if(o&&this.ruleMatchesEvent(o,e))return d(d({},n),{},{kind:r})}}return null}templateRuleToRaw(e,t){const n={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case a.PushRuleKind.Underride:case a.PushRuleKind.Override:n.conditions=t.conditions;break;case a.PushRuleKind.RoomSpecific:if(!t.rule_id)return null;n.conditions.push({kind:a.ConditionKind.EventMatch,key:"room_id",value:t.rule_id});break;case a.PushRuleKind.SenderSpecific:if(!t.rule_id)return null;n.conditions.push({kind:a.ConditionKind.EventMatch,key:"user_id",value:t.rule_id});break;case a.PushRuleKind.ContentSpecific:if(!t.pattern)return null;n.conditions.push({kind:a.ConditionKind.EventMatch,key:"content.body",pattern:t.pattern});break}return n}eventFulfillsCondition(e,t){switch(e.kind){case a.ConditionKind.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case a.ConditionKind.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case a.ConditionKind.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case a.ConditionKind.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){const n=e["key"];if(!n)return!1;const r=this.client.getRoom(t.getRoomId());return!(null===r||void 0===r||!r.currentState)&&r.currentState.mayTriggerNotifOfType(n,t.getSender())}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;const n=this.client.getRoom(t.getRoomId());if(!n||!n.currentState||!n.currentState.members)return!1;const r=n.currentState.getJoinedMemberCount(),i=e.is.match(/^([=<>]*)(\d*)$/);if(!i)return!1;const o=i[1],s=parseInt(i[2]);if(isNaN(s))return!1;switch(o){case"":case"==":return r==s;case"<":return r<s;case">":return r>s;case"<=":return r<=s;case">=":return r>=s;default:return!1}}eventFulfillsDisplayNameCondition(e,t){let n=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(n=t.getClearContent()),!n||!n.body||"string"!=typeof n.body)return!1;const r=this.client.getRoom(t.getRoomId());if(!r||!r.currentState||!r.currentState.members||!r.currentState.getMember(this.client.credentials.userId))return!1;const i=r.currentState.getMember(this.client.credentials.userId).name,s=new RegExp("(^|\\W)"+(0,o.escapeRegExp)(i)+"(\\W|$)","i");return n.body.search(s)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;const n=this.valueForDottedKey(e.key,t);if("string"!==typeof n)return!1;if(e.value)return e.value===n;if("string"!==typeof e.pattern)return!1;let r;return r="content.body"==e.key?this.createCachedRegex("(^|\\W)",e.pattern,"(\\W|$)"):this.createCachedRegex("^",e.pattern,"$"),!!n.match(r)}createCachedRegex(e,t,n){return g.cachedGlobToRegex[t]||(g.cachedGlobToRegex[t]=new RegExp(e+(0,o.globToRegexp)(t)+n,"i")),g.cachedGlobToRegex[t]}valueForDottedKey(e,t){const n=e.split(".");let r;const i=n[0];"content"===i?(r=t.getContent(),n.shift()):"type"===i?(r=t.getType(),n.shift()):r=t.event;while(n.length>0){const e=n.shift();if((0,o.isNullOrUndefined)(r[e]))return null;r=r[e]}return r}matchingRuleForEventWithRulesets(e,t){return t?e.getSender()===this.client.credentials.userId?null:this.matchingRuleFromKindSet(e,t.global):null}pushActionsForEventAndRulesets(e,t){const n=this.matchingRuleForEventWithRulesets(e,t);if(!n)return{};const r=g.actionListToActionsObject(n.actions);return void 0===r.tweaks.highlight&&(r.tweaks.highlight=n.kind==a.PushRuleKind.ContentSpecific),r}ruleMatchesEvent(e,t){var n;if(null===(n=e.conditions)||void 0===n||!n.length)return!0;let r=!0;for(let i=0;i<e.conditions.length;++i){const n=e.conditions[i];r&=this.eventFulfillsCondition(n,t)}return r}actionsForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){for(const t of["global"])if(void 0!==this.client.pushRules[t])for(const n of u)if(void 0!==this.client.pushRules[t][n])for(const r of this.client.pushRules[t][n])if(r.rule_id===e)return r;return null}}t.PushProcessor=g,(0,i.default)(g,"cachedGlobToRegex",{})},5789:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.randomLowercaseString=s,t.randomString=o,t.randomUppercaseString=a;const n="abcdefghijklmnopqrstuvwxyz",r="ABCDEFGHIJKLMNOPQRSTUVWXYZ",i="0123456789";function o(e){return c(e,r+n+i)}function s(e){return c(e,n)}function a(e){return c(e,r)}function c(e,t){let n="";for(let r=0;r<e;++r)n+=t.charAt(Math.floor(Math.random()*t.length));return n}},3623:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.clearTimeout=d,t.setTimeout=l;var r=n(6471);const i=1e3;let o,s=0;const a=[],c=function(...e){};function l(e,t,...n){t=t||0,t<0&&(t=0);const r=Date.now()+t,i=s++;c("setTimeout: scheduling cb",i,"at",r,"(delay",t,")");const o={runAt:r,func:e,params:n,key:i},l=g(a,(function(e){return e.runAt-r}));return a.splice(l,0,o),u(),i}function d(e){if(0===a.length)return;let t;for(t=0;t<a.length;t++){const n=a[t];if(n.key==e){a.splice(t,1);break}}0===t&&u()}function u(){o&&n.g.clearTimeout(o);const e=a[0];if(!e)return void c("scheduleRealCallback: no more callbacks, not rescheduling");const t=Date.now(),r=Math.min(e.runAt-t,i);c("scheduleRealCallback: now:",t,"delay:",r),o=n.g.setTimeout(h,r)}function h(){let e;const t=Date.now();c("runCallbacks: now:",t);const i=[];while(1){const n=a[0];if(!n||n.runAt>t)break;e=a.shift(),c("runCallbacks: popping",e.key),i.push(e)}u();for(let s=0;s<i.length;s++){e=i[s];try{e.func.apply(n.g,e.params)}catch(o){r.logger.error("Uncaught exception in callback function",o.stack||o)}}}function g(e,t){let n=0,r=e.length;while(n<r){const i=n+r>>1,o=t(e[i]);o>0?r=i:n=i+1}return n}},2889:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixScheduler=void 0;var i=r(n(4344)),o=l(n(3926)),s=n(6471),a=n(7778);function c(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(c=function(e){return e?n:t})(e)}function l(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=c(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}const d=!1;class u{static RETRY_BACKOFF_RATELIMIT(e,t,n){if(400===n.httpStatus||403===n.httpStatus||401===n.httpStatus)return-1;if("rejected"===n["cors"])return-1;if("M_TOO_LARGE"===n.name)return-1;if("M_LIMIT_EXCEEDED"===n.name){const e=n.data.retry_after_ms;if(e>0)return e}return t>4?-1:1e3*Math.pow(2,t)}static QUEUE_MESSAGES(e){return e.getType()===a.EventType.RoomMessage||e.hasAssocation()?"message":null}constructor(e=u.RETRY_BACKOFF_RATELIMIT,t=u.QUEUE_MESSAGES){this.retryAlgorithm=e,this.queueAlgorithm=t,(0,i.default)(this,"queues",{}),(0,i.default)(this,"activeQueues",[]),(0,i.default)(this,"procFn",null),(0,i.default)(this,"processQueue",(e=>{const t=this.peekNextEvent(e);if(!t){const t=this.activeQueues.indexOf(e);return t>=0&&this.activeQueues.splice(t,1),void h("Stopping queue '%s' as it is now empty",e)}h("Queue '%s' has %s pending events",e,this.queues[e].length),Promise.resolve().then((()=>this.procFn(t.event))).then((n=>{this.removeNextEvent(e),h("Queue '%s' sent event %s",e,t.event.getId()),t.defer.resolve(n),this.processQueue(e)}),(n=>{t.attempts+=1;const r=this.retryAlgorithm(t.event,t.attempts,n);h("retry(%s) err=%s event_id=%s waitTime=%s",t.attempts,n,t.event.getId(),r),-1===r?(h("Queue '%s' giving up on event %s",e,t.event.getId()),this.removeNextEvent(e),t.defer.reject(n),this.processQueue(e)):setTimeout(this.processQueue,r,e)}))}))}getQueueForEvent(e){const t=this.queueAlgorithm(e);return t&&this.queues[t]?this.queues[t].map((function(e){return e.event})):null}removeEventFromQueue(e){const t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;let n=!1;return o.removeElement(this.queues[t],(t=>{if(t.event.getId()===e.getId())return n=!0,!0})),n}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){const t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);const n=o.defer();return this.queues[t].push({event:e,defer:n,attempts:0}),h("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),this.startProcessingQueues(),n.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter((e=>-1===this.activeQueues.indexOf(e)&&this.queues[e].length>0)).forEach((e=>{this.activeQueues.push(e),h("Spinning up queue: '%s'",e),this.processQueue(e)}))}peekNextEvent(e){const t=this.queues[e];return Array.isArray(t)?t[0]:null}removeNextEvent(e){const t=this.queues[e];return Array.isArray(t)?t.shift():null}}function h(...e){d&&s.logger.log(...e)}t.MatrixScheduler=u},5045:function(e,t){"use strict";let n;Object.defineProperty(t,"__esModule",{value:!0}),t.SERVICE_TYPES=void 0,t.SERVICE_TYPES=n,function(e){e["IS"]="SERVICE_TYPE_IS",e["IM"]="SERVICE_TYPE_IM"}(n||(t.SERVICE_TYPES=n={}))},1558:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.LocalIndexedDBStoreBackend=void 0;var i=r(n(4344)),o=n(568),s=d(n(3926)),a=d(n(3989)),c=n(6471);function l(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(l=function(e){return e?n:t})(e)}function d(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=l(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}const u=3;function h(e){e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})}function g(e){const t=e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]});t.createIndex("room","room_id")}function p(e){e.createObjectStore("client_options",{keyPath:["clobber"]})}function f(e,t,n){const r=e.openCursor(t);return new Promise(((e,t)=>{const i=[];r.onerror=()=>{t(new Error("Query failed: "+r.error))},r.onsuccess=()=>{const t=r.result;t?(i.push(n(t)),t.continue()):e(i)}}))}function y(e){return new Promise(((t,n)=>{e.oncomplete=function(e){t(e)},e.onerror=function(){n(e.error)}}))}function m(e){return new Promise(((t,n)=>{e.onsuccess=function(e){t(e)},e.onerror=function(){n(e.error)}}))}function v(e){return new Promise(((t,n)=>{e.onsuccess=()=>t(e),e.onerror=e=>n(e)}))}function E(e){return m(e).then((t=>e.result))}class S{static exists(e,t){return t="matrix-js-sdk:"+(t||"default"),a.exists(e,t)}constructor(e,t){this.indexedDB=e,(0,i.default)(this,"dbName",void 0),(0,i.default)(this,"syncAccumulator",void 0),(0,i.default)(this,"db",null),(0,i.default)(this,"disconnected",!0),(0,i.default)(this,"_isNewlyCreated",!1),(0,i.default)(this,"isPersisting",!1),(0,i.default)(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+(t||"default"),this.syncAccumulator=new o.SyncAccumulator}connect(){if(!this.disconnected)return c.logger.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,c.logger.log("LocalIndexedDBStoreBackend.connect: connecting...");const e=this.indexedDB.open(this.dbName,u);return e.onupgradeneeded=t=>{const n=e.result,r=t.oldVersion;c.logger.log(`LocalIndexedDBStoreBackend.connect: upgrading from ${r}`),r<1&&(this._isNewlyCreated=!0,h(n)),r<2&&g(n),r<3&&p(n)},e.onblocked=()=>{c.logger.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},c.logger.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),m(e).then((()=>(c.logger.log("LocalIndexedDBStoreBackend.connect: connected"),this.db=e.result,this.db.onversionchange=()=>{this.db.close()},this.init())))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then((([e,t])=>{c.logger.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:t.nextBatch,rooms:t.roomsData,account_data:{events:e}},!0)}))}getOutOfBandMembers(e){return new Promise(((t,n)=>{const r=this.db.transaction(["oob_membership_events"],"readonly"),i=r.objectStore("oob_membership_events"),o=i.index("room"),s=IDBKeyRange.only(e),a=o.openCursor(s),c=[];let l=!1;a.onsuccess=()=>{const e=a.result;if(!e)return c.length||l?t(c):t(null);const n=e.value;n.oob_written?l=!0:c.push(n),e.continue()},a.onerror=e=>{n(e)}})).then((t=>(c.logger.log(`LL: got ${null===t||void 0===t?void 0:t.length} membershipEvents from storage for room ${e} ...`),t)))}async setOutOfBandMembers(e,t){c.logger.log(`LL: backend about to store ${t.length} members for ${e}`);const n=this.db.transaction(["oob_membership_events"],"readwrite"),r=n.objectStore("oob_membership_events");t.forEach((e=>{r.put(e)}));const i={room_id:e,oob_written:!0,state_key:0};r.put(i),await y(n),c.logger.log(`LL: backend done storing for ${e}!`)}async clearOutOfBandMembers(e){const t=this.db.transaction(["oob_membership_events"],"readonly"),n=t.objectStore("oob_membership_events"),r=n.index("room"),i=IDBKeyRange.only(e),o=E(r.openKeyCursor(i,"next")).then((e=>e&&e.primaryKey[1])),s=E(r.openKeyCursor(i,"prev")).then((e=>e&&e.primaryKey[1])),[a,l]=await Promise.all([o,s]),d=this.db.transaction(["oob_membership_events"],"readwrite"),u=d.objectStore("oob_membership_events"),h=IDBKeyRange.bound([e,a],[e,l]);c.logger.log(`LL: Deleting all users + marker in storage for room ${e}, with key range:`,[e,a],[e,l]),await v(u.delete(h))}clearDatabase(){return new Promise((e=>{c.logger.log(`Removing indexeddb instance: ${this.dbName}`);const t=this.indexedDB.deleteDatabase(this.dbName);t.onblocked=()=>{c.logger.log(`can't yet delete indexeddb ${this.dbName} because it is open elsewhere`)},t.onerror=()=>{c.logger.warn(`unable to delete js-sdk store indexeddb: ${t.error}`),e()},t.onsuccess=()=>{c.logger.log(`Removed indexeddb instance: ${this.dbName}`),e()}}))}getSavedSync(e=!0){const t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(s.deepCopy(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then((()=>{this.syncAccumulator.accumulate(e)}))}async syncToDatabase(e){const t=this.syncAccumulator.getJSON(!0);if(this.isPersisting)return c.logger.warn("Skipping syncToDatabase() as persist already in flight"),void this.pendingUserPresenceData.push(...e);e.unshift(...this.pendingUserPresenceData),this.isPersisting=!0;try{await Promise.all([this.persistUserPresenceEvents(e),this.persistAccountData(t.accountData),this.persistSyncData(t.nextBatch,t.roomsData)])}finally{this.isPersisting=!1}}persistSyncData(e,t){return c.logger.log("Persisting sync data up to",e),s.promiseTry((()=>{const n=this.db.transaction(["sync"],"readwrite"),r=n.objectStore("sync");return r.put({clobber:"-",nextBatch:e,roomsData:t}),y(n).then((()=>{c.logger.log("Persisted sync data up to",e)}))}))}persistAccountData(e){return s.promiseTry((()=>{const t=this.db.transaction(["accountData"],"readwrite"),n=t.objectStore("accountData");for(let r=0;r<e.length;r++)n.put(e[r]);return y(t).then()}))}persistUserPresenceEvents(e){return s.promiseTry((()=>{const t=this.db.transaction(["users"],"readwrite"),n=t.objectStore("users");for(const r of e)n.put({userId:r[0],event:r[1]});return y(t).then()}))}getUserPresenceEvents(){return s.promiseTry((()=>{const e=this.db.transaction(["users"],"readonly"),t=e.objectStore("users");return f(t,void 0,(e=>[e.value.userId,e.value.event]))}))}loadAccountData(){return c.logger.log("LocalIndexedDBStoreBackend: loading account data..."),s.promiseTry((()=>{const e=this.db.transaction(["accountData"],"readonly"),t=e.objectStore("accountData");return f(t,void 0,(e=>e.value)).then((e=>(c.logger.log("LocalIndexedDBStoreBackend: loaded account data"),e)))}))}loadSyncData(){return c.logger.log("LocalIndexedDBStoreBackend: loading sync data..."),s.promiseTry((()=>{const e=this.db.transaction(["sync"],"readonly"),t=e.objectStore("sync");return f(t,void 0,(e=>e.value)).then((e=>(c.logger.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&c.logger.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{})))}))}getClientOptions(){return Promise.resolve().then((()=>{const e=this.db.transaction(["client_options"],"readonly"),t=e.objectStore("client_options");return f(t,void 0,(e=>{var t;return null===(t=e.value)||void 0===t?void 0:t.options})).then((e=>e[0]))}))}async storeClientOptions(e){const t=this.db.transaction(["client_options"],"readwrite"),n=t.objectStore("client_options");n.put({clobber:"-",options:e}),await y(t)}}t.LocalIndexedDBStoreBackend=S},9828:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteIndexedDBStoreBackend=void 0;var i=r(n(4344)),o=n(6471),s=n(3926);class a{constructor(e,t){this.workerFactory=e,this.dbName=t,(0,i.default)(this,"worker",void 0),(0,i.default)(this,"nextSeq",0),(0,i.default)(this,"inFlight",{}),(0,i.default)(this,"startPromise",null),(0,i.default)(this,"onWorkerMessage",(e=>{const t=e.data;if("cmd_success"==t.command||"cmd_fail"==t.command){if(void 0===t.seq)return void o.logger.error("Got reply from worker with no seq");const e=this.inFlight[t.seq];if(void 0===e)return void o.logger.error("Got reply for unknown seq "+t.seq);if(delete this.inFlight[t.seq],"cmd_success"==t.command)e.resolve(t.result);else{const n=new Error(t.error.message);n.name=t.error.name,e.reject(n)}}else o.logger.warn("Unrecognised message from worker: ",t)}))}connect(){return this.ensureStarted().then((()=>this.doCmd("connect")))}clearDatabase(){return this.ensureStarted().then((()=>this.doCmd("clearDatabase")))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}ensureStarted(){return null===this.startPromise&&(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("_setupWorker",[this.dbName]).then((()=>{o.logger.log("IndexedDB worker is ready")}))),this.startPromise}doCmd(e,t){return Promise.resolve().then((()=>{const n=this.nextSeq++,r=(0,s.defer)();return this.inFlight[n]=r,this.worker.postMessage({command:e,seq:n,args:t}),r.promise}))}}t.RemoteIndexedDBStoreBackend=a},455:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.IndexedDBStore=void 0;var i=r(n(4344)),o=n(613),s=n(1558),a=n(9828),c=n(6876),l=n(2842),d=n(6471),u=n(9392);const h=3e5;class g extends o.MemoryStore{static exists(e,t){return s.LocalIndexedDBStoreBackend.exists(e,t)}constructor(e){if(super(e),(0,i.default)(this,"backend",void 0),(0,i.default)(this,"startedUp",!1),(0,i.default)(this,"syncTs",0),(0,i.default)(this,"userModifiedMap",{}),(0,i.default)(this,"emitter",new u.TypedEventEmitter),(0,i.default)(this,"on",this.emitter.on.bind(this.emitter)),(0,i.default)(this,"getSavedSync",this.degradable((()=>this.backend.getSavedSync()),"getSavedSync")),(0,i.default)(this,"isNewlyCreated",this.degradable((()=>this.backend.isNewlyCreated()),"isNewlyCreated")),(0,i.default)(this,"getSavedSyncToken",this.degradable((()=>this.backend.getNextBatchToken()),"getSavedSyncToken")),(0,i.default)(this,"deleteAllData",this.degradable((()=>(super.deleteAllData(),this.backend.clearDatabase().then((()=>{d.logger.log("Deleted indexeddb data.")}),(e=>{throw d.logger.error(`Failed to delete indexeddb data: ${e}`),e})))))),(0,i.default)(this,"reallySave",this.degradable((()=>{this.syncTs=Date.now();const e=[];for(const t of this.getUsers())this.userModifiedMap[t.userId]!==t.getLastModifiedTime()&&t.events.presence&&(e.push([t.userId,t.events.presence.event]),this.userModifiedMap[t.userId]=t.getLastModifiedTime());return this.backend.syncToDatabase(e)}))),(0,i.default)(this,"setSyncData",this.degradable((e=>this.backend.setSyncData(e)),"setSyncData")),(0,i.default)(this,"getOutOfBandMembers",this.degradable((e=>this.backend.getOutOfBandMembers(e)),"getOutOfBandMembers")),(0,i.default)(this,"setOutOfBandMembers",this.degradable(((e,t)=>(super.setOutOfBandMembers(e,t),this.backend.setOutOfBandMembers(e,t))),"setOutOfBandMembers")),(0,i.default)(this,"clearOutOfBandMembers",this.degradable((e=>(super.clearOutOfBandMembers(e),this.backend.clearOutOfBandMembers(e))),"clearOutOfBandMembers")),(0,i.default)(this,"getClientOptions",this.degradable((()=>this.backend.getClientOptions()),"getClientOptions")),(0,i.default)(this,"storeClientOptions",this.degradable((e=>(super.storeClientOptions(e),this.backend.storeClientOptions(e))),"storeClientOptions")),!e.indexedDB)throw new Error("Missing required option: indexedDB");e.workerFactory?this.backend=new a.RemoteIndexedDBStoreBackend(e.workerFactory,e.dbName):this.backend=new s.LocalIndexedDBStoreBackend(e.indexedDB,e.dbName)}startup(){return this.startedUp?(d.logger.log("IndexedDBStore.startup: already started"),Promise.resolve()):(d.logger.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect().then((()=>(d.logger.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents()))).then((e=>{d.logger.log("IndexedDBStore.startup: processing presence events"),e.forEach((([e,t])=>{const n=new c.User(e);t&&n.setPresenceEvent(new l.MatrixEvent(t)),this.userModifiedMap[n.userId]=n.getLastModifiedTime(),this.storeUser(n)}))})))}wantsSave(){const e=Date.now();return e-this.syncTs>h}save(e=!1){return e||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){const n=super[t];return async(...t)=>{try{return await e.call(this,...t)}catch(r){d.logger.error("IndexedDBStore failure, degrading to MemoryStore",r),this.emitter.emit("degraded",r);try{d.logger.log("IndexedDBStore trying to delete degraded data"),await this.backend.clearDatabase(),d.logger.log("IndexedDBStore delete after degrading succeeded")}catch(r){d.logger.warn("IndexedDBStore delete after degrading failed",r)}if(n)return n.call(this,...t)}}}async getPendingEvents(e){if(!this.localStorage)return super.getPendingEvents(e);const t=this.localStorage.getItem(p(e));if(t)try{return JSON.parse(t)}catch(n){d.logger.error("Could not parse persisted pending events",n)}return[]}async setPendingEvents(e,t){if(!this.localStorage)return super.setPendingEvents(e,t);t.length>0?this.localStorage.setItem(p(e),JSON.stringify(t)):this.localStorage.removeItem(p(e))}}function p(e){return`mx_pending_events_${e}`}t.IndexedDBStore=g},613:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.MemoryStore=void 0;var i=r(n(4344)),o=n(6876),s=n(8859);function a(e){const t="string"===typeof e&&!!e&&"undefined"!==e&&"null"!==e;return t||"number"===typeof e}class c{constructor(e={}){(0,i.default)(this,"rooms",{}),(0,i.default)(this,"users",{}),(0,i.default)(this,"syncToken",null),(0,i.default)(this,"filters",{}),(0,i.default)(this,"accountData",{}),(0,i.default)(this,"localStorage",void 0),(0,i.default)(this,"oobMembers",{}),(0,i.default)(this,"pendingEvents",{}),(0,i.default)(this,"clientOptions",{}),(0,i.default)(this,"onRoomMember",((e,t,n)=>{if("invite"===n.membership)return;const r=this.users[n.userId]||new o.User(n.userId);n.name&&(r.setDisplayName(n.name),n.events.member&&r.setRawDisplayName(n.events.member.getDirectionalContent().displayname)),n.events.member&&n.events.member.getContent().avatar_url&&r.setAvatarUrl(n.events.member.getContent().avatar_url),this.users[r.userId]=r})),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on(s.RoomStateEvent.Members,this.onRoomMember),e.currentState.getMembers().forEach((t=>{this.onRoomMember(null,e.currentState,t)}))}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener(s.RoomStateEvent.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map((function(e){return e.summary}))}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,n,r){}storeFilter(e){e&&(this.filters[e.userId]||(this.filters[e.userId]={}),this.filters[e.userId][e.filterId]=e)}getFilter(e,t){return this.filters[e]&&this.filters[e][t]?this.filters[e][t]:null}getFilterIdByName(e){if(!this.localStorage)return null;const t="mxjssdk_memory_filter_"+e;try{const e=this.localStorage.getItem(t);if(a(e))return e}catch(n){}return null}setFilterIdByName(e,t){if(!this.localStorage)return;const n="mxjssdk_memory_filter_"+e;try{a(t)?this.localStorage.setItem(n,t):this.localStorage.removeItem(n)}catch(r){}}storeAccountDataEvents(e){e.forEach((e=>{this.accountData[e.getType()]=e}))}getAccountData(e){return this.accountData[e]}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters={},this.accountData={},Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers[e]||null)}setOutOfBandMembers(e,t){return this.oobMembers[e]=t,Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers={},Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}async getPendingEvents(e){var t;return null!==(t=this.pendingEvents[e])&&void 0!==t?t:[]}async setPendingEvents(e,t){this.pendingEvents[e]=t}}t.MemoryStore=c},3484:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.StubStore=void 0;var i=r(n(4344));class o{constructor(){(0,i.default)(this,"accountData",{}),(0,i.default)(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}storeEvents(e,t,n,r){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve({})}storeClientOptions(e){return Promise.resolve()}async getPendingEvents(e){return[]}setPendingEvents(e,t){return Promise.resolve()}}t.StubStore=o},568:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.SyncAccumulator=t.Category=void 0;var i=r(n(4344)),o=n(6471),s=n(3926),a=n(6445);let c;t.Category=c,function(e){e["Invite"]="invite",e["Leave"]="leave",e["Join"]="join"}(c||(t.Category=c={}));class l{constructor(e={}){this.opts=e,(0,i.default)(this,"accountData",{}),(0,i.default)(this,"inviteRooms",{}),(0,i.default)(this,"joinRooms",{}),(0,i.default)(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e,t=!1){this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){e.account_data&&e.account_data.events&&e.account_data.events.forEach((e=>{this.accountData[e.type]=e}))}accumulateRooms(e,t=!1){e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach((n=>{this.accumulateRoom(n,c.Invite,e.rooms.invite[n],t)})),e.rooms.join&&Object.keys(e.rooms.join).forEach((n=>{this.accumulateRoom(n,c.Join,e.rooms.join[n],t)})),e.rooms.leave&&Object.keys(e.rooms.leave).forEach((n=>{this.accumulateRoom(n,c.Leave,e.rooms.leave[n],t)})))}accumulateRoom(e,t,n,r=!1){switch(t){case c.Invite:this.accumulateInviteState(e,n);break;case c.Join:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,n,r);break;case c.Leave:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:o.logger.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(!t.invite_state||!t.invite_state.events)return;if(!this.inviteRooms[e])return void(this.inviteRooms[e]={invite_state:t.invite_state});const n=this.inviteRooms[e];t.invite_state.events.forEach((e=>{let t=!1;for(let r=0;r<n.invite_state.events.length;r++){const i=n.invite_state.events[r];i.type===e.type&&i.state_key==e.state_key&&(n.invite_state.events[r]=e,t=!0)}t||n.invite_state.events.push(e)}))}accumulateJoinState(e,t,n=!1){this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_summary:{},_readReceipts:{}});const r=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach((e=>{r._accountData[e.type]=e})),t.unread_notifications&&(r._unreadNotifications=t.unread_notifications),t.summary){const e="m.heroes",n="m.invited_member_count",i="m.joined_member_count",o=r._summary,s=t.summary;o[e]=s[e]||o[e],o[i]=s[i]||o[i],o[n]=s[n]||o[n]}if(t.ephemeral&&t.ephemeral.events&&t.ephemeral.events.forEach((e=>{"m.receipt"===e.type&&e.content&&Object.keys(e.content).forEach((t=>{if(!e.content[t][a.ReceiptType.Read]&&!e.content[t][a.ReceiptType.ReadPrivate])return;const n=e.content[t][a.ReceiptType.Read];n&&Object.keys(n).forEach((n=>{r._readReceipts[n]={data:e.content[t][a.ReceiptType.Read][n],type:a.ReceiptType.Read,eventId:t}}));const i=e.content[t][a.ReceiptType.ReadPrivate];i&&Object.keys(i).forEach((n=>{r._readReceipts[n]={data:e.content[t][a.ReceiptType.ReadPrivate][n],type:a.ReceiptType.ReadPrivate,eventId:t}}))}))})),t.timeline&&t.timeline.limited&&(r._timeline=[]),t.state&&t.state.events&&t.state.events.forEach((e=>{d(r._currentState,e)})),t.timeline&&t.timeline.events&&t.timeline.events.forEach(((e,i)=>{let o;if(d(r._currentState,e),n)o=e;else{o=Object.assign({},e),void 0!==o.unsigned&&(o.unsigned=Object.assign({},o.unsigned));const t=e.unsigned?e.unsigned.age:e.age;void 0!==t&&(o._localTs=Date.now()-t)}r._timeline.push({event:o,token:0===i?t.timeline.prev_batch:null})})),r._timeline.length>this.opts.maxTimelineEntries){const e=r._timeline.length-this.opts.maxTimelineEntries;for(let t=e;t<r._timeline.length;t++)if(r._timeline[t].token){r._timeline=r._timeline.slice(t,r._timeline.length);break}}}getJSON(e=!1){const t={join:{},invite:{},leave:{}};Object.keys(this.inviteRooms).forEach((e=>{t.invite[e]=this.inviteRooms[e]})),Object.keys(this.joinRooms).forEach((n=>{const r=this.joinRooms[n],i={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:r._unreadNotifications,summary:r._summary};Object.keys(r._accountData).forEach((e=>{i.account_data.events.push(r._accountData[e])}));const o={type:"m.receipt",room_id:n,content:{}};Object.keys(r._readReceipts).forEach((e=>{const t=r._readReceipts[e];o.content[t.eventId]||(o.content[t.eventId]={}),o.content[t.eventId][t.type]||(o.content[t.eventId][t.type]={}),o.content[t.eventId][t.type][e]=t.data})),Object.keys(o.content).length>0&&i.ephemeral.events.push(o),r._timeline.forEach((t=>{if(!i.timeline.prev_batch){if(!t.token)return;i.timeline.prev_batch=t.token}let n;!e&&t.event["_localTs"]?(n=Object.assign({},t.event),void 0!==n.unsigned&&(n.unsigned=Object.assign({},n.unsigned)),delete n._localTs,n.unsigned=n.unsigned||{},n.unsigned.age=Date.now()-t.event["_localTs"]):n=t.event,i.timeline.events.push(n)}));const a=Object.create(null);for(let e=i.timeline.events.length-1;e>=0;e--){const t=i.timeline.events[e];if(null===t.state_key||void 0===t.state_key)continue;const n=(0,s.deepCopy)(t);n.unsigned&&(n.unsigned.prev_content&&(n.content=n.unsigned.prev_content),n.unsigned.prev_sender&&(n.sender=n.unsigned.prev_sender)),d(a,n)}Object.keys(r._currentState).forEach((e=>{Object.keys(r._currentState[e]).forEach((t=>{let n=r._currentState[e][t];a[e]&&a[e][t]&&(n=a[e][t]),i.state.events.push(n)}))})),t.join[n]=i}));const n=[];return Object.keys(this.accountData).forEach((e=>{n.push(this.accountData[e])})),{nextBatch:this.nextBatch,roomsData:t,accountData:n}}getNextBatchToken(){return this.nextBatch}}function d(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}t.SyncAccumulator=l},2438:function(e,t,n){"use strict";n(6699);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.SyncState=t.SyncApi=void 0;var i=r(n(4344)),o=n(6876),s=n(2139),a=S(n(3926)),c=n(9097),l=n(8919),d=n(541),u=n(6471),h=n(5592),g=n(9528),p=n(5354),f=n(7778),y=n(8859),m=n(3078),v=n(9240);function E(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(E=function(e){return e?n:t})(e)}function S(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=E(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}const b=!0,w=8e4,_=3;let T;t.SyncState=T,function(e){e["Error"]="ERROR",e["Prepared"]="PREPARED",e["Stopped"]="STOPPED",e["Syncing"]="SYNCING",e["Catchup"]="CATCHUP",e["Reconnecting"]="RECONNECTING"}(T||(t.SyncState=T={}));const I=["org.matrix.msc2716v3"];function R(e,t){return"FILTER_SYNC_"+e+(t?"_"+t:"")}function k(...e){b&&u.logger.log(...e)}var O;(function(e){e["Offline"]="offline",e["Online"]="online",e["Unavailable"]="unavailable"})(O||(O={}));class C{constructor(e,t={}){var n;this.client=e,this.opts=t,(0,i.default)(this,"_peekRoom",null),(0,i.default)(this,"currentSyncRequest",null),(0,i.default)(this,"syncState",null),(0,i.default)(this,"syncStateData",null),(0,i.default)(this,"catchingUp",!1),(0,i.default)(this,"running",!1),(0,i.default)(this,"keepAliveTimer",null),(0,i.default)(this,"connectionReturnedDefer",null),(0,i.default)(this,"notifEvents",[]),(0,i.default)(this,"failedSyncCount",0),(0,i.default)(this,"storeIsInvalid",!1),(0,i.default)(this,"onOnline",(()=>{k("Browser thinks we are back online"),this.startKeepAlives(0)})),this.opts.initialSyncLimit=null!==(n=this.opts.initialSyncLimit)&&void 0!==n?n:8,this.opts.resolveInvitesToProfiles=this.opts.resolveInvitesToProfiles||!1,this.opts.pollTimeout=this.opts.pollTimeout||3e4,this.opts.pendingEventOrdering=this.opts.pendingEventOrdering||g.PendingEventOrdering.Chronological,this.opts.experimentalThreadSupport=!0===this.opts.experimentalThreadSupport,t.canResetEntireTimeline||(t.canResetEntireTimeline=e=>!1),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[s.RoomEvent.Timeline,s.RoomEvent.TimelineReset])}createRoom(e){const t=this.client,{timelineSupport:n}=t,r=new s.Room(e,t,t.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:n});return t.reEmitter.reEmit(r,[s.RoomEvent.Name,s.RoomEvent.Redaction,s.RoomEvent.RedactionCancelled,s.RoomEvent.Receipt,s.RoomEvent.Tags,s.RoomEvent.LocalEchoUpdated,s.RoomEvent.AccountData,s.RoomEvent.MyMembership,s.RoomEvent.Timeline,s.RoomEvent.TimelineReset]),this.registerStateListeners(r),r.on(s.RoomEvent.CurrentStateUpdated,((e,t)=>{e===r&&(this.deregisterStateListeners(t),this.registerStateListeners(r))})),r}registerStateListeners(e){const t=this.client;t.reEmitter.reEmit(e.currentState,[y.RoomStateEvent.Events,y.RoomStateEvent.Members,y.RoomStateEvent.NewMember,y.RoomStateEvent.Update,v.BeaconEvent.New,v.BeaconEvent.Update,v.BeaconEvent.Destroy,v.BeaconEvent.LivenessChange]),e.currentState.on(y.RoomStateEvent.NewMember,(function(e,n,r){r.user=t.getUser(r.userId),t.reEmitter.reEmit(r,[m.RoomMemberEvent.Name,m.RoomMemberEvent.Typing,m.RoomMemberEvent.PowerLevel,m.RoomMemberEvent.Membership])})),e.currentState.on(y.RoomStateEvent.Marker,((t,n)=>{this.onMarkerStateEvent(e,t,n)}))}deregisterStateListeners(e){e.removeAllListeners(y.RoomStateEvent.Events),e.removeAllListeners(y.RoomStateEvent.Members),e.removeAllListeners(y.RoomStateEvent.NewMember),e.removeAllListeners(y.RoomStateEvent.Marker)}onMarkerStateEvent(e,t,{timelineWasEmpty:n}={}){if(n)return void u.logger.debug(`MarkerState: Ignoring markerEventId=${t.getId()} in roomId=${e.roomId} because the timeline was empty before the marker arrived which means there is nothing to refresh.`);const r=I.includes(e.getVersion())||t.getSender()===e.getCreator();r?(u.logger.debug(`MarkerState: Timeline needs to be refreshed because a new markerEventId=${t.getId()} was sent in roomId=${e.roomId}`),e.setTimelineNeedsRefresh(!0),e.emit(s.RoomEvent.HistoryImportedWithinTimeline,t,e)):u.logger.debug(`MarkerState: Ignoring markerEventId=${t.getId()} in roomId=${e.roomId} because MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.`)}syncLeftRooms(){const e=this.client,t=new c.Filter(this.client.credentials.userId);t.setTimelineLimit(1),t.setIncludeLeaveRooms(!0);const n=this.opts.pollTimeout+w,r={timeout:0};return e.getOrCreateFilter(R(e.credentials.userId,"LEFT_ROOMS"),t).then((function(t){return r.filter=t,e.http.authedRequest(void 0,p.Method.Get,"/sync",r,void 0,n)})).then((async t=>{var n;let r=[];return null!==(n=t.rooms)&&void 0!==n&&n.leave&&(r=this.mapSyncResponseToRoomArray(t.rooms.leave)),Promise.all(r.map((async t=>{const n=t.room;if(!t.isBrandNewRoom)return;t.timeline=t.timeline||{};const r=this.mapSyncEventsFormat(t.timeline,n),i=this.mapSyncEventsFormat(t.state,n);return n.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,l.EventTimeline.BACKWARDS),await this.processRoomEvents(n,i,r),n.recalculate(),e.store.storeRoom(n),e.emit(g.ClientEvent.Room,n),this.processEventsForNotifs(n,r),n})))}))}peek(e){if(this._peekRoom&&this._peekRoom.roomId===e)return Promise.resolve(this._peekRoom);const t=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,20).then((e=>{e.messages=e.messages||{chunk:[]},e.messages.chunk=e.messages.chunk||[],e.state=e.state||[];const n=a.deepCopy(e.state).map(t.getEventMapper()),r=e.state.map(t.getEventMapper()),i=e.messages.chunk.map(t.getEventMapper());return e.presence&&Array.isArray(e.presence)&&e.presence.map(t.getEventMapper()).forEach((function(e){let n=t.store.getUser(e.getContent().user_id);n?n.setPresenceEvent(e):(n=P(t,e.getContent().user_id),n.setPresenceEvent(e),t.store.storeUser(n)),t.emit(g.ClientEvent.Event,e)})),e.messages.start&&(this._peekRoom.oldState.paginationToken=e.messages.start),this._peekRoom.oldState.setStateEvents(n),this._peekRoom.currentState.setStateEvents(r),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(i.reverse(),!0,this._peekRoom.getLiveTimeline(),e.messages.start),t.store.storeRoom(this._peekRoom),t.emit(g.ClientEvent.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom}))}stopPeeking(){this._peekRoom=null}peekPoll(e,t){this._peekRoom===e?this.client.http.authedRequest(void 0,p.Method.Get,"/events",{room_id:e.roomId,timeout:String(3e4),from:t},void 0,5e4).then((t=>{if(this._peekRoom!==e)return void k("Stopped peeking in room %s",e.roomId);t.chunk.filter((function(e){return"m.presence"===e.type})).map(this.client.getEventMapper()).forEach((e=>{let t=this.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=P(this.client,e.getContent().user_id),t.setPresenceEvent(e),this.client.store.storeUser(t)),this.client.emit(g.ClientEvent.Event,e)}));const n=t.chunk.filter((function(t){return t.room_id===e.roomId&&t.event_id})).map(this.client.getEventMapper());e.addLiveEvents(n),this.peekPoll(e,t.end)}),(n=>{u.logger.error("[%s] Peek poll failed: %s",e.roomId,n),setTimeout((()=>{this.peekPoll(e,t)}),3e4)})):k("Stopped peeking in room %s",e.roomId)}getSyncState(){return this.syncState}getSyncStateData(){return this.syncStateData}async recoverFromSyncStartupError(e,t){await e;const n=this.startKeepAlives();this.updateSyncState(T.Error,{error:t}),await n}async wasLazyLoadingToggled(e=!1){let t=!1;const n=await this.client.store.isNewlyCreated();if(!n){const n=await this.client.store.getClientOptions();return n&&(t=!!n.lazyLoadMembers),t!==e}return!1}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(u.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(T.Error,{error:e}),!0)}sync(){const e=this.client;this.running=!0,n.g.window&&n.g.window.addEventListener&&n.g.window.addEventListener("online",this.onOnline,!1);let t=Promise.resolve(),r=null;const i=async()=>{try{k("Getting push rules...");const t=await e.getPushRules();k("Got push rules"),e.pushRules=t}catch(n){if(u.logger.error("Getting push rules failed",n),this.shouldAbortSync(n))return;return k("Waiting for saved sync before retrying push rules..."),await this.recoverFromSyncStartupError(t,n),void i()}s()},o=()=>{const t=new c.Filter(e.credentials.userId);return t.setTimelineLimit(this.opts.initialSyncLimit),t},s=async()=>{if(k("Checking lazy load status..."),this.opts.lazyLoadMembers&&e.isGuest()&&(this.opts.lazyLoadMembers=!1),this.opts.lazyLoadMembers){k("Checking server lazy load support...");const t=await e.doesServerSupportLazyLoading();t?(k("Enabling lazy load on sync filter..."),this.opts.filter||(this.opts.filter=o()),this.opts.filter.setLazyLoadMembers(!0)):(k("LL: lazy loading requested but not supported by server, so disabling"),this.opts.lazyLoadMembers=!1)}k("Checking whether lazy loading has changed in store...");const t=await this.wasLazyLoadingToggled(this.opts.lazyLoadMembers);if(t){this.storeIsInvalid=!0;const e=h.InvalidStoreError.TOGGLED_LAZY_LOADING,t=new h.InvalidStoreError(e,!!this.opts.lazyLoadMembers);return this.updateSyncState(T.Error,{error:t}),void u.logger.warn("InvalidStoreError: store is not usable: stopping sync.")}this.opts.lazyLoadMembers&&this.opts.crypto&&this.opts.crypto.enableLazyLoading();try{k("Storing client options..."),await this.client.storeClientOptions(),k("Stored client options")}catch(n){throw u.logger.error("Storing client options failed",n),n}a()},a=async()=>{let n,i;k("Getting filter..."),n=this.opts.filter?this.opts.filter:o();try{i=await e.getOrCreateFilter(R(e.credentials.userId),n)}catch(s){if(u.logger.error("Getting filter failed",s),this.shouldAbortSync(s))return;return k("Waiting for saved sync before retrying filter..."),await this.recoverFromSyncStartupError(t,s),void a()}e.resetNotifTimelineSet(),null===this.currentSyncRequest&&(k("Sending first sync request..."),this.currentSyncRequest=this.doSyncRequest({filterId:i},r)),k("Waiting for saved sync before starting sync processing..."),await t,this.doSync({filterId:i})};e.isGuest()?this.doSync({}):(k("Getting saved sync token..."),t=e.store.getSavedSyncToken().then((t=>(k("Got saved sync token"),r=t,k("Getting saved sync..."),e.store.getSavedSync()))).then((e=>{if(k(`Got reply from saved sync, exists? ${!!e}`),e)return this.syncFromCache(e)})).catch((e=>{u.logger.error("Getting saved sync failed",e)})),i())}stop(){var e;k("SyncApi.stop"),n.g.window&&n.g.window.removeEventListener&&n.g.window.removeEventListener("online",this.onOnline,!1),this.running=!1,null===(e=this.currentSyncRequest)||void 0===e||e.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=null)}retryImmediately(){return!!this.connectionReturnedDefer&&(this.startKeepAlives(0),!0)}async syncFromCache(e){k("sync(): not doing HTTP hit, instead returning stored /sync data");const t=e.nextBatch;this.client.store.setSyncToken(t);const n={oldSyncToken:null,nextSyncToken:t,catchingUp:!1,fromCache:!0},r={next_batch:t,rooms:e.roomsData,account_data:{events:e.accountData}};try{await this.processSyncResponse(n,r)}catch(i){u.logger.error("Error processing cached sync",i)}this.storeIsInvalid||this.updateSyncState(T.Prepared,n)}async doSync(e){const t=this.client;if(!this.running)return k("Sync no longer running: exiting."),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=null),void this.updateSyncState(T.Stopped);const n=t.store.getSyncToken();let r;try{null===this.currentSyncRequest&&(this.currentSyncRequest=this.doSyncRequest(e,n)),r=await this.currentSyncRequest}catch(o){return void this.onSyncError(o,e)}finally{this.currentSyncRequest=null}t.store.setSyncToken(r.next_batch),this.failedSyncCount=0,await t.store.setSyncData(r);const i={oldSyncToken:n,nextSyncToken:r.next_batch,catchingUp:this.catchingUp};this.opts.crypto&&await this.opts.crypto.onSyncWillProcess(i);try{await this.processSyncResponse(i,r)}catch(o){u.logger.error("Caught /sync error",o),this.client.emit(g.ClientEvent.SyncUnexpectedError,o)}i.catchingUp=this.catchingUp,e.hasSyncedBefore||(this.updateSyncState(T.Prepared,i),e.hasSyncedBefore=!0),this.opts.crypto&&await this.opts.crypto.onSyncCompleted(i),this.updateSyncState(T.Syncing,i),t.store.wantsSave()&&(this.opts.crypto&&await this.opts.crypto.saveDeviceList(0),t.store.save()),this.doSync(e)}doSyncRequest(e,t){const n=this.getSyncParams(e,t);return this.client.http.authedRequest(void 0,p.Method.Get,"/sync",n,void 0,n.timeout+w)}getSyncParams(e,t){let n=this.opts.pollTimeout;("SYNCING"!==this.getSyncState()||this.catchingUp)&&(this.catchingUp=!0,n=0);let r=e.filterId;this.client.isGuest()&&!r&&(r=this.getGuestFilter());const i={filter:r,timeout:n};return this.opts.disablePresence&&(i.set_presence=O.Offline),t?i.since=t:i._cacheBuster=Date.now(),"ERROR"!=this.getSyncState()&&"RECONNECTING"!=this.getSyncState()||(i.timeout=0),i}onSyncError(e,t){if(!this.running)return k("Sync no longer running: exiting"),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=null),void this.updateSyncState(T.Stopped);u.logger.error("/sync error %s",e),u.logger.error(e),this.shouldAbortSync(e)||(this.failedSyncCount++,u.logger.log("Number of consecutive failed sync requests:",this.failedSyncCount),k("Starting keep-alive"),this.startKeepAlives().then((e=>{e&&this.getSyncState()===T.Error&&this.updateSyncState(T.Catchup,{oldSyncToken:null,nextSyncToken:null,catchingUp:!0}),this.doSync(t)})),this.currentSyncRequest=null,this.updateSyncState(this.failedSyncCount>=_?T.Error:T.Reconnecting,{error:e}))}async processSyncResponse(e,t){var n;const r=this.client;if(t.presence&&Array.isArray(t.presence.events)&&t.presence.events.map(r.getEventMapper()).forEach((function(e){let t=r.store.getUser(e.getSender());t?t.setPresenceEvent(e):(t=P(r,e.getSender()),t.setPresenceEvent(e),r.store.storeUser(t)),r.emit(g.ClientEvent.Event,e)})),t.account_data&&Array.isArray(t.account_data.events)){const e=t.account_data.events.map(r.getEventMapper()),n=e.reduce(((e,t)=>(e[t.getId()]=r.store.getAccountData(t.getType()),e)),{});r.store.storeAccountDataEvents(e),e.forEach((function(e){if(e.getType()===f.EventType.PushRules){const t=e.getContent();r.pushRules=d.PushProcessor.rewriteDefaultRules(t)}const t=n[e.getId()];return r.emit(g.ClientEvent.AccountData,e,t),e}))}if(Array.isArray(null===(n=t.to_device)||void 0===n?void 0:n.events)&&t.to_device.events.length>0){const e=[];t.to_device.events.map(r.getEventMapper()).map((t=>{if("m.key.verification.cancel"===t.getType()){const n=t.getContent()["transaction_id"];n&&e.push(n)}return t})).forEach((function(t){const n=t.getContent();if("m.room.message"!=t.getType()||"m.bad.encrypted"!=n.msgtype){if("m.key.verification.start"===t.getType()||"m.key.verification.request"===t.getType()){const r=n["transaction_id"];e.includes(r)&&t.flagCancelled()}r.emit(g.ClientEvent.ToDeviceEvent,t)}else u.logger.log("Ignoring undecryptable to-device event from "+t.getSender())}))}else this.catchingUp=!1;let i=[],o=[],c=[];if(t.rooms&&(t.rooms.invite&&(i=this.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(o=this.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(c=this.mapSyncResponseToRoomArray(t.rooms.leave))),this.notifEvents=[],await a.promiseMapSeries(i,(async e=>{const t=e.room,n=this.mapSyncEventsFormat(e.invite_state,t);await this.processRoomEvents(t,n),e.isBrandNewRoom?(t.recalculate(),r.store.storeRoom(t),r.emit(g.ClientEvent.Room,t)):t.recalculate(),n.forEach((function(e){r.emit(g.ClientEvent.Event,e)}))})),await a.promiseMapSeries(o,(async t=>{const n=t.room,i=this.mapSyncEventsFormat(t.state,n),o=this.mapSyncEventsFormat(t.timeline,n,!1),c=this.mapSyncEventsFormat(t.ephemeral),d=this.mapSyncEventsFormat(t.account_data),u=r.isRoomEncrypted(n.roomId);if(t.unread_notifications&&(n.setUnreadNotificationCount(s.NotificationCountType.Total,t.unread_notifications.notification_count),(!u||u&&n.getUnreadNotificationCount(s.NotificationCountType.Highlight)<=0)&&n.setUnreadNotificationCount(s.NotificationCountType.Highlight,t.unread_notifications.highlight_count)),t.timeline=t.timeline||{},t.isBrandNewRoom)n.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,l.EventTimeline.BACKWARDS);else if(t.timeline.limited){let i=!0;for(let e=o.length-1;e>=0;e--){const t=o[e].getId();if(n.getTimelineForEvent(t)){k("Already have event "+t+" in limited sync - not resetting"),i=!1,o.splice(0,e);break}}i&&(n.resetLiveTimeline(t.timeline.prev_batch,this.opts.canResetEntireTimeline(n.roomId)?null:e.oldSyncToken),r.resetNotifTimelineSet())}await this.processRoomEvents(n,i,o,e.fromCache),t.summary&&n.setSummary(t.summary),n.addEphemeralEvents(c),n.addAccountData(d),n.recalculate(),t.isBrandNewRoom&&(r.store.storeRoom(n),r.emit(g.ClientEvent.Room,n)),this.processEventsForNotifs(n,o);const h=async e=>{r.emit(g.ClientEvent.Event,e),e.isState()&&"m.room.encryption"==e.getType()&&this.opts.crypto&&await this.opts.crypto.onCryptoEvent(e)};await a.promiseMapSeries(i,h),await a.promiseMapSeries(o,h),c.forEach((function(e){r.emit(g.ClientEvent.Event,e)})),d.forEach((function(e){r.emit(g.ClientEvent.Event,e)})),n.decryptCriticalEvents()})),await a.promiseMapSeries(c,(async e=>{const t=e.room,n=this.mapSyncEventsFormat(e.state,t),i=this.mapSyncEventsFormat(e.timeline,t),o=this.mapSyncEventsFormat(e.account_data);await this.processRoomEvents(t,n,i),t.addAccountData(o),t.recalculate(),e.isBrandNewRoom&&(r.store.storeRoom(t),r.emit(g.ClientEvent.Room,t)),this.processEventsForNotifs(t,i),n.forEach((function(e){r.emit(g.ClientEvent.Event,e)})),i.forEach((function(e){r.emit(g.ClientEvent.Event,e)})),o.forEach((function(e){r.emit(g.ClientEvent.Event,e)}))})),e.oldSyncToken&&this.notifEvents.length&&(this.notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this.notifEvents.forEach((function(e){r.getNotifTimelineSet().addLiveEvent(e)}))),t.device_lists&&this.opts.crypto&&await this.opts.crypto.handleDeviceListChanges(e,t.device_lists),this.opts.crypto&&t.device_one_time_keys_count){const e=t.device_one_time_keys_count.signed_curve25519||0;this.opts.crypto.updateOneTimeKeyCount(e)}if(this.opts.crypto&&(t["device_unused_fallback_key_types"]||t["org.matrix.msc2732.device_unused_fallback_key_types"])){const e=t["device_unused_fallback_key_types"]||t["org.matrix.msc2732.device_unused_fallback_key_types"];this.opts.crypto.setNeedsNewFallback(e instanceof Array&&!e.includes("signed_curve25519"))}}startKeepAlives(e){return void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this.keepAliveTimer&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedDefer||(this.connectionReturnedDefer=a.defer()),this.connectionReturnedDefer.promise}pokeKeepAlive(e=!1){const t=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.resolve(e),this.connectionReturnedDefer=null)};this.client.http.request(void 0,p.Method.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3}).then((()=>{t()}),(n=>{400==n.httpStatus||404==n.httpStatus?this.keepAliveTimer=setTimeout(t,2e3):(e=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,e),5e3+Math.floor(5e3*Math.random())),this.updateSyncState(T.Error,{error:n}))}))}mapSyncResponseToRoomArray(e){const t=this.client;return Object.keys(e).map((n=>{const r=e[n];let i=t.store.getRoom(n),o=!1;return i||(i=this.createRoom(n),o=!0),r.room=i,r.isBrandNewRoom=o,r}))}mapSyncEventsFormat(e,t,n=!0){if(!e||!Array.isArray(e.events))return[];const r=this.client.getEventMapper({decrypt:n});return e.events.map((function(e){return t&&(e["room_id"]=t.roomId),r(e)}))}resolveInvites(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership("invite").forEach((function(n){if(n._requestedProfileInfo)return;n._requestedProfileInfo=!0;const r=t.getUser(n.userId);let i;i=r?Promise.resolve({avatar_url:r.avatarUrl,displayname:r.displayName}):t.getProfileInfo(n.userId),i.then((function(t){const r=n.events.member;"invite"===r.getContent().membership&&(r.getContent().avatar_url=t.avatar_url,r.getContent().displayname=t.displayname,n.setMembershipEvent(r,e.currentState))}),(function(e){}))}))}async processRoomEvents(e,t,n,r=!1){const i=e.getLiveTimeline(),o=0==i.getEvents().length;if(o){for(const e of t)this.client.getPushActionsForEvent(e);i.initialiseState(t,{timelineWasEmpty:o})}this.resolveInvites(e),e.recalculate(),o||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),e.addLiveEvents(n||[],{fromCache:r,timelineWasEmpty:o}),this.client.processBeaconEvents(e,n)}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(let n=0;n<t.length;n++){const e=this.client.getPushActionsForEvent(t[n]);e&&e.notify&&e.tweaks&&e.tweaks.highlight&&this.notifEvents.push(t[n])}}getGuestFilter(){return"{}"}updateSyncState(e,t){const n=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(g.ClientEvent.Sync,this.syncState,n,t)}}function P(e,t){const n=new o.User(t);return e.reEmitter.reEmit(n,[o.UserEvent.AvatarUrl,o.UserEvent.DisplayName,o.UserEvent.Presence,o.UserEvent.CurrentlyActive,o.UserEvent.LastPresenceTs]),n}t.SyncApi=C},104:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.TimelineWindow=t.TimelineIndex=void 0;var i=r(n(4344)),o=n(8919),s=n(6471);const a=!1,c=a?s.logger.log.bind(s.logger):function(){},l=5;class d{constructor(e,t,n={}){this.client=e,this.timelineSet=t,(0,i.default)(this,"windowLimit",void 0),(0,i.default)(this,"start",null),(0,i.default)(this,"end",null),(0,i.default)(this,"eventCount",0),this.windowLimit=n.windowLimit||1e3}load(e,t=20){const n=n=>{let r;const i=n.getEvents();if(e){if(r=i.findIndex((t=>t.getId()===e)),r<0)throw new Error("getEventTimeline result didn't include requested event")}else r=i.length;const o=Math.min(i.length,r+Math.ceil(t/2)),s=Math.max(0,o-t);this.start=new u(n,s-n.getBaseIndex()),this.end=new u(n,o-n.getBaseIndex()),this.eventCount=o-s};if(e){const t=this.timelineSet.getTimelineForEvent(e);return t?(n(t),Promise.resolve()):this.client.getEventTimeline(this.timelineSet,e).then(n)}{const e=this.timelineSet.getLiveTimeline();return n(e),Promise.resolve()}}getTimelineIndex(e){if(e==o.EventTimeline.BACKWARDS)return this.start;if(e==o.EventTimeline.FORWARDS)return this.end;throw new Error("Invalid direction '"+e+"'")}extend(e,t){const n=this.getTimelineIndex(e);if(!n)return c("TimelineWindow: no timeline yet"),!1;const r=e==o.EventTimeline.BACKWARDS?n.retreat(t):n.advance(t);if(r){this.eventCount+=r,c("TimelineWindow: increased cap by "+r+" (now "+this.eventCount+")");const t=this.eventCount-this.windowLimit;return t>0&&this.unpaginate(t,e!=o.EventTimeline.BACKWARDS),!0}return!1}canPaginate(e){const t=this.getTimelineIndex(e);if(!t)return c("TimelineWindow: no timeline yet"),!1;if(e==o.EventTimeline.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;return Boolean(t.timeline.getNeighbouringTimeline(e)||null!==t.timeline.getPaginationToken(e))}paginate(e,t,n=!0,r=l){const i=this.getTimelineIndex(e);if(!i)return c("TimelineWindow: no timeline yet"),Promise.resolve(!1);if(i.pendingPaginate)return i.pendingPaginate;if(this.extend(e,t))return Promise.resolve(!0);if(!n||0===r)return Promise.resolve(!1);const s=i.timeline.getPaginationToken(e);if(null===s)return c("TimelineWindow: no token"),Promise.resolve(!1);c("TimelineWindow: starting request");const a=this.client.paginateEventTimeline(i.timeline,{backwards:e==o.EventTimeline.BACKWARDS,limit:t}).finally((function(){i.pendingPaginate=null})).then((n=>(c("TimelineWindow: request completed with result "+n),!!n&&this.paginate(e,t,!0,r-1))));return i.pendingPaginate=a,a}unpaginate(e,t){const n=t?this.start:this.end;if(e>this.eventCount||e<0)throw new Error("Attemting to unpaginate "+e+" events, but only have "+this.eventCount+" in the timeline");while(e>0){const r=t?n.advance(e):n.retreat(e);if(r<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=r,this.eventCount-=r,c("TimelineWindow.unpaginate: dropped "+r+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];const e=[];let t=this.start.timeline;while(1){const n=t.getEvents();let r=0,i=n.length;t===this.start.timeline&&(r=this.start.index+t.getBaseIndex()),t===this.end.timeline&&(i=this.end.index+t.getBaseIndex());for(let t=r;t<i;t++)e.push(n[t]);if(t===this.end.timeline)break;t=t.getNeighbouringTimeline(o.EventTimeline.FORWARDS)}return e}}t.TimelineWindow=d;class u{constructor(e,t){this.timeline=e,this.index=t,(0,i.default)(this,"pendingPaginate",void 0)}minIndex(){return-1*this.timeline.getBaseIndex()}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;let t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;const n=this.timeline.getNeighbouringTimeline(e<0?o.EventTimeline.BACKWARDS:o.EventTimeline.FORWARDS);return n?(this.timeline=n,this.index=e<0?this.maxIndex():this.minIndex(),c("paginate: switched to new neighbour"),this.advance(e)):0}retreat(e){return-1*this.advance(-1*e)}}t.TimelineIndex=u},3926:function(e,t,n){"use strict";n(1703);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_ALPHABET=void 0,t.alphabetPad=L,t.averageBetweenStrings=j,t.baseToString=N,t.checkObjectHasKeys=h,t.chunkPromises=C,t.compare=$,t.decodeParams=c,t.deepCompare=p,t.deepCopy=g,t.deepSortedObjectEntries=f,t.defer=R,t.encodeParams=a,t.encodeUri=l,t.ensureNoTrailingSlash=_,t.escapeRegExp=b,t.getCrypto=A,t.globToRegexp=w,t.isFunction=u,t.isNullOrUndefined=I,t.isNumber=y,t.lexicographicCompare=F,t.nextString=x,t.normalize=E,t.prevString=K,t.promiseMapSeries=k,t.promiseTry=O,t.recursivelyAssign=V,t.removeDirectionOverrideChars=v,t.removeElement=d,t.removeHiddenChars=m,t.setCrypto=D,t.simpleRetryOperation=P,t.sleep=T,t.sortEventsByLatestContentTimestamp=W,t.stringToBase=B;var i=r(n(3732)),o=r(n(9437)),s=n(3786);function a(e){const t=new URLSearchParams;for(const[n,r]of Object.entries(e))void 0!==r&&null!==r&&t.set(n,String(r));return t.toString()}function c(e){const t={},n=new URLSearchParams(e);for(const r of n.keys()){const e=n.getAll(r);t[r]=1===e.length?e[0]:e}return t}function l(e,t){for(const n in t)t.hasOwnProperty(n)&&(e=e.replace(n,encodeURIComponent(t[n])));return e}function d(e,t,n){let r;if(n){for(r=e.length-1;r>=0;r--)if(t(e[r],r,e))return e.splice(r,1),!0}else for(r=0;r<e.length;r++)if(t(e[r],r,e))return e.splice(r,1),!0;return!1}function u(e){return"[object Function]"===Object.prototype.toString.call(e)}function h(e,t){for(let n=0;n<t.length;n++)if(!e.hasOwnProperty(t[n]))throw new Error("Missing required key: "+t[n])}function g(e){return JSON.parse(JSON.stringify(e))}function p(e,t){if(e===t)return!0;if(typeof e!==typeof t)return!1;if("number"===typeof e&&isNaN(e)&&isNaN(t))return!0;if(null===e||null===t)return e===t;if(!(e instanceof Object))return!1;if(e.constructor!==t.constructor||e.prototype!==t.prototype)return!1;if(e instanceof RegExp||e instanceof Date)return e.toString()===t.toString();if(e instanceof Array){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!p(e[n],t[n]))return!1}else{let n;for(n in t)if(t.hasOwnProperty(n)!==e.hasOwnProperty(n))return!1;for(n in t){if(t.hasOwnProperty(n)!==e.hasOwnProperty(n))return!1;if(!p(e[n],t[n]))return!1}}return!0}function f(e){if("object"!==typeof e)return e;if(null===e||void 0===e||Array.isArray(e))return e;const t=[];for(const[n,r]of Object.entries(e))t.push([n,f(r)]);return t.sort(((e,t)=>F(e[0],t[0]))),t}function y(e){return"number"===typeof e&&isFinite(e)}function m(e){return"string"===typeof e?(0,i.default)(e.normalize("NFD").replace(S,"")):""}function v(e){return"string"===typeof e?e.replace(/[\u202d-\u202e]/g,""):""}function E(e){return m(e.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}const S=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\s]/g;function b(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function w(e,t){t="boolean"!==typeof t||t;let n=b(e);return n=n.replace(/\\\*/g,".*"),n=n.replace(/\?/g,"."),t&&(n=n.replace(/\\\[(!|)(.*)\\]/g,(function(e,t,n,r,i){const o=t?"^":"",s=n.replace(/\\-/,"-");return"["+o+s+"]"}))),n}function _(e){return e&&e.endsWith("/")?e.slice(0,-1):e}function T(e,t){return new Promise((n=>{setTimeout(n,e,t)}))}function I(e){return null===e||void 0===e}function R(){let e,t;const n=new Promise(((n,r)=>{e=n,t=r}));return{resolve:e,reject:t,promise:n}}async function k(e,t){for(const n of e)await t(await n)}function O(e){return Promise.resolve(e())}async function C(e,t){const n=[];for(let r=0;r<e.length;r+=t)n.push(...await Promise.all(e.slice(r,r+t).map((e=>e()))));return n}function P(e){return(0,o.default)((t=>e(t)),{forever:!0,factor:2,minTimeout:3e3,maxTimeout:15e3})}let M;function D(e){M=e}function A(){return M}const U=(()=>{let e="";for(let t=32;t<=126;t++)e+=String.fromCharCode(t);return e})();function L(e,t,n=U){return e.padEnd(t,n[0])}function N(e,t=U){const n=BigInt(t.length);var r;if(e<=n)return null!==(r=t[Number(e)-1])&&void 0!==r?r:"";let i=e/n,o=Number(e%n)-1;return o<0&&(i-=BigInt(Math.abs(o)),o=Number(n)-1),N(i,t)+t[o]}function B(e,t=U){const n=BigInt(t.length);let r=BigInt(0);for(let i=e.length-1,o=BigInt(0);i>=0;i--,o++){const s=e.charCodeAt(i)-t.charCodeAt(0);r+=BigInt(1+s)*n**o}return r}function j(e,t,n=U){const r=Math.max(e.length,t.length),i=B(L(e,r,n),n),o=B(L(t,r,n),n),s=(i+o)/BigInt(2);return s===i||s==o?N(s,n)+n[0]:N(s,n)}function x(e,t=U){return N(B(e,t)+BigInt(1),t)}function K(e,t=U){return N(B(e,t)-BigInt(1),t)}function F(e,t){return e<t?-1:e>t?1:0}t.DEFAULT_ALPHABET=U;const q=new Intl.Collator;function $(e,t){return q.compare(e,t)}function V(e,t,n=!1){for(const[r,i]of Object.entries(t))e[r]instanceof Object&&i?V(e[r],i):(null!==i&&void 0!==i||!n)&&(e[r]=i);return e}function G(e){var t;return null!==(t=s.M_TIMESTAMP.findIn(e.getContent()))&&void 0!==t?t:-1}function W(e,t){return G(t)-G(e)}},9393:function(e,t,n){"use strict";n(1703),n(6699);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixCall=t.CallType=t.CallState=t.CallParty=t.CallEvent=t.CallErrorCode=t.CallError=t.CallDirection=void 0,t.createNewMatrixCall=O,t.supportsMatrixCall=k;var i=r(n(4344)),o=n(6471),s=g(n(3926)),a=n(7778),c=n(5789),l=n(1559),d=n(5561),u=n(9392);function h(e){if("function"!==typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(h=function(e){return e?n:t})(e)}function g(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var n=h(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}let p,f,y,m,v,E;t.CallState=p,function(e){e["Fledgling"]="fledgling",e["InviteSent"]="invite_sent",e["WaitLocalMedia"]="wait_local_media",e["CreateOffer"]="create_offer",e["CreateAnswer"]="create_answer",e["Connecting"]="connecting",e["Connected"]="connected",e["Ringing"]="ringing",e["Ended"]="ended"}(p||(t.CallState=p={})),t.CallType=f,function(e){e["Voice"]="voice",e["Video"]="video"}(f||(t.CallType=f={})),t.CallDirection=y,function(e){e["Inbound"]="inbound",e["Outbound"]="outbound"}(y||(t.CallDirection=y={})),t.CallParty=m,function(e){e["Local"]="local",e["Remote"]="remote"}(m||(t.CallParty=m={})),t.CallEvent=v,function(e){e["Hangup"]="hangup",e["State"]="state",e["Error"]="error",e["Replaced"]="replaced",e["LocalHoldUnhold"]="local_hold_unhold",e["RemoteHoldUnhold"]="remote_hold_unhold",e["HoldUnhold"]="hold_unhold",e["FeedsChanged"]="feeds_changed",e["AssertedIdentityChanged"]="asserted_identity_changed",e["LengthChanged"]="length_changed",e["DataChannel"]="datachannel"}(v||(t.CallEvent=v={})),t.CallErrorCode=E,function(e){e["UserHangup"]="user_hangup",e["LocalOfferFailed"]="local_offer_failed",e["NoUserMedia"]="no_user_media",e["UnknownDevices"]="unknown_devices",e["SendInvite"]="send_invite",e["CreateAnswer"]="create_answer",e["SendAnswer"]="send_answer",e["SetRemoteDescription"]="set_remote_description",e["SetLocalDescription"]="set_local_description",e["AnsweredElsewhere"]="answered_elsewhere",e["IceFailed"]="ice_failed",e["InviteTimeout"]="invite_timeout",e["Replaced"]="replaced",e["SignallingFailed"]="signalling_timeout",e["UserBusy"]="user_busy",e["Transfered"]="transferred"}(E||(t.CallErrorCode=E={}));const S="1",b="stun:turn.matrix.org",w=6e4;class _ extends Error{constructor(e,t,n){super(t+": "+n),(0,i.default)(this,"code",void 0),this.code=e}}function T(){return Date.now().toString()+(0,c.randomString)(16)}t.CallError=_;class I extends u.TypedEventEmitter{constructor(e){super(),(0,i.default)(this,"roomId",void 0),(0,i.default)(this,"callId",void 0),(0,i.default)(this,"state",p.Fledgling),(0,i.default)(this,"hangupParty",void 0),(0,i.default)(this,"hangupReason",void 0),(0,i.default)(this,"direction",void 0),(0,i.default)(this,"ourPartyId",void 0),(0,i.default)(this,"client",void 0),(0,i.default)(this,"forceTURN",void 0),(0,i.default)(this,"turnServers",void 0),(0,i.default)(this,"candidateSendQueue",[]),(0,i.default)(this,"candidateSendTries",0),(0,i.default)(this,"sentEndOfCandidates",!1),(0,i.default)(this,"peerConn",void 0),(0,i.default)(this,"feeds",[]),(0,i.default)(this,"usermediaSenders",[]),(0,i.default)(this,"screensharingSenders",[]),(0,i.default)(this,"inviteOrAnswerSent",!1),(0,i.default)(this,"waitForLocalAVStream",void 0),(0,i.default)(this,"successor",void 0),(0,i.default)(this,"opponentMember",void 0),(0,i.default)(this,"opponentVersion",void 0),(0,i.default)(this,"opponentPartyId",void 0),(0,i.default)(this,"opponentCaps",void 0),(0,i.default)(this,"inviteTimeout",void 0),(0,i.default)(this,"remoteOnHold",!1),(0,i.default)(this,"callStatsAtEnd",void 0),(0,i.default)(this,"makingOffer",!1),(0,i.default)(this,"ignoreOffer",void 0),(0,i.default)(this,"remoteCandidateBuffer",new Map),(0,i.default)(this,"remoteAssertedIdentity",void 0),(0,i.default)(this,"remoteSDPStreamMetadata",void 0),(0,i.default)(this,"callLengthInterval",void 0),(0,i.default)(this,"callLength",0),(0,i.default)(this,"gotLocalIceCandidate",(e=>{if(e.candidate){if(o.logger.debug("Call "+this.callId+" got local ICE "+e.candidate.sdpMid+" candidate: "+e.candidate.candidate),this.callHasEnded())return;""===e.candidate.candidate&&this.sentEndOfCandidates||(this.queueCandidate(e.candidate),""===e.candidate.candidate&&(this.sentEndOfCandidates=!0))}})),(0,i.default)(this,"onIceGatheringStateChange",(e=>{if(o.logger.debug("ice gathering state changed to "+this.peerConn.iceGatheringState),"complete"===this.peerConn.iceGatheringState&&!this.sentEndOfCandidates){const e={candidate:""};this.queueCandidate(e),this.sentEndOfCandidates=!0}})),(0,i.default)(this,"gotLocalOffer",(async e=>{if(o.logger.debug("Created offer: ",e),this.callHasEnded())return void o.logger.debug("Ignoring newly created offer on call ID "+this.callId+" because the call has ended");try{await this.peerConn.setLocalDescription(e)}catch(r){return o.logger.debug("Error setting local description!",r),void this.terminate(m.Local,E.SetLocalDescription,!0)}if("gathering"===this.peerConn.iceGatheringState&&await new Promise((e=>{setTimeout(e,200)})),this.callHasEnded())return;const t=this.state===p.CreateOffer?a.EventType.CallInvite:a.EventType.CallNegotiate,n={lifetime:w};this.state===p.CreateOffer?n.offer=this.peerConn.localDescription:n.description=this.peerConn.localDescription,n.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1},n[l.SDPStreamMetadataKey]=this.getLocalSDPStreamMetadata(),o.logger.info(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in offer`),this.candidateSendQueue=[];try{await this.sendVoipEvent(t,n)}catch(i){o.logger.error("Failed to send invite",i),i.event&&this.client.cancelPendingEvent(i.event);let e=E.SignallingFailed,t="Signalling failed";return this.state===p.CreateOffer&&(e=E.SendInvite,t="Failed to send invite"),"UnknownDeviceError"==i.name&&(e=E.UnknownDevices,t="Unknown devices present in the room"),this.emit(v.Error,new _(e,t,i)),void this.terminate(m.Local,e,!1)}this.sendCandidateQueue(),this.state===p.CreateOffer&&(this.inviteOrAnswerSent=!0,this.setState(p.InviteSent),this.inviteTimeout=setTimeout((()=>{this.inviteTimeout=null,this.state===p.InviteSent&&this.hangup(E.InviteTimeout,!1)}),w))})),(0,i.default)(this,"getLocalOfferFailed",(e=>{o.logger.error("Failed to get local offer",e),this.emit(v.Error,new _(E.LocalOfferFailed,"Failed to get local offer!",e)),this.terminate(m.Local,E.LocalOfferFailed,!1)})),(0,i.default)(this,"getUserMediaFailed",(e=>{this.successor?this.successor.getUserMediaFailed(e):(o.logger.warn("Failed to get user media - ending call",e),this.emit(v.Error,new _(E.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",e)),this.terminate(m.Local,E.NoUserMedia,!1))})),(0,i.default)(this,"onIceConnectionStateChanged",(()=>{this.callHasEnded()||(o.logger.debug("Call ID "+this.callId+": ICE connection state changed to: "+this.peerConn.iceConnectionState),"connected"==this.peerConn.iceConnectionState?(this.setState(p.Connected),this.callLengthInterval||(this.callLengthInterval=setInterval((()=>{this.callLength++,this.emit(v.LengthChanged,this.callLength)}),1e3))):"failed"==this.peerConn.iceConnectionState&&this.hangup(E.IceFailed,!1))})),(0,i.default)(this,"onSignallingStateChanged",(()=>{o.logger.debug("call "+this.callId+": Signalling state changed to: "+this.peerConn.signalingState)})),(0,i.default)(this,"onTrack",(e=>{if(0===e.streams.length)return void o.logger.warn(`Streamless ${e.track.kind} found: ignoring.`);const t=e.streams[0];this.pushRemoteFeed(t),t.addEventListener("removetrack",(()=>{0===t.getTracks().length&&(o.logger.info(`Stream ID ${t.id} has no tracks remaining - removing`),this.deleteFeedByStream(t))}))})),(0,i.default)(this,"onDataChannel",(e=>{this.emit(v.DataChannel,e.channel)})),(0,i.default)(this,"onNegotiationNeeded",(async()=>{if(o.logger.info("Negotiation is needed!"),this.state===p.CreateOffer||0!==this.opponentVersion){this.makingOffer=!0;try{this.getRidOfRTXCodecs();const e=await this.peerConn.createOffer();await this.gotLocalOffer(e)}catch(e){return void this.getLocalOfferFailed(e)}finally{this.makingOffer=!1}}else o.logger.info("Opponent does not support renegotiation: ignoring negotiationneeded event")})),(0,i.default)(this,"onHangupReceived",(e=>{o.logger.debug("Hangup received for call ID "+this.callId),this.partyIdMatches(e)||this.state===p.Ringing?this.terminate(m.Remote,e.reason||E.UserHangup,!0):o.logger.info(`Ignoring message from party ID ${e.party_id}: our partner is ${this.opponentPartyId}`)})),(0,i.default)(this,"onRejectReceived",(e=>{o.logger.debug("Reject received for call ID "+this.callId);const t=[p.InviteSent,p.Ringing].includes(this.state)||this.state===p.Fledgling&&this.direction===y.Inbound;t?this.terminate(m.Remote,e.reason||E.UserHangup,!0):o.logger.debug(`Call is in state: ${this.state}: ignoring reject`)})),(0,i.default)(this,"onAnsweredElsewhere",(e=>{o.logger.debug("Call ID "+this.callId+" answered elsewhere"),this.terminate(m.Remote,E.AnsweredElsewhere,!0)})),this.roomId=e.roomId,this.client=e.client,this.forceTURN=e.forceTURN,this.ourPartyId=this.client.deviceId,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[b]});for(const t of this.turnServers)s.checkObjectHasKeys(t,["urls"]);this.callId=T()}async placeVoiceCall(){await this.placeCall(!0,!1)}async placeVideoCall(){await this.placeCall(!0,!0)}createDataChannel(e,t){const n=this.peerConn.createDataChannel(e,t);return this.emit(v.DataChannel,n),o.logger.debug("created data channel"),n}getOpponentMember(){return this.opponentMember}opponentCanBeTransferred(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get type(){return this.hasLocalUserMediaVideoTrack||this.hasRemoteUserMediaVideoTrack?f.Video:f.Voice}get hasLocalUserMediaVideoTrack(){var e;return(null===(e=this.localUsermediaStream)||void 0===e?void 0:e.getVideoTracks().length)>0}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some((e=>e.purpose===l.SDPStreamMetadataPurpose.Usermedia&&e.stream.getVideoTracks().length>0))}get hasLocalUserMediaAudioTrack(){var e;return(null===(e=this.localUsermediaStream)||void 0===e?void 0:e.getAudioTracks().length)>0}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some((e=>e.purpose===l.SDPStreamMetadataPurpose.Usermedia&&e.stream.getAudioTracks().length>0))}get localUsermediaFeed(){return this.getLocalFeeds().find((e=>e.purpose===l.SDPStreamMetadataPurpose.Usermedia))}get localScreensharingFeed(){return this.getLocalFeeds().find((e=>e.purpose===l.SDPStreamMetadataPurpose.Screenshare))}get localUsermediaStream(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.stream}get localScreensharingStream(){var e;return null===(e=this.localScreensharingFeed)||void 0===e?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find((e=>e.purpose===l.SDPStreamMetadataPurpose.Usermedia))}get remoteScreensharingFeed(){return this.getRemoteFeeds().find((e=>e.purpose===l.SDPStreamMetadataPurpose.Screenshare))}get remoteUsermediaStream(){var e;return null===(e=this.remoteUsermediaFeed)||void 0===e?void 0:e.stream}get remoteScreensharingStream(){var e;return null===(e=this.remoteScreensharingFeed)||void 0===e?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find((t=>t.stream.id===e))}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter((e=>e.isLocal()))}getRemoteFeeds(){return this.feeds.filter((e=>!e.isLocal()))}getLocalSDPStreamMetadata(){const e={};for(const t of this.getLocalFeeds())e[t.stream.id]={purpose:t.purpose,audio_muted:t.isAudioMuted(),video_muted:t.isVideoMuted()};return o.logger.debug("Got local SDPStreamMetadata",e),e}noIncomingFeeds(){return!this.feeds.some((e=>!e.isLocal()))}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata())return void this.pushRemoteFeedWithoutMetadata(e);const t=this.getOpponentMember().userId,n=this.remoteSDPStreamMetadata[e.id].purpose,r=this.remoteSDPStreamMetadata[e.id].audio_muted,i=this.remoteSDPStreamMetadata[e.id].video_muted;if(!n)return void o.logger.warn(`Ignoring stream with id ${e.id} because we didn't get any metadata about it`);const s=this.getRemoteFeeds().find((e=>e.purpose===n));s?s.setNewStream(e):(this.feeds.push(new d.CallFeed({client:this.client,roomId:this.roomId,userId:t,stream:e,purpose:n,audioMuted:r,videoMuted:i})),this.emit(v.FeedsChanged,this.feeds)),o.logger.info(`Pushed remote stream (id="${e.id}", active="${e.active}", purpose=${n})`)}pushRemoteFeedWithoutMetadata(e){var t;const n=this.getOpponentMember().userId,r=l.SDPStreamMetadataPurpose.Usermedia,i=null===(t=this.feeds.find((e=>!e.isLocal())))||void 0===t?void 0:t.stream;if(i&&e.id!==i.id)return void o.logger.warn(`Ignoring new stream ID ${e.id}: we already have stream ID ${i.id}`);const s=this.getFeedByStreamId(e.id);s?s.setNewStream(e):(this.feeds.push(new d.CallFeed({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,stream:e,purpose:r})),this.emit(v.FeedsChanged,this.feeds)),o.logger.info(`Pushed remote stream (id="${e.id}", active="${e.active}")`)}pushNewLocalFeed(e,t,n=!0){const r=this.client.getUserId();R(e.getAudioTracks(),!0),R(e.getVideoTracks(),!0);const i=this.getLocalFeeds().find((e=>e.purpose===t));i?i.setNewStream(e):(this.pushLocalFeed(new d.CallFeed({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:r,stream:e,purpose:t}),n),this.emit(v.FeedsChanged,this.feeds))}pushLocalFeed(e,t=!0){if(this.feeds.push(e),t){const t=e.purpose===l.SDPStreamMetadataPurpose.Usermedia?this.usermediaSenders:this.screensharingSenders;t.splice(0,t.length);for(const n of e.stream.getTracks())o.logger.info(`Adding track (id="${n.id}", kind="${n.kind}", streamId="${e.stream.id}", streamPurpose="${e.purpose}", enabled=${n.enabled}) to peer connection`),t.push(this.peerConn.addTrack(n,e.stream))}o.logger.info(`Pushed local stream (id="${e.stream.id}", active="${e.stream.active}", purpose="${e.purpose}")`),this.emit(v.FeedsChanged,this.feeds)}removeLocalFeed(e){const t=e.purpose===l.SDPStreamMetadataPurpose.Usermedia?this.usermediaSenders:this.screensharingSenders;for(const n of t)this.peerConn.removeTrack(n);t.splice(0,t.length),this.deleteFeedByStream(e.stream)}deleteAllFeeds(){for(const e of this.feeds)e.dispose();this.feeds=[],this.emit(v.FeedsChanged,this.feeds)}deleteFeedByStream(e){o.logger.debug(`Removing feed with stream id ${e.id}`);const t=this.getFeedByStreamId(e.id);t?(t.dispose(),this.feeds.splice(this.feeds.indexOf(t),1),this.emit(v.FeedsChanged,this.feeds)):o.logger.warn(`Didn't find the feed with stream id ${e.id} to delete`)}async getCurrentCallStats(){return this.callHasEnded()?this.callStatsAtEnd:this.collectCallStats()}async collectCallStats(){if(!this.peerConn)return;const e=await this.peerConn.getStats(),t=[];return e.forEach((e=>{t.push(e)})),t}async initWithInvite(e){var t;const n=e.getContent();this.direction=y.Inbound;const r=await this.client.checkTurnServers();r||o.logger.warn("Failed to get TURN credentials! Proceeding with call anyway...");const i=n[l.SDPStreamMetadataKey];i?this.updateRemoteSDPStreamMetadata(i):o.logger.debug("Did not get any SDPStreamMetadata! Can not send/receive multiple streams"),this.peerConn=this.createPeerConnection(),this.chooseOpponent(e);try{await this.peerConn.setRemoteDescription(n.offer),await this.addBufferedIceCandidates()}catch(a){return o.logger.debug("Failed to set remote description",a),void this.terminate(m.Local,E.SetRemoteDescription,!1)}const s=null===(t=this.feeds.find((e=>!e.isLocal())))||void 0===t?void 0:t.stream;if(!s||0===s.getTracks().length)return o.logger.error("No remote stream or no tracks after setting remote description!"),void this.terminate(m.Local,E.SetRemoteDescription,!1);this.setState(p.Ringing),e.getLocalAge()&&setTimeout((()=>{this.state==p.Ringing&&(o.logger.debug("Call invite has expired. Hanging up."),this.hangupParty=m.Remote,this.setState(p.Ended),this.stopAllMedia(),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),this.emit(v.Hangup))}),n.lifetime-e.getLocalAge())}initWithHangup(e){this.setState(p.Ended)}shouldAnswerWithMediaType(e,t,n){return e&&!t?(o.logger.warn(`Unable to answer with ${n} because the other side isn't sending it either.`),!1):s.isNullOrUndefined(e)||e===t||this.opponentSupportsSDPStreamMetadata()?null!==e&&void 0!==e?e:t:(o.logger.warn(`Unable to answer with ${n}=${e} because the other side doesn't support it. Answering with ${n}=${t}.`),t)}async answer(e,t){if(!this.inviteOrAnswerSent){if(!1===e&&!1===t)throw new Error("You CANNOT answer a call without media");if(o.logger.debug(`Answering call ${this.callId}`),this.localUsermediaStream||this.waitForLocalAVStream)this.waitForLocalAVStream&&this.setState(p.WaitLocalMedia);else{const r=this.state,i=this.shouldAnswerWithMediaType(e,this.hasRemoteUserMediaAudioTrack,"audio"),s=this.shouldAnswerWithMediaType(t,this.hasRemoteUserMediaVideoTrack,"video");this.setState(p.WaitLocalMedia),this.waitForLocalAVStream=!0;try{const e=await this.client.getMediaHandler().getUserMediaStream(i,s);this.waitForLocalAVStream=!1;const t=new d.CallFeed({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),stream:e,purpose:l.SDPStreamMetadataPurpose.Usermedia,audioMuted:!1,videoMuted:!1}),n=[t];this.localScreensharingFeed&&n.push(this.localScreensharingFeed),this.answerWithCallFeeds(n)}catch(n){if(!s)return void this.getUserMediaFailed(n);o.logger.warn("Failed to getUserMedia(), trying to getUserMedia() without video"),this.setState(r),this.waitForLocalAVStream=!1,await this.answer(i,!1)}}}}answerWithCallFeeds(e){this.inviteOrAnswerSent||(o.logger.debug(`Answering call ${this.callId}`),this.gotCallFeedsForAnswer(e))}replacedBy(e){this.state===p.WaitLocalMedia?(o.logger.debug("Telling new call to wait for local media"),e.waitForLocalAVStream=!0):[p.CreateOffer,p.InviteSent].includes(this.state)&&(o.logger.debug("Handing local stream to new call"),e.gotCallFeedsForAnswer(this.getLocalFeeds())),this.successor=e,this.emit(v.Replaced,e),this.hangup(E.Replaced,!0)}hangup(e,t){if(this.callHasEnded())return;if(o.logger.debug("Ending call "+this.callId),this.terminate(m.Local,e,!t),this.state===p.WaitLocalMedia)return;const n={};(this.opponentVersion&&0!==this.opponentVersion||e!==E.UserHangup)&&(n["reason"]=e),this.sendVoipEvent(a.EventType.CallHangup,n)}reject(){if(this.state!==p.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(0===this.opponentVersion)return o.logger.info(`Opponent version is less than 1 (${this.opponentVersion}): sending hangup instead of reject`),void this.hangup(E.UserHangup,!0);o.logger.debug("Rejecting call: "+this.callId),this.terminate(m.Local,E.UserHangup,!0),this.sendVoipEvent(a.EventType.CallReject,{})}async upgradeCall(e,t){if((e||t)&&this.opponentSupportsSDPStreamMetadata())try{const n=e||this.hasLocalUserMediaAudioTrack,r=t||this.hasLocalUserMediaVideoTrack,i=await this.client.getMediaHandler().getUserMediaStream(n,r,!1);await this.updateLocalUsermediaStream(i,e,t)}catch(n){o.logger.error("Failed to upgrade the call",n),this.emit(v.Error,new _(E.NoUserMedia,"Failed to get camera access: ",n))}}opponentSupportsSDPStreamMetadata(){return Boolean(this.remoteSDPStreamMetadata)}isScreensharing(){return Boolean(this.localScreensharingStream)}async setScreensharingEnabled(e,t){if(e&&this.isScreensharing())return o.logger.warn("There is already a screensharing stream - there is nothing to do!"),!0;if(!e&&!this.isScreensharing())return o.logger.warn("There already isn't a screensharing stream - there is nothing to do!"),!1;if(!this.opponentSupportsSDPStreamMetadata())return this.setScreensharingEnabledWithoutMetadataSupport(e,t);if(o.logger.debug(`Set screensharing enabled? ${e}`),!e){for(const e of this.screensharingSenders)this.peerConn.removeTrack(e);return this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}try{const e=await this.client.getMediaHandler().getScreensharingStream(t);return!!e&&(this.pushNewLocalFeed(e,l.SDPStreamMetadataPurpose.Screenshare),!0)}catch(n){return o.logger.error("Failed to get screen-sharing stream:",n),!1}}async setScreensharingEnabledWithoutMetadataSupport(e,t){if(o.logger.debug(`Set screensharing enabled? ${e} using replaceTrack()`),!e){const e=this.localUsermediaStream.getTracks().find((e=>"video"===e.kind)),t=this.usermediaSenders.find((e=>{var t;return"video"===(null===(t=e.track)||void 0===t?void 0:t.kind)}));return t.replaceTrack(e),this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}try{const e=await this.client.getMediaHandler().getScreensharingStream(t);if(!e)return!1;const n=e.getTracks().find((e=>"video"===e.kind)),r=this.usermediaSenders.find((e=>{var t;return"video"===(null===(t=e.track)||void 0===t?void 0:t.kind)}));return r.replaceTrack(n),this.pushNewLocalFeed(e,l.SDPStreamMetadataPurpose.Screenshare,!1),!0}catch(n){return o.logger.error("Failed to get screen-sharing stream:",n),!1}}async updateLocalUsermediaStream(e,t=!1,n=!1){const r=this.localUsermediaFeed,i=t||!r.isAudioMuted()&&!this.remoteOnHold,s=n||!r.isVideoMuted()&&!this.remoteOnHold;R(e.getAudioTracks(),i),R(e.getVideoTracks(),s);for(const o of this.localUsermediaStream.getTracks())this.localUsermediaStream.removeTrack(o),o.stop();for(const o of e.getTracks())this.localUsermediaStream.addTrack(o);const a=[];for(const c of e.getTracks()){const t=this.usermediaSenders.find((e=>{var t;return(null===(t=e.track)||void 0===t?void 0:t.kind)===c.kind}));let n;t?(o.logger.info(`Replacing track (id="${c.id}", kind="${c.kind}", streamId="${e.id}", streamPurpose="${r.purpose}") to peer connection`),await t.replaceTrack(c),n=t):(o.logger.info(`Adding track (id="${c.id}", kind="${c.kind}", streamId="${e.id}", streamPurpose="${r.purpose}") to peer connection`),n=this.peerConn.addTrack(c,this.localUsermediaStream)),a.push(n)}this.usermediaSenders=a}async setLocalVideoMuted(e){var t;return await this.client.getMediaHandler().hasVideoDevice()?this.hasLocalUserMediaVideoTrack||e?(null===(t=this.localUsermediaFeed)||void 0===t||t.setVideoMuted(e),this.updateMuteStatus(),this.isLocalVideoMuted()):(await this.upgradeCall(!1,!0),this.isLocalVideoMuted()):this.isLocalVideoMuted()}isLocalVideoMuted(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.isVideoMuted()}async setMicrophoneMuted(e){var t;return await this.client.getMediaHandler().hasAudioDevice()?this.hasLocalUserMediaAudioTrack||e?(null===(t=this.localUsermediaFeed)||void 0===t||t.setAudioMuted(e),this.updateMuteStatus(),this.isMicrophoneMuted()):(await this.upgradeCall(!0,!1),this.isMicrophoneMuted()):this.isMicrophoneMuted()}isMicrophoneMuted(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.isAudioMuted()}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(const t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.emit(v.RemoteHoldUnhold,this.remoteOnHold)}}isLocalOnHold(){if(this.state!==p.Connected)return!1;let e=!0;for(const t of this.peerConn.getTransceivers()){const n=["inactive","recvonly"].includes(t.currentDirection);n||(e=!1)}return e}sendDtmfDigit(e){for(const t of this.peerConn.getSenders())if("audio"===t.track.kind&&t.dtmf)return void t.dtmf.insertDTMF(e);throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){this.sendVoipEvent(a.EventType.CallSDPStreamMetadataChangedPrefix,{[l.SDPStreamMetadataKey]:this.getLocalSDPStreamMetadata()});const e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;R(this.localUsermediaStream.getAudioTracks(),!e),R(this.localUsermediaStream.getVideoTracks(),!t)}gotCallFeedsForInvite(e){if(this.successor)this.successor.gotCallFeedsForAnswer(e);else if(this.callHasEnded())this.stopAllMedia();else{for(const t of e)this.pushLocalFeed(t);this.setState(p.CreateOffer),o.logger.debug("gotUserMediaForInvite")}}async sendAnswer(){const e={answer:{sdp:this.peerConn.localDescription.sdp,type:this.peerConn.localDescription.type},[l.SDPStreamMetadataKey]:this.getLocalSDPStreamMetadata()};e.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1},o.logger.info(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in answer`),this.candidateSendQueue=[];try{await this.sendVoipEvent(a.EventType.CallAnswer,e),this.inviteOrAnswerSent=!0}catch(t){this.setState(p.Ringing),this.client.cancelPendingEvent(t.event);let e=E.SendAnswer,n="Failed to send answer";throw"UnknownDeviceError"==t.name&&(e=E.UnknownDevices,n="Unknown devices present in the room"),this.emit(v.Error,new _(e,n,t)),t}this.sendCandidateQueue()}async gotCallFeedsForAnswer(e){if(this.callHasEnded())return;this.waitForLocalAVStream=!1;for(const r of e)this.pushLocalFeed(r);let t;this.setState(p.CreateAnswer);try{this.getRidOfRTXCodecs(),t=await this.peerConn.createAnswer()}catch(n){return o.logger.debug("Failed to create answer: ",n),void this.terminate(m.Local,E.CreateAnswer,!0)}try{await this.peerConn.setLocalDescription(t),this.setState(p.Connecting),await new Promise((e=>{setTimeout(e,200)})),this.sendAnswer()}catch(n){return o.logger.debug("Error setting local description!",n),void this.terminate(m.Local,E.SetLocalDescription,!0)}}async onRemoteIceCandidatesReceived(e){if(this.callHasEnded())return;const t=e.getContent(),n=t.candidates;if(!n)return void o.logger.info("Ignoring candidates event with no candidates!");const r=0===t.version?null:t.party_id||null;if(void 0===this.opponentPartyId){o.logger.info(`Buffering ${n.length} candidates until we pick an opponent`);const e=this.remoteCandidateBuffer.get(r)||[];return e.push(...n),void this.remoteCandidateBuffer.set(r,e)}this.partyIdMatches(t)?await this.addIceCandidates(n):o.logger.info(`Ignoring candidates from party ID ${t.party_id}: we have chosen party ID ${this.opponentPartyId}`)}async onAnswerReceived(e){const t=e.getContent();if(o.logger.debug(`Got answer for call ID ${this.callId} from party ID ${t.party_id}`),this.callHasEnded())return void o.logger.debug(`Ignoring answer because call ID ${this.callId} has ended`);if(void 0!==this.opponentPartyId)return void o.logger.info(`Ignoring answer from party ID ${t.party_id}: we already have an answer/reject from ${this.opponentPartyId}`);this.chooseOpponent(e),await this.addBufferedIceCandidates(),this.setState(p.Connecting);const n=t[l.SDPStreamMetadataKey];n?this.updateRemoteSDPStreamMetadata(n):o.logger.warn("Did not get any SDPStreamMetadata! Can not send/receive multiple streams");try{await this.peerConn.setRemoteDescription(t.answer)}catch(r){return o.logger.debug("Failed to set remote description",r),void this.terminate(m.Local,E.SetRemoteDescription,!1)}if(null!==this.opponentPartyId)try{await this.sendVoipEvent(a.EventType.CallSelectAnswer,{selected_party_id:this.opponentPartyId})}catch(i){o.logger.warn("Failed to send select_answer event",i)}}async onSelectAnswerReceived(e){if(this.direction!==y.Inbound)return void o.logger.warn("Got select_answer for an outbound call: ignoring");const t=e.getContent().selected_party_id;void 0!==t&&null!==t?t!==this.ourPartyId&&(o.logger.info(`Got select_answer for party ID ${t}: we are party ID ${this.ourPartyId}.`),await this.terminate(m.Remote,E.AnsweredElsewhere,!0)):o.logger.warn("Got nonsensical select_answer with null/undefined selected_party_id: ignoring")}async onNegotiateReceived(e){const t=e.getContent(),n=t.description;if(!n||!n.sdp||!n.type)return void o.logger.info("Ignoring invalid m.call.negotiate event");const r=this.direction===y.Inbound,i="offer"===n.type&&(this.makingOffer||"stable"!==this.peerConn.signalingState);if(this.ignoreOffer=!r&&i,this.ignoreOffer)return void o.logger.info("Ignoring colliding negotiate event because we're impolite");const s=this.isLocalOnHold(),c=t[l.SDPStreamMetadataKey];c?this.updateRemoteSDPStreamMetadata(c):o.logger.warn("Received negotiation event without SDPStreamMetadata!");try{if(await this.peerConn.setRemoteDescription(n),"offer"===n.type){this.getRidOfRTXCodecs();const e=await this.peerConn.createAnswer();await this.peerConn.setLocalDescription(e),this.sendVoipEvent(a.EventType.CallNegotiate,{description:this.peerConn.localDescription,[l.SDPStreamMetadataKey]:this.getLocalSDPStreamMetadata()})}}catch(u){o.logger.warn("Failed to complete negotiation",u)}const d=this.isLocalOnHold();s!==d&&(this.emit(v.LocalHoldUnhold,d),this.emit(v.HoldUnhold,d))}updateRemoteSDPStreamMetadata(e){this.remoteSDPStreamMetadata=s.recursivelyAssign(this.remoteSDPStreamMetadata||{},e,!0);for(const i of this.getRemoteFeeds()){var t,n,r;const e=i.stream.id;i.setAudioMuted(null===(t=this.remoteSDPStreamMetadata[e])||void 0===t?void 0:t.audio_muted),i.setVideoMuted(null===(n=this.remoteSDPStreamMetadata[e])||void 0===n?void 0:n.video_muted),i.purpose=null===(r=this.remoteSDPStreamMetadata[e])||void 0===r?void 0:r.purpose}}onSDPStreamMetadataChangedReceived(e){const t=e.getContent(),n=t[l.SDPStreamMetadataKey];this.updateRemoteSDPStreamMetadata(n)}async onAssertedIdentityReceived(e){const t=e.getContent();t.asserted_identity&&(this.remoteAssertedIdentity={id:t.asserted_identity.id,displayName:t.asserted_identity.display_name},this.emit(v.AssertedIdentityChanged))}callHasEnded(){return this.state===p.Ended}getRidOfRTXCodecs(){if(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)return;const e=RTCRtpReceiver.getCapabilities("video").codecs,t=RTCRtpSender.getCapabilities("video").codecs,n=[...t,...e];for(const o of n)if("video/rtx"===o.mimeType){const e=n.indexOf(o);n.splice(e,1)}for(const o of this.peerConn.getTransceivers()){var r,i;!this.screensharingSenders.includes(o.sender)||"video"!==(null===(r=o.sender.track)||void 0===r?void 0:r.kind)&&"video"!==(null===(i=o.receiver.track)||void 0===i?void 0:i.kind)||o.setCodecPreferences(n)}}setState(e){const t=this.state;this.state=e,this.emit(v.State,e,t)}sendVoipEvent(e,t){return this.client.sendEvent(this.roomId,e,Object.assign({},t,{version:S,call_id:this.callId,party_id:this.ourPartyId}))}queueCandidate(e){if(this.candidateSendQueue.push(e),this.state===p.Ringing||!this.inviteOrAnswerSent)return;const t=this.direction===y.Inbound?500:2e3;0===this.candidateSendTries&&setTimeout((()=>{this.sendCandidateQueue()}),t)}async transfer(e){const t=await this.client.getProfileInfo(e),n=T(),r={replacement_id:T(),target_user:{id:e,display_name:t.displayname,avatar_url:t.avatar_url},create_call:n};await this.sendVoipEvent(a.EventType.CallReplaces,r),await this.terminate(m.Local,E.Transfered,!0)}async transferToCall(e){const t=await this.client.getProfileInfo(e.getOpponentMember().userId),n=await this.client.getProfileInfo(this.getOpponentMember().userId),r=T(),i={replacement_id:T(),target_user:{id:this.getOpponentMember().userId,display_name:n.displayname,avatar_url:n.avatar_url},await_call:r};await e.sendVoipEvent(a.EventType.CallReplaces,i);const o={replacement_id:T(),target_user:{id:e.getOpponentMember().userId,display_name:t.displayname,avatar_url:t.avatar_url},create_call:r};await this.sendVoipEvent(a.EventType.CallReplaces,o),await this.terminate(m.Local,E.Transfered,!0),await e.terminate(m.Local,E.Transfered,!0)}async terminate(e,t,n){this.callHasEnded()||(this.callStatsAtEnd=await this.collectCallStats(),this.inviteTimeout&&(clearTimeout(this.inviteTimeout),this.inviteTimeout=null),this.callLengthInterval&&(clearInterval(this.callLengthInterval),this.callLengthInterval=null),t!==E.Replaced&&this.stopAllMedia(),this.deleteAllFeeds(),this.hangupParty=e,this.hangupReason=t,this.setState(p.Ended),this.peerConn&&"closed"!==this.peerConn.signalingState&&this.peerConn.close(),n&&this.emit(v.Hangup))}stopAllMedia(){o.logger.debug("Stopping all media for call",this.callId);for(const e of this.feeds)if(e.isLocal()&&e.purpose===l.SDPStreamMetadataPurpose.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===l.SDPStreamMetadataPurpose.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else{o.logger.debug("Stopping remote stream",e.stream.id);for(const t of e.stream.getTracks())t.stop()}}checkForErrorListener(){if(0===this.listeners(u.EventEmitterEvents.Error).length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}async sendCandidateQueue(){if(0===this.candidateSendQueue.length)return;const e=this.candidateSendQueue;this.candidateSendQueue=[],++this.candidateSendTries;const t={candidates:e};o.logger.debug("Attempting to send "+e.length+" candidates");try{await this.sendVoipEvent(a.EventType.CallCandidates,t),this.candidateSendTries=0}catch(n){if(n.event&&this.client.cancelPendingEvent(n.event),this.candidateSendQueue.push(...e),this.candidateSendTries>5){o.logger.debug("Failed to send candidates on attempt "+this.candidateSendTries+". Giving up on this call.",n);const e=E.SignallingFailed,t="Signalling failed";return this.emit(v.Error,new _(e,t,n)),void this.hangup(e,!1)}const t=500*Math.pow(2,this.candidateSendTries);++this.candidateSendTries,o.logger.debug("Failed to send candidates. Retrying in "+t+"ms",n),setTimeout((()=>{this.sendCandidateQueue()}),t)}}async placeCall(e,t){if(!e)throw new Error("You CANNOT start a call without audio");this.setState(p.WaitLocalMedia);try{const n=await this.client.getMediaHandler().getUserMediaStream(e,t);R(n.getAudioTracks(),!0),R(n.getVideoTracks(),!0);const r=new d.CallFeed({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),stream:n,purpose:l.SDPStreamMetadataPurpose.Usermedia,audioMuted:!1,videoMuted:!1});await this.placeCallWithCallFeeds([r])}catch(n){return void this.getUserMediaFailed(n)}}async placeCallWithCallFeeds(e){this.checkForErrorListener(),this.direction=y.Outbound,this.client.callEventHandler.calls.set(this.callId,this);const t=await this.client.checkTurnServers();t||o.logger.warn("Failed to get TURN credentials! Proceeding with call anyway..."),this.peerConn=this.createPeerConnection(),this.gotCallFeedsForInvite(e)}createPeerConnection(){const e=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers,iceCandidatePoolSize:this.client.iceCandidatePoolSize});return e.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),e.addEventListener("signalingstatechange",this.onSignallingStateChanged),e.addEventListener("icecandidate",this.gotLocalIceCandidate),e.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),e.addEventListener("track",this.onTrack),e.addEventListener("negotiationneeded",this.onNegotiationNeeded),e.addEventListener("datachannel",this.onDataChannel),e}partyIdMatches(e){const t=0===e.version?null:e.party_id||null;return t===this.opponentPartyId}chooseOpponent(e){const t=e.getContent();o.logger.debug(`Choosing party ID ${t.party_id} for call ID ${this.callId}`),this.opponentVersion=t.version,0===this.opponentVersion?this.opponentPartyId=null:this.opponentPartyId=t.party_id||null,this.opponentCaps=t.capabilities||{},this.opponentMember=e.sender}async addBufferedIceCandidates(){const e=this.remoteCandidateBuffer.get(this.opponentPartyId);e&&(o.logger.info(`Adding ${e.length} buffered candidates for opponent ${this.opponentPartyId}`),await this.addIceCandidates(e)),this.remoteCandidateBuffer=null}async addIceCandidates(e){for(const n of e)if(null!==n.sdpMid&&void 0!==n.sdpMid||null!==n.sdpMLineIndex&&void 0!==n.sdpMLineIndex){o.logger.debug("Call "+this.callId+" got remote ICE "+n.sdpMid+" candidate: "+n.candidate);try{await this.peerConn.addIceCandidate(n)}catch(t){this.ignoreOffer||o.logger.info("Failed to add remote ICE candidate",t)}}else o.logger.debug("Ignoring remote ICE candidate with no sdpMid or sdpMLineIndex")}get hasPeerConnection(){return Boolean(this.peerConn)}}function R(e,t){for(let n=0;n<e.length;n++)e[n].enabled=t}function k(){if("undefined"===typeof window||"undefined"===typeof document)return!1;try{const e=Boolean(window.RTCPeerConnection||window.RTCSessionDescription||window.RTCIceCandidate||navigator.mediaDevices);if(!e)return o.logger.error("WebRTC is not supported in this browser / environment"),!1}catch(e){return o.logger.error("Exception thrown when trying to access WebRTC",e),!1}return!0}function O(e,t,n){if(!k())return null;const r=!!n&&n.forceTURN,i={client:e,roomId:t,turnServers:e.getTurnServers(),forceTURN:e.forceTURN||r},o=new I(i);return e.reEmitter.reEmit(o,Object.values(v)),o}t.MatrixCall=I},9028:function(e,t,n){"use strict";n(6699);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.CallEventHandlerEvent=t.CallEventHandler=void 0;var i=r(n(4344)),o=n(2842),s=n(6471),a=n(9393),c=n(7778),l=n(9528),d=n(2438),u=n(2139);const h=3e3;let g;t.CallEventHandlerEvent=g,function(e){e["Incoming"]="Call.incoming"}(g||(t.CallEventHandlerEvent=g={}));class p{constructor(e){(0,i.default)(this,"client",void 0),(0,i.default)(this,"calls",void 0),(0,i.default)(this,"callEventBuffer",void 0),(0,i.default)(this,"candidateEventsByCall",void 0),(0,i.default)(this,"evaluateEventBuffer",(async()=>{if(this.client.getSyncState()===d.SyncState.Syncing){await Promise.all(this.callEventBuffer.map((e=>{this.client.decryptEventIfNeeded(e)})));const t=new Set;for(const e of this.callEventBuffer)e.getType()!==c.EventType.CallAnswer&&e.getType()!==c.EventType.CallHangup||t.add(e.getContent().call_id);for(const n of this.callEventBuffer)if(n.getType()!==c.EventType.CallInvite||!t.has(n.getContent().call_id))try{await this.handleCallEvent(n)}catch(e){s.logger.error("Caught exception handling call event",e)}this.callEventBuffer=[]}})),(0,i.default)(this,"onRoomTimeline",(e=>{this.client.decryptEventIfNeeded(e),(this.eventIsACall(e)||e.isBeingDecrypted())&&this.callEventBuffer.push(e),(e.isBeingDecrypted()||e.isDecryptionFailure())&&e.once(o.MatrixEventEvent.Decrypted,(async()=>{if(this.eventIsACall(e))if(this.callEventBuffer.includes(e))this.evaluateEventBuffer();else try{await this.handleCallEvent(e)}catch(t){s.logger.error("Caught exception handling call event",t)}}))})),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(l.ClientEvent.Sync,this.evaluateEventBuffer),this.client.on(u.RoomEvent.Timeline,this.onRoomTimeline)}stop(){this.client.removeListener(l.ClientEvent.Sync,this.evaluateEventBuffer),this.client.removeListener(u.RoomEvent.Timeline,this.onRoomTimeline)}eventIsACall(e){const t=e.getType();return t.startsWith("m.call.")||t.startsWith("org.matrix.call.")}async handleCallEvent(e){const t=e.getContent(),n=e.getType(),r=e.getSender()===this.client.credentials.userId;let i=t.call_id?this.calls.get(t.call_id):void 0;if(n!==c.EventType.CallInvite)if(n!==c.EventType.CallCandidates)if([c.EventType.CallHangup,c.EventType.CallReject].includes(n))i?i.state!==a.CallState.Ended&&(n===c.EventType.CallHangup?i.onHangupReceived(t):i.onRejectReceived(t),i.state===a.CallState.Ended&&this.calls.delete(t.call_id)):(i=(0,a.createNewMatrixCall)(this.client,e.getRoomId()),i&&(i.callId=t.call_id,i.initWithHangup(e),this.calls.set(t.call_id,i)));else if(i&&i.hasPeerConnection){if(e.getContent().party_id!==i.ourPartyId)switch(n){case c.EventType.CallAnswer:r?i.state===a.CallState.Ringing&&i.onAnsweredElsewhere(t):i.onAnswerReceived(e);break;case c.EventType.CallSelectAnswer:i.onSelectAnswerReceived(e);break;case c.EventType.CallNegotiate:i.onNegotiateReceived(e);break;case c.EventType.CallAssertedIdentity:case c.EventType.CallAssertedIdentityPrefix:i.onAssertedIdentityReceived(e);break;case c.EventType.CallSDPStreamMetadataChanged:case c.EventType.CallSDPStreamMetadataChangedPrefix:i.onSDPStreamMetadataChangedReceived(e);break}}else s.logger.info(`Discarding possible call event ${e.getId()} as we don't have a call/peerConn`,n);else{if(r)return;i?i.onRemoteIceCandidatesReceived(e):(this.candidateEventsByCall.has(t.call_id)||this.candidateEventsByCall.set(t.call_id,[]),this.candidateEventsByCall.get(t.call_id).push(e))}else{if(r)return;if(e.getLocalAge()>t.lifetime-h)return;if(i&&i.state===a.CallState.Ended)return;i&&s.logger.log(`WARN: Already have a MatrixCall with id ${t.call_id} but got an invite. Clobbering.`);const n=this.client.getTurnServersExpiry()-Date.now();if(s.logger.info("Current turn creds expire in "+n+" ms"),i=(0,a.createNewMatrixCall)(this.client,e.getRoomId(),{forceTURN:this.client.forceTURN}),!i)return void s.logger.log("Incoming call ID "+t.call_id+" but this client doesn't support WebRTC");if(i.callId=t.call_id,await i.initWithInvite(e),this.calls.set(i.callId,i),this.candidateEventsByCall.get(i.callId))for(const e of this.candidateEventsByCall.get(i.callId))i.onRemoteIceCandidatesReceived(e);let o;for(const e of this.calls.values()){const t=[a.CallState.WaitLocalMedia,a.CallState.CreateOffer,a.CallState.InviteSent].includes(e.state);if(i.roomId===e.roomId&&e.direction===a.CallDirection.Outbound&&t){o=e;break}}o?o.state===a.CallState.WaitLocalMedia||o.state===a.CallState.CreateOffer||o.callId>i.callId?(s.logger.log("Glare detected: answering incoming call "+i.callId+" and canceling outgoing call "+o.callId),o.replacedBy(i),i.answer()):(s.logger.log("Glare detected: rejecting incoming call "+i.callId+" and keeping outgoing call "+o.callId),i.hangup(a.CallErrorCode.Replaced,!0)):this.client.emit(g.Incoming,i)}}}t.CallEventHandler=p},1559:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SDPStreamMetadataPurpose=t.SDPStreamMetadataKey=void 0;const n="org.matrix.msc3077.sdp_stream_metadata";let r;t.SDPStreamMetadataKey=n,t.SDPStreamMetadataPurpose=r,function(e){e["Usermedia"]="m.usermedia",e["Screenshare"]="m.screenshare"}(r||(t.SDPStreamMetadataPurpose=r={}))},5561:function(e,t,n){"use strict";n(8675),n(3462),n(7380),n(1118);var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.SPEAKING_THRESHOLD=t.CallFeedEvent=t.CallFeed=void 0;var i=r(n(4344)),o=n(9392);const s=200,a=-60;t.SPEAKING_THRESHOLD=a;const c=8;let l;t.CallFeedEvent=l,function(e){e["NewStream"]="new_stream",e["MuteStateChanged"]="mute_state_changed",e["VolumeChanged"]="volume_changed",e["Speaking"]="speaking"}(l||(t.CallFeedEvent=l={}));class d extends o.TypedEventEmitter{constructor(e){super(),(0,i.default)(this,"stream",void 0),(0,i.default)(this,"userId",void 0),(0,i.default)(this,"purpose",void 0),(0,i.default)(this,"speakingVolumeSamples",void 0),(0,i.default)(this,"client",void 0),(0,i.default)(this,"roomId",void 0),(0,i.default)(this,"audioMuted",void 0),(0,i.default)(this,"videoMuted",void 0),(0,i.default)(this,"measuringVolumeActivity",!1),(0,i.default)(this,"audioContext",void 0),(0,i.default)(this,"analyser",void 0),(0,i.default)(this,"frequencyBinCount",void 0),(0,i.default)(this,"speakingThreshold",a),(0,i.default)(this,"speaking",!1),(0,i.default)(this,"volumeLooperTimeout",void 0),(0,i.default)(this,"onAddTrack",(()=>{this.emit(l.NewStream,this.stream)})),(0,i.default)(this,"volumeLooper",(()=>{if(!this.analyser)return;if(!this.measuringVolumeActivity)return;this.analyser.getFloatFrequencyData(this.frequencyBinCount);let e=-1/0;for(let n=0;n<this.frequencyBinCount.length;n++)this.frequencyBinCount[n]>e&&(e=this.frequencyBinCount[n]);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(e),this.emit(l.VolumeChanged,e);let t=!1;for(let n=0;n<this.speakingVolumeSamples.length;n++){const e=this.speakingVolumeSamples[n];if(e>this.speakingThreshold){t=!0;break}}this.speaking!==t&&(this.speaking=t,this.emit(l.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,s)})),this.client=e.client,this.roomId=e.roomId,this.userId=e.userId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(c).fill(-1/0),this.updateStream(null,e.stream),this.hasAudioTrack&&this.initVolumeMeasuring()}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){t!==e&&(e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),t&&(this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?this.initVolumeMeasuring():this.measureVolumeActivity(!1)),this.emit(l.NewStream,this.stream))}initVolumeMeasuring(){const e=window.AudioContext||window.webkitAudioContext;if(!this.hasAudioTrack||!e)return;this.audioContext=new e,this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1;const t=this.audioContext.createMediaStreamSource(this.stream);t.connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}getMember(){const e=this.client.getRoom(this.roomId);return e.getMember(this.userId)}isLocal(){return this.userId===this.client.getUserId()}isAudioMuted(){return 0===this.stream.getAudioTracks().length||this.audioMuted}isVideoMuted(){return 0===this.stream.getVideoTracks().length||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioMuted(e){this.audioMuted=e,this.speakingVolumeSamples.fill(-1/0),this.emit(l.MuteStateChanged,this.audioMuted,this.videoMuted)}setVideoMuted(e){this.videoMuted=e,this.emit(l.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!this.audioContext||!this.analyser||!this.frequencyBinCount||!this.hasAudioTrack)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(l.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}dispose(){clearTimeout(this.volumeLooperTimeout)}}t.CallFeed=d},241:function(e,t,n){"use strict";var r=n(3965);Object.defineProperty(t,"__esModule",{value:!0}),t.MediaHandler=void 0;var i=r(n(4344)),o=n(6471),s=n(9393);class a{constructor(e){this.client=e,(0,i.default)(this,"audioInput",void 0),(0,i.default)(this,"videoInput",void 0),(0,i.default)(this,"localUserMediaStream",void 0),(0,i.default)(this,"userMediaStreams",[]),(0,i.default)(this,"screensharingStreams",[])}async setAudioInput(e){o.logger.info("LOG setting audio input to",e),this.audioInput!==e&&(this.audioInput=e,await this.updateLocalUsermediaStreams())}async setVideoInput(e){o.logger.info("LOG setting video input to",e),this.videoInput!==e&&(this.videoInput=e,await this.updateLocalUsermediaStreams())}async updateLocalUsermediaStreams(){if(0===this.userMediaStreams.length)return;const e=new Map;for(const t of this.client.callEventHandler.calls.values())e.set(t.callId,{audio:t.hasLocalUserMediaAudioTrack,video:t.hasLocalUserMediaVideoTrack});for(const t of this.client.callEventHandler.calls.values()){if(t.state===s.CallState.Ended||!e.has(t.callId))continue;const{audio:n,video:r}=e.get(t.callId),i=await this.getUserMediaStream(n,r,!1);await t.updateLocalUsermediaStream(i)}}async hasAudioDevice(){const e=await navigator.mediaDevices.enumerateDevices();return e.filter((e=>"audioinput"===e.kind)).length>0}async hasVideoDevice(){const e=await navigator.mediaDevices.enumerateDevices();return e.filter((e=>"videoinput"===e.kind)).length>0}async getUserMediaStream(e,t,n=!0){var r,i,s,a;const c=e&&await this.hasAudioDevice(),l=t&&await this.hasVideoDevice();let d;if(!this.localUserMediaStream||0===this.localUserMediaStream.getAudioTracks().length&&c||0===this.localUserMediaStream.getVideoTracks().length&&l||(null===(r=this.localUserMediaStream.getAudioTracks()[0])||void 0===r||null===(i=r.getSettings())||void 0===i?void 0:i.deviceId)!==this.audioInput||(null===(s=this.localUserMediaStream.getVideoTracks()[0])||void 0===s||null===(a=s.getSettings())||void 0===a?void 0:a.deviceId)!==this.videoInput){const e=this.getUserMediaContraints(c,l);o.logger.log("Getting user media with constraints",e),d=await navigator.mediaDevices.getUserMedia(e);for(const t of d.getTracks()){const e=t.getSettings();"audio"===t.kind?this.audioInput=e.deviceId:"video"===t.kind&&(this.videoInput=e.deviceId)}n&&(this.localUserMediaStream=d)}else{if(d=this.localUserMediaStream.clone(),!c)for(const e of d.getAudioTracks())d.removeTrack(e);if(!l)for(const e of d.getVideoTracks())d.removeTrack(e)}return n&&this.userMediaStreams.push(d),d}stopUserMediaStream(e){o.logger.debug("Stopping usermedia stream",e.id);for(const n of e.getTracks())n.stop();const t=this.userMediaStreams.indexOf(e);-1!==t&&(o.logger.debug("Splicing usermedia stream out stream array",e.id),this.userMediaStreams.splice(t,1)),this.localUserMediaStream===e&&(this.localUserMediaStream=void 0)}async getScreensharingStream(e,t=!0){let n;if(0===this.screensharingStreams.length){const t=this.getScreenshareContraints(e);if(!t)return null;e?(o.logger.debug("Getting screensharing stream using getUserMedia()",e),n=await navigator.mediaDevices.getUserMedia(t)):(o.logger.debug("Getting screensharing stream using getDisplayMedia()"),n=await navigator.mediaDevices.getDisplayMedia(t))}else{const e=this.screensharingStreams[this.screensharingStreams.length-1];o.logger.log("Cloning screensharing stream",e.id),n=e.clone()}return t&&this.screensharingStreams.push(n),n}stopScreensharingStream(e){o.logger.debug("Stopping screensharing stream",e.id);for(const n of e.getTracks())n.stop();const t=this.screensharingStreams.indexOf(e);-1!==t&&(o.logger.debug("Splicing screensharing stream out stream array",e.id),this.screensharingStreams.splice(t,1))}stopAllStreams(){for(const e of this.userMediaStreams)for(const t of e.getTracks())t.stop();for(const e of this.screensharingStreams)for(const t of e.getTracks())t.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0}getUserMediaContraints(e,t){const n=!!navigator.webkitGetUserMedia;return{audio:!!e&&{deviceId:this.audioInput?{ideal:this.audioInput}:void 0},video:!!t&&{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:n?{exact:640}:{ideal:640},height:n?{exact:360}:{ideal:360}}}}getScreenshareContraints(e){return e?(o.logger.debug("Using desktop capturer source",e),{audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e}}}):(o.logger.debug("Not using desktop capturer source"),{audio:!1,video:!0})}}t.MediaHandler=a},5812:function(e,t,n){n(1703);var r="function"===typeof Map&&Map.prototype,i=Object.getOwnPropertyDescriptor&&r?Object.getOwnPropertyDescriptor(Map.prototype,"size"):null,o=r&&i&&"function"===typeof i.get?i.get:null,s=r&&Map.prototype.forEach,a="function"===typeof Set&&Set.prototype,c=Object.getOwnPropertyDescriptor&&a?Object.getOwnPropertyDescriptor(Set.prototype,"size"):null,l=a&&c&&"function"===typeof c.get?c.get:null,d=a&&Set.prototype.forEach,u="function"===typeof WeakMap&&WeakMap.prototype,h=u?WeakMap.prototype.has:null,g="function"===typeof WeakSet&&WeakSet.prototype,p=g?WeakSet.prototype.has:null,f="function"===typeof WeakRef&&WeakRef.prototype,y=f?WeakRef.prototype.deref:null,m=Boolean.prototype.valueOf,v=Object.prototype.toString,E=Function.prototype.toString,S=String.prototype.match,b=String.prototype.slice,w=String.prototype.replace,_=String.prototype.toUpperCase,T=String.prototype.toLowerCase,I=RegExp.prototype.test,R=Array.prototype.concat,k=Array.prototype.join,O=Array.prototype.slice,C=Math.floor,P="function"===typeof BigInt?BigInt.prototype.valueOf:null,M=Object.getOwnPropertySymbols,D="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?Symbol.prototype.toString:null,A="function"===typeof Symbol&&"object"===typeof Symbol.iterator,U="function"===typeof Symbol&&Symbol.toStringTag&&(typeof Symbol.toStringTag===A||"symbol")?Symbol.toStringTag:null,L=Object.prototype.propertyIsEnumerable,N=("function"===typeof Reflect?Reflect.getPrototypeOf:Object.getPrototypeOf)||([].__proto__===Array.prototype?function(e){return e.__proto__}:null);function B(e,t){if(e===1/0||e===-1/0||e!==e||e&&e>-1e3&&e<1e3||I.call(/e/,t))return t;var n=/[0-9](?=(?:[0-9]{3})+(?![0-9]))/g;if("number"===typeof e){var r=e<0?-C(-e):C(e);if(r!==e){var i=String(r),o=b.call(t,i.length+1);return w.call(i,n,"$&_")+"."+w.call(w.call(o,/([0-9]{3})/g,"$&_"),/_$/,"")}}return w.call(t,n,"$&_")}var j=n(4654),x=j.custom,K=z(x)?x:null;function F(e,t,n){var r="double"===(n.quoteStyle||t)?'"':"'";return r+e+r}function q(e){return w.call(String(e),/"/g,"&quot;")}function $(e){return"[object Array]"===ee(e)&&(!U||!("object"===typeof e&&U in e))}function V(e){return"[object Date]"===ee(e)&&(!U||!("object"===typeof e&&U in e))}function G(e){return"[object RegExp]"===ee(e)&&(!U||!("object"===typeof e&&U in e))}function W(e){return"[object Error]"===ee(e)&&(!U||!("object"===typeof e&&U in e))}function H(e){return"[object String]"===ee(e)&&(!U||!("object"===typeof e&&U in e))}function Y(e){return"[object Number]"===ee(e)&&(!U||!("object"===typeof e&&U in e))}function J(e){return"[object Boolean]"===ee(e)&&(!U||!("object"===typeof e&&U in e))}function z(e){if(A)return e&&"object"===typeof e&&e instanceof Symbol;if("symbol"===typeof e)return!0;if(!e||"object"!==typeof e||!D)return!1;try{return D.call(e),!0}catch(t){}return!1}function Q(e){if(!e||"object"!==typeof e||!P)return!1;try{return P.call(e),!0}catch(t){}return!1}e.exports=function e(t,n,r,i){var a=n||{};if(Z(a,"quoteStyle")&&"single"!==a.quoteStyle&&"double"!==a.quoteStyle)throw new TypeError('option "quoteStyle" must be "single" or "double"');if(Z(a,"maxStringLength")&&("number"===typeof a.maxStringLength?a.maxStringLength<0&&a.maxStringLength!==1/0:null!==a.maxStringLength))throw new TypeError('option "maxStringLength", if provided, must be a positive integer, Infinity, or `null`');var c=!Z(a,"customInspect")||a.customInspect;if("boolean"!==typeof c&&"symbol"!==c)throw new TypeError("option \"customInspect\", if provided, must be `true`, `false`, or `'symbol'`");if(Z(a,"indent")&&null!==a.indent&&"\t"!==a.indent&&!(parseInt(a.indent,10)===a.indent&&a.indent>0))throw new TypeError('option "indent" must be "\\t", an integer > 0, or `null`');if(Z(a,"numericSeparator")&&"boolean"!==typeof a.numericSeparator)throw new TypeError('option "numericSeparator", if provided, must be `true` or `false`');var u=a.numericSeparator;if("undefined"===typeof t)return"undefined";if(null===t)return"null";if("boolean"===typeof t)return t?"true":"false";if("string"===typeof t)return le(t,a);if("number"===typeof t){if(0===t)return 1/0/t>0?"0":"-0";var h=String(t);return u?B(t,h):h}if("bigint"===typeof t){var g=String(t)+"n";return u?B(t,g):g}var p="undefined"===typeof a.depth?5:a.depth;if("undefined"===typeof r&&(r=0),r>=p&&p>0&&"object"===typeof t)return $(t)?"[Array]":"[Object]";var f=fe(a,r);if("undefined"===typeof i)i=[];else if(ne(i,t)>=0)return"[Circular]";function y(t,n,o){if(n&&(i=O.call(i),i.push(n)),o){var s={depth:a.depth};return Z(a,"quoteStyle")&&(s.quoteStyle=a.quoteStyle),e(t,s,r+1,i)}return e(t,a,r+1,i)}if("function"===typeof t&&!G(t)){var v=te(t),E=me(t,y);return"[Function"+(v?": "+v:" (anonymous)")+"]"+(E.length>0?" { "+k.call(E,", ")+" }":"")}if(z(t)){var S=A?w.call(String(t),/^(Symbol\(.*\))_[^)]*$/,"$1"):D.call(t);return"object"!==typeof t||A?S:ue(S)}if(ce(t)){for(var _="<"+T.call(String(t.nodeName)),I=t.attributes||[],C=0;C<I.length;C++)_+=" "+I[C].name+"="+F(q(I[C].value),"double",a);return _+=">",t.childNodes&&t.childNodes.length&&(_+="..."),_+="</"+T.call(String(t.nodeName))+">",_}if($(t)){if(0===t.length)return"[]";var M=me(t,y);return f&&!pe(M)?"["+ye(M,f)+"]":"[ "+k.call(M,", ")+" ]"}if(W(t)){var x=me(t,y);return"cause"in Error.prototype||!("cause"in t)||L.call(t,"cause")?0===x.length?"["+String(t)+"]":"{ ["+String(t)+"] "+k.call(x,", ")+" }":"{ ["+String(t)+"] "+k.call(R.call("[cause]: "+y(t.cause),x),", ")+" }"}if("object"===typeof t&&c){if(K&&"function"===typeof t[K]&&j)return j(t,{depth:p-r});if("symbol"!==c&&"function"===typeof t.inspect)return t.inspect()}if(re(t)){var X=[];return s.call(t,(function(e,n){X.push(y(n,t,!0)+" => "+y(e,t))})),ge("Map",o.call(t),X,f)}if(se(t)){var de=[];return d.call(t,(function(e){de.push(y(e,t))})),ge("Set",l.call(t),de,f)}if(ie(t))return he("WeakMap");if(ae(t))return he("WeakSet");if(oe(t))return he("WeakRef");if(Y(t))return ue(y(Number(t)));if(Q(t))return ue(y(P.call(t)));if(J(t))return ue(m.call(t));if(H(t))return ue(y(String(t)));if(!V(t)&&!G(t)){var ve=me(t,y),Ee=N?N(t)===Object.prototype:t instanceof Object||t.constructor===Object,Se=t instanceof Object?"":"null prototype",be=!Ee&&U&&Object(t)===t&&U in t?b.call(ee(t),8,-1):Se?"Object":"",we=Ee||"function"!==typeof t.constructor?"":t.constructor.name?t.constructor.name+" ":"",_e=we+(be||Se?"["+k.call(R.call([],be||[],Se||[]),": ")+"] ":"");return 0===ve.length?_e+"{}":f?_e+"{"+ye(ve,f)+"}":_e+"{ "+k.call(ve,", ")+" }"}return String(t)};var X=Object.prototype.hasOwnProperty||function(e){return e in this};function Z(e,t){return X.call(e,t)}function ee(e){return v.call(e)}function te(e){if(e.name)return e.name;var t=S.call(E.call(e),/^function\s*([\w$]+)/);return t?t[1]:null}function ne(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1}function re(e){if(!o||!e||"object"!==typeof e)return!1;try{o.call(e);try{l.call(e)}catch(t){return!0}return e instanceof Map}catch(n){}return!1}function ie(e){if(!h||!e||"object"!==typeof e)return!1;try{h.call(e,h);try{p.call(e,p)}catch(t){return!0}return e instanceof WeakMap}catch(n){}return!1}function oe(e){if(!y||!e||"object"!==typeof e)return!1;try{return y.call(e),!0}catch(t){}return!1}function se(e){if(!l||!e||"object"!==typeof e)return!1;try{l.call(e);try{o.call(e)}catch(t){return!0}return e instanceof Set}catch(n){}return!1}function ae(e){if(!p||!e||"object"!==typeof e)return!1;try{p.call(e,p);try{h.call(e,h)}catch(t){return!0}return e instanceof WeakSet}catch(n){}return!1}function ce(e){return!(!e||"object"!==typeof e)&&("undefined"!==typeof HTMLElement&&e instanceof HTMLElement||"string"===typeof e.nodeName&&"function"===typeof e.getAttribute)}function le(e,t){if(e.length>t.maxStringLength){var n=e.length-t.maxStringLength,r="... "+n+" more character"+(n>1?"s":"");return le(b.call(e,0,t.maxStringLength),t)+r}var i=w.call(w.call(e,/(['\\])/g,"\\$1"),/[\x00-\x1f]/g,de);return F(i,"single",t)}function de(e){var t=e.charCodeAt(0),n={8:"b",9:"t",10:"n",12:"f",13:"r"}[t];return n?"\\"+n:"\\x"+(t<16?"0":"")+_.call(t.toString(16))}function ue(e){return"Object("+e+")"}function he(e){return e+" { ? }"}function ge(e,t,n,r){var i=r?ye(n,r):k.call(n,", ");return e+" ("+t+") {"+i+"}"}function pe(e){for(var t=0;t<e.length;t++)if(ne(e[t],"\n")>=0)return!1;return!0}function fe(e,t){var n;if("\t"===e.indent)n="\t";else{if(!("number"===typeof e.indent&&e.indent>0))return null;n=k.call(Array(e.indent+1)," ")}return{base:n,prev:k.call(Array(t+1),n)}}function ye(e,t){if(0===e.length)return"";var n="\n"+t.prev+t.base;return n+k.call(e,","+n)+"\n"+t.prev}function me(e,t){var n=$(e),r=[];if(n){r.length=e.length;for(var i=0;i<e.length;i++)r[i]=Z(e,i)?t(e[i],e):""}var o,s="function"===typeof M?M(e):[];if(A){o={};for(var a=0;a<s.length;a++)o["$"+s[a]]=s[a]}for(var c in e)Z(e,c)&&(n&&String(Number(c))===c&&c<e.length||A&&o["$"+c]instanceof Symbol||(I.call(/[^\w$]/,c)?r.push(t(c,e)+": "+t(e[c],e)):r.push(c+": "+t(e[c],e))));if("function"===typeof M)for(var l=0;l<s.length;l++)L.call(e,s[l])&&r.push("["+t(s[l])+"]: "+t(e[s[l]],e));return r}},9437:function(e,t,n){"use strict";n(1703),n(6699);const r=n(5711),i=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class o extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const s=(e,t,n)=>{const r=n.retries-(t-1);return e.attemptNumber=t,e.retriesLeft=r,e},a=e=>i.includes(e),c=(e,t)=>new Promise(((n,i)=>{t={onFailedAttempt:()=>{},retries:10,...t};const c=r.operation(t);c.attempt((async r=>{try{n(await e(r))}catch(l){if(!(l instanceof Error))return void i(new TypeError(`Non-error was thrown: "${l}". You should only throw errors.`));if(l instanceof o)c.stop(),i(l.originalError);else if(l instanceof TypeError&&!a(l.message))c.stop(),i(l);else{s(l,r,t);try{await t.onFailedAttempt(l)}catch(l){return void i(l)}c.retry(l)||i(c.mainError())}}}))}));e.exports=c,e.exports["default"]=c,e.exports.AbortError=o},9734:function(e){"use strict";var t=String.prototype.replace,n=/%20/g,r={RFC1738:"RFC1738",RFC3986:"RFC3986"};e.exports={default:r.RFC3986,formatters:{RFC1738:function(e){return t.call(e,n,"+")},RFC3986:function(e){return String(e)}},RFC1738:r.RFC1738,RFC3986:r.RFC3986}},5410:function(e,t,n){"use strict";var r=n(6383),i=n(5730),o=n(9734);e.exports={formats:o,parse:i,stringify:r}},5730:function(e,t,n){"use strict";n(1703);var r=n(2898),i=Object.prototype.hasOwnProperty,o=Array.isArray,s={allowDots:!1,allowPrototypes:!1,allowSparse:!1,arrayLimit:20,charset:"utf-8",charsetSentinel:!1,comma:!1,decoder:r.decode,delimiter:"&",depth:5,ignoreQueryPrefix:!1,interpretNumericEntities:!1,parameterLimit:1e3,parseArrays:!0,plainObjects:!1,strictNullHandling:!1},a=function(e){return e.replace(/&#(\d+);/g,(function(e,t){return String.fromCharCode(parseInt(t,10))}))},c=function(e,t){return e&&"string"===typeof e&&t.comma&&e.indexOf(",")>-1?e.split(","):e},l="utf8=%26%2310003%3B",d="utf8=%E2%9C%93",u=function(e,t){var n,u={},h=t.ignoreQueryPrefix?e.replace(/^\?/,""):e,g=t.parameterLimit===1/0?void 0:t.parameterLimit,p=h.split(t.delimiter,g),f=-1,y=t.charset;if(t.charsetSentinel)for(n=0;n<p.length;++n)0===p[n].indexOf("utf8=")&&(p[n]===d?y="utf-8":p[n]===l&&(y="iso-8859-1"),f=n,n=p.length);for(n=0;n<p.length;++n)if(n!==f){var m,v,E=p[n],S=E.indexOf("]="),b=-1===S?E.indexOf("="):S+1;-1===b?(m=t.decoder(E,s.decoder,y,"key"),v=t.strictNullHandling?null:""):(m=t.decoder(E.slice(0,b),s.decoder,y,"key"),v=r.maybeMap(c(E.slice(b+1),t),(function(e){return t.decoder(e,s.decoder,y,"value")}))),v&&t.interpretNumericEntities&&"iso-8859-1"===y&&(v=a(v)),E.indexOf("[]=")>-1&&(v=o(v)?[v]:v),i.call(u,m)?u[m]=r.combine(u[m],v):u[m]=v}return u},h=function(e,t,n,r){for(var i=r?t:c(t,n),o=e.length-1;o>=0;--o){var s,a=e[o];if("[]"===a&&n.parseArrays)s=[].concat(i);else{s=n.plainObjects?Object.create(null):{};var l="["===a.charAt(0)&&"]"===a.charAt(a.length-1)?a.slice(1,-1):a,d=parseInt(l,10);n.parseArrays||""!==l?!isNaN(d)&&a!==l&&String(d)===l&&d>=0&&n.parseArrays&&d<=n.arrayLimit?(s=[],s[d]=i):"__proto__"!==l&&(s[l]=i):s={0:i}}i=s}return i},g=function(e,t,n,r){if(e){var o=n.allowDots?e.replace(/\.([^.[]+)/g,"[$1]"):e,s=/(\[[^[\]]*])/,a=/(\[[^[\]]*])/g,c=n.depth>0&&s.exec(o),l=c?o.slice(0,c.index):o,d=[];if(l){if(!n.plainObjects&&i.call(Object.prototype,l)&&!n.allowPrototypes)return;d.push(l)}var u=0;while(n.depth>0&&null!==(c=a.exec(o))&&u<n.depth){if(u+=1,!n.plainObjects&&i.call(Object.prototype,c[1].slice(1,-1))&&!n.allowPrototypes)return;d.push(c[1])}return c&&d.push("["+o.slice(c.index)+"]"),h(d,t,n,r)}},p=function(e){if(!e)return s;if(null!==e.decoder&&void 0!==e.decoder&&"function"!==typeof e.decoder)throw new TypeError("Decoder has to be a function.");if("undefined"!==typeof e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var t="undefined"===typeof e.charset?s.charset:e.charset;return{allowDots:"undefined"===typeof e.allowDots?s.allowDots:!!e.allowDots,allowPrototypes:"boolean"===typeof e.allowPrototypes?e.allowPrototypes:s.allowPrototypes,allowSparse:"boolean"===typeof e.allowSparse?e.allowSparse:s.allowSparse,arrayLimit:"number"===typeof e.arrayLimit?e.arrayLimit:s.arrayLimit,charset:t,charsetSentinel:"boolean"===typeof e.charsetSentinel?e.charsetSentinel:s.charsetSentinel,comma:"boolean"===typeof e.comma?e.comma:s.comma,decoder:"function"===typeof e.decoder?e.decoder:s.decoder,delimiter:"string"===typeof e.delimiter||r.isRegExp(e.delimiter)?e.delimiter:s.delimiter,depth:"number"===typeof e.depth||!1===e.depth?+e.depth:s.depth,ignoreQueryPrefix:!0===e.ignoreQueryPrefix,interpretNumericEntities:"boolean"===typeof e.interpretNumericEntities?e.interpretNumericEntities:s.interpretNumericEntities,parameterLimit:"number"===typeof e.parameterLimit?e.parameterLimit:s.parameterLimit,parseArrays:!1!==e.parseArrays,plainObjects:"boolean"===typeof e.plainObjects?e.plainObjects:s.plainObjects,strictNullHandling:"boolean"===typeof e.strictNullHandling?e.strictNullHandling:s.strictNullHandling}};e.exports=function(e,t){var n=p(t);if(""===e||null===e||"undefined"===typeof e)return n.plainObjects?Object.create(null):{};for(var i="string"===typeof e?u(e,n):e,o=n.plainObjects?Object.create(null):{},s=Object.keys(i),a=0;a<s.length;++a){var c=s[a],l=g(c,i[c],n,"string"===typeof e);o=r.merge(o,l,n)}return!0===n.allowSparse?o:r.compact(o)}},6383:function(e,t,n){"use strict";n(1703);var r=n(4525),i=n(2898),o=n(9734),s=Object.prototype.hasOwnProperty,a={brackets:function(e){return e+"[]"},comma:"comma",indices:function(e,t){return e+"["+t+"]"},repeat:function(e){return e}},c=Array.isArray,l=String.prototype.split,d=Array.prototype.push,u=function(e,t){d.apply(e,c(t)?t:[t])},h=Date.prototype.toISOString,g=o["default"],p={addQueryPrefix:!1,allowDots:!1,charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encoder:i.encode,encodeValuesOnly:!1,format:g,formatter:o.formatters[g],indices:!1,serializeDate:function(e){return h.call(e)},skipNulls:!1,strictNullHandling:!1},f=function(e){return"string"===typeof e||"number"===typeof e||"boolean"===typeof e||"symbol"===typeof e||"bigint"===typeof e},y={},m=function e(t,n,o,s,a,d,h,g,m,v,E,S,b,w,_){var T=t,I=_,R=0,k=!1;while(void 0!==(I=I.get(y))&&!k){var O=I.get(t);if(R+=1,"undefined"!==typeof O){if(O===R)throw new RangeError("Cyclic object value");k=!0}"undefined"===typeof I.get(y)&&(R=0)}if("function"===typeof h?T=h(n,T):T instanceof Date?T=v(T):"comma"===o&&c(T)&&(T=i.maybeMap(T,(function(e){return e instanceof Date?v(e):e}))),null===T){if(s)return d&&!b?d(n,p.encoder,w,"key",E):n;T=""}if(f(T)||i.isBuffer(T)){if(d){var C=b?n:d(n,p.encoder,w,"key",E);if("comma"===o&&b){for(var P=l.call(String(T),","),M="",D=0;D<P.length;++D)M+=(0===D?"":",")+S(d(P[D],p.encoder,w,"value",E));return[S(C)+"="+M]}return[S(C)+"="+S(d(T,p.encoder,w,"value",E))]}return[S(n)+"="+S(String(T))]}var A,U=[];if("undefined"===typeof T)return U;if("comma"===o&&c(T))A=[{value:T.length>0?T.join(",")||null:void 0}];else if(c(h))A=h;else{var L=Object.keys(T);A=g?L.sort(g):L}for(var N=0;N<A.length;++N){var B=A[N],j="object"===typeof B&&"undefined"!==typeof B.value?B.value:T[B];if(!a||null!==j){var x=c(T)?"function"===typeof o?o(n,B):n:n+(m?"."+B:"["+B+"]");_.set(t,R);var K=r();K.set(y,_),u(U,e(j,x,o,s,a,d,h,g,m,v,E,S,b,w,K))}}return U},v=function(e){if(!e)return p;if(null!==e.encoder&&"undefined"!==typeof e.encoder&&"function"!==typeof e.encoder)throw new TypeError("Encoder has to be a function.");var t=e.charset||p.charset;if("undefined"!==typeof e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var n=o["default"];if("undefined"!==typeof e.format){if(!s.call(o.formatters,e.format))throw new TypeError("Unknown format option provided.");n=e.format}var r=o.formatters[n],i=p.filter;return("function"===typeof e.filter||c(e.filter))&&(i=e.filter),{addQueryPrefix:"boolean"===typeof e.addQueryPrefix?e.addQueryPrefix:p.addQueryPrefix,allowDots:"undefined"===typeof e.allowDots?p.allowDots:!!e.allowDots,charset:t,charsetSentinel:"boolean"===typeof e.charsetSentinel?e.charsetSentinel:p.charsetSentinel,delimiter:"undefined"===typeof e.delimiter?p.delimiter:e.delimiter,encode:"boolean"===typeof e.encode?e.encode:p.encode,encoder:"function"===typeof e.encoder?e.encoder:p.encoder,encodeValuesOnly:"boolean"===typeof e.encodeValuesOnly?e.encodeValuesOnly:p.encodeValuesOnly,filter:i,format:n,formatter:r,serializeDate:"function"===typeof e.serializeDate?e.serializeDate:p.serializeDate,skipNulls:"boolean"===typeof e.skipNulls?e.skipNulls:p.skipNulls,sort:"function"===typeof e.sort?e.sort:null,strictNullHandling:"boolean"===typeof e.strictNullHandling?e.strictNullHandling:p.strictNullHandling}};e.exports=function(e,t){var n,i,o=e,s=v(t);"function"===typeof s.filter?(i=s.filter,o=i("",o)):c(s.filter)&&(i=s.filter,n=i);var l,d=[];if("object"!==typeof o||null===o)return"";l=t&&t.arrayFormat in a?t.arrayFormat:t&&"indices"in t?t.indices?"indices":"repeat":"indices";var h=a[l];n||(n=Object.keys(o)),s.sort&&n.sort(s.sort);for(var g=r(),p=0;p<n.length;++p){var f=n[p];s.skipNulls&&null===o[f]||u(d,m(o[f],f,h,s.strictNullHandling,s.skipNulls,s.encode?s.encoder:null,s.filter,s.sort,s.allowDots,s.serializeDate,s.format,s.formatter,s.encodeValuesOnly,s.charset,g))}var y=d.join(s.delimiter),E=!0===s.addQueryPrefix?"?":"";return s.charsetSentinel&&("iso-8859-1"===s.charset?E+="utf8=%26%2310003%3B&":E+="utf8=%E2%9C%93&"),y.length>0?E+y:""}},2898:function(e,t,n){"use strict";var r=n(9734),i=Object.prototype.hasOwnProperty,o=Array.isArray,s=function(){for(var e=[],t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e}(),a=function(e){while(e.length>1){var t=e.pop(),n=t.obj[t.prop];if(o(n)){for(var r=[],i=0;i<n.length;++i)"undefined"!==typeof n[i]&&r.push(n[i]);t.obj[t.prop]=r}}},c=function(e,t){for(var n=t&&t.plainObjects?Object.create(null):{},r=0;r<e.length;++r)"undefined"!==typeof e[r]&&(n[r]=e[r]);return n},l=function e(t,n,r){if(!n)return t;if("object"!==typeof n){if(o(t))t.push(n);else{if(!t||"object"!==typeof t)return[t,n];(r&&(r.plainObjects||r.allowPrototypes)||!i.call(Object.prototype,n))&&(t[n]=!0)}return t}if(!t||"object"!==typeof t)return[t].concat(n);var s=t;return o(t)&&!o(n)&&(s=c(t,r)),o(t)&&o(n)?(n.forEach((function(n,o){if(i.call(t,o)){var s=t[o];s&&"object"===typeof s&&n&&"object"===typeof n?t[o]=e(s,n,r):t.push(n)}else t[o]=n})),t):Object.keys(n).reduce((function(t,o){var s=n[o];return i.call(t,o)?t[o]=e(t[o],s,r):t[o]=s,t}),s)},d=function(e,t){return Object.keys(t).reduce((function(e,n){return e[n]=t[n],e}),e)},u=function(e,t,n){var r=e.replace(/\+/g," ");if("iso-8859-1"===n)return r.replace(/%[0-9a-f]{2}/gi,unescape);try{return decodeURIComponent(r)}catch(i){return r}},h=function(e,t,n,i,o){if(0===e.length)return e;var a=e;if("symbol"===typeof e?a=Symbol.prototype.toString.call(e):"string"!==typeof e&&(a=String(e)),"iso-8859-1"===n)return escape(a).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));for(var c="",l=0;l<a.length;++l){var d=a.charCodeAt(l);45===d||46===d||95===d||126===d||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||o===r.RFC1738&&(40===d||41===d)?c+=a.charAt(l):d<128?c+=s[d]:d<2048?c+=s[192|d>>6]+s[128|63&d]:d<55296||d>=57344?c+=s[224|d>>12]+s[128|d>>6&63]+s[128|63&d]:(l+=1,d=65536+((1023&d)<<10|1023&a.charCodeAt(l)),c+=s[240|d>>18]+s[128|d>>12&63]+s[128|d>>6&63]+s[128|63&d])}return c},g=function(e){for(var t=[{obj:{o:e},prop:"o"}],n=[],r=0;r<t.length;++r)for(var i=t[r],o=i.obj[i.prop],s=Object.keys(o),c=0;c<s.length;++c){var l=s[c],d=o[l];"object"===typeof d&&null!==d&&-1===n.indexOf(d)&&(t.push({obj:o,prop:l}),n.push(d))}return a(t),e},p=function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},f=function(e){return!(!e||"object"!==typeof e)&&!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))},y=function(e,t){return[].concat(e,t)},m=function(e,t){if(o(e)){for(var n=[],r=0;r<e.length;r+=1)n.push(t(e[r]));return n}return t(e)};e.exports={arrayToObject:c,assign:d,combine:y,compact:g,decode:u,encode:h,isBuffer:f,isRegExp:p,maybeMap:m,merge:l}},5711:function(e,t,n){e.exports=n(7334)},7334:function(e,t,n){n(1703);var r=n(8463);t.operation=function(e){var n=t.timeouts(e);return new r(n,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var n in e)t[n]=e[n];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],i=0;i<t.retries;i++)r.push(this.createTimeout(i,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(i,t)),r.sort((function(e,t){return e-t})),r},t.createTimeout=function(e,t){var n=t.randomize?Math.random()+1:1,r=Math.round(n*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return r=Math.min(r,t.maxTimeout),r},t.wrap=function(e,n,r){if(n instanceof Array&&(r=n,n=null),!r)for(var i in r=[],e)"function"===typeof e[i]&&r.push(i);for(var o=0;o<r.length;o++){var s=r[o],a=e[s];e[s]=function(r){var i=t.operation(n),o=Array.prototype.slice.call(arguments,1),s=o.pop();o.push((function(e){i.retry(e)||(e&&(arguments[0]=i.mainError()),s.apply(this,arguments))})),i.attempt((function(){r.apply(e,o)}))}.bind(e,a),e[s].options=n}}},8463:function(e,t,n){function r(e,t){"boolean"===typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}n(1703),e.exports=r,r.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},r.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},r.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var n=this._timeouts.shift();if(void 0===n){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1)}var r=this;return this._timer=setTimeout((function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout((function(){r._operationTimeoutCb(r._attempts)}),r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)}),n),this._options.unref&&this._timer.unref(),!0},r.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){n._operationTimeoutCb()}),n._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},r.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},r.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},r.prototype.start=r.prototype.try,r.prototype.errors=function(){return this._errors},r.prototype.attempts=function(){return this._attempts},r.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,n=0,r=0;r<this._errors.length;r++){var i=this._errors[r],o=i.message,s=(e[o]||0)+1;e[o]=s,s>=n&&(t=i,n=s)}return t}},6779:function(e,t,n){n(1703);var r=n(5361),i=r.Buffer;function o(e,t){for(var n in e)t[n]=e[n]}function s(e,t,n){return i(e,t,n)}i.from&&i.alloc&&i.allocUnsafe&&i.allocUnsafeSlow?e.exports=r:(o(r,t),t.Buffer=s),o(i,s),s.from=function(e,t,n){if("number"===typeof e)throw new TypeError("Argument must not be a number");return i(e,t,n)},s.alloc=function(e,t,n){if("number"!==typeof e)throw new TypeError("Argument must be a number");var r=i(e);return void 0!==t?"string"===typeof n?r.fill(t,n):r.fill(t):r.fill(0),r},s.allocUnsafe=function(e){if("number"!==typeof e)throw new TypeError("Argument must be a number");return i(e)},s.allocUnsafeSlow=function(e){if("number"!==typeof e)throw new TypeError("Argument must be a number");return r.SlowBuffer(e)}},4525:function(e,t,n){"use strict";var r=n(8692),i=n(5477),o=n(5812),s=r("%TypeError%"),a=r("%WeakMap%",!0),c=r("%Map%",!0),l=i("WeakMap.prototype.get",!0),d=i("WeakMap.prototype.set",!0),u=i("WeakMap.prototype.has",!0),h=i("Map.prototype.get",!0),g=i("Map.prototype.set",!0),p=i("Map.prototype.has",!0),f=function(e,t){for(var n,r=e;null!==(n=r.next);r=n)if(n.key===t)return r.next=n.next,n.next=e.next,e.next=n,n},y=function(e,t){var n=f(e,t);return n&&n.value},m=function(e,t,n){var r=f(e,t);r?r.value=n:e.next={key:t,next:e.next,value:n}},v=function(e,t){return!!f(e,t)};e.exports=function(){var e,t,n,r={assert:function(e){if(!r.has(e))throw new s("Side channel does not contain "+o(e))},get:function(r){if(a&&r&&("object"===typeof r||"function"===typeof r)){if(e)return l(e,r)}else if(c){if(t)return h(t,r)}else if(n)return y(n,r)},has:function(r){if(a&&r&&("object"===typeof r||"function"===typeof r)){if(e)return u(e,r)}else if(c){if(t)return p(t,r)}else if(n)return v(n,r);return!1},set:function(r,i){a&&r&&("object"===typeof r||"function"===typeof r)?(e||(e=new a),d(e,r,i)):c?(t||(t=new c),g(t,r,i)):(n||(n={key:{},next:null}),m(n,r,i))}};return r}},3732:function(e,t,n){"use strict";var r=n(7873);function i(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}var o=RegExp(Object.keys(r).map(i).join("|"),"g");function s(e){return r[e]}function a(e){return e.replace(o,s)}e.exports=a},4654:function(){},4344:function(e){function t(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}e.exports=t,e.exports.__esModule=!0,e.exports["default"]=e.exports},3965:function(e){function t(e){return e&&e.__esModule?e:{default:e}}e.exports=t,e.exports.__esModule=!0,e.exports["default"]=e.exports},7873:function(e){"use strict";e.exports=JSON.parse('{"0":"O","1":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\\u2028":" ","\\u2029":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":"_","":"_","":"_","":"_","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-.","":"","":",","":",","":",","":",","":",","":"","":"","":";","":"","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":"::=","":":","":"!","":"!","":"!","":"!!","":"!?","":"?","":"?","":"?","":"?","":"?","":"?!","":"??","":"","":".","":".","":".","":".","":".","":".","":".","":".","":".","":".,","":"..","":"..","":"...","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"<","":">","":">","":">","":"4","":"b","":"b","":"d","":"J","":"L","":"P","":"U","":"V","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","`":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'\'","\\"":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'\'","":"\'\'\'","":"\'\'\'\'","":"\'B","":"\'D","":"\'n","":"\'P","":"\'T","":"\'Y","":"(","":"(","":"(","":"(","":"(","":"((","":"()","":"(2)","":"(2O)","":"(3)","":"(4)","":"(5)","":"(6)","":"(7)","":"(8)","":"(9)","":"(a)","":"(A)","":"(b)","":"(B)","":"(c)","":"(C)","":"(d)","":"(D)","":"(e)","":"(E)","":"(f)","":"(F)","":"(g)","":"(G)","":"(h)","":"(H)","":"(i)","":"(j)","":"(J)","":"(k)","":"(K)","":"(l)","":"(l)","":"(l)","":"(L)","":"(l2)","":"(l3)","":"(l4)","":"(l5)","":"(l6)","":"(l7)","":"(l8)","":"(l9)","":"(ll)","":"(lO)","":"(M)","":"(n)","":"(N)","":"(o)","":"(O)","":"(p)","":"(P)","":"(q)","":"(Q)","":"(r)","":"(R)","":"(rn)","":"(s)","":"(S)","":"(S)","":"(t)","":"(T)","":"(u)","":"(U)","":"(v)","":"(V)","":"(w)","":"(W)","":"(x)","":"(X)","":"(y)","":"(Y)","":"(z)","":"(Z)","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":")","":")","":")","":")","":")","":"))","":"{","":"{","":"}","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"*","":"*","":"*","":"*","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"//","":"///","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\\\\\","":"\\\\\\\\","":"\\\\","":"&","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"^","":"^","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"b","":"bi","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"C","":"F","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<<","":"<<<","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"==","":"===","":"=","":">","":">","":">","":">","":">","":">","":">","":"><","":">>","":">>","":">>>","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"$","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"","":"","":"","":"","":"","":"","":"2","":"2,","":"2.","":"22","":"22","":"23","":"23","":"24","":"24","":"25","":"26","":"27","":"28","":"29","":"2l","":"2l","":"2O.","":"2O","":"2O","":"","":"","":"2","":"2","":"2","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"","":"","":"","":"","":"3","":"3,","":"3.","":"3l","":"3O","":"3","":"3","":"3","":"4","":"4","":"4","":"4","":"4","":"4","":"4","":"4","":"","":"","":"","":"4,","":"4.","":"4","":"4","":"4","":"4","":"5","":"5","":"5","":"5","":"5","":"5","":"5","":"5","":"","":"5,","":"5.","":"5","":"5","":"5","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"","":"","":"","":"6,","":"6.","":"6","":"6","":"6","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"","":"7,","":"7.","":"7","":"7","":"7","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"","":"","":"8,","":"8.","":"8","":"8","":"8","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"","":"","":"","":"","":"","":"9,","":"9.","":"9","":"9","":"9","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"a","":"","":"","":"","":"","":"","":"a/c","":"a/s","":"aa","":"AA","":"ae","":"ae","":"AE","":"AE","":"ao","":"AO","":"AR","":"au","":"AU","":"av","":"av","":"AV","":"AV","":"ay","":"AY","":"","":"","":"","":"","":"","":"","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b\'","":"bl","":"","":"","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"c","":"c","":"C","":"C","":"c","":"c","":"C","":"C","":"C\'","":"c/o","":"c/u","":"\\t","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"d","":"d","":"d","":"d","":"D","":"D","":"D","":"d","":"","":"d","":"d\'","":"d","":"dz","":"dz","":"Dz","":"DZ","":"d","":"D","":"D","":"d","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"","":"","":"e","":"E","":"e","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"f","":"F","":"f","":"FAX","":"ff","":"ffi","":"ffl","":"fi","":"fl","":"f","":"","":"","":"","":"","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"","":"g","":"","":"","":"","":"g","":"G","":"G\'","":"","":"","":"","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"","":"h","":"h","":"h","":"H","":"H","":"h","":"h","":"h","":"H","":"H","":"H","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"","":"i","":"","":"","":"i","":"i","":"i","":"ii","":"iii","":"ij","":"iv","":"ix","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"j","":"J","":"J","":"","":"","":"","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"k","":"K","":"K","":"K","":"K","":"K","":"K\'","":"l","|":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","I":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"l","":"l","":"l","":"L","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l,","":"l.","":"l\'","":"l2.","":"l2","":"l2","":"l2","":"l3.","":"l3","":"l3","":"l4.","":"l4","":"l4","":"l5.","":"l5","":"l5","":"l6.","":"l6","":"l6","":"l7.","":"l7","":"l7","":"l8.","":"l8","":"l8","":"l9.","":"l9","":"l9","":"lj","":"lJ","":"Lj","":"LJ","":"ll","":"ll","":"ll","":"ll","":"ll","":"ll","":"ll.","":"lll","":"llS","":"ll","":"ll","":"ll","":"lO","":"lO.","":"lO","":"lO","":"lO","":"ls","":"lt","":"lV","":"lX","":"l","":"lz","":"l","":"l","":"l","":"l","":"l","":"l","":"lo","":"l","":"l","":"l","":"","":"","":"","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"MB","":"","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"N","":"n","":"nj","":"Nj","":"NJ","":"No","":"","":"","":"","":"","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"","":"","":"","":"","":"o","":"","":"o","":"o","":"O","":"O","":"O","":"o","":"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"o","":"o","":"O,","":"O.","":"o\'","":"O\'","":"O\'","%":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"oe","":"OE","":"o","":"oo","":"oo","":"oo","":"OO","":"OO","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"oo","":"o","":"O","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"p","":"p","":"p","":"P\'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"q","":"QE","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"r","":"r","":"r","":"r","":"r","":"r\'","":"rn","m":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"Rs","":"","":"","":"","":"","":"","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"s","":"s","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"sss","":"st","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"t","":"T","":"T","":"","":"T","":"T","":"T","":"t","":"T","":"t","":"","":"T3","":"t","":"TEL","":"tf","":"ts","":"t","":"t","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"","":"","":"u","":"u","":"U","":"U","":"U","":"U\'","":"ue","":"uo","":"","":"","":"","":"","":"","":"","":"","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"VB","":"vi","":"vii","":"viii","":"Vl","":"Vll","":"Vlll","":"V","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"w","":"w","":"W","":"w","":"","":"","":"","":"","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"x","":"X","":"X","":"xi","":"xii","":"Xl","":"Xll","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"y","":"y","":"y","":"Y","":"Y","":"Y","":"","":"","":"","":"","":"","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"z","":"z","":"Z","":"z","":"Z","":"z","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"i","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"\'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"\'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":" lo","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":" lo o ","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"l","":"l","":"l","":"l","":"l","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"l","":"l","":"o","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"\'","":"/","":"","":"","":"","":"","":"","":"\'","":"","":"","":"\'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"<","":"b","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"b","":"b","":"d","":"P","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"J","":"","":"","":"","":"","":"","":"","":"","":"J","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""}')}}]);
//# sourceMappingURL=583.e735e566.js.map